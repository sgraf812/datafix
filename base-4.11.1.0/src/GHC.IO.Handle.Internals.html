<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE Trustworthy #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE NoImplicitPrelude
           , RecordWildCards
           , BangPatterns
           , NondecreasingIndentation
           , RankNTypes
  #-}</span><span>
</span><a name="line-8"></a><span class="hs-pragma">{-# OPTIONS_GHC -Wno-unused-matches #-}</span><span>
</span><a name="line-9"></a><span class="hs-pragma">{-# OPTIONS_GHC -Wno-name-shadowing #-}</span><span>
</span><a name="line-10"></a><span class="hs-pragma">{-# OPTIONS_HADDOCK hide #-}</span><span>
</span><a name="line-11"></a><span>
</span><a name="line-12"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-13"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-14"></a><span class="hs-comment">-- Module      :  GHC.IO.Handle.Internals</span><span>
</span><a name="line-15"></a><span class="hs-comment">-- Copyright   :  (c) The University of Glasgow, 1994-2001</span><span>
</span><a name="line-16"></a><span class="hs-comment">-- License     :  see libraries/base/LICENSE</span><span>
</span><a name="line-17"></a><span class="hs-comment">--</span><span>
</span><a name="line-18"></a><span class="hs-comment">-- Maintainer  :  libraries@haskell.org</span><span>
</span><a name="line-19"></a><span class="hs-comment">-- Stability   :  internal</span><span>
</span><a name="line-20"></a><span class="hs-comment">-- Portability :  non-portable</span><span>
</span><a name="line-21"></a><span class="hs-comment">--</span><span>
</span><a name="line-22"></a><span class="hs-comment">-- This module defines the basic operations on I\/O \&quot;handles\&quot;.  All</span><span>
</span><a name="line-23"></a><span class="hs-comment">-- of the operations defined here are independent of the underlying</span><span>
</span><a name="line-24"></a><span class="hs-comment">-- device.</span><span>
</span><a name="line-25"></a><span class="hs-comment">--</span><span>
</span><a name="line-26"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-27"></a><span>
</span><a name="line-28"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">GHC.IO.Handle.Internals</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-29"></a><span>  </span><a href="GHC.IO.Handle.Internals.html#withHandle"><span class="hs-identifier hs-var">withHandle</span></a><span class="hs-special">,</span><span> </span><a href="GHC.IO.Handle.Internals.html#withHandle%27"><span class="hs-identifier hs-var">withHandle'</span></a><span class="hs-special">,</span><span> </span><a href="GHC.IO.Handle.Internals.html#withHandle_"><span class="hs-identifier hs-var">withHandle_</span></a><span class="hs-special">,</span><span>
</span><a name="line-30"></a><span>  </span><a href="GHC.IO.Handle.Internals.html#withHandle__%27"><span class="hs-identifier hs-var">withHandle__'</span></a><span class="hs-special">,</span><span> </span><a href="GHC.IO.Handle.Internals.html#withHandle_%27"><span class="hs-identifier hs-var">withHandle_'</span></a><span class="hs-special">,</span><span> </span><a href="GHC.IO.Handle.Internals.html#withAllHandles__"><span class="hs-identifier hs-var">withAllHandles__</span></a><span class="hs-special">,</span><span>
</span><a name="line-31"></a><span>  </span><a href="GHC.IO.Handle.Internals.html#wantWritableHandle"><span class="hs-identifier hs-var">wantWritableHandle</span></a><span class="hs-special">,</span><span> </span><a href="GHC.IO.Handle.Internals.html#wantReadableHandle"><span class="hs-identifier hs-var">wantReadableHandle</span></a><span class="hs-special">,</span><span> </span><a href="GHC.IO.Handle.Internals.html#wantReadableHandle_"><span class="hs-identifier hs-var">wantReadableHandle_</span></a><span class="hs-special">,</span><span>
</span><a name="line-32"></a><span>  </span><a href="GHC.IO.Handle.Internals.html#wantSeekableHandle"><span class="hs-identifier hs-var">wantSeekableHandle</span></a><span class="hs-special">,</span><span>
</span><a name="line-33"></a><span>
</span><a name="line-34"></a><span>  </span><a href="GHC.IO.Handle.Internals.html#mkHandle"><span class="hs-identifier hs-var">mkHandle</span></a><span class="hs-special">,</span><span> </span><a href="GHC.IO.Handle.Internals.html#mkFileHandle"><span class="hs-identifier hs-var">mkFileHandle</span></a><span class="hs-special">,</span><span> </span><a href="GHC.IO.Handle.Internals.html#mkDuplexHandle"><span class="hs-identifier hs-var">mkDuplexHandle</span></a><span class="hs-special">,</span><span>
</span><a name="line-35"></a><span>  </span><a href="GHC.IO.Handle.Internals.html#openTextEncoding"><span class="hs-identifier hs-var">openTextEncoding</span></a><span class="hs-special">,</span><span> </span><a href="GHC.IO.Handle.Internals.html#closeTextCodecs"><span class="hs-identifier hs-var">closeTextCodecs</span></a><span class="hs-special">,</span><span> </span><a href="GHC.IO.Handle.Internals.html#initBufferState"><span class="hs-identifier hs-var">initBufferState</span></a><span class="hs-special">,</span><span>
</span><a name="line-36"></a><span>  </span><a href="GHC.IO.Handle.Internals.html#dEFAULT_CHAR_BUFFER_SIZE"><span class="hs-identifier hs-var">dEFAULT_CHAR_BUFFER_SIZE</span></a><span class="hs-special">,</span><span>
</span><a name="line-37"></a><span>
</span><a name="line-38"></a><span>  </span><a href="GHC.IO.Handle.Internals.html#flushBuffer"><span class="hs-identifier hs-var">flushBuffer</span></a><span class="hs-special">,</span><span> </span><a href="GHC.IO.Handle.Internals.html#flushWriteBuffer"><span class="hs-identifier hs-var">flushWriteBuffer</span></a><span class="hs-special">,</span><span> </span><a href="GHC.IO.Handle.Internals.html#flushCharReadBuffer"><span class="hs-identifier hs-var">flushCharReadBuffer</span></a><span class="hs-special">,</span><span>
</span><a name="line-39"></a><span>  </span><a href="GHC.IO.Handle.Internals.html#flushCharBuffer"><span class="hs-identifier hs-var">flushCharBuffer</span></a><span class="hs-special">,</span><span> </span><a href="GHC.IO.Handle.Internals.html#flushByteReadBuffer"><span class="hs-identifier hs-var">flushByteReadBuffer</span></a><span class="hs-special">,</span><span> </span><a href="GHC.IO.Handle.Internals.html#flushByteWriteBuffer"><span class="hs-identifier hs-var">flushByteWriteBuffer</span></a><span class="hs-special">,</span><span>
</span><a name="line-40"></a><span>
</span><a name="line-41"></a><span>  </span><a href="GHC.IO.Handle.Internals.html#readTextDevice"><span class="hs-identifier hs-var">readTextDevice</span></a><span class="hs-special">,</span><span> </span><a href="GHC.IO.Handle.Internals.html#writeCharBuffer"><span class="hs-identifier hs-var">writeCharBuffer</span></a><span class="hs-special">,</span><span> </span><a href="GHC.IO.Handle.Internals.html#readTextDeviceNonBlocking"><span class="hs-identifier hs-var">readTextDeviceNonBlocking</span></a><span class="hs-special">,</span><span>
</span><a name="line-42"></a><span>  </span><a href="GHC.IO.Handle.Internals.html#decodeByteBuf"><span class="hs-identifier hs-var">decodeByteBuf</span></a><span class="hs-special">,</span><span>
</span><a name="line-43"></a><span>
</span><a name="line-44"></a><span>  </span><a href="GHC.IO.Handle.Internals.html#augmentIOError"><span class="hs-identifier hs-var">augmentIOError</span></a><span class="hs-special">,</span><span>
</span><a name="line-45"></a><span>  </span><a href="GHC.IO.Handle.Internals.html#ioe_closedHandle"><span class="hs-identifier hs-var">ioe_closedHandle</span></a><span class="hs-special">,</span><span> </span><a href="GHC.IO.Handle.Internals.html#ioe_semiclosedHandle"><span class="hs-identifier hs-var">ioe_semiclosedHandle</span></a><span class="hs-special">,</span><span>
</span><a name="line-46"></a><span>  </span><a href="GHC.IO.Handle.Internals.html#ioe_EOF"><span class="hs-identifier hs-var">ioe_EOF</span></a><span class="hs-special">,</span><span> </span><a href="GHC.IO.Handle.Internals.html#ioe_notReadable"><span class="hs-identifier hs-var">ioe_notReadable</span></a><span class="hs-special">,</span><span> </span><a href="GHC.IO.Handle.Internals.html#ioe_notWritable"><span class="hs-identifier hs-var">ioe_notWritable</span></a><span class="hs-special">,</span><span>
</span><a name="line-47"></a><span>  </span><a href="GHC.IO.Handle.Internals.html#ioe_finalizedHandle"><span class="hs-identifier hs-var">ioe_finalizedHandle</span></a><span class="hs-special">,</span><span> </span><a href="GHC.IO.Handle.Internals.html#ioe_bufsiz"><span class="hs-identifier hs-var">ioe_bufsiz</span></a><span class="hs-special">,</span><span>
</span><a name="line-48"></a><span>
</span><a name="line-49"></a><span>  </span><a href="GHC.IO.Handle.Internals.html#hClose_help"><span class="hs-identifier hs-var">hClose_help</span></a><span class="hs-special">,</span><span> </span><a href="GHC.IO.Handle.Internals.html#hLookAhead_"><span class="hs-identifier hs-var">hLookAhead_</span></a><span class="hs-special">,</span><span>
</span><a name="line-50"></a><span>
</span><a name="line-51"></a><span>  </span><a href="GHC.IO.Handle.Internals.html#HandleFinalizer"><span class="hs-identifier hs-type">HandleFinalizer</span></a><span class="hs-special">,</span><span> </span><a href="GHC.IO.Handle.Internals.html#handleFinalizer"><span class="hs-identifier hs-var">handleFinalizer</span></a><span class="hs-special">,</span><span>
</span><a name="line-52"></a><span>
</span><a name="line-53"></a><span>  </span><a href="GHC.IO.Handle.Internals.html#debugIO"><span class="hs-identifier hs-var">debugIO</span></a><span class="hs-special">,</span><span>
</span><a name="line-54"></a><span> </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-55"></a><span>
</span><a name="line-56"></a><span class="hs-keyword">import</span><span> </span><a href="GHC.IO.html"><span class="hs-identifier">GHC.IO</span></a><span>
</span><a name="line-57"></a><span class="hs-keyword">import</span><span> </span><a href="GHC.IO.IOMode.html"><span class="hs-identifier">GHC.IO.IOMode</span></a><span>
</span><a name="line-58"></a><span class="hs-keyword">import</span><span> </span><a href="GHC.IO.Encoding.html"><span class="hs-identifier">GHC.IO.Encoding</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Encoding</span><span>
</span><a name="line-59"></a><span class="hs-keyword">import</span><span> </span><a href="GHC.IO.Encoding.Types.html"><span class="hs-identifier">GHC.IO.Encoding.Types</span></a><span> </span><span class="hs-special">(</span><a href="GHC.IO.Encoding.Types.html#CodeBuffer"><span class="hs-identifier hs-type">CodeBuffer</span></a><span class="hs-special">)</span><span>
</span><a name="line-60"></a><span class="hs-keyword">import</span><span> </span><a href="GHC.IO.Handle.Types.html"><span class="hs-identifier">GHC.IO.Handle.Types</span></a><span>
</span><a name="line-61"></a><span class="hs-keyword">import</span><span> </span><a href="GHC.IO.Buffer.html"><span class="hs-identifier">GHC.IO.Buffer</span></a><span>
</span><a name="line-62"></a><span class="hs-keyword">import</span><span> </span><a href="GHC.IO.BufferedIO.html"><span class="hs-identifier">GHC.IO.BufferedIO</span></a><span> </span><span class="hs-special">(</span><a href="GHC.IO.BufferedIO.html#BufferedIO"><span class="hs-identifier hs-type">BufferedIO</span></a><span class="hs-special">)</span><span>
</span><a name="line-63"></a><span class="hs-keyword">import</span><span> </span><a href="GHC.IO.Exception.html"><span class="hs-identifier">GHC.IO.Exception</span></a><span>
</span><a name="line-64"></a><span class="hs-keyword">import</span><span> </span><a href="GHC.IO.Device.html"><span class="hs-identifier">GHC.IO.Device</span></a><span> </span><span class="hs-special">(</span><a href="GHC.IO.Device.html#IODevice"><span class="hs-identifier hs-type">IODevice</span></a><span class="hs-special">,</span><span> </span><a href="GHC.IO.Device.html#SeekMode"><span class="hs-identifier hs-type">SeekMode</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-65"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="GHC.IO.Device.html"><span class="hs-identifier">GHC.IO.Device</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">IODevice</span><span>
</span><a name="line-66"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="GHC.IO.BufferedIO.html"><span class="hs-identifier">GHC.IO.BufferedIO</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Buffered</span><span>
</span><a name="line-67"></a><span>
</span><a name="line-68"></a><span class="hs-keyword">import</span><span> </span><a href="GHC.Conc.Sync.html"><span class="hs-identifier">GHC.Conc.Sync</span></a><span>
</span><a name="line-69"></a><span class="hs-keyword">import</span><span> </span><a href="GHC.Real.html"><span class="hs-identifier">GHC.Real</span></a><span>
</span><a name="line-70"></a><span class="hs-keyword">import</span><span> </span><a href="GHC.Base.html"><span class="hs-identifier">GHC.Base</span></a><span>
</span><a name="line-71"></a><span class="hs-keyword">import</span><span> </span><a href="GHC.Exception.html"><span class="hs-identifier">GHC.Exception</span></a><span>
</span><a name="line-72"></a><span class="hs-keyword">import</span><span> </span><a href="GHC.Num.html"><span class="hs-identifier">GHC.Num</span></a><span>          </span><span class="hs-special">(</span><span> </span><a href="GHC.Num.html#Num"><span class="hs-identifier hs-type">Num</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-73"></a><span class="hs-keyword">import</span><span> </span><a href="GHC.Show.html"><span class="hs-identifier">GHC.Show</span></a><span>
</span><a name="line-74"></a><span class="hs-keyword">import</span><span> </span><a href="GHC.IORef.html"><span class="hs-identifier">GHC.IORef</span></a><span>
</span><a name="line-75"></a><span class="hs-keyword">import</span><span> </span><a href="GHC.MVar.html"><span class="hs-identifier">GHC.MVar</span></a><span>
</span><a name="line-76"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Typeable.html"><span class="hs-identifier">Data.Typeable</span></a><span>
</span><a name="line-77"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Maybe.html"><span class="hs-identifier">Data.Maybe</span></a><span>
</span><a name="line-78"></a><span class="hs-keyword">import</span><span> </span><a href="Foreign.html"><span class="hs-identifier">Foreign</span></a><span>
</span><a name="line-79"></a><span class="hs-keyword">import</span><span> </span><a href="System.Posix.Internals.html"><span class="hs-identifier">System.Posix.Internals</span></a><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><a href="System.Posix.Internals.html#FD"><span class="hs-identifier hs-type">FD</span></a><span class="hs-special">)</span><span>
</span><a name="line-80"></a><span>
</span><a name="line-81"></a><span class="hs-keyword">import</span><span> </span><a href="Foreign.C.html"><span class="hs-identifier">Foreign.C</span></a><span>
</span><a name="line-82"></a><span>
</span><a name="line-83"></a><span class="hs-identifier">c_DEBUG_DUMP</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a><span>
</span><a name="line-84"></a><a name="c_DEBUG_DUMP"><a href="GHC.IO.Handle.Internals.html#c_DEBUG_DUMP"><span class="hs-identifier">c_DEBUG_DUMP</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a><span>
</span><a name="line-85"></a><span>
</span><a name="line-86"></a><span class="hs-comment">-- ---------------------------------------------------------------------------</span><span>
</span><a name="line-87"></a><span class="hs-comment">-- Creating a new handle</span><span>
</span><a name="line-88"></a><span>
</span><a name="line-89"></a><span class="hs-keyword">type</span><span> </span><a name="HandleFinalizer"><a href="GHC.IO.Handle.Internals.html#HandleFinalizer"><span class="hs-identifier">HandleFinalizer</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.html#FilePath"><span class="hs-identifier hs-type">FilePath</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.MVar.html#MVar"><span class="hs-identifier hs-type">MVar</span></a><span> </span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-type">Handle__</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-90"></a><span>
</span><a name="line-91"></a><span class="hs-identifier">newFileHandle</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.IO.html#FilePath"><span class="hs-identifier hs-type">FilePath</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="GHC.IO.Handle.Internals.html#HandleFinalizer"><span class="hs-identifier hs-type">HandleFinalizer</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-type">Handle__</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="GHC.IO.Handle.Types.html#Handle"><span class="hs-identifier hs-type">Handle</span></a><span>
</span><a name="line-92"></a><a name="newFileHandle"><a href="GHC.IO.Handle.Internals.html#newFileHandle"><span class="hs-identifier">newFileHandle</span></a></a><span> </span><a name="local-6989586621679289192"><a href="#local-6989586621679289192"><span class="hs-identifier">filepath</span></a></a><span> </span><a name="local-6989586621679289193"><a href="#local-6989586621679289193"><span class="hs-identifier">mb_finalizer</span></a></a><span> </span><a name="local-6989586621679289194"><a href="#local-6989586621679289194"><span class="hs-identifier">hc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-93"></a><span>  </span><a name="local-6989586621679289195"><a href="#local-6989586621679289195"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.MVar.html#newMVar"><span class="hs-identifier hs-var">newMVar</span></a><span> </span><a href="#local-6989586621679289194"><span class="hs-identifier hs-var">hc</span></a><span>
</span><a name="line-94"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679289193"><span class="hs-identifier hs-var">mb_finalizer</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-95"></a><span>    </span><a href="GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621679289196"><a href="#local-6989586621679289196"><span class="hs-identifier">finalizer</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.MVar.html#addMVarFinalizer"><span class="hs-identifier hs-var">addMVarFinalizer</span></a><span> </span><a href="#local-6989586621679289195"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679289196"><span class="hs-identifier hs-var">finalizer</span></a><span> </span><a href="#local-6989586621679289192"><span class="hs-identifier hs-var">filepath</span></a><span> </span><a href="#local-6989586621679289195"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-96"></a><span>    </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-97"></a><span>  </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="GHC.IO.Handle.Types.html#FileHandle"><span class="hs-identifier hs-var">FileHandle</span></a><span> </span><a href="#local-6989586621679289192"><span class="hs-identifier hs-var">filepath</span></a><span> </span><a href="#local-6989586621679289195"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-98"></a><span>
</span><a name="line-99"></a><span class="hs-comment">-- ---------------------------------------------------------------------------</span><span>
</span><a name="line-100"></a><span class="hs-comment">-- Working with Handles</span><span>
</span><a name="line-101"></a><span>
</span><a name="line-102"></a><span class="hs-comment">{-
In the concurrent world, handles are locked during use.  This is done
by wrapping an MVar around the handle which acts as a mutex over
operations on the handle.

To avoid races, we use the following bracketing operations.  The idea
is to obtain the lock, do some operation and replace the lock again,
whether the operation succeeded or failed.  We also want to handle the
case where the thread receives an exception while processing the IO
operation: in these cases we also want to relinquish the lock.

There are three versions of @withHandle@: corresponding to the three
possible combinations of:

        - the operation may side-effect the handle
        - the operation may return a result

If the operation generates an error or an exception is raised, the
original handle is always replaced.
-}</span><span>
</span><a name="line-122"></a><span>
</span><a name="line-123"></a><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">withHandle</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-124"></a><span class="hs-identifier">withHandle</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.Handle.Types.html#Handle"><span class="hs-identifier hs-type">Handle</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-type">Handle__</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-type">Handle__</span></a><span class="hs-special">,</span><a href="#local-6989586621679289191"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="#local-6989586621679289191"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-125"></a><a name="withHandle"><a href="GHC.IO.Handle.Internals.html#withHandle"><span class="hs-identifier">withHandle</span></a></a><span> </span><a name="local-6989586621679289197"><a href="#local-6989586621679289197"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-6989586621679289198"><a href="#local-6989586621679289198"><span class="hs-identifier">h</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="GHC.IO.Handle.Types.html#FileHandle"><span class="hs-identifier hs-var">FileHandle</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679289199"><a href="#local-6989586621679289199"><span class="hs-identifier">m</span></a></a><span class="hs-special">)</span><span>     </span><a name="local-6989586621679289200"><a href="#local-6989586621679289200"><span class="hs-identifier">act</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.Handle.Internals.html#withHandle%27"><span class="hs-identifier hs-var">withHandle'</span></a><span> </span><a href="#local-6989586621679289197"><span class="hs-identifier hs-var">fun</span></a><span> </span><a href="#local-6989586621679289198"><span class="hs-identifier hs-var">h</span></a><span> </span><a href="#local-6989586621679289199"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="#local-6989586621679289200"><span class="hs-identifier hs-var">act</span></a><span>
</span><a name="line-126"></a><span class="hs-identifier">withHandle</span><span> </span><a name="local-6989586621679289201"><a href="#local-6989586621679289201"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-6989586621679289202"><a href="#local-6989586621679289202"><span class="hs-identifier">h</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="GHC.IO.Handle.Types.html#DuplexHandle"><span class="hs-identifier hs-var">DuplexHandle</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679289203"><a href="#local-6989586621679289203"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621679289204"><a href="#local-6989586621679289204"><span class="hs-identifier">act</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.Handle.Internals.html#withHandle%27"><span class="hs-identifier hs-var">withHandle'</span></a><span> </span><a href="#local-6989586621679289201"><span class="hs-identifier hs-var">fun</span></a><span> </span><a href="#local-6989586621679289202"><span class="hs-identifier hs-var">h</span></a><span> </span><a href="#local-6989586621679289203"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="#local-6989586621679289204"><span class="hs-identifier hs-var">act</span></a><span>
</span><a name="line-127"></a><span>
</span><a name="line-128"></a><span class="hs-identifier">withHandle'</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.Handle.Types.html#Handle"><span class="hs-identifier hs-type">Handle</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.MVar.html#MVar"><span class="hs-identifier hs-type">MVar</span></a><span> </span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-type">Handle__</span></a><span>
</span><a name="line-129"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-type">Handle__</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-type">Handle__</span></a><span class="hs-special">,</span><a href="#local-6989586621679289190"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="#local-6989586621679289190"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-130"></a><a name="withHandle%27"><a href="GHC.IO.Handle.Internals.html#withHandle%27"><span class="hs-identifier">withHandle'</span></a></a><span> </span><a name="local-6989586621679289205"><a href="#local-6989586621679289205"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-6989586621679289206"><a href="#local-6989586621679289206"><span class="hs-identifier">h</span></a></a><span> </span><a name="local-6989586621679289207"><a href="#local-6989586621679289207"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679289208"><a href="#local-6989586621679289208"><span class="hs-identifier">act</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-131"></a><span> </span><a href="GHC.IO.html#mask_"><span class="hs-identifier hs-var">mask_</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-132"></a><span>   </span><span class="hs-special">(</span><a name="local-6989586621679289209"><a href="#local-6989586621679289209"><span class="hs-identifier">h'</span></a></a><span class="hs-special">,</span><a name="local-6989586621679289210"><a href="#local-6989586621679289210"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IO.Handle.Internals.html#do_operation"><span class="hs-identifier hs-var">do_operation</span></a><span> </span><a href="#local-6989586621679289205"><span class="hs-identifier hs-var">fun</span></a><span> </span><a href="#local-6989586621679289206"><span class="hs-identifier hs-var">h</span></a><span> </span><a href="#local-6989586621679289208"><span class="hs-identifier hs-var">act</span></a><span> </span><a href="#local-6989586621679289207"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-133"></a><span>   </span><a href="GHC.IO.Handle.Types.html#checkHandleInvariants"><span class="hs-identifier hs-var">checkHandleInvariants</span></a><span> </span><a href="#local-6989586621679289209"><span class="hs-identifier hs-var">h'</span></a><span>
</span><a name="line-134"></a><span>   </span><a href="GHC.MVar.html#putMVar"><span class="hs-identifier hs-var">putMVar</span></a><span> </span><a href="#local-6989586621679289207"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="#local-6989586621679289209"><span class="hs-identifier hs-var">h'</span></a><span>
</span><a name="line-135"></a><span>   </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621679289210"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-136"></a><span>
</span><a name="line-137"></a><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">withHandle_</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-138"></a><span class="hs-identifier">withHandle_</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.Handle.Types.html#Handle"><span class="hs-identifier hs-type">Handle</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-type">Handle__</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="#local-6989586621679289189"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="#local-6989586621679289189"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-139"></a><a name="withHandle_"><a href="GHC.IO.Handle.Internals.html#withHandle_"><span class="hs-identifier">withHandle_</span></a></a><span> </span><a name="local-6989586621679289211"><a href="#local-6989586621679289211"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-6989586621679289212"><a href="#local-6989586621679289212"><span class="hs-identifier">h</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="GHC.IO.Handle.Types.html#FileHandle"><span class="hs-identifier hs-var">FileHandle</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679289213"><a href="#local-6989586621679289213"><span class="hs-identifier">m</span></a></a><span class="hs-special">)</span><span>     </span><a name="local-6989586621679289214"><a href="#local-6989586621679289214"><span class="hs-identifier">act</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.Handle.Internals.html#withHandle_%27"><span class="hs-identifier hs-var">withHandle_'</span></a><span> </span><a href="#local-6989586621679289211"><span class="hs-identifier hs-var">fun</span></a><span> </span><a href="#local-6989586621679289212"><span class="hs-identifier hs-var">h</span></a><span> </span><a href="#local-6989586621679289213"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="#local-6989586621679289214"><span class="hs-identifier hs-var">act</span></a><span>
</span><a name="line-140"></a><span class="hs-identifier">withHandle_</span><span> </span><a name="local-6989586621679289215"><a href="#local-6989586621679289215"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-6989586621679289216"><a href="#local-6989586621679289216"><span class="hs-identifier">h</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="GHC.IO.Handle.Types.html#DuplexHandle"><span class="hs-identifier hs-var">DuplexHandle</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679289217"><a href="#local-6989586621679289217"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621679289218"><a href="#local-6989586621679289218"><span class="hs-identifier">act</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.Handle.Internals.html#withHandle_%27"><span class="hs-identifier hs-var">withHandle_'</span></a><span> </span><a href="#local-6989586621679289215"><span class="hs-identifier hs-var">fun</span></a><span> </span><a href="#local-6989586621679289216"><span class="hs-identifier hs-var">h</span></a><span> </span><a href="#local-6989586621679289217"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="#local-6989586621679289218"><span class="hs-identifier hs-var">act</span></a><span>
</span><a name="line-141"></a><span>
</span><a name="line-142"></a><span class="hs-identifier">withHandle_'</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.Handle.Types.html#Handle"><span class="hs-identifier hs-type">Handle</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.MVar.html#MVar"><span class="hs-identifier hs-type">MVar</span></a><span> </span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-type">Handle__</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-type">Handle__</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="#local-6989586621679289188"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="#local-6989586621679289188"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-143"></a><a name="withHandle_%27"><a href="GHC.IO.Handle.Internals.html#withHandle_%27"><span class="hs-identifier">withHandle_'</span></a></a><span> </span><a name="local-6989586621679289219"><a href="#local-6989586621679289219"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-6989586621679289220"><a href="#local-6989586621679289220"><span class="hs-identifier">h</span></a></a><span> </span><a name="local-6989586621679289221"><a href="#local-6989586621679289221"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679289222"><a href="#local-6989586621679289222"><span class="hs-identifier">act</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.Handle.Internals.html#withHandle%27"><span class="hs-identifier hs-var">withHandle'</span></a><span> </span><a href="#local-6989586621679289219"><span class="hs-identifier hs-var">fun</span></a><span> </span><a href="#local-6989586621679289220"><span class="hs-identifier hs-var">h</span></a><span> </span><a href="#local-6989586621679289221"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679289223"><a href="#local-6989586621679289223"><span class="hs-identifier">h_</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-144"></a><span>                              </span><a name="local-6989586621679289224"><a href="#local-6989586621679289224"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679289222"><span class="hs-identifier hs-var">act</span></a><span> </span><a href="#local-6989586621679289223"><span class="hs-identifier hs-var">h_</span></a><span>
</span><a name="line-145"></a><span>                              </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679289223"><span class="hs-identifier hs-var">h_</span></a><span class="hs-special">,</span><a href="#local-6989586621679289224"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-146"></a><span>
</span><a name="line-147"></a><span class="hs-identifier">withAllHandles__</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.Handle.Types.html#Handle"><span class="hs-identifier hs-type">Handle</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-type">Handle__</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-type">Handle__</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-148"></a><a name="withAllHandles__"><a href="GHC.IO.Handle.Internals.html#withAllHandles__"><span class="hs-identifier">withAllHandles__</span></a></a><span> </span><a name="local-6989586621679289225"><a href="#local-6989586621679289225"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-6989586621679289226"><a href="#local-6989586621679289226"><span class="hs-identifier">h</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="GHC.IO.Handle.Types.html#FileHandle"><span class="hs-identifier hs-var">FileHandle</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679289227"><a href="#local-6989586621679289227"><span class="hs-identifier">m</span></a></a><span class="hs-special">)</span><span>     </span><a name="local-6989586621679289228"><a href="#local-6989586621679289228"><span class="hs-identifier">act</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.Handle.Internals.html#withHandle__%27"><span class="hs-identifier hs-var">withHandle__'</span></a><span> </span><a href="#local-6989586621679289225"><span class="hs-identifier hs-var">fun</span></a><span> </span><a href="#local-6989586621679289226"><span class="hs-identifier hs-var">h</span></a><span> </span><a href="#local-6989586621679289227"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="#local-6989586621679289228"><span class="hs-identifier hs-var">act</span></a><span>
</span><a name="line-149"></a><span class="hs-identifier">withAllHandles__</span><span> </span><a name="local-6989586621679289229"><a href="#local-6989586621679289229"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-6989586621679289230"><a href="#local-6989586621679289230"><span class="hs-identifier">h</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="GHC.IO.Handle.Types.html#DuplexHandle"><span class="hs-identifier hs-var">DuplexHandle</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679289231"><a href="#local-6989586621679289231"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-6989586621679289232"><a href="#local-6989586621679289232"><span class="hs-identifier">w</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679289233"><a href="#local-6989586621679289233"><span class="hs-identifier">act</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-150"></a><span>  </span><a href="GHC.IO.Handle.Internals.html#withHandle__%27"><span class="hs-identifier hs-var">withHandle__'</span></a><span> </span><a href="#local-6989586621679289229"><span class="hs-identifier hs-var">fun</span></a><span> </span><a href="#local-6989586621679289230"><span class="hs-identifier hs-var">h</span></a><span> </span><a href="#local-6989586621679289231"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621679289233"><span class="hs-identifier hs-var">act</span></a><span>
</span><a name="line-151"></a><span>  </span><a href="GHC.IO.Handle.Internals.html#withHandle__%27"><span class="hs-identifier hs-var">withHandle__'</span></a><span> </span><a href="#local-6989586621679289229"><span class="hs-identifier hs-var">fun</span></a><span> </span><a href="#local-6989586621679289230"><span class="hs-identifier hs-var">h</span></a><span> </span><a href="#local-6989586621679289232"><span class="hs-identifier hs-var">w</span></a><span> </span><a href="#local-6989586621679289233"><span class="hs-identifier hs-var">act</span></a><span>
</span><a name="line-152"></a><span>
</span><a name="line-153"></a><span class="hs-identifier">withHandle__'</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.Handle.Types.html#Handle"><span class="hs-identifier hs-type">Handle</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.MVar.html#MVar"><span class="hs-identifier hs-type">MVar</span></a><span> </span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-type">Handle__</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-type">Handle__</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-type">Handle__</span></a><span class="hs-special">)</span><span>
</span><a name="line-154"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-155"></a><a name="withHandle__%27"><a href="GHC.IO.Handle.Internals.html#withHandle__%27"><span class="hs-identifier">withHandle__'</span></a></a><span> </span><a name="local-6989586621679289234"><a href="#local-6989586621679289234"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-6989586621679289235"><a href="#local-6989586621679289235"><span class="hs-identifier">h</span></a></a><span> </span><a name="local-6989586621679289236"><a href="#local-6989586621679289236"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679289237"><a href="#local-6989586621679289237"><span class="hs-identifier">act</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-156"></a><span> </span><a href="GHC.IO.html#mask_"><span class="hs-identifier hs-var">mask_</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-157"></a><span>   </span><a name="local-6989586621679289238"><a href="#local-6989586621679289238"><span class="hs-identifier">h'</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IO.Handle.Internals.html#do_operation"><span class="hs-identifier hs-var">do_operation</span></a><span> </span><a href="#local-6989586621679289234"><span class="hs-identifier hs-var">fun</span></a><span> </span><a href="#local-6989586621679289235"><span class="hs-identifier hs-var">h</span></a><span> </span><a href="#local-6989586621679289237"><span class="hs-identifier hs-var">act</span></a><span> </span><a href="#local-6989586621679289236"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-158"></a><span>   </span><a href="GHC.IO.Handle.Types.html#checkHandleInvariants"><span class="hs-identifier hs-var">checkHandleInvariants</span></a><span> </span><a href="#local-6989586621679289238"><span class="hs-identifier hs-var">h'</span></a><span>
</span><a name="line-159"></a><span>   </span><a href="GHC.MVar.html#putMVar"><span class="hs-identifier hs-var">putMVar</span></a><span> </span><a href="#local-6989586621679289236"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="#local-6989586621679289238"><span class="hs-identifier hs-var">h'</span></a><span>
</span><a name="line-160"></a><span>   </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-161"></a><span>
</span><a name="line-162"></a><span class="hs-identifier">do_operation</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.Handle.Types.html#Handle"><span class="hs-identifier hs-type">Handle</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-type">Handle__</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="#local-6989586621679289187"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.MVar.html#MVar"><span class="hs-identifier hs-type">MVar</span></a><span> </span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-type">Handle__</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="#local-6989586621679289187"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-163"></a><a name="do_operation"><a href="GHC.IO.Handle.Internals.html#do_operation"><span class="hs-identifier">do_operation</span></a></a><span> </span><a name="local-6989586621679289239"><a href="#local-6989586621679289239"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-6989586621679289240"><a href="#local-6989586621679289240"><span class="hs-identifier">h</span></a></a><span> </span><a name="local-6989586621679289241"><a href="#local-6989586621679289241"><span class="hs-identifier">act</span></a></a><span> </span><a name="local-6989586621679289242"><a href="#local-6989586621679289242"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-164"></a><span>  </span><a name="local-6989586621679289250"><a href="#local-6989586621679289250"><span class="hs-identifier">h_</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.MVar.html#takeMVar"><span class="hs-identifier hs-var">takeMVar</span></a><span> </span><a href="#local-6989586621679289242"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-165"></a><span>  </span><a href="GHC.IO.Handle.Types.html#checkHandleInvariants"><span class="hs-identifier hs-var">checkHandleInvariants</span></a><span> </span><a href="#local-6989586621679289250"><span class="hs-identifier hs-var">h_</span></a><span>
</span><a name="line-166"></a><span>  </span><a href="#local-6989586621679289241"><span class="hs-identifier hs-var">act</span></a><span> </span><a href="#local-6989586621679289250"><span class="hs-identifier hs-var">h_</span></a><span> </span><span class="hs-special">`</span><a href="GHC.IO.html#catchException"><span class="hs-identifier hs-var">catchException</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679289243"><span class="hs-identifier hs-var">handler</span></a><span> </span><a href="#local-6989586621679289250"><span class="hs-identifier hs-var">h_</span></a><span>
</span><a name="line-167"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-168"></a><span>    </span><a name="local-6989586621679289243"><a href="#local-6989586621679289243"><span class="hs-identifier">handler</span></a></a><span> </span><a name="local-6989586621679289244"><a href="#local-6989586621679289244"><span class="hs-identifier">h_</span></a></a><span> </span><a name="local-6989586621679289245"><a href="#local-6989586621679289245"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-169"></a><span>      </span><a href="GHC.MVar.html#putMVar"><span class="hs-identifier hs-var">putMVar</span></a><span> </span><a href="#local-6989586621679289242"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="#local-6989586621679289244"><span class="hs-identifier hs-var">h_</span></a><span>
</span><a name="line-170"></a><span>      </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-171"></a><span>        </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621679289246"><a href="#local-6989586621679289246"><span class="hs-identifier">ioe</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.Exception.html#fromException"><span class="hs-identifier hs-var">fromException</span></a><span> </span><a href="#local-6989586621679289245"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-172"></a><span>            </span><a href="GHC.IO.Exception.html#ioError"><span class="hs-identifier hs-var">ioError</span></a><span> </span><span class="hs-special">(</span><a href="GHC.IO.Handle.Internals.html#augmentIOError"><span class="hs-identifier hs-var">augmentIOError</span></a><span> </span><a href="#local-6989586621679289246"><span class="hs-identifier hs-var">ioe</span></a><span> </span><a href="#local-6989586621679289239"><span class="hs-identifier hs-var">fun</span></a><span> </span><a href="#local-6989586621679289240"><span class="hs-identifier hs-var">h</span></a><span class="hs-special">)</span><span>
</span><a name="line-173"></a><span>        </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621679289247"><a href="#local-6989586621679289247"><span class="hs-identifier">async_ex</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.Exception.html#fromException"><span class="hs-identifier hs-var">fromException</span></a><span> </span><a href="#local-6989586621679289245"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-comment">-- see Note [async]</span><span>
</span><a name="line-174"></a><span>            </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679289247"><span class="hs-identifier hs-var">async_ex</span></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.IO.Exception.html#SomeAsyncException"><span class="hs-identifier hs-type">SomeAsyncException</span></a><span>
</span><a name="line-175"></a><span>            </span><a name="local-6989586621679289248"><a href="#local-6989586621679289248"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.Conc.Sync.html#myThreadId"><span class="hs-identifier hs-var">myThreadId</span></a><span>
</span><a name="line-176"></a><span>            </span><a href="GHC.Conc.Sync.html#throwTo"><span class="hs-identifier hs-var">throwTo</span></a><span> </span><a href="#local-6989586621679289248"><span class="hs-identifier hs-var">t</span></a><span> </span><a href="#local-6989586621679289245"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-177"></a><span>            </span><a href="GHC.IO.Handle.Internals.html#do_operation"><span class="hs-identifier hs-var">do_operation</span></a><span> </span><a href="#local-6989586621679289239"><span class="hs-identifier hs-var">fun</span></a><span> </span><a href="#local-6989586621679289240"><span class="hs-identifier hs-var">h</span></a><span> </span><a href="#local-6989586621679289241"><span class="hs-identifier hs-var">act</span></a><span> </span><a href="#local-6989586621679289242"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-178"></a><span>        </span><a name="local-6989586621679289249"><a href="#local-6989586621679289249"><span class="hs-identifier">_otherwise</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-179"></a><span>            </span><a href="GHC.IO.html#throwIO"><span class="hs-identifier hs-var">throwIO</span></a><span> </span><a href="#local-6989586621679289245"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-180"></a><span>
</span><a name="line-181"></a><span class="hs-comment">-- Note [async]</span><span>
</span><a name="line-182"></a><span class="hs-comment">--</span><span>
</span><a name="line-183"></a><span class="hs-comment">-- If an asynchronous exception is raised during an I/O operation,</span><span>
</span><a name="line-184"></a><span class="hs-comment">-- normally it is fine to just re-throw the exception synchronously.</span><span>
</span><a name="line-185"></a><span class="hs-comment">-- However, if we are inside an unsafePerformIO or an</span><span>
</span><a name="line-186"></a><span class="hs-comment">-- unsafeInterleaveIO, this would replace the enclosing thunk with the</span><span>
</span><a name="line-187"></a><span class="hs-comment">-- exception raised, which is wrong (#3997).  We have to release the</span><span>
</span><a name="line-188"></a><span class="hs-comment">-- lock on the Handle, but what do we replace the thunk with?  What</span><span>
</span><a name="line-189"></a><span class="hs-comment">-- should happen when the thunk is subsequently demanded again?</span><span>
</span><a name="line-190"></a><span class="hs-comment">--</span><span>
</span><a name="line-191"></a><span class="hs-comment">-- The only sensible choice we have is to re-do the IO operation on</span><span>
</span><a name="line-192"></a><span class="hs-comment">-- resumption, but then we have to be careful in the IO library that</span><span>
</span><a name="line-193"></a><span class="hs-comment">-- this is always safe to do.  In particular we should</span><span>
</span><a name="line-194"></a><span class="hs-comment">--</span><span>
</span><a name="line-195"></a><span class="hs-comment">--    never perform any side-effects before an interruptible operation</span><span>
</span><a name="line-196"></a><span class="hs-comment">--</span><span>
</span><a name="line-197"></a><span class="hs-comment">-- because the interruptible operation may raise an asynchronous</span><span>
</span><a name="line-198"></a><span class="hs-comment">-- exception, which may cause the operation and its side effects to be</span><span>
</span><a name="line-199"></a><span class="hs-comment">-- subsequently performed again.</span><span>
</span><a name="line-200"></a><span class="hs-comment">--</span><span>
</span><a name="line-201"></a><span class="hs-comment">-- Re-doing the IO operation is achieved by:</span><span>
</span><a name="line-202"></a><span class="hs-comment">--   - using throwTo to re-throw the asynchronous exception asynchronously</span><span>
</span><a name="line-203"></a><span class="hs-comment">--     in the current thread</span><span>
</span><a name="line-204"></a><span class="hs-comment">--   - on resumption, it will be as if throwTo returns.  In that case, we</span><span>
</span><a name="line-205"></a><span class="hs-comment">--     recursively invoke the original operation (see do_operation above).</span><span>
</span><a name="line-206"></a><span class="hs-comment">--</span><span>
</span><a name="line-207"></a><span class="hs-comment">-- Interruptible operations in the I/O library are:</span><span>
</span><a name="line-208"></a><span class="hs-comment">--    - threadWaitRead/threadWaitWrite</span><span>
</span><a name="line-209"></a><span class="hs-comment">--    - fillReadBuffer/flushWriteBuffer</span><span>
</span><a name="line-210"></a><span class="hs-comment">--    - readTextDevice/writeTextDevice</span><span>
</span><a name="line-211"></a><span>
</span><a name="line-212"></a><span class="hs-identifier">augmentIOError</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.IO.Exception.html#IOException"><span class="hs-identifier hs-type">IOException</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.Handle.Types.html#Handle"><span class="hs-identifier hs-type">Handle</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.Exception.html#IOException"><span class="hs-identifier hs-type">IOException</span></a><span>
</span><a name="line-213"></a><a name="augmentIOError"><a href="GHC.IO.Handle.Internals.html#augmentIOError"><span class="hs-identifier">augmentIOError</span></a></a><span> </span><a name="local-6989586621679289251"><a href="#local-6989586621679289251"><span class="hs-identifier">ioe</span></a></a><span class="hs-glyph">@</span><a href="GHC.IO.Exception.html#IOError"><span class="hs-identifier hs-var">IOError</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">ioe_filename</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679289252"><a href="#local-6989586621679289252"><span class="hs-identifier">fp</span></a></a><span> </span><span class="hs-special">}</span><span> </span><a name="local-6989586621679289253"><a href="#local-6989586621679289253"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-6989586621679289254"><a href="#local-6989586621679289254"><span class="hs-identifier">h</span></a></a><span>
</span><a name="line-214"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679289251"><span class="hs-identifier hs-var">ioe</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ioe_handle</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="#local-6989586621679289254"><span class="hs-identifier hs-var">h</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ioe_location</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679289253"><span class="hs-identifier hs-var">fun</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ioe_filename</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679289255"><span class="hs-identifier hs-var">filepath</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-215"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621679289255"><a href="#local-6989586621679289255"><span class="hs-identifier">filepath</span></a></a><span>
</span><a name="line-216"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a href="GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679289252"><span class="hs-identifier hs-var">fp</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679289252"><span class="hs-identifier hs-var">fp</span></a><span>
</span><a name="line-217"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a href="GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679289254"><span class="hs-identifier hs-var">h</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-218"></a><span>                          </span><a href="GHC.IO.Handle.Types.html#FileHandle"><span class="hs-identifier hs-var">FileHandle</span></a><span> </span><a name="local-6989586621679289256"><a href="#local-6989586621679289256"><span class="hs-identifier">path</span></a></a><span> </span><span class="hs-identifier">_</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="#local-6989586621679289256"><span class="hs-identifier hs-var">path</span></a><span>
</span><a name="line-219"></a><span>                          </span><a href="GHC.IO.Handle.Types.html#DuplexHandle"><span class="hs-identifier hs-var">DuplexHandle</span></a><span> </span><a name="local-6989586621679289257"><a href="#local-6989586621679289257"><span class="hs-identifier">path</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="#local-6989586621679289257"><span class="hs-identifier hs-var">path</span></a><span>
</span><a name="line-220"></a><span>
</span><a name="line-221"></a><span class="hs-comment">-- ---------------------------------------------------------------------------</span><span>
</span><a name="line-222"></a><span class="hs-comment">-- Wrapper for write operations.</span><span>
</span><a name="line-223"></a><span>
</span><a name="line-224"></a><span class="hs-identifier">wantWritableHandle</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.Handle.Types.html#Handle"><span class="hs-identifier hs-type">Handle</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-type">Handle__</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="#local-6989586621679289186"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="#local-6989586621679289186"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-225"></a><a name="wantWritableHandle"><a href="GHC.IO.Handle.Internals.html#wantWritableHandle"><span class="hs-identifier">wantWritableHandle</span></a></a><span> </span><a name="local-6989586621679289258"><a href="#local-6989586621679289258"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-6989586621679289259"><a href="#local-6989586621679289259"><span class="hs-identifier">h</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="GHC.IO.Handle.Types.html#FileHandle"><span class="hs-identifier hs-var">FileHandle</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679289260"><a href="#local-6989586621679289260"><span class="hs-identifier">m</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679289261"><a href="#local-6989586621679289261"><span class="hs-identifier">act</span></a></a><span>
</span><a name="line-226"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.Handle.Internals.html#wantWritableHandle%27"><span class="hs-identifier hs-var">wantWritableHandle'</span></a><span> </span><a href="#local-6989586621679289258"><span class="hs-identifier hs-var">fun</span></a><span> </span><a href="#local-6989586621679289259"><span class="hs-identifier hs-var">h</span></a><span> </span><a href="#local-6989586621679289260"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="#local-6989586621679289261"><span class="hs-identifier hs-var">act</span></a><span>
</span><a name="line-227"></a><span class="hs-identifier">wantWritableHandle</span><span> </span><a name="local-6989586621679289262"><a href="#local-6989586621679289262"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-6989586621679289263"><a href="#local-6989586621679289263"><span class="hs-identifier">h</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="GHC.IO.Handle.Types.html#DuplexHandle"><span class="hs-identifier hs-var">DuplexHandle</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679289264"><a href="#local-6989586621679289264"><span class="hs-identifier">m</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679289265"><a href="#local-6989586621679289265"><span class="hs-identifier">act</span></a></a><span>
</span><a name="line-228"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.Handle.Internals.html#wantWritableHandle%27"><span class="hs-identifier hs-var">wantWritableHandle'</span></a><span> </span><a href="#local-6989586621679289262"><span class="hs-identifier hs-var">fun</span></a><span> </span><a href="#local-6989586621679289263"><span class="hs-identifier hs-var">h</span></a><span> </span><a href="#local-6989586621679289264"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="#local-6989586621679289265"><span class="hs-identifier hs-var">act</span></a><span>
</span><a name="line-229"></a><span>    </span><span class="hs-comment">-- we know it's not a ReadHandle or ReadWriteHandle, but we have to</span><span>
</span><a name="line-230"></a><span>    </span><span class="hs-comment">-- check for ClosedHandle/SemiClosedHandle. (#4808)</span><span>
</span><a name="line-231"></a><span>
</span><a name="line-232"></a><span class="hs-identifier">wantWritableHandle'</span><span>
</span><a name="line-233"></a><span>        </span><span class="hs-glyph">::</span><span> </span><a href="GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.Handle.Types.html#Handle"><span class="hs-identifier hs-type">Handle</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.MVar.html#MVar"><span class="hs-identifier hs-type">MVar</span></a><span> </span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-type">Handle__</span></a><span>
</span><a name="line-234"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-type">Handle__</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="#local-6989586621679289185"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="#local-6989586621679289185"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-235"></a><a name="wantWritableHandle%27"><a href="GHC.IO.Handle.Internals.html#wantWritableHandle%27"><span class="hs-identifier">wantWritableHandle'</span></a></a><span> </span><a name="local-6989586621679289266"><a href="#local-6989586621679289266"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-6989586621679289267"><a href="#local-6989586621679289267"><span class="hs-identifier">h</span></a></a><span> </span><a name="local-6989586621679289268"><a href="#local-6989586621679289268"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679289269"><a href="#local-6989586621679289269"><span class="hs-identifier">act</span></a></a><span>
</span><a name="line-236"></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.Handle.Internals.html#withHandle_%27"><span class="hs-identifier hs-var">withHandle_'</span></a><span> </span><a href="#local-6989586621679289266"><span class="hs-identifier hs-var">fun</span></a><span> </span><a href="#local-6989586621679289267"><span class="hs-identifier hs-var">h</span></a><span> </span><a href="#local-6989586621679289268"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-special">(</span><a href="GHC.IO.Handle.Internals.html#checkWritableHandle"><span class="hs-identifier hs-var">checkWritableHandle</span></a><span> </span><a href="#local-6989586621679289269"><span class="hs-identifier hs-var">act</span></a><span class="hs-special">)</span><span>
</span><a name="line-237"></a><span>
</span><a name="line-238"></a><span class="hs-identifier">checkWritableHandle</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-type">Handle__</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="#local-6989586621679289184"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-type">Handle__</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="#local-6989586621679289184"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-239"></a><a name="checkWritableHandle"><a href="GHC.IO.Handle.Internals.html#checkWritableHandle"><span class="hs-identifier">checkWritableHandle</span></a></a><span> </span><a name="local-6989586621679289270"><a href="#local-6989586621679289270"><span class="hs-identifier">act</span></a></a><span> </span><a name="local-6989586621679289271"><a href="#local-6989586621679289271"><span class="hs-identifier">h_</span></a></a><span class="hs-glyph">@</span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-var">Handle__</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span>
</span><a name="line-240"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679289273"><span class="hs-identifier hs-var">haType</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-241"></a><span>      </span><a href="GHC.IO.Handle.Types.html#ClosedHandle"><span class="hs-identifier hs-var">ClosedHandle</span></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.Handle.Internals.html#ioe_closedHandle"><span class="hs-identifier hs-var">ioe_closedHandle</span></a><span>
</span><a name="line-242"></a><span>      </span><a href="GHC.IO.Handle.Types.html#SemiClosedHandle"><span class="hs-identifier hs-var">SemiClosedHandle</span></a><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.Handle.Internals.html#ioe_semiclosedHandle"><span class="hs-identifier hs-var">ioe_semiclosedHandle</span></a><span>
</span><a name="line-243"></a><span>      </span><a href="GHC.IO.Handle.Types.html#ReadHandle"><span class="hs-identifier hs-var">ReadHandle</span></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.Handle.Internals.html#ioe_notWritable"><span class="hs-identifier hs-var">ioe_notWritable</span></a><span>
</span><a name="line-244"></a><span>      </span><a href="GHC.IO.Handle.Types.html#ReadWriteHandle"><span class="hs-identifier hs-var">ReadWriteHandle</span></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-245"></a><span>        </span><a name="local-6989586621679289285"><a href="#local-6989586621679289285"><span class="hs-identifier">buf</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IORef.html#readIORef"><span class="hs-identifier hs-var">readIORef</span></a><span> </span><a href="#local-6989586621679289277"><span class="hs-identifier hs-var">haCharBuffer</span></a><span>
</span><a name="line-246"></a><span>        </span><a href="GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a><span> </span><span class="hs-special">(</span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Classes.html#not"><span class="hs-identifier hs-var">not</span></a><span> </span><span class="hs-special">(</span><a href="GHC.IO.Buffer.html#isWriteBuffer"><span class="hs-identifier hs-var">isWriteBuffer</span></a><span> </span><a href="#local-6989586621679289285"><span class="hs-identifier hs-var">buf</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-247"></a><span>           </span><a href="GHC.IO.Handle.Internals.html#flushCharReadBuffer"><span class="hs-identifier hs-var">flushCharReadBuffer</span></a><span> </span><a href="#local-6989586621679289271"><span class="hs-identifier hs-var">h_</span></a><span>
</span><a name="line-248"></a><span>           </span><a href="GHC.IO.Handle.Internals.html#flushByteReadBuffer"><span class="hs-identifier hs-var">flushByteReadBuffer</span></a><span> </span><a href="#local-6989586621679289271"><span class="hs-identifier hs-var">h_</span></a><span>
</span><a name="line-249"></a><span>           </span><a name="local-6989586621679289286"><a href="#local-6989586621679289286"><span class="hs-identifier">buf</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IORef.html#readIORef"><span class="hs-identifier hs-var">readIORef</span></a><span> </span><a href="#local-6989586621679289277"><span class="hs-identifier hs-var">haCharBuffer</span></a><span>
</span><a name="line-250"></a><span>           </span><a href="GHC.IORef.html#writeIORef"><span class="hs-identifier hs-var">writeIORef</span></a><span> </span><a href="#local-6989586621679289277"><span class="hs-identifier hs-var">haCharBuffer</span></a><span> </span><a href="#local-6989586621679289286"><span class="hs-identifier hs-var">buf</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">bufState</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.Buffer.html#WriteBuffer"><span class="hs-identifier hs-var">WriteBuffer</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-251"></a><span>           </span><a name="local-6989586621679289287"><a href="#local-6989586621679289287"><span class="hs-identifier">buf</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IORef.html#readIORef"><span class="hs-identifier hs-var">readIORef</span></a><span> </span><a href="#local-6989586621679289274"><span class="hs-identifier hs-var">haByteBuffer</span></a><span>
</span><a name="line-252"></a><span>           </span><a name="local-6989586621679289288"><a href="#local-6989586621679289288"><span class="hs-identifier">buf'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IO.BufferedIO.html#emptyWriteBuffer"><span class="hs-identifier hs-var">Buffered.emptyWriteBuffer</span></a><span> </span><a href="#local-6989586621679289272"><span class="hs-identifier hs-var">haDevice</span></a><span> </span><a href="#local-6989586621679289287"><span class="hs-identifier hs-var">buf</span></a><span>
</span><a name="line-253"></a><span>           </span><a href="GHC.IORef.html#writeIORef"><span class="hs-identifier hs-var">writeIORef</span></a><span> </span><a href="#local-6989586621679289274"><span class="hs-identifier hs-var">haByteBuffer</span></a><span> </span><a href="#local-6989586621679289288"><span class="hs-identifier hs-var">buf'</span></a><span>
</span><a name="line-254"></a><span>        </span><a href="#local-6989586621679289270"><span class="hs-identifier hs-var">act</span></a><span> </span><a href="#local-6989586621679289271"><span class="hs-identifier hs-var">h_</span></a><span>
</span><a name="line-255"></a><span>      </span><a name="local-6989586621679289289"><a href="#local-6989586621679289289"><span class="hs-identifier">_other</span></a></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679289270"><span class="hs-identifier hs-var">act</span></a><span> </span><a href="#local-6989586621679289271"><span class="hs-identifier hs-var">h_</span></a><span>
</span><a name="line-256"></a><span>
</span><a name="line-257"></a><span class="hs-comment">-- ---------------------------------------------------------------------------</span><span>
</span><a name="line-258"></a><span class="hs-comment">-- Wrapper for read operations.</span><span>
</span><a name="line-259"></a><span>
</span><a name="line-260"></a><span class="hs-identifier">wantReadableHandle</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.Handle.Types.html#Handle"><span class="hs-identifier hs-type">Handle</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-type">Handle__</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-type">Handle__</span></a><span class="hs-special">,</span><a href="#local-6989586621679289183"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="#local-6989586621679289183"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-261"></a><a name="wantReadableHandle"><a href="GHC.IO.Handle.Internals.html#wantReadableHandle"><span class="hs-identifier">wantReadableHandle</span></a></a><span> </span><a name="local-6989586621679289290"><a href="#local-6989586621679289290"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-6989586621679289291"><a href="#local-6989586621679289291"><span class="hs-identifier">h</span></a></a><span> </span><a name="local-6989586621679289292"><a href="#local-6989586621679289292"><span class="hs-identifier">act</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.Handle.Internals.html#withHandle"><span class="hs-identifier hs-var">withHandle</span></a><span> </span><a href="#local-6989586621679289290"><span class="hs-identifier hs-var">fun</span></a><span> </span><a href="#local-6989586621679289291"><span class="hs-identifier hs-var">h</span></a><span> </span><span class="hs-special">(</span><a href="GHC.IO.Handle.Internals.html#checkReadableHandle"><span class="hs-identifier hs-var">checkReadableHandle</span></a><span> </span><a href="#local-6989586621679289292"><span class="hs-identifier hs-var">act</span></a><span class="hs-special">)</span><span>
</span><a name="line-262"></a><span>
</span><a name="line-263"></a><span class="hs-identifier">wantReadableHandle_</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.Handle.Types.html#Handle"><span class="hs-identifier hs-type">Handle</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-type">Handle__</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="#local-6989586621679289182"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="#local-6989586621679289182"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-264"></a><a name="wantReadableHandle_"><a href="GHC.IO.Handle.Internals.html#wantReadableHandle_"><span class="hs-identifier">wantReadableHandle_</span></a></a><span> </span><a name="local-6989586621679289293"><a href="#local-6989586621679289293"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-6989586621679289294"><a href="#local-6989586621679289294"><span class="hs-identifier">h</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="GHC.IO.Handle.Types.html#FileHandle"><span class="hs-identifier hs-var">FileHandle</span></a><span>  </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679289295"><a href="#local-6989586621679289295"><span class="hs-identifier">m</span></a></a><span class="hs-special">)</span><span>   </span><a name="local-6989586621679289296"><a href="#local-6989586621679289296"><span class="hs-identifier">act</span></a></a><span>
</span><a name="line-265"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.Handle.Internals.html#wantReadableHandle%27"><span class="hs-identifier hs-var">wantReadableHandle'</span></a><span> </span><a href="#local-6989586621679289293"><span class="hs-identifier hs-var">fun</span></a><span> </span><a href="#local-6989586621679289294"><span class="hs-identifier hs-var">h</span></a><span> </span><a href="#local-6989586621679289295"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="#local-6989586621679289296"><span class="hs-identifier hs-var">act</span></a><span>
</span><a name="line-266"></a><span class="hs-identifier">wantReadableHandle_</span><span> </span><a name="local-6989586621679289297"><a href="#local-6989586621679289297"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-6989586621679289298"><a href="#local-6989586621679289298"><span class="hs-identifier">h</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="GHC.IO.Handle.Types.html#DuplexHandle"><span class="hs-identifier hs-var">DuplexHandle</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679289299"><a href="#local-6989586621679289299"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621679289300"><a href="#local-6989586621679289300"><span class="hs-identifier">act</span></a></a><span>
</span><a name="line-267"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.Handle.Internals.html#wantReadableHandle%27"><span class="hs-identifier hs-var">wantReadableHandle'</span></a><span> </span><a href="#local-6989586621679289297"><span class="hs-identifier hs-var">fun</span></a><span> </span><a href="#local-6989586621679289298"><span class="hs-identifier hs-var">h</span></a><span> </span><a href="#local-6989586621679289299"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="#local-6989586621679289300"><span class="hs-identifier hs-var">act</span></a><span>
</span><a name="line-268"></a><span>    </span><span class="hs-comment">-- we know it's not a WriteHandle or ReadWriteHandle, but we have to</span><span>
</span><a name="line-269"></a><span>    </span><span class="hs-comment">-- check for ClosedHandle/SemiClosedHandle. (#4808)</span><span>
</span><a name="line-270"></a><span>
</span><a name="line-271"></a><span class="hs-identifier">wantReadableHandle'</span><span>
</span><a name="line-272"></a><span>        </span><span class="hs-glyph">::</span><span> </span><a href="GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.Handle.Types.html#Handle"><span class="hs-identifier hs-type">Handle</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.MVar.html#MVar"><span class="hs-identifier hs-type">MVar</span></a><span> </span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-type">Handle__</span></a><span>
</span><a name="line-273"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-type">Handle__</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="#local-6989586621679289181"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="#local-6989586621679289181"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-274"></a><a name="wantReadableHandle%27"><a href="GHC.IO.Handle.Internals.html#wantReadableHandle%27"><span class="hs-identifier">wantReadableHandle'</span></a></a><span> </span><a name="local-6989586621679289301"><a href="#local-6989586621679289301"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-6989586621679289302"><a href="#local-6989586621679289302"><span class="hs-identifier">h</span></a></a><span> </span><a name="local-6989586621679289303"><a href="#local-6989586621679289303"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679289304"><a href="#local-6989586621679289304"><span class="hs-identifier">act</span></a></a><span>
</span><a name="line-275"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.Handle.Internals.html#withHandle_%27"><span class="hs-identifier hs-var">withHandle_'</span></a><span> </span><a href="#local-6989586621679289301"><span class="hs-identifier hs-var">fun</span></a><span> </span><a href="#local-6989586621679289302"><span class="hs-identifier hs-var">h</span></a><span> </span><a href="#local-6989586621679289303"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-special">(</span><a href="GHC.IO.Handle.Internals.html#checkReadableHandle"><span class="hs-identifier hs-var">checkReadableHandle</span></a><span> </span><a href="#local-6989586621679289304"><span class="hs-identifier hs-var">act</span></a><span class="hs-special">)</span><span>
</span><a name="line-276"></a><span>
</span><a name="line-277"></a><span class="hs-identifier">checkReadableHandle</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-type">Handle__</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="#local-6989586621679289180"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-type">Handle__</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="#local-6989586621679289180"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-278"></a><a name="checkReadableHandle"><a href="GHC.IO.Handle.Internals.html#checkReadableHandle"><span class="hs-identifier">checkReadableHandle</span></a></a><span> </span><a name="local-6989586621679289305"><a href="#local-6989586621679289305"><span class="hs-identifier">act</span></a></a><span> </span><a name="local-6989586621679289306"><a href="#local-6989586621679289306"><span class="hs-identifier">h_</span></a></a><span class="hs-glyph">@</span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-var">Handle__</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-279"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679289308"><span class="hs-identifier hs-var">haType</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-280"></a><span>      </span><a href="GHC.IO.Handle.Types.html#ClosedHandle"><span class="hs-identifier hs-var">ClosedHandle</span></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.Handle.Internals.html#ioe_closedHandle"><span class="hs-identifier hs-var">ioe_closedHandle</span></a><span>
</span><a name="line-281"></a><span>      </span><a href="GHC.IO.Handle.Types.html#SemiClosedHandle"><span class="hs-identifier hs-var">SemiClosedHandle</span></a><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.Handle.Internals.html#ioe_semiclosedHandle"><span class="hs-identifier hs-var">ioe_semiclosedHandle</span></a><span>
</span><a name="line-282"></a><span>      </span><a href="GHC.IO.Handle.Types.html#AppendHandle"><span class="hs-identifier hs-var">AppendHandle</span></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.Handle.Internals.html#ioe_notReadable"><span class="hs-identifier hs-var">ioe_notReadable</span></a><span>
</span><a name="line-283"></a><span>      </span><a href="GHC.IO.Handle.Types.html#WriteHandle"><span class="hs-identifier hs-var">WriteHandle</span></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.Handle.Internals.html#ioe_notReadable"><span class="hs-identifier hs-var">ioe_notReadable</span></a><span>
</span><a name="line-284"></a><span>      </span><a href="GHC.IO.Handle.Types.html#ReadWriteHandle"><span class="hs-identifier hs-var">ReadWriteHandle</span></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-285"></a><span>          </span><span class="hs-comment">-- a read/write handle and we want to read from it.  We must</span><span>
</span><a name="line-286"></a><span>          </span><span class="hs-comment">-- flush all buffered write data first.</span><span>
</span><a name="line-287"></a><span>          </span><a name="local-6989586621679289320"><a href="#local-6989586621679289320"><span class="hs-identifier">bbuf</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IORef.html#readIORef"><span class="hs-identifier hs-var">readIORef</span></a><span> </span><a href="#local-6989586621679289309"><span class="hs-identifier hs-var">haByteBuffer</span></a><span>
</span><a name="line-288"></a><span>          </span><a href="GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a><span> </span><span class="hs-special">(</span><a href="GHC.IO.Buffer.html#isWriteBuffer"><span class="hs-identifier hs-var">isWriteBuffer</span></a><span> </span><a href="#local-6989586621679289320"><span class="hs-identifier hs-var">bbuf</span></a><span class="hs-special">)</span><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-289"></a><span>             </span><a href="GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a><span> </span><span class="hs-special">(</span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Classes.html#not"><span class="hs-identifier hs-var">not</span></a><span> </span><span class="hs-special">(</span><a href="GHC.IO.Buffer.html#isEmptyBuffer"><span class="hs-identifier hs-var">isEmptyBuffer</span></a><span> </span><a href="#local-6989586621679289320"><span class="hs-identifier hs-var">bbuf</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="GHC.IO.Handle.Internals.html#flushByteWriteBuffer"><span class="hs-identifier hs-var">flushByteWriteBuffer</span></a><span> </span><a href="#local-6989586621679289306"><span class="hs-identifier hs-var">h_</span></a><span>
</span><a name="line-290"></a><span>             </span><a name="local-6989586621679289321"><a href="#local-6989586621679289321"><span class="hs-identifier">cbuf'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IORef.html#readIORef"><span class="hs-identifier hs-var">readIORef</span></a><span> </span><a href="#local-6989586621679289312"><span class="hs-identifier hs-var">haCharBuffer</span></a><span>
</span><a name="line-291"></a><span>             </span><a href="GHC.IORef.html#writeIORef"><span class="hs-identifier hs-var">writeIORef</span></a><span> </span><a href="#local-6989586621679289312"><span class="hs-identifier hs-var">haCharBuffer</span></a><span> </span><a href="#local-6989586621679289321"><span class="hs-identifier hs-var">cbuf'</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">bufState</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.Buffer.html#ReadBuffer"><span class="hs-identifier hs-var">ReadBuffer</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-292"></a><span>             </span><a name="local-6989586621679289322"><a href="#local-6989586621679289322"><span class="hs-identifier">bbuf</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IORef.html#readIORef"><span class="hs-identifier hs-var">readIORef</span></a><span> </span><a href="#local-6989586621679289309"><span class="hs-identifier hs-var">haByteBuffer</span></a><span>
</span><a name="line-293"></a><span>             </span><a href="GHC.IORef.html#writeIORef"><span class="hs-identifier hs-var">writeIORef</span></a><span> </span><a href="#local-6989586621679289309"><span class="hs-identifier hs-var">haByteBuffer</span></a><span> </span><a href="#local-6989586621679289322"><span class="hs-identifier hs-var">bbuf</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">bufState</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.Buffer.html#ReadBuffer"><span class="hs-identifier hs-var">ReadBuffer</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-294"></a><span>          </span><a href="#local-6989586621679289305"><span class="hs-identifier hs-var">act</span></a><span> </span><a href="#local-6989586621679289306"><span class="hs-identifier hs-var">h_</span></a><span>
</span><a name="line-295"></a><span>      </span><a name="local-6989586621679289323"><a href="#local-6989586621679289323"><span class="hs-identifier">_other</span></a></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679289305"><span class="hs-identifier hs-var">act</span></a><span> </span><a href="#local-6989586621679289306"><span class="hs-identifier hs-var">h_</span></a><span>
</span><a name="line-296"></a><span>
</span><a name="line-297"></a><span class="hs-comment">-- ---------------------------------------------------------------------------</span><span>
</span><a name="line-298"></a><span class="hs-comment">-- Wrapper for seek operations.</span><span>
</span><a name="line-299"></a><span>
</span><a name="line-300"></a><span class="hs-identifier">wantSeekableHandle</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.Handle.Types.html#Handle"><span class="hs-identifier hs-type">Handle</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-type">Handle__</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="#local-6989586621679289179"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="#local-6989586621679289179"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-301"></a><a name="wantSeekableHandle"><a href="GHC.IO.Handle.Internals.html#wantSeekableHandle"><span class="hs-identifier">wantSeekableHandle</span></a></a><span> </span><a name="local-6989586621679289324"><a href="#local-6989586621679289324"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-6989586621679289325"><a href="#local-6989586621679289325"><span class="hs-identifier">h</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="GHC.IO.Handle.Types.html#DuplexHandle"><span class="hs-identifier hs-var">DuplexHandle</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621679289326"><a href="#local-6989586621679289326"><span class="hs-identifier">_act</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-302"></a><span>  </span><a href="GHC.IO.Exception.html#ioException"><span class="hs-identifier hs-var">ioException</span></a><span> </span><span class="hs-special">(</span><a href="GHC.IO.Exception.html#IOError"><span class="hs-identifier hs-var">IOError</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="#local-6989586621679289325"><span class="hs-identifier hs-var">h</span></a><span class="hs-special">)</span><span> </span><a href="GHC.IO.Exception.html#IllegalOperation"><span class="hs-identifier hs-var">IllegalOperation</span></a><span> </span><a href="#local-6989586621679289324"><span class="hs-identifier hs-var">fun</span></a><span>
</span><a name="line-303"></a><span>                   </span><span class="hs-string">&quot;handle is not seekable&quot;</span><span> </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span class="hs-special">)</span><span>
</span><a name="line-304"></a><span class="hs-identifier">wantSeekableHandle</span><span> </span><a name="local-6989586621679289327"><a href="#local-6989586621679289327"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-6989586621679289328"><a href="#local-6989586621679289328"><span class="hs-identifier">h</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="GHC.IO.Handle.Types.html#FileHandle"><span class="hs-identifier hs-var">FileHandle</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679289329"><a href="#local-6989586621679289329"><span class="hs-identifier">m</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679289330"><a href="#local-6989586621679289330"><span class="hs-identifier">act</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-305"></a><span>  </span><a href="GHC.IO.Handle.Internals.html#withHandle_%27"><span class="hs-identifier hs-var">withHandle_'</span></a><span> </span><a href="#local-6989586621679289327"><span class="hs-identifier hs-var">fun</span></a><span> </span><a href="#local-6989586621679289328"><span class="hs-identifier hs-var">h</span></a><span> </span><a href="#local-6989586621679289329"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-special">(</span><a href="GHC.IO.Handle.Internals.html#checkSeekableHandle"><span class="hs-identifier hs-var">checkSeekableHandle</span></a><span> </span><a href="#local-6989586621679289330"><span class="hs-identifier hs-var">act</span></a><span class="hs-special">)</span><span>
</span><a name="line-306"></a><span>
</span><a name="line-307"></a><span class="hs-identifier">checkSeekableHandle</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-type">Handle__</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="#local-6989586621679289178"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-type">Handle__</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="#local-6989586621679289178"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-308"></a><a name="checkSeekableHandle"><a href="GHC.IO.Handle.Internals.html#checkSeekableHandle"><span class="hs-identifier">checkSeekableHandle</span></a></a><span> </span><a name="local-6989586621679289331"><a href="#local-6989586621679289331"><span class="hs-identifier">act</span></a></a><span> </span><a name="local-6989586621679289332"><a href="#local-6989586621679289332"><span class="hs-identifier">handle_</span></a></a><span class="hs-glyph">@</span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-var">Handle__</span></a><span class="hs-special">{</span><span class="hs-identifier">haDevice</span><span class="hs-glyph">=</span><a name="local-6989586621679289333"><a href="#local-6989586621679289333"><span class="hs-identifier">dev</span></a></a><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-309"></a><span>    </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">haType</span><span> </span><a href="#local-6989586621679289332"><span class="hs-identifier hs-var">handle_</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-310"></a><span>      </span><a href="GHC.IO.Handle.Types.html#ClosedHandle"><span class="hs-identifier hs-var">ClosedHandle</span></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.Handle.Internals.html#ioe_closedHandle"><span class="hs-identifier hs-var">ioe_closedHandle</span></a><span>
</span><a name="line-311"></a><span>      </span><a href="GHC.IO.Handle.Types.html#SemiClosedHandle"><span class="hs-identifier hs-var">SemiClosedHandle</span></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.Handle.Internals.html#ioe_semiclosedHandle"><span class="hs-identifier hs-var">ioe_semiclosedHandle</span></a><span>
</span><a name="line-312"></a><span>      </span><a href="GHC.IO.Handle.Types.html#AppendHandle"><span class="hs-identifier hs-var">AppendHandle</span></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.Handle.Internals.html#ioe_notSeekable"><span class="hs-identifier hs-var">ioe_notSeekable</span></a><span>
</span><a name="line-313"></a><span>      </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621679289334"><a href="#local-6989586621679289334"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IO.Device.html#isSeekable"><span class="hs-identifier hs-var">IODevice.isSeekable</span></a><span> </span><a href="#local-6989586621679289333"><span class="hs-identifier hs-var">dev</span></a><span>
</span><a name="line-314"></a><span>              </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679289334"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621679289331"><span class="hs-identifier hs-var">act</span></a><span> </span><a href="#local-6989586621679289332"><span class="hs-identifier hs-var">handle_</span></a><span>
</span><a name="line-315"></a><span>                   </span><span class="hs-keyword">else</span><span> </span><a href="GHC.IO.Handle.Internals.html#ioe_notSeekable"><span class="hs-identifier hs-var">ioe_notSeekable</span></a><span>
</span><a name="line-316"></a><span>
</span><a name="line-317"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-318"></a><span class="hs-comment">-- Handy IOErrors</span><span>
</span><a name="line-319"></a><span>
</span><a name="line-320"></a><span class="hs-identifier">ioe_closedHandle</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ioe_semiclosedHandle</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ioe_EOF</span><span class="hs-special">,</span><span>
</span><a name="line-321"></a><span>  </span><span class="hs-identifier">ioe_notReadable</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ioe_notWritable</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ioe_cannotFlushNotSeekable</span><span class="hs-special">,</span><span>
</span><a name="line-322"></a><span>  </span><span class="hs-identifier">ioe_notSeekable</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="#local-6989586621679289177"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-323"></a><span>
</span><a name="line-324"></a><a name="ioe_closedHandle"><a href="GHC.IO.Handle.Internals.html#ioe_closedHandle"><span class="hs-identifier">ioe_closedHandle</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.Exception.html#ioException"><span class="hs-identifier hs-var">ioException</span></a><span>
</span><a name="line-325"></a><span>   </span><span class="hs-special">(</span><a href="GHC.IO.Exception.html#IOError"><span class="hs-identifier hs-var">IOError</span></a><span> </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><a href="GHC.IO.Exception.html#IllegalOperation"><span class="hs-identifier hs-var">IllegalOperation</span></a><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-326"></a><span>        </span><span class="hs-string">&quot;handle is closed&quot;</span><span> </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span class="hs-special">)</span><span>
</span><a name="line-327"></a><a name="ioe_semiclosedHandle"><a href="GHC.IO.Handle.Internals.html#ioe_semiclosedHandle"><span class="hs-identifier">ioe_semiclosedHandle</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.Exception.html#ioException"><span class="hs-identifier hs-var">ioException</span></a><span>
</span><a name="line-328"></a><span>   </span><span class="hs-special">(</span><a href="GHC.IO.Exception.html#IOError"><span class="hs-identifier hs-var">IOError</span></a><span> </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><a href="GHC.IO.Exception.html#IllegalOperation"><span class="hs-identifier hs-var">IllegalOperation</span></a><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-329"></a><span>        </span><span class="hs-string">&quot;handle is semi-closed&quot;</span><span> </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span class="hs-special">)</span><span>
</span><a name="line-330"></a><a name="ioe_EOF"><a href="GHC.IO.Handle.Internals.html#ioe_EOF"><span class="hs-identifier">ioe_EOF</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.Exception.html#ioException"><span class="hs-identifier hs-var">ioException</span></a><span>
</span><a name="line-331"></a><span>   </span><span class="hs-special">(</span><a href="GHC.IO.Exception.html#IOError"><span class="hs-identifier hs-var">IOError</span></a><span> </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><a href="GHC.IO.Exception.html#EOF"><span class="hs-identifier hs-var">EOF</span></a><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span class="hs-special">)</span><span>
</span><a name="line-332"></a><a name="ioe_notReadable"><a href="GHC.IO.Handle.Internals.html#ioe_notReadable"><span class="hs-identifier">ioe_notReadable</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.Exception.html#ioException"><span class="hs-identifier hs-var">ioException</span></a><span>
</span><a name="line-333"></a><span>   </span><span class="hs-special">(</span><a href="GHC.IO.Exception.html#IOError"><span class="hs-identifier hs-var">IOError</span></a><span> </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><a href="GHC.IO.Exception.html#IllegalOperation"><span class="hs-identifier hs-var">IllegalOperation</span></a><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-334"></a><span>        </span><span class="hs-string">&quot;handle is not open for reading&quot;</span><span> </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span class="hs-special">)</span><span>
</span><a name="line-335"></a><a name="ioe_notWritable"><a href="GHC.IO.Handle.Internals.html#ioe_notWritable"><span class="hs-identifier">ioe_notWritable</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.Exception.html#ioException"><span class="hs-identifier hs-var">ioException</span></a><span>
</span><a name="line-336"></a><span>   </span><span class="hs-special">(</span><a href="GHC.IO.Exception.html#IOError"><span class="hs-identifier hs-var">IOError</span></a><span> </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><a href="GHC.IO.Exception.html#IllegalOperation"><span class="hs-identifier hs-var">IllegalOperation</span></a><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-337"></a><span>        </span><span class="hs-string">&quot;handle is not open for writing&quot;</span><span> </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span class="hs-special">)</span><span>
</span><a name="line-338"></a><a name="ioe_notSeekable"><a href="GHC.IO.Handle.Internals.html#ioe_notSeekable"><span class="hs-identifier">ioe_notSeekable</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.Exception.html#ioException"><span class="hs-identifier hs-var">ioException</span></a><span>
</span><a name="line-339"></a><span>   </span><span class="hs-special">(</span><a href="GHC.IO.Exception.html#IOError"><span class="hs-identifier hs-var">IOError</span></a><span> </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><a href="GHC.IO.Exception.html#IllegalOperation"><span class="hs-identifier hs-var">IllegalOperation</span></a><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-340"></a><span>        </span><span class="hs-string">&quot;handle is not seekable&quot;</span><span> </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span class="hs-special">)</span><span>
</span><a name="line-341"></a><a name="ioe_cannotFlushNotSeekable"><a href="GHC.IO.Handle.Internals.html#ioe_cannotFlushNotSeekable"><span class="hs-identifier">ioe_cannotFlushNotSeekable</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.Exception.html#ioException"><span class="hs-identifier hs-var">ioException</span></a><span>
</span><a name="line-342"></a><span>   </span><span class="hs-special">(</span><a href="GHC.IO.Exception.html#IOError"><span class="hs-identifier hs-var">IOError</span></a><span> </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><a href="GHC.IO.Exception.html#IllegalOperation"><span class="hs-identifier hs-var">IllegalOperation</span></a><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-343"></a><span>      </span><span class="hs-string">&quot;cannot flush the read buffer: underlying device is not seekable&quot;</span><span>
</span><a name="line-344"></a><span>        </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span class="hs-special">)</span><span>
</span><a name="line-345"></a><span>
</span><a name="line-346"></a><span class="hs-identifier">ioe_finalizedHandle</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.IO.html#FilePath"><span class="hs-identifier hs-type">FilePath</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-type">Handle__</span></a><span>
</span><a name="line-347"></a><a name="ioe_finalizedHandle"><a href="GHC.IO.Handle.Internals.html#ioe_finalizedHandle"><span class="hs-identifier">ioe_finalizedHandle</span></a></a><span> </span><a name="local-6989586621679289335"><a href="#local-6989586621679289335"><span class="hs-identifier">fp</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.Exception.html#throw"><span class="hs-identifier hs-var">throw</span></a><span>
</span><a name="line-348"></a><span>   </span><span class="hs-special">(</span><a href="GHC.IO.Exception.html#IOError"><span class="hs-identifier hs-var">IOError</span></a><span> </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><a href="GHC.IO.Exception.html#IllegalOperation"><span class="hs-identifier hs-var">IllegalOperation</span></a><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-349"></a><span>        </span><span class="hs-string">&quot;handle is finalized&quot;</span><span> </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="#local-6989586621679289335"><span class="hs-identifier hs-var">fp</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-350"></a><span>
</span><a name="line-351"></a><span class="hs-identifier">ioe_bufsiz</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="#local-6989586621679289176"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-352"></a><a name="ioe_bufsiz"><a href="GHC.IO.Handle.Internals.html#ioe_bufsiz"><span class="hs-identifier">ioe_bufsiz</span></a></a><span> </span><a name="local-6989586621679289336"><a href="#local-6989586621679289336"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.Exception.html#ioException"><span class="hs-identifier hs-var">ioException</span></a><span>
</span><a name="line-353"></a><span>   </span><span class="hs-special">(</span><a href="GHC.IO.Exception.html#IOError"><span class="hs-identifier hs-var">IOError</span></a><span> </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><a href="GHC.IO.Exception.html#InvalidArgument"><span class="hs-identifier hs-var">InvalidArgument</span></a><span> </span><span class="hs-string">&quot;hSetBuffering&quot;</span><span>
</span><a name="line-354"></a><span>        </span><span class="hs-special">(</span><span class="hs-string">&quot;illegal buffer size &quot;</span><span> </span><a href="GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="GHC.Show.html#showsPrec"><span class="hs-identifier hs-var">showsPrec</span></a><span> </span><span class="hs-number">9</span><span> </span><a href="#local-6989586621679289336"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span class="hs-special">)</span><span>
</span><a name="line-355"></a><span>                                </span><span class="hs-comment">-- 9 =&gt; should be parens'ified.</span><span>
</span><a name="line-356"></a><span>
</span><a name="line-357"></a><span class="hs-comment">-- ---------------------------------------------------------------------------</span><span>
</span><a name="line-358"></a><span class="hs-comment">-- Wrapper for Handle encoding/decoding.</span><span>
</span><a name="line-359"></a><span>
</span><a name="line-360"></a><span class="hs-comment">-- The interface for TextEncoding changed so that a TextEncoding doesn't raise</span><span>
</span><a name="line-361"></a><span class="hs-comment">-- an exception if it encounters an invalid sequnce. Furthermore, encoding</span><span>
</span><a name="line-362"></a><span class="hs-comment">-- returns a reason as to why encoding stopped, letting us know if it was due</span><span>
</span><a name="line-363"></a><span class="hs-comment">-- to input/output underflow or an invalid sequence.</span><span>
</span><a name="line-364"></a><span class="hs-comment">--</span><span>
</span><a name="line-365"></a><span class="hs-comment">-- This code adapts this elaborated interface back to the original TextEncoding</span><span>
</span><a name="line-366"></a><span class="hs-comment">-- interface.</span><span>
</span><a name="line-367"></a><span class="hs-comment">--</span><span>
</span><a name="line-368"></a><span class="hs-comment">-- FIXME: it is possible that Handle code using the haDecoder/haEncoder fields</span><span>
</span><a name="line-369"></a><span class="hs-comment">-- could be made clearer by using the 'encode' interface directly. I have not</span><span>
</span><a name="line-370"></a><span class="hs-comment">-- looked into this.</span><span>
</span><a name="line-371"></a><span>
</span><a name="line-372"></a><span class="hs-identifier">streamEncode</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.IO.Encoding.Types.html#BufferCodec"><span class="hs-identifier hs-type">BufferCodec</span></a><span> </span><a href="#local-6989586621679289173"><span class="hs-identifier hs-type">from</span></a><span> </span><a href="#local-6989586621679289174"><span class="hs-identifier hs-type">to</span></a><span> </span><a href="#local-6989586621679289175"><span class="hs-identifier hs-type">state</span></a><span>
</span><a name="line-373"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.Buffer.html#Buffer"><span class="hs-identifier hs-type">Buffer</span></a><span> </span><a href="#local-6989586621679289173"><span class="hs-identifier hs-type">from</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.Buffer.html#Buffer"><span class="hs-identifier hs-type">Buffer</span></a><span> </span><a href="#local-6989586621679289174"><span class="hs-identifier hs-type">to</span></a><span>
</span><a name="line-374"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><a href="GHC.IO.Buffer.html#Buffer"><span class="hs-identifier hs-type">Buffer</span></a><span> </span><a href="#local-6989586621679289173"><span class="hs-identifier hs-type">from</span></a><span class="hs-special">,</span><span> </span><a href="GHC.IO.Buffer.html#Buffer"><span class="hs-identifier hs-type">Buffer</span></a><span> </span><a href="#local-6989586621679289174"><span class="hs-identifier hs-type">to</span></a><span class="hs-special">)</span><span>
</span><a name="line-375"></a><a name="streamEncode"><a href="GHC.IO.Handle.Internals.html#streamEncode"><span class="hs-identifier">streamEncode</span></a></a><span> </span><a name="local-6989586621679289337"><a href="#local-6989586621679289337"><span class="hs-identifier">codec</span></a></a><span> </span><a name="local-6989586621679289338"><a href="#local-6989586621679289338"><span class="hs-identifier">from</span></a></a><span> </span><a name="local-6989586621679289339"><a href="#local-6989586621679289339"><span class="hs-identifier">to</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.Base.html#fmap"><span class="hs-identifier hs-var">fmap</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679289340"><a href="#local-6989586621679289340"><span class="hs-identifier">from'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679289341"><a href="#local-6989586621679289341"><span class="hs-identifier">to'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679289340"><span class="hs-identifier hs-var">from'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679289341"><span class="hs-identifier hs-var">to'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="GHC.IO.Handle.Internals.html#recoveringEncode"><span class="hs-identifier hs-var">recoveringEncode</span></a><span> </span><a href="#local-6989586621679289337"><span class="hs-identifier hs-var">codec</span></a><span> </span><a href="#local-6989586621679289338"><span class="hs-identifier hs-var">from</span></a><span> </span><a href="#local-6989586621679289339"><span class="hs-identifier hs-var">to</span></a><span>
</span><a name="line-376"></a><span>
</span><a name="line-377"></a><span class="hs-comment">-- | Just like 'encode', but interleaves calls to 'encode' with calls to 'recover' in order to make as much progress as possible</span><span>
</span><a name="line-378"></a><span class="hs-identifier">recoveringEncode</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.IO.Encoding.Types.html#BufferCodec"><span class="hs-identifier hs-type">BufferCodec</span></a><span> </span><a href="#local-6989586621679289170"><span class="hs-identifier hs-type">from</span></a><span> </span><a href="#local-6989586621679289171"><span class="hs-identifier hs-type">to</span></a><span> </span><a href="#local-6989586621679289172"><span class="hs-identifier hs-type">state</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.Encoding.Types.html#CodeBuffer"><span class="hs-identifier hs-type">CodeBuffer</span></a><span> </span><a href="#local-6989586621679289170"><span class="hs-identifier hs-type">from</span></a><span> </span><a href="#local-6989586621679289171"><span class="hs-identifier hs-type">to</span></a><span>
</span><a name="line-379"></a><a name="recoveringEncode"><a href="GHC.IO.Handle.Internals.html#recoveringEncode"><span class="hs-identifier">recoveringEncode</span></a></a><span> </span><a name="local-6989586621679289342"><a href="#local-6989586621679289342"><span class="hs-identifier">codec</span></a></a><span> </span><a name="local-6989586621679289343"><a href="#local-6989586621679289343"><span class="hs-identifier">from</span></a></a><span> </span><a name="local-6989586621679289344"><a href="#local-6989586621679289344"><span class="hs-identifier">to</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679289345"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679289343"><span class="hs-identifier hs-var">from</span></a><span> </span><a href="#local-6989586621679289344"><span class="hs-identifier hs-var">to</span></a><span>
</span><a name="line-380"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-381"></a><span>    </span><a name="local-6989586621679289345"><a href="#local-6989586621679289345"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621679289346"><a href="#local-6989586621679289346"><span class="hs-identifier">from</span></a></a><span> </span><a name="local-6989586621679289347"><a href="#local-6989586621679289347"><span class="hs-identifier">to</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-382"></a><span>      </span><span class="hs-special">(</span><a name="local-6989586621679289348"><a href="#local-6989586621679289348"><span class="hs-identifier">why</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679289349"><a href="#local-6989586621679289349"><span class="hs-identifier">from'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679289350"><a href="#local-6989586621679289350"><span class="hs-identifier">to'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">encode</span><span> </span><a href="#local-6989586621679289342"><span class="hs-identifier hs-var">codec</span></a><span> </span><a href="#local-6989586621679289346"><span class="hs-identifier hs-var">from</span></a><span> </span><a href="#local-6989586621679289347"><span class="hs-identifier hs-var">to</span></a><span>
</span><a name="line-383"></a><span>      </span><span class="hs-comment">-- When we are dealing with Handles, we don't care about input/output</span><span>
</span><a name="line-384"></a><span>      </span><span class="hs-comment">-- underflow particularly, and we want to delay errors about invalid</span><span>
</span><a name="line-385"></a><span>      </span><span class="hs-comment">-- sequences as far as possible.</span><span>
</span><a name="line-386"></a><span>      </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679289348"><span class="hs-identifier hs-var">why</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-387"></a><span>        </span><a href="GHC.IO.Encoding.Types.html#InvalidSequence"><span class="hs-identifier hs-var">InvalidSequence</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">bufL</span><span> </span><a href="#local-6989586621679289346"><span class="hs-identifier hs-var">from</span></a><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a><span> </span><span class="hs-identifier">bufL</span><span> </span><a href="#local-6989586621679289349"><span class="hs-identifier hs-var">from'</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-388"></a><span>          </span><span class="hs-comment">-- NB: it is OK to call recover here. Because we saw InvalidSequence, by the invariants</span><span>
</span><a name="line-389"></a><span>          </span><span class="hs-comment">-- on &quot;encode&quot; it must be the case that there is at least one elements available in the output</span><span>
</span><a name="line-390"></a><span>          </span><span class="hs-comment">-- buffer. Furthermore, clearly there is at least one element in the input buffer since we found</span><span>
</span><a name="line-391"></a><span>          </span><span class="hs-comment">-- something invalid there!</span><span>
</span><a name="line-392"></a><span>          </span><span class="hs-special">(</span><a name="local-6989586621679289351"><a href="#local-6989586621679289351"><span class="hs-identifier">from'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679289352"><a href="#local-6989586621679289352"><span class="hs-identifier">to'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">recover</span><span> </span><a href="#local-6989586621679289342"><span class="hs-identifier hs-var">codec</span></a><span> </span><a href="#local-6989586621679289349"><span class="hs-identifier hs-var">from'</span></a><span> </span><a href="#local-6989586621679289350"><span class="hs-identifier hs-var">to'</span></a><span>
</span><a name="line-393"></a><span>          </span><a href="#local-6989586621679289345"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679289351"><span class="hs-identifier hs-var">from'</span></a><span> </span><a href="#local-6989586621679289352"><span class="hs-identifier hs-var">to'</span></a><span>
</span><a name="line-394"></a><span>        </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679289348"><span class="hs-identifier hs-var">why</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679289349"><span class="hs-identifier hs-var">from'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679289350"><span class="hs-identifier hs-var">to'</span></a><span class="hs-special">)</span><span>
</span><a name="line-395"></a><span>
</span><a name="line-396"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-397"></a><span class="hs-comment">-- Handle Finalizers</span><span>
</span><a name="line-398"></a><span>
</span><a name="line-399"></a><span class="hs-comment">-- For a duplex handle, we arrange that the read side points to the write side</span><span>
</span><a name="line-400"></a><span class="hs-comment">-- (and hence keeps it alive if the read side is alive).  This is done by</span><span>
</span><a name="line-401"></a><span class="hs-comment">-- having the haOtherSide field of the read side point to the read side.</span><span>
</span><a name="line-402"></a><span class="hs-comment">-- The finalizer is then placed on the write side, and the handle only gets</span><span>
</span><a name="line-403"></a><span class="hs-comment">-- finalized once, when both sides are no longer required.</span><span>
</span><a name="line-404"></a><span>
</span><a name="line-405"></a><span class="hs-comment">-- NOTE about finalized handles: It's possible that a handle can be</span><span>
</span><a name="line-406"></a><span class="hs-comment">-- finalized and then we try to use it later, for example if the</span><span>
</span><a name="line-407"></a><span class="hs-comment">-- handle is referenced from another finalizer, or from a thread that</span><span>
</span><a name="line-408"></a><span class="hs-comment">-- has become unreferenced and then resurrected (arguably in the</span><span>
</span><a name="line-409"></a><span class="hs-comment">-- latter case we shouldn't finalize the Handle...).  Anyway,</span><span>
</span><a name="line-410"></a><span class="hs-comment">-- we try to emit a helpful message which is better than nothing.</span><span>
</span><a name="line-411"></a><span class="hs-comment">--</span><span>
</span><a name="line-412"></a><span class="hs-comment">-- [later; 8/2010] However, a program like this can yield a strange</span><span>
</span><a name="line-413"></a><span class="hs-comment">-- error message:</span><span>
</span><a name="line-414"></a><span class="hs-comment">--</span><span>
</span><a name="line-415"></a><span class="hs-comment">--   main = writeFile &quot;out&quot; loop</span><span>
</span><a name="line-416"></a><span class="hs-comment">--   loop = let x = x in x</span><span>
</span><a name="line-417"></a><span class="hs-comment">--</span><span>
</span><a name="line-418"></a><span class="hs-comment">-- because the main thread and the Handle are both unreachable at the</span><span>
</span><a name="line-419"></a><span class="hs-comment">-- same time, the Handle may get finalized before the main thread</span><span>
</span><a name="line-420"></a><span class="hs-comment">-- receives the NonTermination exception, and the exception handler</span><span>
</span><a name="line-421"></a><span class="hs-comment">-- will then report an error.  We'd rather this was not an error and</span><span>
</span><a name="line-422"></a><span class="hs-comment">-- the program just prints &quot;&lt;&lt;loop&gt;&gt;&quot;.</span><span>
</span><a name="line-423"></a><span>
</span><a name="line-424"></a><span class="hs-identifier">handleFinalizer</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.IO.html#FilePath"><span class="hs-identifier hs-type">FilePath</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.MVar.html#MVar"><span class="hs-identifier hs-type">MVar</span></a><span> </span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-type">Handle__</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-425"></a><a name="handleFinalizer"><a href="GHC.IO.Handle.Internals.html#handleFinalizer"><span class="hs-identifier">handleFinalizer</span></a></a><span> </span><a name="local-6989586621679289353"><a href="#local-6989586621679289353"><span class="hs-identifier">fp</span></a></a><span> </span><a name="local-6989586621679289354"><a href="#local-6989586621679289354"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-426"></a><span>  </span><a name="local-6989586621679289355"><a href="#local-6989586621679289355"><span class="hs-identifier">handle_</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.MVar.html#takeMVar"><span class="hs-identifier hs-var">takeMVar</span></a><span> </span><a href="#local-6989586621679289354"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-427"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679289356"><a href="#local-6989586621679289356"><span class="hs-identifier">handle_'</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IO.Handle.Internals.html#hClose_help"><span class="hs-identifier hs-var">hClose_help</span></a><span> </span><a href="#local-6989586621679289355"><span class="hs-identifier hs-var">handle_</span></a><span>
</span><a name="line-428"></a><span>  </span><a href="GHC.MVar.html#putMVar"><span class="hs-identifier hs-var">putMVar</span></a><span> </span><a href="#local-6989586621679289354"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="#local-6989586621679289356"><span class="hs-identifier hs-var">handle_'</span></a><span>
</span><a name="line-429"></a><span>  </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-430"></a><span>
</span><a name="line-431"></a><span class="hs-comment">-- ---------------------------------------------------------------------------</span><span>
</span><a name="line-432"></a><span class="hs-comment">-- Allocating buffers</span><span>
</span><a name="line-433"></a><span>
</span><a name="line-434"></a><span class="hs-comment">-- using an 8k char buffer instead of 32k improved performance for a</span><span>
</span><a name="line-435"></a><span class="hs-comment">-- basic &quot;cat&quot; program by ~30% for me.  --SDM</span><span>
</span><a name="line-436"></a><span class="hs-identifier">dEFAULT_CHAR_BUFFER_SIZE</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a><span>
</span><a name="line-437"></a><a name="dEFAULT_CHAR_BUFFER_SIZE"><a href="GHC.IO.Handle.Internals.html#dEFAULT_CHAR_BUFFER_SIZE"><span class="hs-identifier">dEFAULT_CHAR_BUFFER_SIZE</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">2048</span><span> </span><span class="hs-comment">-- 8k/sizeof(HsChar)</span><span>
</span><a name="line-438"></a><span>
</span><a name="line-439"></a><span class="hs-identifier">getCharBuffer</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.IO.Device.html#IODevice"><span class="hs-identifier hs-type">IODevice</span></a><span> </span><a href="#local-6989586621679289169"><span class="hs-identifier hs-type">dev</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679289169"><span class="hs-identifier hs-type">dev</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.Buffer.html#BufferState"><span class="hs-identifier hs-type">BufferState</span></a><span>
</span><a name="line-440"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><a href="GHC.IORef.html#IORef"><span class="hs-identifier hs-type">IORef</span></a><span> </span><a href="GHC.IO.Buffer.html#CharBuffer"><span class="hs-identifier hs-type">CharBuffer</span></a><span class="hs-special">,</span><span> </span><a href="GHC.IO.Handle.Types.html#BufferMode"><span class="hs-identifier hs-type">BufferMode</span></a><span class="hs-special">)</span><span>
</span><a name="line-441"></a><a name="getCharBuffer"><a href="GHC.IO.Handle.Internals.html#getCharBuffer"><span class="hs-identifier">getCharBuffer</span></a></a><span> </span><a name="local-6989586621679289357"><a href="#local-6989586621679289357"><span class="hs-identifier">dev</span></a></a><span> </span><a name="local-6989586621679289358"><a href="#local-6989586621679289358"><span class="hs-identifier">state</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-442"></a><span>  </span><a name="local-6989586621679289359"><a href="#local-6989586621679289359"><span class="hs-identifier">buffer</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IO.Buffer.html#newCharBuffer"><span class="hs-identifier hs-var">newCharBuffer</span></a><span> </span><a href="GHC.IO.Handle.Internals.html#dEFAULT_CHAR_BUFFER_SIZE"><span class="hs-identifier hs-var">dEFAULT_CHAR_BUFFER_SIZE</span></a><span> </span><a href="#local-6989586621679289358"><span class="hs-identifier hs-var">state</span></a><span>
</span><a name="line-443"></a><span>  </span><a name="local-6989586621679289360"><a href="#local-6989586621679289360"><span class="hs-identifier">ioref</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IORef.html#newIORef"><span class="hs-identifier hs-var">newIORef</span></a><span> </span><a href="#local-6989586621679289359"><span class="hs-identifier hs-var">buffer</span></a><span>
</span><a name="line-444"></a><span>  </span><a name="local-6989586621679289361"><a href="#local-6989586621679289361"><span class="hs-identifier">is_tty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IO.Device.html#isTerminal"><span class="hs-identifier hs-var">IODevice.isTerminal</span></a><span> </span><a href="#local-6989586621679289357"><span class="hs-identifier hs-var">dev</span></a><span>
</span><a name="line-445"></a><span>
</span><a name="line-446"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679289362"><a href="#local-6989586621679289362"><span class="hs-identifier">buffer_mode</span></a></a><span>
</span><a name="line-447"></a><span>         </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679289361"><span class="hs-identifier hs-var">is_tty</span></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.Handle.Types.html#LineBuffering"><span class="hs-identifier hs-var">LineBuffering</span></a><span>
</span><a name="line-448"></a><span>         </span><span class="hs-glyph">|</span><span> </span><a href="GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.Handle.Types.html#BlockBuffering"><span class="hs-identifier hs-var">BlockBuffering</span></a><span> </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>
</span><a name="line-449"></a><span>
</span><a name="line-450"></a><span>  </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679289360"><span class="hs-identifier hs-var">ioref</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679289362"><span class="hs-identifier hs-var">buffer_mode</span></a><span class="hs-special">)</span><span>
</span><a name="line-451"></a><span>
</span><a name="line-452"></a><span class="hs-identifier">mkUnBuffer</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.IO.Buffer.html#BufferState"><span class="hs-identifier hs-type">BufferState</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><a href="GHC.IORef.html#IORef"><span class="hs-identifier hs-type">IORef</span></a><span> </span><a href="GHC.IO.Buffer.html#CharBuffer"><span class="hs-identifier hs-type">CharBuffer</span></a><span class="hs-special">,</span><span> </span><a href="GHC.IO.Handle.Types.html#BufferMode"><span class="hs-identifier hs-type">BufferMode</span></a><span class="hs-special">)</span><span>
</span><a name="line-453"></a><a name="mkUnBuffer"><a href="GHC.IO.Handle.Internals.html#mkUnBuffer"><span class="hs-identifier">mkUnBuffer</span></a></a><span> </span><a name="local-6989586621679289363"><a href="#local-6989586621679289363"><span class="hs-identifier">state</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-454"></a><span>  </span><a name="local-6989586621679289364"><a href="#local-6989586621679289364"><span class="hs-identifier">buffer</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IO.Buffer.html#newCharBuffer"><span class="hs-identifier hs-var">newCharBuffer</span></a><span> </span><a href="GHC.IO.Handle.Internals.html#dEFAULT_CHAR_BUFFER_SIZE"><span class="hs-identifier hs-var">dEFAULT_CHAR_BUFFER_SIZE</span></a><span> </span><a href="#local-6989586621679289363"><span class="hs-identifier hs-var">state</span></a><span>
</span><a name="line-455"></a><span>              </span><span class="hs-comment">--  See [note Buffer Sizing], GHC.IO.Handle.Types</span><span>
</span><a name="line-456"></a><span>  </span><a name="local-6989586621679289365"><a href="#local-6989586621679289365"><span class="hs-identifier">ref</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IORef.html#newIORef"><span class="hs-identifier hs-var">newIORef</span></a><span> </span><a href="#local-6989586621679289364"><span class="hs-identifier hs-var">buffer</span></a><span>
</span><a name="line-457"></a><span>  </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679289365"><span class="hs-identifier hs-var">ref</span></a><span class="hs-special">,</span><span> </span><a href="GHC.IO.Handle.Types.html#NoBuffering"><span class="hs-identifier hs-var">NoBuffering</span></a><span class="hs-special">)</span><span>
</span><a name="line-458"></a><span>
</span><a name="line-459"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-460"></a><span class="hs-comment">-- Flushing buffers</span><span>
</span><a name="line-461"></a><span>
</span><a name="line-462"></a><span class="hs-comment">-- | syncs the file with the buffer, including moving the</span><span>
</span><a name="line-463"></a><span class="hs-comment">-- file pointer backwards in the case of a read buffer.  This can fail</span><span>
</span><a name="line-464"></a><span class="hs-comment">-- on a non-seekable read Handle.</span><span>
</span><a name="line-465"></a><span class="hs-identifier">flushBuffer</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-type">Handle__</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-466"></a><a name="flushBuffer"><a href="GHC.IO.Handle.Internals.html#flushBuffer"><span class="hs-identifier">flushBuffer</span></a></a><span> </span><a name="local-6989586621679289366"><a href="#local-6989586621679289366"><span class="hs-identifier">h_</span></a></a><span class="hs-glyph">@</span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-var">Handle__</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-467"></a><span>  </span><a name="local-6989586621679289380"><a href="#local-6989586621679289380"><span class="hs-identifier">buf</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IORef.html#readIORef"><span class="hs-identifier hs-var">readIORef</span></a><span> </span><a href="#local-6989586621679289372"><span class="hs-identifier hs-var">haCharBuffer</span></a><span>
</span><a name="line-468"></a><span>  </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">bufState</span><span> </span><a href="#local-6989586621679289380"><span class="hs-identifier hs-var">buf</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-469"></a><span>    </span><a href="GHC.IO.Buffer.html#ReadBuffer"><span class="hs-identifier hs-var">ReadBuffer</span></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-470"></a><span>        </span><a href="GHC.IO.Handle.Internals.html#flushCharReadBuffer"><span class="hs-identifier hs-var">flushCharReadBuffer</span></a><span> </span><a href="#local-6989586621679289366"><span class="hs-identifier hs-var">h_</span></a><span>
</span><a name="line-471"></a><span>        </span><a href="GHC.IO.Handle.Internals.html#flushByteReadBuffer"><span class="hs-identifier hs-var">flushByteReadBuffer</span></a><span> </span><a href="#local-6989586621679289366"><span class="hs-identifier hs-var">h_</span></a><span>
</span><a name="line-472"></a><span>    </span><a href="GHC.IO.Buffer.html#WriteBuffer"><span class="hs-identifier hs-var">WriteBuffer</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-473"></a><span>        </span><a href="GHC.IO.Handle.Internals.html#flushByteWriteBuffer"><span class="hs-identifier hs-var">flushByteWriteBuffer</span></a><span> </span><a href="#local-6989586621679289366"><span class="hs-identifier hs-var">h_</span></a><span>
</span><a name="line-474"></a><span>
</span><a name="line-475"></a><span class="hs-comment">-- | flushes the Char buffer only.  Works on all Handles.</span><span>
</span><a name="line-476"></a><span class="hs-identifier">flushCharBuffer</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-type">Handle__</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-477"></a><a name="flushCharBuffer"><a href="GHC.IO.Handle.Internals.html#flushCharBuffer"><span class="hs-identifier">flushCharBuffer</span></a></a><span> </span><a name="local-6989586621679289381"><a href="#local-6989586621679289381"><span class="hs-identifier">h_</span></a></a><span class="hs-glyph">@</span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-var">Handle__</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-478"></a><span>  </span><a name="local-6989586621679289395"><a href="#local-6989586621679289395"><span class="hs-identifier">cbuf</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IORef.html#readIORef"><span class="hs-identifier hs-var">readIORef</span></a><span> </span><a href="#local-6989586621679289387"><span class="hs-identifier hs-var">haCharBuffer</span></a><span>
</span><a name="line-479"></a><span>  </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">bufState</span><span> </span><a href="#local-6989586621679289395"><span class="hs-identifier hs-var">cbuf</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-480"></a><span>    </span><a href="GHC.IO.Buffer.html#ReadBuffer"><span class="hs-identifier hs-var">ReadBuffer</span></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-481"></a><span>        </span><a href="GHC.IO.Handle.Internals.html#flushCharReadBuffer"><span class="hs-identifier hs-var">flushCharReadBuffer</span></a><span> </span><a href="#local-6989586621679289381"><span class="hs-identifier hs-var">h_</span></a><span>
</span><a name="line-482"></a><span>    </span><a href="GHC.IO.Buffer.html#WriteBuffer"><span class="hs-identifier hs-var">WriteBuffer</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-483"></a><span>        </span><span class="hs-comment">-- Nothing to do here. Char buffer on a write Handle is always empty</span><span>
</span><a name="line-484"></a><span>        </span><span class="hs-comment">-- between Handle operations.</span><span>
</span><a name="line-485"></a><span>        </span><span class="hs-comment">-- See [note Buffer Flushing], GHC.IO.Handle.Types.</span><span>
</span><a name="line-486"></a><span>        </span><a href="GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a><span> </span><span class="hs-special">(</span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Classes.html#not"><span class="hs-identifier hs-var">not</span></a><span> </span><span class="hs-special">(</span><a href="GHC.IO.Buffer.html#isEmptyBuffer"><span class="hs-identifier hs-var">isEmptyBuffer</span></a><span> </span><a href="#local-6989586621679289395"><span class="hs-identifier hs-var">cbuf</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-487"></a><span>           </span><a href="GHC.Err.html#error"><span class="hs-identifier hs-var">error</span></a><span> </span><span class="hs-string">&quot;internal IO library error: Char buffer non-empty&quot;</span><span>
</span><a name="line-488"></a><span>
</span><a name="line-489"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-490"></a><span class="hs-comment">-- Writing data (flushing write buffers)</span><span>
</span><a name="line-491"></a><span>
</span><a name="line-492"></a><span class="hs-comment">-- flushWriteBuffer flushes the byte buffer iff it contains pending write</span><span>
</span><a name="line-493"></a><span class="hs-comment">-- data. Because the Char buffer on a write Handle is always empty between</span><span>
</span><a name="line-494"></a><span class="hs-comment">-- Handle operations (see [note Buffer Flushing], GHC.IO.Handle.Types),</span><span>
</span><a name="line-495"></a><span class="hs-comment">-- both buffers are empty after this.</span><span>
</span><a name="line-496"></a><span class="hs-identifier">flushWriteBuffer</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-type">Handle__</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-497"></a><a name="flushWriteBuffer"><a href="GHC.IO.Handle.Internals.html#flushWriteBuffer"><span class="hs-identifier">flushWriteBuffer</span></a></a><span> </span><a name="local-6989586621679289396"><a href="#local-6989586621679289396"><span class="hs-identifier">h_</span></a></a><span class="hs-glyph">@</span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-var">Handle__</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-498"></a><span>  </span><a name="local-6989586621679289410"><a href="#local-6989586621679289410"><span class="hs-identifier">buf</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IORef.html#readIORef"><span class="hs-identifier hs-var">readIORef</span></a><span> </span><a href="#local-6989586621679289399"><span class="hs-identifier hs-var">haByteBuffer</span></a><span>
</span><a name="line-499"></a><span>  </span><a href="GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a><span> </span><span class="hs-special">(</span><a href="GHC.IO.Buffer.html#isWriteBuffer"><span class="hs-identifier hs-var">isWriteBuffer</span></a><span> </span><a href="#local-6989586621679289410"><span class="hs-identifier hs-var">buf</span></a><span class="hs-special">)</span><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="GHC.IO.Handle.Internals.html#flushByteWriteBuffer"><span class="hs-identifier hs-var">flushByteWriteBuffer</span></a><span> </span><a href="#local-6989586621679289396"><span class="hs-identifier hs-var">h_</span></a><span>
</span><a name="line-500"></a><span>
</span><a name="line-501"></a><span class="hs-identifier">flushByteWriteBuffer</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-type">Handle__</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-502"></a><a name="flushByteWriteBuffer"><a href="GHC.IO.Handle.Internals.html#flushByteWriteBuffer"><span class="hs-identifier">flushByteWriteBuffer</span></a></a><span> </span><a name="local-6989586621679289411"><a href="#local-6989586621679289411"><span class="hs-identifier">h_</span></a></a><span class="hs-glyph">@</span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-var">Handle__</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-503"></a><span>  </span><a name="local-6989586621679289425"><a href="#local-6989586621679289425"><span class="hs-identifier">bbuf</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IORef.html#readIORef"><span class="hs-identifier hs-var">readIORef</span></a><span> </span><a href="#local-6989586621679289414"><span class="hs-identifier hs-var">haByteBuffer</span></a><span>
</span><a name="line-504"></a><span>  </span><a href="GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a><span> </span><span class="hs-special">(</span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Classes.html#not"><span class="hs-identifier hs-var">not</span></a><span> </span><span class="hs-special">(</span><a href="GHC.IO.Buffer.html#isEmptyBuffer"><span class="hs-identifier hs-var">isEmptyBuffer</span></a><span> </span><a href="#local-6989586621679289425"><span class="hs-identifier hs-var">bbuf</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-505"></a><span>    </span><a name="local-6989586621679289426"><a href="#local-6989586621679289426"><span class="hs-identifier">bbuf'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IO.BufferedIO.html#flushWriteBuffer"><span class="hs-identifier hs-var">Buffered.flushWriteBuffer</span></a><span> </span><a href="#local-6989586621679289412"><span class="hs-identifier hs-var">haDevice</span></a><span> </span><a href="#local-6989586621679289425"><span class="hs-identifier hs-var">bbuf</span></a><span>
</span><a name="line-506"></a><span>    </span><a href="GHC.IORef.html#writeIORef"><span class="hs-identifier hs-var">writeIORef</span></a><span> </span><a href="#local-6989586621679289414"><span class="hs-identifier hs-var">haByteBuffer</span></a><span> </span><a href="#local-6989586621679289426"><span class="hs-identifier hs-var">bbuf'</span></a><span>
</span><a name="line-507"></a><span>
</span><a name="line-508"></a><span class="hs-comment">-- write the contents of the CharBuffer to the Handle__.</span><span>
</span><a name="line-509"></a><span class="hs-comment">-- The data will be encoded and pushed to the byte buffer,</span><span>
</span><a name="line-510"></a><span class="hs-comment">-- flushing if the buffer becomes full.</span><span>
</span><a name="line-511"></a><span class="hs-identifier">writeCharBuffer</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-type">Handle__</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.Buffer.html#CharBuffer"><span class="hs-identifier hs-type">CharBuffer</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-512"></a><a name="writeCharBuffer"><a href="GHC.IO.Handle.Internals.html#writeCharBuffer"><span class="hs-identifier">writeCharBuffer</span></a></a><span> </span><a name="local-6989586621679289427"><a href="#local-6989586621679289427"><span class="hs-identifier">h_</span></a></a><span class="hs-glyph">@</span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-var">Handle__</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679289441"><a href="#local-6989586621679289441"><span class="hs-identifier">cbuf</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-513"></a><span>  </span><span class="hs-comment">--</span><span>
</span><a name="line-514"></a><span>  </span><a name="local-6989586621679289442"><a href="#local-6989586621679289442"><span class="hs-identifier">bbuf</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IORef.html#readIORef"><span class="hs-identifier hs-var">readIORef</span></a><span> </span><a href="#local-6989586621679289430"><span class="hs-identifier hs-var">haByteBuffer</span></a><span>
</span><a name="line-515"></a><span>
</span><a name="line-516"></a><span>  </span><a href="GHC.IO.Handle.Internals.html#debugIO"><span class="hs-identifier hs-var">debugIO</span></a><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;writeCharBuffer: cbuf=&quot;</span><span> </span><a href="GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="GHC.IO.Buffer.html#summaryBuffer"><span class="hs-identifier hs-var">summaryBuffer</span></a><span> </span><a href="#local-6989586621679289441"><span class="hs-identifier hs-var">cbuf</span></a><span> </span><a href="GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span>
</span><a name="line-517"></a><span>        </span><span class="hs-string">&quot; bbuf=&quot;</span><span> </span><a href="GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="GHC.IO.Buffer.html#summaryBuffer"><span class="hs-identifier hs-var">summaryBuffer</span></a><span> </span><a href="#local-6989586621679289442"><span class="hs-identifier hs-var">bbuf</span></a><span class="hs-special">)</span><span>
</span><a name="line-518"></a><span>
</span><a name="line-519"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679289444"><a href="#local-6989586621679289444"><span class="hs-identifier">cbuf'</span></a></a><span class="hs-special">,</span><a name="local-6989586621679289445"><a href="#local-6989586621679289445"><span class="hs-identifier">bbuf'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679289435"><span class="hs-identifier hs-var">haEncoder</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-520"></a><span>    </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.Encoding.html#latin1_encode"><span class="hs-identifier hs-var">latin1_encode</span></a><span> </span><a href="#local-6989586621679289441"><span class="hs-identifier hs-var">cbuf</span></a><span> </span><a href="#local-6989586621679289442"><span class="hs-identifier hs-var">bbuf</span></a><span>
</span><a name="line-521"></a><span>    </span><a href="GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621679289443"><a href="#local-6989586621679289443"><span class="hs-identifier">encoder</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="GHC.IO.Handle.Internals.html#streamEncode"><span class="hs-identifier hs-var">streamEncode</span></a><span> </span><a href="#local-6989586621679289443"><span class="hs-identifier hs-var">encoder</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679289441"><span class="hs-identifier hs-var">cbuf</span></a><span> </span><a href="#local-6989586621679289442"><span class="hs-identifier hs-var">bbuf</span></a><span>
</span><a name="line-522"></a><span>
</span><a name="line-523"></a><span>  </span><a href="GHC.IO.Handle.Internals.html#debugIO"><span class="hs-identifier hs-var">debugIO</span></a><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;writeCharBuffer after encoding: cbuf=&quot;</span><span> </span><a href="GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="GHC.IO.Buffer.html#summaryBuffer"><span class="hs-identifier hs-var">summaryBuffer</span></a><span> </span><a href="#local-6989586621679289444"><span class="hs-identifier hs-var">cbuf'</span></a><span> </span><a href="GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span>
</span><a name="line-524"></a><span>        </span><span class="hs-string">&quot; bbuf=&quot;</span><span> </span><a href="GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="GHC.IO.Buffer.html#summaryBuffer"><span class="hs-identifier hs-var">summaryBuffer</span></a><span> </span><a href="#local-6989586621679289445"><span class="hs-identifier hs-var">bbuf'</span></a><span class="hs-special">)</span><span>
</span><a name="line-525"></a><span>
</span><a name="line-526"></a><span>          </span><span class="hs-comment">-- flush the byte buffer if it is full</span><span>
</span><a name="line-527"></a><span>  </span><span class="hs-keyword">if</span><span> </span><a href="GHC.IO.Buffer.html#isFullBuffer"><span class="hs-identifier hs-var">isFullBuffer</span></a><span> </span><a href="#local-6989586621679289445"><span class="hs-identifier hs-var">bbuf'</span></a><span>
</span><a name="line-528"></a><span>          </span><span class="hs-comment">--  or we made no progress</span><span>
</span><a name="line-529"></a><span>     </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Classes.html#%7C%7C"><span class="hs-operator hs-var">||</span></a><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Classes.html#not"><span class="hs-identifier hs-var">not</span></a><span> </span><span class="hs-special">(</span><a href="GHC.IO.Buffer.html#isEmptyBuffer"><span class="hs-identifier hs-var">isEmptyBuffer</span></a><span> </span><a href="#local-6989586621679289444"><span class="hs-identifier hs-var">cbuf'</span></a><span class="hs-special">)</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Classes.html#%26%26"><span class="hs-operator hs-var">&amp;&amp;</span></a><span> </span><span class="hs-identifier">bufL</span><span> </span><a href="#local-6989586621679289444"><span class="hs-identifier hs-var">cbuf'</span></a><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a><span> </span><span class="hs-identifier">bufL</span><span> </span><a href="#local-6989586621679289441"><span class="hs-identifier hs-var">cbuf</span></a><span>
</span><a name="line-530"></a><span>          </span><span class="hs-comment">-- or the byte buffer has more elements than the user wanted buffered</span><span>
</span><a name="line-531"></a><span>     </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Classes.html#%7C%7C"><span class="hs-operator hs-var">||</span></a><span> </span><span class="hs-special">(</span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679289431"><span class="hs-identifier hs-var">haBufferMode</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-532"></a><span>          </span><a href="GHC.IO.Handle.Types.html#BlockBuffering"><span class="hs-identifier hs-var">BlockBuffering</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621679289446"><a href="#local-6989586621679289446"><span class="hs-identifier">s</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.Buffer.html#bufferElems"><span class="hs-identifier hs-var">bufferElems</span></a><span> </span><a href="#local-6989586621679289445"><span class="hs-identifier hs-var">bbuf'</span></a><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Classes.html#%3E%3D"><span class="hs-operator hs-var">&gt;=</span></a><span> </span><a href="#local-6989586621679289446"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-533"></a><span>          </span><a href="GHC.IO.Handle.Types.html#NoBuffering"><span class="hs-identifier hs-var">NoBuffering</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a><span>
</span><a name="line-534"></a><span>          </span><a name="local-6989586621679289447"><a href="#local-6989586621679289447"><span class="hs-identifier">_other</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a><span class="hs-special">)</span><span>
</span><a name="line-535"></a><span>    </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-536"></a><span>      </span><a name="local-6989586621679289448"><a href="#local-6989586621679289448"><span class="hs-identifier">bbuf''</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IO.BufferedIO.html#flushWriteBuffer"><span class="hs-identifier hs-var">Buffered.flushWriteBuffer</span></a><span> </span><a href="#local-6989586621679289428"><span class="hs-identifier hs-var">haDevice</span></a><span> </span><a href="#local-6989586621679289445"><span class="hs-identifier hs-var">bbuf'</span></a><span>
</span><a name="line-537"></a><span>      </span><a href="GHC.IORef.html#writeIORef"><span class="hs-identifier hs-var">writeIORef</span></a><span> </span><a href="#local-6989586621679289430"><span class="hs-identifier hs-var">haByteBuffer</span></a><span> </span><a href="#local-6989586621679289448"><span class="hs-identifier hs-var">bbuf''</span></a><span>
</span><a name="line-538"></a><span>    </span><span class="hs-keyword">else</span><span>
</span><a name="line-539"></a><span>      </span><a href="GHC.IORef.html#writeIORef"><span class="hs-identifier hs-var">writeIORef</span></a><span> </span><a href="#local-6989586621679289430"><span class="hs-identifier hs-var">haByteBuffer</span></a><span> </span><a href="#local-6989586621679289445"><span class="hs-identifier hs-var">bbuf'</span></a><span>
</span><a name="line-540"></a><span>
</span><a name="line-541"></a><span>  </span><span class="hs-keyword">if</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Classes.html#not"><span class="hs-identifier hs-var">not</span></a><span> </span><span class="hs-special">(</span><a href="GHC.IO.Buffer.html#isEmptyBuffer"><span class="hs-identifier hs-var">isEmptyBuffer</span></a><span> </span><a href="#local-6989586621679289444"><span class="hs-identifier hs-var">cbuf'</span></a><span class="hs-special">)</span><span>
</span><a name="line-542"></a><span>     </span><span class="hs-keyword">then</span><span> </span><a href="GHC.IO.Handle.Internals.html#writeCharBuffer"><span class="hs-identifier hs-var">writeCharBuffer</span></a><span> </span><a href="#local-6989586621679289427"><span class="hs-identifier hs-var">h_</span></a><span> </span><a href="#local-6989586621679289444"><span class="hs-identifier hs-var">cbuf'</span></a><span>
</span><a name="line-543"></a><span>     </span><span class="hs-keyword">else</span><span> </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-544"></a><span>
</span><a name="line-545"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-546"></a><span class="hs-comment">-- Flushing read buffers</span><span>
</span><a name="line-547"></a><span>
</span><a name="line-548"></a><span class="hs-comment">-- It is always possible to flush the Char buffer back to the byte buffer.</span><span>
</span><a name="line-549"></a><span class="hs-identifier">flushCharReadBuffer</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-type">Handle__</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-550"></a><a name="flushCharReadBuffer"><a href="GHC.IO.Handle.Internals.html#flushCharReadBuffer"><span class="hs-identifier">flushCharReadBuffer</span></a></a><span> </span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-var">Handle__</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-551"></a><span>  </span><a name="local-6989586621679289462"><a href="#local-6989586621679289462"><span class="hs-identifier">cbuf</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IORef.html#readIORef"><span class="hs-identifier hs-var">readIORef</span></a><span> </span><a href="#local-6989586621679289454"><span class="hs-identifier hs-var">haCharBuffer</span></a><span>
</span><a name="line-552"></a><span>  </span><span class="hs-keyword">if</span><span> </span><a href="GHC.IO.Buffer.html#isWriteBuffer"><span class="hs-identifier hs-var">isWriteBuffer</span></a><span> </span><a href="#local-6989586621679289462"><span class="hs-identifier hs-var">cbuf</span></a><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Classes.html#%7C%7C"><span class="hs-operator hs-var">||</span></a><span> </span><a href="GHC.IO.Buffer.html#isEmptyBuffer"><span class="hs-identifier hs-var">isEmptyBuffer</span></a><span> </span><a href="#local-6989586621679289462"><span class="hs-identifier hs-var">cbuf</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-553"></a><span>
</span><a name="line-554"></a><span>  </span><span class="hs-comment">-- haLastDecode is the byte buffer just before we did our last batch of</span><span>
</span><a name="line-555"></a><span>  </span><span class="hs-comment">-- decoding.  We're going to re-decode the bytes up to the current char,</span><span>
</span><a name="line-556"></a><span>  </span><span class="hs-comment">-- to find out where we should revert the byte buffer to.</span><span>
</span><a name="line-557"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679289463"><a href="#local-6989586621679289463"><span class="hs-identifier">codec_state</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679289464"><a href="#local-6989586621679289464"><span class="hs-identifier">bbuf0</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IORef.html#readIORef"><span class="hs-identifier hs-var">readIORef</span></a><span> </span><a href="#local-6989586621679289453"><span class="hs-identifier hs-var">haLastDecode</span></a><span>
</span><a name="line-558"></a><span>
</span><a name="line-559"></a><span>  </span><a name="local-6989586621679289465"><a href="#local-6989586621679289465"><span class="hs-identifier">cbuf0</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IORef.html#readIORef"><span class="hs-identifier hs-var">readIORef</span></a><span> </span><a href="#local-6989586621679289454"><span class="hs-identifier hs-var">haCharBuffer</span></a><span>
</span><a name="line-560"></a><span>  </span><a href="GHC.IORef.html#writeIORef"><span class="hs-identifier hs-var">writeIORef</span></a><span> </span><a href="#local-6989586621679289454"><span class="hs-identifier hs-var">haCharBuffer</span></a><span> </span><a href="#local-6989586621679289465"><span class="hs-identifier hs-var">cbuf0</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">bufL</span><span class="hs-glyph">=</span><span class="hs-number">0</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">bufR</span><span class="hs-glyph">=</span><span class="hs-number">0</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-561"></a><span>
</span><a name="line-562"></a><span>  </span><span class="hs-comment">-- if we haven't used any characters from the char buffer, then just</span><span>
</span><a name="line-563"></a><span>  </span><span class="hs-comment">-- re-install the old byte buffer.</span><span>
</span><a name="line-564"></a><span>  </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">bufL</span><span> </span><a href="#local-6989586621679289465"><span class="hs-identifier hs-var">cbuf0</span></a><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a><span> </span><span class="hs-number">0</span><span>
</span><a name="line-565"></a><span>     </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span> </span><a href="GHC.IORef.html#writeIORef"><span class="hs-identifier hs-var">writeIORef</span></a><span> </span><a href="#local-6989586621679289451"><span class="hs-identifier hs-var">haByteBuffer</span></a><span> </span><a href="#local-6989586621679289464"><span class="hs-identifier hs-var">bbuf0</span></a><span>
</span><a name="line-566"></a><span>             </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-567"></a><span>     </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-568"></a><span>
</span><a name="line-569"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679289457"><span class="hs-identifier hs-var">haDecoder</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-570"></a><span>    </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-571"></a><span>      </span><a href="GHC.IORef.html#writeIORef"><span class="hs-identifier hs-var">writeIORef</span></a><span> </span><a href="#local-6989586621679289451"><span class="hs-identifier hs-var">haByteBuffer</span></a><span> </span><a href="#local-6989586621679289464"><span class="hs-identifier hs-var">bbuf0</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">bufL</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">bufL</span><span> </span><a href="#local-6989586621679289464"><span class="hs-identifier hs-var">bbuf0</span></a><span> </span><a href="GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a><span> </span><span class="hs-identifier">bufL</span><span> </span><a href="#local-6989586621679289465"><span class="hs-identifier hs-var">cbuf0</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-572"></a><span>      </span><span class="hs-comment">-- no decoder: the number of bytes to decode is the same as the</span><span>
</span><a name="line-573"></a><span>      </span><span class="hs-comment">-- number of chars we have used up.</span><span>
</span><a name="line-574"></a><span>
</span><a name="line-575"></a><span>    </span><a href="GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621679289466"><a href="#local-6989586621679289466"><span class="hs-identifier">decoder</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-576"></a><span>      </span><a href="GHC.IO.Handle.Internals.html#debugIO"><span class="hs-identifier hs-var">debugIO</span></a><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;flushCharReadBuffer re-decode, bbuf=&quot;</span><span> </span><a href="GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="GHC.IO.Buffer.html#summaryBuffer"><span class="hs-identifier hs-var">summaryBuffer</span></a><span> </span><a href="#local-6989586621679289464"><span class="hs-identifier hs-var">bbuf0</span></a><span> </span><a href="GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span>
</span><a name="line-577"></a><span>               </span><span class="hs-string">&quot; cbuf=&quot;</span><span> </span><a href="GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="GHC.IO.Buffer.html#summaryBuffer"><span class="hs-identifier hs-var">summaryBuffer</span></a><span> </span><a href="#local-6989586621679289465"><span class="hs-identifier hs-var">cbuf0</span></a><span class="hs-special">)</span><span>
</span><a name="line-578"></a><span>
</span><a name="line-579"></a><span>      </span><span class="hs-comment">-- restore the codec state</span><span>
</span><a name="line-580"></a><span>      </span><span class="hs-identifier">setState</span><span> </span><a href="#local-6989586621679289466"><span class="hs-identifier hs-var">decoder</span></a><span> </span><a href="#local-6989586621679289463"><span class="hs-identifier hs-var">codec_state</span></a><span>
</span><a name="line-581"></a><span>
</span><a name="line-582"></a><span>      </span><span class="hs-special">(</span><a name="local-6989586621679289467"><a href="#local-6989586621679289467"><span class="hs-identifier">bbuf1</span></a></a><span class="hs-special">,</span><a name="local-6989586621679289468"><a href="#local-6989586621679289468"><span class="hs-identifier">cbuf1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><a href="GHC.IO.Handle.Internals.html#streamEncode"><span class="hs-identifier hs-var">streamEncode</span></a><span> </span><a href="#local-6989586621679289466"><span class="hs-identifier hs-var">decoder</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679289464"><span class="hs-identifier hs-var">bbuf0</span></a><span>
</span><a name="line-583"></a><span>                               </span><a href="#local-6989586621679289465"><span class="hs-identifier hs-var">cbuf0</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">bufL</span><span class="hs-glyph">=</span><span class="hs-number">0</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">bufR</span><span class="hs-glyph">=</span><span class="hs-number">0</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">bufSize</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">bufL</span><span> </span><a href="#local-6989586621679289465"><span class="hs-identifier hs-var">cbuf0</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-584"></a><span>
</span><a name="line-585"></a><span>      </span><a href="GHC.IO.Handle.Internals.html#debugIO"><span class="hs-identifier hs-var">debugIO</span></a><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;finished, bbuf=&quot;</span><span> </span><a href="GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="GHC.IO.Buffer.html#summaryBuffer"><span class="hs-identifier hs-var">summaryBuffer</span></a><span> </span><a href="#local-6989586621679289467"><span class="hs-identifier hs-var">bbuf1</span></a><span> </span><a href="GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span>
</span><a name="line-586"></a><span>               </span><span class="hs-string">&quot; cbuf=&quot;</span><span> </span><a href="GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="GHC.IO.Buffer.html#summaryBuffer"><span class="hs-identifier hs-var">summaryBuffer</span></a><span> </span><a href="#local-6989586621679289468"><span class="hs-identifier hs-var">cbuf1</span></a><span class="hs-special">)</span><span>
</span><a name="line-587"></a><span>
</span><a name="line-588"></a><span>      </span><a href="GHC.IORef.html#writeIORef"><span class="hs-identifier hs-var">writeIORef</span></a><span> </span><a href="#local-6989586621679289451"><span class="hs-identifier hs-var">haByteBuffer</span></a><span> </span><a href="#local-6989586621679289467"><span class="hs-identifier hs-var">bbuf1</span></a><span>
</span><a name="line-589"></a><span>
</span><a name="line-590"></a><span>
</span><a name="line-591"></a><span class="hs-comment">-- When flushing the byte read buffer, we seek backwards by the number</span><span>
</span><a name="line-592"></a><span class="hs-comment">-- of characters in the buffer.  The file descriptor must therefore be</span><span>
</span><a name="line-593"></a><span class="hs-comment">-- seekable: attempting to flush the read buffer on an unseekable</span><span>
</span><a name="line-594"></a><span class="hs-comment">-- handle is not allowed.</span><span>
</span><a name="line-595"></a><span>
</span><a name="line-596"></a><span class="hs-identifier">flushByteReadBuffer</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-type">Handle__</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-597"></a><a name="flushByteReadBuffer"><a href="GHC.IO.Handle.Internals.html#flushByteReadBuffer"><span class="hs-identifier">flushByteReadBuffer</span></a></a><span> </span><a name="local-6989586621679289469"><a href="#local-6989586621679289469"><span class="hs-identifier">h_</span></a></a><span class="hs-glyph">@</span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-var">Handle__</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-598"></a><span>  </span><a name="local-6989586621679289483"><a href="#local-6989586621679289483"><span class="hs-identifier">bbuf</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IORef.html#readIORef"><span class="hs-identifier hs-var">readIORef</span></a><span> </span><a href="#local-6989586621679289472"><span class="hs-identifier hs-var">haByteBuffer</span></a><span>
</span><a name="line-599"></a><span>
</span><a name="line-600"></a><span>  </span><span class="hs-keyword">if</span><span> </span><a href="GHC.IO.Buffer.html#isEmptyBuffer"><span class="hs-identifier hs-var">isEmptyBuffer</span></a><span> </span><a href="#local-6989586621679289483"><span class="hs-identifier hs-var">bbuf</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-601"></a><span>
</span><a name="line-602"></a><span>  </span><a name="local-6989586621679289484"><a href="#local-6989586621679289484"><span class="hs-identifier">seekable</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IO.Device.html#isSeekable"><span class="hs-identifier hs-var">IODevice.isSeekable</span></a><span> </span><a href="#local-6989586621679289470"><span class="hs-identifier hs-var">haDevice</span></a><span>
</span><a name="line-603"></a><span>  </span><a href="GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a><span> </span><span class="hs-special">(</span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Classes.html#not"><span class="hs-identifier hs-var">not</span></a><span> </span><a href="#local-6989586621679289484"><span class="hs-identifier hs-var">seekable</span></a><span class="hs-special">)</span><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="GHC.IO.Handle.Internals.html#ioe_cannotFlushNotSeekable"><span class="hs-identifier hs-var">ioe_cannotFlushNotSeekable</span></a><span>
</span><a name="line-604"></a><span>
</span><a name="line-605"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679289485"><a href="#local-6989586621679289485"><span class="hs-identifier">seek</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.Num.html#negate"><span class="hs-identifier hs-var">negate</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">bufR</span><span> </span><a href="#local-6989586621679289483"><span class="hs-identifier hs-var">bbuf</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-identifier">bufL</span><span> </span><a href="#local-6989586621679289483"><span class="hs-identifier hs-var">bbuf</span></a><span class="hs-special">)</span><span>
</span><a name="line-606"></a><span>
</span><a name="line-607"></a><span>  </span><a href="GHC.IO.Handle.Internals.html#debugIO"><span class="hs-identifier hs-var">debugIO</span></a><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;flushByteReadBuffer: new file offset = &quot;</span><span> </span><a href="GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="GHC.Show.html#show"><span class="hs-identifier hs-var">show</span></a><span> </span><a href="#local-6989586621679289485"><span class="hs-identifier hs-var">seek</span></a><span class="hs-special">)</span><span>
</span><a name="line-608"></a><span>  </span><a href="GHC.IO.Device.html#seek"><span class="hs-identifier hs-var">IODevice.seek</span></a><span> </span><a href="#local-6989586621679289470"><span class="hs-identifier hs-var">haDevice</span></a><span> </span><a href="GHC.IO.Device.html#RelativeSeek"><span class="hs-identifier hs-var">RelativeSeek</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a><span> </span><a href="#local-6989586621679289485"><span class="hs-identifier hs-var">seek</span></a><span class="hs-special">)</span><span>
</span><a name="line-609"></a><span>
</span><a name="line-610"></a><span>  </span><a href="GHC.IORef.html#writeIORef"><span class="hs-identifier hs-var">writeIORef</span></a><span> </span><a href="#local-6989586621679289472"><span class="hs-identifier hs-var">haByteBuffer</span></a><span> </span><a href="#local-6989586621679289483"><span class="hs-identifier hs-var">bbuf</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">bufL</span><span class="hs-glyph">=</span><span class="hs-number">0</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">bufR</span><span class="hs-glyph">=</span><span class="hs-number">0</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-611"></a><span>
</span><a name="line-612"></a><span class="hs-comment">-- ----------------------------------------------------------------------------</span><span>
</span><a name="line-613"></a><span class="hs-comment">-- Making Handles</span><span>
</span><a name="line-614"></a><span>
</span><a name="line-615"></a><span class="hs-identifier">mkHandle</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="GHC.IO.Device.html#IODevice"><span class="hs-identifier hs-type">IODevice</span></a><span> </span><a href="#local-6989586621679289168"><span class="hs-identifier hs-type">dev</span></a><span class="hs-special">,</span><span> </span><a href="GHC.IO.BufferedIO.html#BufferedIO"><span class="hs-identifier hs-type">BufferedIO</span></a><span> </span><a href="#local-6989586621679289168"><span class="hs-identifier hs-type">dev</span></a><span class="hs-special">,</span><span> </span><a href="Data.Typeable.Internal.html#Typeable"><span class="hs-identifier hs-type">Typeable</span></a><span> </span><a href="#local-6989586621679289168"><span class="hs-identifier hs-type">dev</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679289168"><span class="hs-identifier hs-type">dev</span></a><span>
</span><a name="line-616"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.html#FilePath"><span class="hs-identifier hs-type">FilePath</span></a><span>
</span><a name="line-617"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.Handle.Types.html#HandleType"><span class="hs-identifier hs-type">HandleType</span></a><span>
</span><a name="line-618"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a><span>                     </span><span class="hs-comment">-- buffered?</span><span>
</span><a name="line-619"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="GHC.IO.Encoding.Types.html#TextEncoding"><span class="hs-identifier hs-type">TextEncoding</span></a><span>
</span><a name="line-620"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.Handle.Types.html#NewlineMode"><span class="hs-identifier hs-type">NewlineMode</span></a><span>
</span><a name="line-621"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="GHC.IO.Handle.Internals.html#HandleFinalizer"><span class="hs-identifier hs-type">HandleFinalizer</span></a><span>
</span><a name="line-622"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><span class="hs-special">(</span><a href="GHC.MVar.html#MVar"><span class="hs-identifier hs-type">MVar</span></a><span> </span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-type">Handle__</span></a><span class="hs-special">)</span><span>
</span><a name="line-623"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="GHC.IO.Handle.Types.html#Handle"><span class="hs-identifier hs-type">Handle</span></a><span>
</span><a name="line-624"></a><span>
</span><a name="line-625"></a><a name="mkHandle"><a href="GHC.IO.Handle.Internals.html#mkHandle"><span class="hs-identifier">mkHandle</span></a></a><span> </span><a name="local-6989586621679289486"><a href="#local-6989586621679289486"><span class="hs-identifier">dev</span></a></a><span> </span><a name="local-6989586621679289487"><a href="#local-6989586621679289487"><span class="hs-identifier">filepath</span></a></a><span> </span><a name="local-6989586621679289488"><a href="#local-6989586621679289488"><span class="hs-identifier">ha_type</span></a></a><span> </span><a name="local-6989586621679289489"><a href="#local-6989586621679289489"><span class="hs-identifier">buffered</span></a></a><span> </span><a name="local-6989586621679289490"><a href="#local-6989586621679289490"><span class="hs-identifier">mb_codec</span></a></a><span> </span><a name="local-6989586621679289491"><a href="#local-6989586621679289491"><span class="hs-identifier">nl</span></a></a><span> </span><a name="local-6989586621679289492"><a href="#local-6989586621679289492"><span class="hs-identifier">finalizer</span></a></a><span> </span><a name="local-6989586621679289493"><a href="#local-6989586621679289493"><span class="hs-identifier">other_side</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-626"></a><span>   </span><a href="GHC.IO.Handle.Internals.html#openTextEncoding"><span class="hs-identifier hs-var">openTextEncoding</span></a><span> </span><a href="#local-6989586621679289490"><span class="hs-identifier hs-var">mb_codec</span></a><span> </span><a href="#local-6989586621679289488"><span class="hs-identifier hs-var">ha_type</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621679289494"><a href="#local-6989586621679289494"><span class="hs-identifier">mb_encoder</span></a></a><span> </span><a name="local-6989586621679289495"><a href="#local-6989586621679289495"><span class="hs-identifier">mb_decoder</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-627"></a><span>
</span><a name="line-628"></a><span>   </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679289496"><a href="#local-6989586621679289496"><span class="hs-identifier">buf_state</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.Handle.Internals.html#initBufferState"><span class="hs-identifier hs-var">initBufferState</span></a><span> </span><a href="#local-6989586621679289488"><span class="hs-identifier hs-var">ha_type</span></a><span>
</span><a name="line-629"></a><span>   </span><a name="local-6989586621679289497"><a href="#local-6989586621679289497"><span class="hs-identifier">bbuf</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IO.BufferedIO.html#newBuffer"><span class="hs-identifier hs-var">Buffered.newBuffer</span></a><span> </span><a href="#local-6989586621679289486"><span class="hs-identifier hs-var">dev</span></a><span> </span><a href="#local-6989586621679289496"><span class="hs-identifier hs-var">buf_state</span></a><span>
</span><a name="line-630"></a><span>   </span><a name="local-6989586621679289498"><a href="#local-6989586621679289498"><span class="hs-identifier">bbufref</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IORef.html#newIORef"><span class="hs-identifier hs-var">newIORef</span></a><span> </span><a href="#local-6989586621679289497"><span class="hs-identifier hs-var">bbuf</span></a><span>
</span><a name="line-631"></a><span>   </span><a name="local-6989586621679289499"><a href="#local-6989586621679289499"><span class="hs-identifier">last_decode</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IORef.html#newIORef"><span class="hs-identifier hs-var">newIORef</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Err.html#errorWithoutStackTrace"><span class="hs-identifier hs-var">errorWithoutStackTrace</span></a><span> </span><span class="hs-string">&quot;codec_state&quot;</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679289497"><span class="hs-identifier hs-var">bbuf</span></a><span class="hs-special">)</span><span>
</span><a name="line-632"></a><span>
</span><a name="line-633"></a><span>   </span><span class="hs-special">(</span><a name="local-6989586621679289500"><a href="#local-6989586621679289500"><span class="hs-identifier">cbufref</span></a></a><span class="hs-special">,</span><a name="local-6989586621679289501"><a href="#local-6989586621679289501"><span class="hs-identifier">bmode</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-634"></a><span>         </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679289489"><span class="hs-identifier hs-var">buffered</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="GHC.IO.Handle.Internals.html#getCharBuffer"><span class="hs-identifier hs-var">getCharBuffer</span></a><span> </span><a href="#local-6989586621679289486"><span class="hs-identifier hs-var">dev</span></a><span> </span><a href="#local-6989586621679289496"><span class="hs-identifier hs-var">buf_state</span></a><span>
</span><a name="line-635"></a><span>                     </span><span class="hs-keyword">else</span><span> </span><a href="GHC.IO.Handle.Internals.html#mkUnBuffer"><span class="hs-identifier hs-var">mkUnBuffer</span></a><span> </span><a href="#local-6989586621679289496"><span class="hs-identifier hs-var">buf_state</span></a><span>
</span><a name="line-636"></a><span>
</span><a name="line-637"></a><span>   </span><a name="local-6989586621679289502"><a href="#local-6989586621679289502"><span class="hs-identifier">spares</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IORef.html#newIORef"><span class="hs-identifier hs-var">newIORef</span></a><span> </span><a href="GHC.IO.Handle.Types.html#BufferListNil"><span class="hs-identifier hs-var">BufferListNil</span></a><span>
</span><a name="line-638"></a><span>   </span><a href="GHC.IO.Handle.Internals.html#newFileHandle"><span class="hs-identifier hs-var">newFileHandle</span></a><span> </span><a href="#local-6989586621679289487"><span class="hs-identifier hs-var">filepath</span></a><span> </span><a href="#local-6989586621679289492"><span class="hs-identifier hs-var">finalizer</span></a><span>
</span><a name="line-639"></a><span>            </span><span class="hs-special">(</span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-var">Handle__</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">haDevice</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679289486"><span class="hs-identifier hs-var">dev</span></a><span class="hs-special">,</span><span>
</span><a name="line-640"></a><span>                        </span><span class="hs-identifier">haType</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679289488"><span class="hs-identifier hs-var">ha_type</span></a><span class="hs-special">,</span><span>
</span><a name="line-641"></a><span>                        </span><span class="hs-identifier">haBufferMode</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679289501"><span class="hs-identifier hs-var">bmode</span></a><span class="hs-special">,</span><span>
</span><a name="line-642"></a><span>                        </span><span class="hs-identifier">haByteBuffer</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679289498"><span class="hs-identifier hs-var">bbufref</span></a><span class="hs-special">,</span><span>
</span><a name="line-643"></a><span>                        </span><span class="hs-identifier">haLastDecode</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679289499"><span class="hs-identifier hs-var">last_decode</span></a><span class="hs-special">,</span><span>
</span><a name="line-644"></a><span>                        </span><span class="hs-identifier">haCharBuffer</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679289500"><span class="hs-identifier hs-var">cbufref</span></a><span class="hs-special">,</span><span>
</span><a name="line-645"></a><span>                        </span><span class="hs-identifier">haBuffers</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679289502"><span class="hs-identifier hs-var">spares</span></a><span class="hs-special">,</span><span>
</span><a name="line-646"></a><span>                        </span><span class="hs-identifier">haEncoder</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679289494"><span class="hs-identifier hs-var">mb_encoder</span></a><span class="hs-special">,</span><span>
</span><a name="line-647"></a><span>                        </span><span class="hs-identifier">haDecoder</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679289495"><span class="hs-identifier hs-var">mb_decoder</span></a><span class="hs-special">,</span><span>
</span><a name="line-648"></a><span>                        </span><span class="hs-identifier">haCodec</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679289490"><span class="hs-identifier hs-var">mb_codec</span></a><span class="hs-special">,</span><span>
</span><a name="line-649"></a><span>                        </span><span class="hs-identifier">haInputNL</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">inputNL</span><span> </span><a href="#local-6989586621679289491"><span class="hs-identifier hs-var">nl</span></a><span class="hs-special">,</span><span>
</span><a name="line-650"></a><span>                        </span><span class="hs-identifier">haOutputNL</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">outputNL</span><span> </span><a href="#local-6989586621679289491"><span class="hs-identifier hs-var">nl</span></a><span class="hs-special">,</span><span>
</span><a name="line-651"></a><span>                        </span><span class="hs-identifier">haOtherSide</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679289493"><span class="hs-identifier hs-var">other_side</span></a><span>
</span><a name="line-652"></a><span>                      </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-653"></a><span>
</span><a name="line-654"></a><span class="hs-comment">-- | makes a new 'Handle'</span><span>
</span><a name="line-655"></a><span class="hs-identifier">mkFileHandle</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="GHC.IO.Device.html#IODevice"><span class="hs-identifier hs-type">IODevice</span></a><span> </span><a href="#local-6989586621679289167"><span class="hs-identifier hs-type">dev</span></a><span class="hs-special">,</span><span> </span><a href="GHC.IO.BufferedIO.html#BufferedIO"><span class="hs-identifier hs-type">BufferedIO</span></a><span> </span><a href="#local-6989586621679289167"><span class="hs-identifier hs-type">dev</span></a><span class="hs-special">,</span><span> </span><a href="Data.Typeable.Internal.html#Typeable"><span class="hs-identifier hs-type">Typeable</span></a><span> </span><a href="#local-6989586621679289167"><span class="hs-identifier hs-type">dev</span></a><span class="hs-special">)</span><span>
</span><a name="line-656"></a><span>             </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679289167"><span class="hs-identifier hs-type">dev</span></a><span> </span><span class="hs-comment">-- ^ the underlying IO device, which must support</span><span>
</span><a name="line-657"></a><span>                    </span><span class="hs-comment">-- 'IODevice', 'BufferedIO' and 'Typeable'</span><span>
</span><a name="line-658"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.html#FilePath"><span class="hs-identifier hs-type">FilePath</span></a><span>
</span><a name="line-659"></a><span>                    </span><span class="hs-comment">-- ^ a string describing the 'Handle', e.g. the file</span><span>
</span><a name="line-660"></a><span>                    </span><span class="hs-comment">-- path for a file.  Used in error messages.</span><span>
</span><a name="line-661"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.IOMode.html#IOMode"><span class="hs-identifier hs-type">IOMode</span></a><span>
</span><a name="line-662"></a><span>                    </span><span class="hs-comment">-- The mode in which the 'Handle' is to be used</span><span>
</span><a name="line-663"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="GHC.IO.Encoding.Types.html#TextEncoding"><span class="hs-identifier hs-type">TextEncoding</span></a><span>
</span><a name="line-664"></a><span>                    </span><span class="hs-comment">-- Create the 'Handle' with no text encoding?</span><span>
</span><a name="line-665"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.Handle.Types.html#NewlineMode"><span class="hs-identifier hs-type">NewlineMode</span></a><span>
</span><a name="line-666"></a><span>                    </span><span class="hs-comment">-- Translate newlines?</span><span>
</span><a name="line-667"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="GHC.IO.Handle.Types.html#Handle"><span class="hs-identifier hs-type">Handle</span></a><span>
</span><a name="line-668"></a><a name="mkFileHandle"><a href="GHC.IO.Handle.Internals.html#mkFileHandle"><span class="hs-identifier">mkFileHandle</span></a></a><span> </span><a name="local-6989586621679289503"><a href="#local-6989586621679289503"><span class="hs-identifier">dev</span></a></a><span> </span><a name="local-6989586621679289504"><a href="#local-6989586621679289504"><span class="hs-identifier">filepath</span></a></a><span> </span><a name="local-6989586621679289505"><a href="#local-6989586621679289505"><span class="hs-identifier">iomode</span></a></a><span> </span><a name="local-6989586621679289506"><a href="#local-6989586621679289506"><span class="hs-identifier">mb_codec</span></a></a><span> </span><a name="local-6989586621679289507"><a href="#local-6989586621679289507"><span class="hs-identifier">tr_newlines</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-669"></a><span>   </span><a href="GHC.IO.Handle.Internals.html#mkHandle"><span class="hs-identifier hs-var">mkHandle</span></a><span> </span><a href="#local-6989586621679289503"><span class="hs-identifier hs-var">dev</span></a><span> </span><a href="#local-6989586621679289504"><span class="hs-identifier hs-var">filepath</span></a><span> </span><span class="hs-special">(</span><a href="GHC.IO.Handle.Internals.html#ioModeToHandleType"><span class="hs-identifier hs-var">ioModeToHandleType</span></a><span> </span><a href="#local-6989586621679289505"><span class="hs-identifier hs-var">iomode</span></a><span class="hs-special">)</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a><span class="hs-comment">{-buffered-}</span><span> </span><a href="#local-6989586621679289506"><span class="hs-identifier hs-var">mb_codec</span></a><span>
</span><a name="line-670"></a><span>            </span><a href="#local-6989586621679289507"><span class="hs-identifier hs-var">tr_newlines</span></a><span>
</span><a name="line-671"></a><span>            </span><span class="hs-special">(</span><a href="GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="GHC.IO.Handle.Internals.html#handleFinalizer"><span class="hs-identifier hs-var">handleFinalizer</span></a><span class="hs-special">)</span><span> </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span class="hs-comment">{-other_side-}</span><span>
</span><a name="line-672"></a><span>
</span><a name="line-673"></a><span class="hs-comment">-- | like 'mkFileHandle', except that a 'Handle' is created with two</span><span>
</span><a name="line-674"></a><span class="hs-comment">-- independent buffers, one for reading and one for writing.  Used for</span><span>
</span><a name="line-675"></a><span class="hs-comment">-- full-duplex streams, such as network sockets.</span><span>
</span><a name="line-676"></a><span class="hs-identifier">mkDuplexHandle</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="GHC.IO.Device.html#IODevice"><span class="hs-identifier hs-type">IODevice</span></a><span> </span><a href="#local-6989586621679289166"><span class="hs-identifier hs-type">dev</span></a><span class="hs-special">,</span><span> </span><a href="GHC.IO.BufferedIO.html#BufferedIO"><span class="hs-identifier hs-type">BufferedIO</span></a><span> </span><a href="#local-6989586621679289166"><span class="hs-identifier hs-type">dev</span></a><span class="hs-special">,</span><span> </span><a href="Data.Typeable.Internal.html#Typeable"><span class="hs-identifier hs-type">Typeable</span></a><span> </span><a href="#local-6989586621679289166"><span class="hs-identifier hs-type">dev</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679289166"><span class="hs-identifier hs-type">dev</span></a><span>
</span><a name="line-677"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.html#FilePath"><span class="hs-identifier hs-type">FilePath</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="GHC.IO.Encoding.Types.html#TextEncoding"><span class="hs-identifier hs-type">TextEncoding</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.Handle.Types.html#NewlineMode"><span class="hs-identifier hs-type">NewlineMode</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="GHC.IO.Handle.Types.html#Handle"><span class="hs-identifier hs-type">Handle</span></a><span>
</span><a name="line-678"></a><a name="mkDuplexHandle"><a href="GHC.IO.Handle.Internals.html#mkDuplexHandle"><span class="hs-identifier">mkDuplexHandle</span></a></a><span> </span><a name="local-6989586621679289508"><a href="#local-6989586621679289508"><span class="hs-identifier">dev</span></a></a><span> </span><a name="local-6989586621679289509"><a href="#local-6989586621679289509"><span class="hs-identifier">filepath</span></a></a><span> </span><a name="local-6989586621679289510"><a href="#local-6989586621679289510"><span class="hs-identifier">mb_codec</span></a></a><span> </span><a name="local-6989586621679289511"><a href="#local-6989586621679289511"><span class="hs-identifier">tr_newlines</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-679"></a><span>
</span><a name="line-680"></a><span>  </span><a name="local-6989586621679289512"><a href="#local-6989586621679289512"><span class="hs-identifier">write_side</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="GHC.IO.Handle.Types.html#FileHandle"><span class="hs-identifier hs-var">FileHandle</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679289513"><a href="#local-6989586621679289513"><span class="hs-identifier">write_m</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-681"></a><span>       </span><a href="GHC.IO.Handle.Internals.html#mkHandle"><span class="hs-identifier hs-var">mkHandle</span></a><span> </span><a href="#local-6989586621679289508"><span class="hs-identifier hs-var">dev</span></a><span> </span><a href="#local-6989586621679289509"><span class="hs-identifier hs-var">filepath</span></a><span> </span><a href="GHC.IO.Handle.Types.html#WriteHandle"><span class="hs-identifier hs-var">WriteHandle</span></a><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a><span> </span><a href="#local-6989586621679289510"><span class="hs-identifier hs-var">mb_codec</span></a><span>
</span><a name="line-682"></a><span>                        </span><a href="#local-6989586621679289511"><span class="hs-identifier hs-var">tr_newlines</span></a><span>
</span><a name="line-683"></a><span>                        </span><span class="hs-special">(</span><a href="GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="GHC.IO.Handle.Internals.html#handleFinalizer"><span class="hs-identifier hs-var">handleFinalizer</span></a><span class="hs-special">)</span><span>
</span><a name="line-684"></a><span>                        </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><span class="hs-comment">-- no othersie</span><span>
</span><a name="line-685"></a><span>
</span><a name="line-686"></a><span>  </span><a name="local-6989586621679289514"><a href="#local-6989586621679289514"><span class="hs-identifier">read_side</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="GHC.IO.Handle.Types.html#FileHandle"><span class="hs-identifier hs-var">FileHandle</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679289515"><a href="#local-6989586621679289515"><span class="hs-identifier">read_m</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-687"></a><span>      </span><a href="GHC.IO.Handle.Internals.html#mkHandle"><span class="hs-identifier hs-var">mkHandle</span></a><span> </span><a href="#local-6989586621679289508"><span class="hs-identifier hs-var">dev</span></a><span> </span><a href="#local-6989586621679289509"><span class="hs-identifier hs-var">filepath</span></a><span> </span><a href="GHC.IO.Handle.Types.html#ReadHandle"><span class="hs-identifier hs-var">ReadHandle</span></a><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a><span> </span><a href="#local-6989586621679289510"><span class="hs-identifier hs-var">mb_codec</span></a><span>
</span><a name="line-688"></a><span>                        </span><a href="#local-6989586621679289511"><span class="hs-identifier hs-var">tr_newlines</span></a><span>
</span><a name="line-689"></a><span>                        </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><span class="hs-comment">-- no finalizer</span><span>
</span><a name="line-690"></a><span>                        </span><span class="hs-special">(</span><a href="GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="#local-6989586621679289513"><span class="hs-identifier hs-var">write_m</span></a><span class="hs-special">)</span><span>
</span><a name="line-691"></a><span>
</span><a name="line-692"></a><span>  </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="GHC.IO.Handle.Types.html#DuplexHandle"><span class="hs-identifier hs-var">DuplexHandle</span></a><span> </span><a href="#local-6989586621679289509"><span class="hs-identifier hs-var">filepath</span></a><span> </span><a href="#local-6989586621679289515"><span class="hs-identifier hs-var">read_m</span></a><span> </span><a href="#local-6989586621679289513"><span class="hs-identifier hs-var">write_m</span></a><span class="hs-special">)</span><span>
</span><a name="line-693"></a><span>
</span><a name="line-694"></a><span class="hs-identifier">ioModeToHandleType</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.IO.IOMode.html#IOMode"><span class="hs-identifier hs-type">IOMode</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.Handle.Types.html#HandleType"><span class="hs-identifier hs-type">HandleType</span></a><span>
</span><a name="line-695"></a><a name="ioModeToHandleType"><a href="GHC.IO.Handle.Internals.html#ioModeToHandleType"><span class="hs-identifier">ioModeToHandleType</span></a></a><span> </span><a href="GHC.IO.IOMode.html#ReadMode"><span class="hs-identifier hs-var">ReadMode</span></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.Handle.Types.html#ReadHandle"><span class="hs-identifier hs-var">ReadHandle</span></a><span>
</span><a name="line-696"></a><span class="hs-identifier">ioModeToHandleType</span><span> </span><a href="GHC.IO.IOMode.html#WriteMode"><span class="hs-identifier hs-var">WriteMode</span></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.Handle.Types.html#WriteHandle"><span class="hs-identifier hs-var">WriteHandle</span></a><span>
</span><a name="line-697"></a><span class="hs-identifier">ioModeToHandleType</span><span> </span><a href="GHC.IO.IOMode.html#ReadWriteMode"><span class="hs-identifier hs-var">ReadWriteMode</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.Handle.Types.html#ReadWriteHandle"><span class="hs-identifier hs-var">ReadWriteHandle</span></a><span>
</span><a name="line-698"></a><span class="hs-identifier">ioModeToHandleType</span><span> </span><a href="GHC.IO.IOMode.html#AppendMode"><span class="hs-identifier hs-var">AppendMode</span></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.Handle.Types.html#AppendHandle"><span class="hs-identifier hs-var">AppendHandle</span></a><span>
</span><a name="line-699"></a><span>
</span><a name="line-700"></a><span class="hs-identifier">initBufferState</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.IO.Handle.Types.html#HandleType"><span class="hs-identifier hs-type">HandleType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.Buffer.html#BufferState"><span class="hs-identifier hs-type">BufferState</span></a><span>
</span><a name="line-701"></a><a name="initBufferState"><a href="GHC.IO.Handle.Internals.html#initBufferState"><span class="hs-identifier">initBufferState</span></a></a><span> </span><a href="GHC.IO.Handle.Types.html#ReadHandle"><span class="hs-identifier hs-var">ReadHandle</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.Buffer.html#ReadBuffer"><span class="hs-identifier hs-var">ReadBuffer</span></a><span>
</span><a name="line-702"></a><span class="hs-identifier">initBufferState</span><span> </span><span class="hs-identifier">_</span><span>          </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.Buffer.html#WriteBuffer"><span class="hs-identifier hs-var">WriteBuffer</span></a><span>
</span><a name="line-703"></a><span>
</span><a name="line-704"></a><span class="hs-identifier">openTextEncoding</span><span>
</span><a name="line-705"></a><span>   </span><span class="hs-glyph">::</span><span> </span><a href="GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="GHC.IO.Encoding.Types.html#TextEncoding"><span class="hs-identifier hs-type">TextEncoding</span></a><span>
</span><a name="line-706"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.Handle.Types.html#HandleType"><span class="hs-identifier hs-type">HandleType</span></a><span>
</span><a name="line-707"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679289164"><a href="#local-6989586621679289164"><span class="hs-identifier">es</span></a></a><span> </span><a name="local-6989586621679289165"><a href="#local-6989586621679289165"><span class="hs-identifier">ds</span></a></a><span> </span><span class="hs-operator">.</span><span> </span><a href="GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><span class="hs-special">(</span><a href="GHC.IO.Encoding.Types.html#TextEncoder"><span class="hs-identifier hs-type">TextEncoder</span></a><span> </span><a href="#local-6989586621679289164"><span class="hs-identifier hs-type">es</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><span class="hs-special">(</span><a href="GHC.IO.Encoding.Types.html#TextDecoder"><span class="hs-identifier hs-type">TextDecoder</span></a><span> </span><a href="#local-6989586621679289165"><span class="hs-identifier hs-type">ds</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="#local-6989586621679289163"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-708"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="#local-6989586621679289163"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-709"></a><span>
</span><a name="line-710"></a><a name="openTextEncoding"><a href="GHC.IO.Handle.Internals.html#openTextEncoding"><span class="hs-identifier">openTextEncoding</span></a></a><span> </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>   </span><a name="local-6989586621679289516"><a href="#local-6989586621679289516"><span class="hs-identifier">ha_type</span></a></a><span> </span><a name="local-6989586621679289517"><a href="#local-6989586621679289517"><span class="hs-identifier">cont</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679289517"><span class="hs-identifier hs-var">cont</span></a><span> </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>
</span><a name="line-711"></a><span class="hs-identifier">openTextEncoding</span><span> </span><span class="hs-special">(</span><a href="GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="GHC.IO.Encoding.Types.html#TextEncoding"><span class="hs-identifier hs-var">TextEncoding</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621679289521"><a href="#local-6989586621679289521"><span class="hs-identifier">ha_type</span></a></a><span> </span><a name="local-6989586621679289522"><a href="#local-6989586621679289522"><span class="hs-identifier">cont</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-712"></a><span>    </span><a name="local-6989586621679289524"><a href="#local-6989586621679289524"><span class="hs-identifier">mb_decoder</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="GHC.IO.Handle.Types.html#isReadableHandleType"><span class="hs-identifier hs-var">isReadableHandleType</span></a><span> </span><a href="#local-6989586621679289521"><span class="hs-identifier hs-var">ha_type</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-713"></a><span>                     </span><a name="local-6989586621679289523"><a href="#local-6989586621679289523"><span class="hs-identifier">decoder</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679289519"><span class="hs-identifier hs-var">mkTextDecoder</span></a><span>
</span><a name="line-714"></a><span>                     </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="#local-6989586621679289523"><span class="hs-identifier hs-var">decoder</span></a><span class="hs-special">)</span><span>
</span><a name="line-715"></a><span>                  </span><span class="hs-keyword">else</span><span>
</span><a name="line-716"></a><span>                     </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>
</span><a name="line-717"></a><span>    </span><a name="local-6989586621679289526"><a href="#local-6989586621679289526"><span class="hs-identifier">mb_encoder</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="GHC.IO.Handle.Types.html#isWritableHandleType"><span class="hs-identifier hs-var">isWritableHandleType</span></a><span> </span><a href="#local-6989586621679289521"><span class="hs-identifier hs-var">ha_type</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-718"></a><span>                     </span><a name="local-6989586621679289525"><a href="#local-6989586621679289525"><span class="hs-identifier">encoder</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679289520"><span class="hs-identifier hs-var">mkTextEncoder</span></a><span>
</span><a name="line-719"></a><span>                     </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="#local-6989586621679289525"><span class="hs-identifier hs-var">encoder</span></a><span class="hs-special">)</span><span>
</span><a name="line-720"></a><span>                  </span><span class="hs-keyword">else</span><span>
</span><a name="line-721"></a><span>                     </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>
</span><a name="line-722"></a><span>    </span><a href="#local-6989586621679289522"><span class="hs-identifier hs-var">cont</span></a><span> </span><a href="#local-6989586621679289526"><span class="hs-identifier hs-var">mb_encoder</span></a><span> </span><a href="#local-6989586621679289524"><span class="hs-identifier hs-var">mb_decoder</span></a><span>
</span><a name="line-723"></a><span>
</span><a name="line-724"></a><span class="hs-identifier">closeTextCodecs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-type">Handle__</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-725"></a><a name="closeTextCodecs"><a href="GHC.IO.Handle.Internals.html#closeTextCodecs"><span class="hs-identifier">closeTextCodecs</span></a></a><span> </span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-var">Handle__</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-726"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679289535"><span class="hs-identifier hs-var">haDecoder</span></a><span> </span><span class="hs-keyword">of</span><span> </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">;</span><span> </span><a href="GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621679289540"><a href="#local-6989586621679289540"><span class="hs-identifier">d</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Encoding.close</span><span> </span><a href="#local-6989586621679289540"><span class="hs-identifier hs-var">d</span></a><span>
</span><a name="line-727"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679289534"><span class="hs-identifier hs-var">haEncoder</span></a><span> </span><span class="hs-keyword">of</span><span> </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">;</span><span> </span><a href="GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621679289541"><a href="#local-6989586621679289541"><span class="hs-identifier">d</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Encoding.close</span><span> </span><a href="#local-6989586621679289541"><span class="hs-identifier hs-var">d</span></a><span>
</span><a name="line-728"></a><span>
</span><a name="line-729"></a><span class="hs-comment">-- ---------------------------------------------------------------------------</span><span>
</span><a name="line-730"></a><span class="hs-comment">-- closing Handles</span><span>
</span><a name="line-731"></a><span>
</span><a name="line-732"></a><span class="hs-comment">-- hClose_help is also called by lazyRead (in GHC.IO.Handle.Text) when</span><span>
</span><a name="line-733"></a><span class="hs-comment">-- EOF is read or an IO error occurs on a lazy stream.  The</span><span>
</span><a name="line-734"></a><span class="hs-comment">-- semi-closed Handle is then closed immediately.  We have to be</span><span>
</span><a name="line-735"></a><span class="hs-comment">-- careful with DuplexHandles though: we have to leave the closing to</span><span>
</span><a name="line-736"></a><span class="hs-comment">-- the finalizer in that case, because the write side may still be in</span><span>
</span><a name="line-737"></a><span class="hs-comment">-- use.</span><span>
</span><a name="line-738"></a><span class="hs-identifier">hClose_help</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-type">Handle__</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-type">Handle__</span></a><span class="hs-special">,</span><span> </span><a href="GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="GHC.Exception.html#SomeException"><span class="hs-identifier hs-type">SomeException</span></a><span class="hs-special">)</span><span>
</span><a name="line-739"></a><a name="hClose_help"><a href="GHC.IO.Handle.Internals.html#hClose_help"><span class="hs-identifier">hClose_help</span></a></a><span> </span><a name="local-6989586621679289542"><a href="#local-6989586621679289542"><span class="hs-identifier">handle_</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-740"></a><span>  </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">haType</span><span> </span><a href="#local-6989586621679289542"><span class="hs-identifier hs-var">handle_</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-741"></a><span>      </span><a href="GHC.IO.Handle.Types.html#ClosedHandle"><span class="hs-identifier hs-var">ClosedHandle</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679289542"><span class="hs-identifier hs-var">handle_</span></a><span class="hs-special">,</span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span class="hs-special">)</span><span>
</span><a name="line-742"></a><span>      </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621679289543"><a href="#local-6989586621679289543"><span class="hs-identifier">mb_exc1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IO.Handle.Internals.html#trymaybe"><span class="hs-identifier hs-var">trymaybe</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="GHC.IO.Handle.Internals.html#flushWriteBuffer"><span class="hs-identifier hs-var">flushWriteBuffer</span></a><span> </span><a href="#local-6989586621679289542"><span class="hs-identifier hs-var">handle_</span></a><span> </span><span class="hs-comment">-- interruptible</span><span>
</span><a name="line-743"></a><span>                    </span><span class="hs-comment">-- it is important that hClose doesn't fail and</span><span>
</span><a name="line-744"></a><span>                    </span><span class="hs-comment">-- leave the Handle open (#3128), so we catch</span><span>
</span><a name="line-745"></a><span>                    </span><span class="hs-comment">-- exceptions when flushing the buffer.</span><span>
</span><a name="line-746"></a><span>              </span><span class="hs-special">(</span><a name="local-6989586621679289544"><a href="#local-6989586621679289544"><span class="hs-identifier">h_</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679289545"><a href="#local-6989586621679289545"><span class="hs-identifier">mb_exc2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IO.Handle.Internals.html#hClose_handle_"><span class="hs-identifier hs-var">hClose_handle_</span></a><span> </span><a href="#local-6989586621679289542"><span class="hs-identifier hs-var">handle_</span></a><span>
</span><a name="line-747"></a><span>              </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679289544"><span class="hs-identifier hs-var">h_</span></a><span class="hs-special">,</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="Data.Maybe.html#isJust"><span class="hs-identifier hs-var">isJust</span></a><span> </span><a href="#local-6989586621679289543"><span class="hs-identifier hs-var">mb_exc1</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621679289543"><span class="hs-identifier hs-var">mb_exc1</span></a><span> </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621679289545"><span class="hs-identifier hs-var">mb_exc2</span></a><span class="hs-special">)</span><span>
</span><a name="line-748"></a><span>
</span><a name="line-749"></a><span>
</span><a name="line-750"></a><span class="hs-identifier">trymaybe</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="GHC.Exception.html#SomeException"><span class="hs-identifier hs-type">SomeException</span></a><span class="hs-special">)</span><span>
</span><a name="line-751"></a><a name="trymaybe"><a href="GHC.IO.Handle.Internals.html#trymaybe"><span class="hs-identifier">trymaybe</span></a></a><span> </span><a name="local-6989586621679289546"><a href="#local-6989586621679289546"><span class="hs-identifier">io</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">do</span><span> </span><a href="#local-6989586621679289546"><span class="hs-identifier hs-var">io</span></a><span class="hs-special">;</span><span> </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><a href="GHC.IO.html#catchException"><span class="hs-identifier hs-var">catchException</span></a><span class="hs-special">`</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679289547"><a href="#local-6989586621679289547"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="#local-6989586621679289547"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-752"></a><span>
</span><a name="line-753"></a><span class="hs-identifier">hClose_handle_</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-type">Handle__</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-type">Handle__</span></a><span class="hs-special">,</span><span> </span><a href="GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="GHC.Exception.html#SomeException"><span class="hs-identifier hs-type">SomeException</span></a><span class="hs-special">)</span><span>
</span><a name="line-754"></a><a name="hClose_handle_"><a href="GHC.IO.Handle.Internals.html#hClose_handle_"><span class="hs-identifier">hClose_handle_</span></a></a><span> </span><a name="local-6989586621679289548"><a href="#local-6989586621679289548"><span class="hs-identifier">h_</span></a></a><span class="hs-glyph">@</span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-var">Handle__</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-755"></a><span>
</span><a name="line-756"></a><span>    </span><span class="hs-comment">-- close the file descriptor, but not when this is the read</span><span>
</span><a name="line-757"></a><span>    </span><span class="hs-comment">-- side of a duplex handle.</span><span>
</span><a name="line-758"></a><span>    </span><span class="hs-comment">-- If an exception is raised by the close(), we want to continue</span><span>
</span><a name="line-759"></a><span>    </span><span class="hs-comment">-- to close the handle and release the lock if it has one, then</span><span>
</span><a name="line-760"></a><span>    </span><span class="hs-comment">-- we return the exception to the caller of hClose_help which can</span><span>
</span><a name="line-761"></a><span>    </span><span class="hs-comment">-- raise it if necessary.</span><span>
</span><a name="line-762"></a><span>    </span><a name="local-6989586621679289562"><a href="#local-6989586621679289562"><span class="hs-identifier">maybe_exception</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-763"></a><span>      </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679289561"><span class="hs-identifier hs-var">haOtherSide</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-764"></a><span>        </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.Handle.Internals.html#trymaybe"><span class="hs-identifier hs-var">trymaybe</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="GHC.IO.Device.html#close"><span class="hs-identifier hs-var">IODevice.close</span></a><span> </span><a href="#local-6989586621679289549"><span class="hs-identifier hs-var">haDevice</span></a><span>
</span><a name="line-765"></a><span>        </span><a href="GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>
</span><a name="line-766"></a><span>
</span><a name="line-767"></a><span>    </span><span class="hs-comment">-- free the spare buffers</span><span>
</span><a name="line-768"></a><span>    </span><a href="GHC.IORef.html#writeIORef"><span class="hs-identifier hs-var">writeIORef</span></a><span> </span><a href="#local-6989586621679289555"><span class="hs-identifier hs-var">haBuffers</span></a><span> </span><a href="GHC.IO.Handle.Types.html#BufferListNil"><span class="hs-identifier hs-var">BufferListNil</span></a><span>
</span><a name="line-769"></a><span>    </span><a href="GHC.IORef.html#writeIORef"><span class="hs-identifier hs-var">writeIORef</span></a><span> </span><a href="#local-6989586621679289554"><span class="hs-identifier hs-var">haCharBuffer</span></a><span> </span><a href="GHC.IO.Handle.Internals.html#noCharBuffer"><span class="hs-identifier hs-var">noCharBuffer</span></a><span>
</span><a name="line-770"></a><span>    </span><a href="GHC.IORef.html#writeIORef"><span class="hs-identifier hs-var">writeIORef</span></a><span> </span><a href="#local-6989586621679289551"><span class="hs-identifier hs-var">haByteBuffer</span></a><span> </span><a href="GHC.IO.Handle.Internals.html#noByteBuffer"><span class="hs-identifier hs-var">noByteBuffer</span></a><span>
</span><a name="line-771"></a><span>
</span><a name="line-772"></a><span>    </span><span class="hs-comment">-- release our encoder/decoder</span><span>
</span><a name="line-773"></a><span>    </span><a href="GHC.IO.Handle.Internals.html#closeTextCodecs"><span class="hs-identifier hs-var">closeTextCodecs</span></a><span> </span><a href="#local-6989586621679289548"><span class="hs-identifier hs-var">h_</span></a><span>
</span><a name="line-774"></a><span>
</span><a name="line-775"></a><span>    </span><span class="hs-comment">-- we must set the fd to -1, because the finalizer is going</span><span>
</span><a name="line-776"></a><span>    </span><span class="hs-comment">-- to run eventually and try to close/unlock it.</span><span>
</span><a name="line-777"></a><span>    </span><span class="hs-comment">-- ToDo: necessary?  the handle will be marked ClosedHandle</span><span>
</span><a name="line-778"></a><span>    </span><span class="hs-comment">-- XXX GHC won't let us use record update here, hence wildcards</span><span>
</span><a name="line-779"></a><span>    </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-var">Handle__</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">haType</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.Handle.Types.html#ClosedHandle"><span class="hs-identifier hs-var">ClosedHandle</span></a><span class="hs-special">,</span><span> </span><span class="hs-glyph">..</span><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679289562"><span class="hs-identifier hs-var">maybe_exception</span></a><span class="hs-special">)</span><span>
</span><a name="line-780"></a><span>
</span><a name="line-781"></a><span class="hs-pragma">{-# NOINLINE</span><span> </span><span class="hs-pragma">noCharBuffer</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-782"></a><span class="hs-identifier">noCharBuffer</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.IO.Buffer.html#CharBuffer"><span class="hs-identifier hs-type">CharBuffer</span></a><span>
</span><a name="line-783"></a><a name="noCharBuffer"><a href="GHC.IO.Handle.Internals.html#noCharBuffer"><span class="hs-identifier">noCharBuffer</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.Unsafe.html#unsafePerformIO"><span class="hs-identifier hs-var">unsafePerformIO</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="GHC.IO.Buffer.html#newCharBuffer"><span class="hs-identifier hs-var">newCharBuffer</span></a><span> </span><span class="hs-number">1</span><span> </span><a href="GHC.IO.Buffer.html#ReadBuffer"><span class="hs-identifier hs-var">ReadBuffer</span></a><span>
</span><a name="line-784"></a><span>
</span><a name="line-785"></a><span class="hs-pragma">{-# NOINLINE</span><span> </span><span class="hs-pragma">noByteBuffer</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-786"></a><span class="hs-identifier">noByteBuffer</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.IO.Buffer.html#Buffer"><span class="hs-identifier hs-type">Buffer</span></a><span> </span><a href="GHC.Word.html#Word8"><span class="hs-identifier hs-type">Word8</span></a><span>
</span><a name="line-787"></a><a name="noByteBuffer"><a href="GHC.IO.Handle.Internals.html#noByteBuffer"><span class="hs-identifier">noByteBuffer</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.Unsafe.html#unsafePerformIO"><span class="hs-identifier hs-var">unsafePerformIO</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="GHC.IO.Buffer.html#newByteBuffer"><span class="hs-identifier hs-var">newByteBuffer</span></a><span> </span><span class="hs-number">1</span><span> </span><a href="GHC.IO.Buffer.html#ReadBuffer"><span class="hs-identifier hs-var">ReadBuffer</span></a><span>
</span><a name="line-788"></a><span>
</span><a name="line-789"></a><span class="hs-comment">-- ---------------------------------------------------------------------------</span><span>
</span><a name="line-790"></a><span class="hs-comment">-- Looking ahead</span><span>
</span><a name="line-791"></a><span>
</span><a name="line-792"></a><span class="hs-identifier">hLookAhead_</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-type">Handle__</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#Char"><span class="hs-identifier hs-type">Char</span></a><span>
</span><a name="line-793"></a><a name="hLookAhead_"><a href="GHC.IO.Handle.Internals.html#hLookAhead_"><span class="hs-identifier">hLookAhead_</span></a></a><span> </span><a name="local-6989586621679289563"><a href="#local-6989586621679289563"><span class="hs-identifier">handle_</span></a></a><span class="hs-glyph">@</span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-var">Handle__</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-794"></a><span>    </span><a name="local-6989586621679289577"><a href="#local-6989586621679289577"><span class="hs-identifier">buf</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IORef.html#readIORef"><span class="hs-identifier hs-var">readIORef</span></a><span> </span><a href="#local-6989586621679289569"><span class="hs-identifier hs-var">haCharBuffer</span></a><span>
</span><a name="line-795"></a><span>
</span><a name="line-796"></a><span>    </span><span class="hs-comment">-- fill up the read buffer if necessary</span><span>
</span><a name="line-797"></a><span>    </span><a name="local-6989586621679289578"><a href="#local-6989586621679289578"><span class="hs-identifier">new_buf</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="GHC.IO.Buffer.html#isEmptyBuffer"><span class="hs-identifier hs-var">isEmptyBuffer</span></a><span> </span><a href="#local-6989586621679289577"><span class="hs-identifier hs-var">buf</span></a><span>
</span><a name="line-798"></a><span>                  </span><span class="hs-keyword">then</span><span> </span><a href="GHC.IO.Handle.Internals.html#readTextDevice"><span class="hs-identifier hs-var">readTextDevice</span></a><span> </span><a href="#local-6989586621679289563"><span class="hs-identifier hs-var">handle_</span></a><span> </span><a href="#local-6989586621679289577"><span class="hs-identifier hs-var">buf</span></a><span>
</span><a name="line-799"></a><span>                  </span><span class="hs-keyword">else</span><span> </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621679289577"><span class="hs-identifier hs-var">buf</span></a><span>
</span><a name="line-800"></a><span>    </span><a href="GHC.IORef.html#writeIORef"><span class="hs-identifier hs-var">writeIORef</span></a><span> </span><a href="#local-6989586621679289569"><span class="hs-identifier hs-var">haCharBuffer</span></a><span> </span><a href="#local-6989586621679289578"><span class="hs-identifier hs-var">new_buf</span></a><span>
</span><a name="line-801"></a><span>
</span><a name="line-802"></a><span>    </span><a href="GHC.IO.Buffer.html#peekCharBuf"><span class="hs-identifier hs-var">peekCharBuf</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">bufRaw</span><span> </span><a href="#local-6989586621679289577"><span class="hs-identifier hs-var">buf</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">bufL</span><span> </span><a href="#local-6989586621679289577"><span class="hs-identifier hs-var">buf</span></a><span class="hs-special">)</span><span>
</span><a name="line-803"></a><span>
</span><a name="line-804"></a><span class="hs-comment">-- ---------------------------------------------------------------------------</span><span>
</span><a name="line-805"></a><span class="hs-comment">-- debugging</span><span>
</span><a name="line-806"></a><span>
</span><a name="line-807"></a><span class="hs-identifier">debugIO</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-808"></a><a name="debugIO"><a href="GHC.IO.Handle.Internals.html#debugIO"><span class="hs-identifier">debugIO</span></a></a><span> </span><a name="local-6989586621679289579"><a href="#local-6989586621679289579"><span class="hs-identifier">s</span></a></a><span>
</span><a name="line-809"></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="GHC.IO.Handle.Internals.html#c_DEBUG_DUMP"><span class="hs-identifier hs-var">c_DEBUG_DUMP</span></a><span>
</span><a name="line-810"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Foreign.C.String.html#withCStringLen"><span class="hs-identifier hs-var">withCStringLen</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679289579"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><span class="hs-string">&quot;\n&quot;</span><span class="hs-special">)</span><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-811"></a><span>                  </span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621679289580"><a href="#local-6989586621679289580"><span class="hs-identifier">p</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679289581"><a href="#local-6989586621679289581"><span class="hs-identifier">len</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="System.Posix.Internals.html#c_write"><span class="hs-identifier hs-var">c_write</span></a><span> </span><span class="hs-number">1</span><span> </span><span class="hs-special">(</span><a href="GHC.Ptr.html#castPtr"><span class="hs-identifier hs-var">castPtr</span></a><span> </span><a href="#local-6989586621679289580"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a><span> </span><a href="#local-6989586621679289581"><span class="hs-identifier hs-var">len</span></a><span class="hs-special">)</span><span>
</span><a name="line-812"></a><span>         </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-813"></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-814"></a><span>
</span><a name="line-815"></a><span class="hs-comment">-- ----------------------------------------------------------------------------</span><span>
</span><a name="line-816"></a><span class="hs-comment">-- Text input/output</span><span>
</span><a name="line-817"></a><span>
</span><a name="line-818"></a><span class="hs-comment">-- Read characters into the provided buffer.  Return when any</span><span>
</span><a name="line-819"></a><span class="hs-comment">-- characters are available; raise an exception if the end of</span><span>
</span><a name="line-820"></a><span class="hs-comment">-- file is reached.</span><span>
</span><a name="line-821"></a><span class="hs-comment">--</span><span>
</span><a name="line-822"></a><span class="hs-comment">-- In uses of readTextDevice within base, the input buffer is either:</span><span>
</span><a name="line-823"></a><span class="hs-comment">--   * empty</span><span>
</span><a name="line-824"></a><span class="hs-comment">--   * or contains a single \r (when doing newline translation)</span><span>
</span><a name="line-825"></a><span class="hs-comment">--</span><span>
</span><a name="line-826"></a><span class="hs-comment">-- The input character buffer must have a capacity at least 1 greater</span><span>
</span><a name="line-827"></a><span class="hs-comment">-- than the number of elements it currently contains.</span><span>
</span><a name="line-828"></a><span class="hs-comment">--</span><span>
</span><a name="line-829"></a><span class="hs-comment">-- Users of this function expect that the buffer returned contains</span><span>
</span><a name="line-830"></a><span class="hs-comment">-- at least 1 more character than the input buffer.</span><span>
</span><a name="line-831"></a><span class="hs-identifier">readTextDevice</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-type">Handle__</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.Buffer.html#CharBuffer"><span class="hs-identifier hs-type">CharBuffer</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="GHC.IO.Buffer.html#CharBuffer"><span class="hs-identifier hs-type">CharBuffer</span></a><span>
</span><a name="line-832"></a><a name="readTextDevice"><a href="GHC.IO.Handle.Internals.html#readTextDevice"><span class="hs-identifier">readTextDevice</span></a></a><span> </span><a name="local-6989586621679289582"><a href="#local-6989586621679289582"><span class="hs-identifier">h_</span></a></a><span class="hs-glyph">@</span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-var">Handle__</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><a name="local-6989586621679289596"><a href="#local-6989586621679289596"><span class="hs-identifier">cbuf</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-833"></a><span>  </span><span class="hs-comment">--</span><span>
</span><a name="line-834"></a><span>  </span><a name="local-6989586621679289597"><a href="#local-6989586621679289597"><span class="hs-identifier">bbuf0</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IORef.html#readIORef"><span class="hs-identifier hs-var">readIORef</span></a><span> </span><a href="#local-6989586621679289585"><span class="hs-identifier hs-var">haByteBuffer</span></a><span>
</span><a name="line-835"></a><span>
</span><a name="line-836"></a><span>  </span><a href="GHC.IO.Handle.Internals.html#debugIO"><span class="hs-identifier hs-var">debugIO</span></a><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;readTextDevice: cbuf=&quot;</span><span> </span><a href="GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="GHC.IO.Buffer.html#summaryBuffer"><span class="hs-identifier hs-var">summaryBuffer</span></a><span> </span><a href="#local-6989586621679289596"><span class="hs-identifier hs-var">cbuf</span></a><span> </span><a href="GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span>
</span><a name="line-837"></a><span>        </span><span class="hs-string">&quot; bbuf=&quot;</span><span> </span><a href="GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="GHC.IO.Buffer.html#summaryBuffer"><span class="hs-identifier hs-var">summaryBuffer</span></a><span> </span><a href="#local-6989586621679289597"><span class="hs-identifier hs-var">bbuf0</span></a><span class="hs-special">)</span><span>
</span><a name="line-838"></a><span>
</span><a name="line-839"></a><span>  </span><a name="local-6989586621679289600"><a href="#local-6989586621679289600"><span class="hs-identifier">bbuf1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Classes.html#not"><span class="hs-identifier hs-var">not</span></a><span> </span><span class="hs-special">(</span><a href="GHC.IO.Buffer.html#isEmptyBuffer"><span class="hs-identifier hs-var">isEmptyBuffer</span></a><span> </span><a href="#local-6989586621679289597"><span class="hs-identifier hs-var">bbuf0</span></a><span class="hs-special">)</span><span>
</span><a name="line-840"></a><span>              </span><span class="hs-keyword">then</span><span> </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621679289597"><span class="hs-identifier hs-var">bbuf0</span></a><span>
</span><a name="line-841"></a><span>              </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-842"></a><span>                   </span><span class="hs-special">(</span><a name="local-6989586621679289598"><a href="#local-6989586621679289598"><span class="hs-identifier">r</span></a></a><span class="hs-special">,</span><a name="local-6989586621679289599"><a href="#local-6989586621679289599"><span class="hs-identifier">bbuf1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IO.BufferedIO.html#fillReadBuffer"><span class="hs-identifier hs-var">Buffered.fillReadBuffer</span></a><span> </span><a href="#local-6989586621679289583"><span class="hs-identifier hs-var">haDevice</span></a><span> </span><a href="#local-6989586621679289597"><span class="hs-identifier hs-var">bbuf0</span></a><span>
</span><a name="line-843"></a><span>                   </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679289598"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-keyword">then</span><span> </span><a href="GHC.IO.Handle.Internals.html#ioe_EOF"><span class="hs-identifier hs-var">ioe_EOF</span></a><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-comment">-- raise EOF</span><span>
</span><a name="line-844"></a><span>                   </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621679289599"><span class="hs-identifier hs-var">bbuf1</span></a><span>
</span><a name="line-845"></a><span>
</span><a name="line-846"></a><span>  </span><a href="GHC.IO.Handle.Internals.html#debugIO"><span class="hs-identifier hs-var">debugIO</span></a><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;readTextDevice after reading: bbuf=&quot;</span><span> </span><a href="GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="GHC.IO.Buffer.html#summaryBuffer"><span class="hs-identifier hs-var">summaryBuffer</span></a><span> </span><a href="#local-6989586621679289600"><span class="hs-identifier hs-var">bbuf1</span></a><span class="hs-special">)</span><span>
</span><a name="line-847"></a><span>
</span><a name="line-848"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679289603"><a href="#local-6989586621679289603"><span class="hs-identifier">bbuf2</span></a></a><span class="hs-special">,</span><a name="local-6989586621679289604"><a href="#local-6989586621679289604"><span class="hs-identifier">cbuf'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-849"></a><span>      </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679289591"><span class="hs-identifier hs-var">haDecoder</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-850"></a><span>          </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-851"></a><span>               </span><a href="GHC.IORef.html#writeIORef"><span class="hs-identifier hs-var">writeIORef</span></a><span> </span><a href="#local-6989586621679289587"><span class="hs-identifier hs-var">haLastDecode</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Err.html#errorWithoutStackTrace"><span class="hs-identifier hs-var">errorWithoutStackTrace</span></a><span> </span><span class="hs-string">&quot;codec_state&quot;</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679289600"><span class="hs-identifier hs-var">bbuf1</span></a><span class="hs-special">)</span><span>
</span><a name="line-852"></a><span>               </span><a href="GHC.IO.Encoding.html#latin1_decode"><span class="hs-identifier hs-var">latin1_decode</span></a><span> </span><a href="#local-6989586621679289600"><span class="hs-identifier hs-var">bbuf1</span></a><span> </span><a href="#local-6989586621679289596"><span class="hs-identifier hs-var">cbuf</span></a><span>
</span><a name="line-853"></a><span>          </span><a href="GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621679289601"><a href="#local-6989586621679289601"><span class="hs-identifier">decoder</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-854"></a><span>               </span><a name="local-6989586621679289602"><a href="#local-6989586621679289602"><span class="hs-identifier">state</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">getState</span><span> </span><a href="#local-6989586621679289601"><span class="hs-identifier hs-var">decoder</span></a><span>
</span><a name="line-855"></a><span>               </span><a href="GHC.IORef.html#writeIORef"><span class="hs-identifier hs-var">writeIORef</span></a><span> </span><a href="#local-6989586621679289587"><span class="hs-identifier hs-var">haLastDecode</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679289602"><span class="hs-identifier hs-var">state</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679289600"><span class="hs-identifier hs-var">bbuf1</span></a><span class="hs-special">)</span><span>
</span><a name="line-856"></a><span>               </span><span class="hs-special">(</span><a href="GHC.IO.Handle.Internals.html#streamEncode"><span class="hs-identifier hs-var">streamEncode</span></a><span> </span><a href="#local-6989586621679289601"><span class="hs-identifier hs-var">decoder</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679289600"><span class="hs-identifier hs-var">bbuf1</span></a><span> </span><a href="#local-6989586621679289596"><span class="hs-identifier hs-var">cbuf</span></a><span>
</span><a name="line-857"></a><span>
</span><a name="line-858"></a><span>  </span><a href="GHC.IO.Handle.Internals.html#debugIO"><span class="hs-identifier hs-var">debugIO</span></a><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;readTextDevice after decoding: cbuf=&quot;</span><span> </span><a href="GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="GHC.IO.Buffer.html#summaryBuffer"><span class="hs-identifier hs-var">summaryBuffer</span></a><span> </span><a href="#local-6989586621679289604"><span class="hs-identifier hs-var">cbuf'</span></a><span> </span><a href="GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span>
</span><a name="line-859"></a><span>        </span><span class="hs-string">&quot; bbuf=&quot;</span><span> </span><a href="GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="GHC.IO.Buffer.html#summaryBuffer"><span class="hs-identifier hs-var">summaryBuffer</span></a><span> </span><a href="#local-6989586621679289603"><span class="hs-identifier hs-var">bbuf2</span></a><span class="hs-special">)</span><span>
</span><a name="line-860"></a><span>
</span><a name="line-861"></a><span>  </span><span class="hs-comment">-- We can't return from readTextDevice without reading at least a single extra character,</span><span>
</span><a name="line-862"></a><span>  </span><span class="hs-comment">-- so check that we have managed to achieve that</span><span>
</span><a name="line-863"></a><span>  </span><a href="GHC.IORef.html#writeIORef"><span class="hs-identifier hs-var">writeIORef</span></a><span> </span><a href="#local-6989586621679289585"><span class="hs-identifier hs-var">haByteBuffer</span></a><span> </span><a href="#local-6989586621679289603"><span class="hs-identifier hs-var">bbuf2</span></a><span>
</span><a name="line-864"></a><span>  </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">bufR</span><span> </span><a href="#local-6989586621679289604"><span class="hs-identifier hs-var">cbuf'</span></a><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a><span> </span><span class="hs-identifier">bufR</span><span> </span><a href="#local-6989586621679289596"><span class="hs-identifier hs-var">cbuf</span></a><span>
</span><a name="line-865"></a><span>     </span><span class="hs-comment">-- we need more bytes to make a Char. NB: bbuf2 may be empty (even though bbuf1 wasn't) when we</span><span>
</span><a name="line-866"></a><span>     </span><span class="hs-comment">-- are using an encoding that can skip bytes without outputting characters, such as UTF8//IGNORE</span><span>
</span><a name="line-867"></a><span>     </span><span class="hs-keyword">then</span><span> </span><a href="GHC.IO.Handle.Internals.html#readTextDevice%27"><span class="hs-identifier hs-var">readTextDevice'</span></a><span> </span><a href="#local-6989586621679289582"><span class="hs-identifier hs-var">h_</span></a><span> </span><a href="#local-6989586621679289603"><span class="hs-identifier hs-var">bbuf2</span></a><span> </span><a href="#local-6989586621679289596"><span class="hs-identifier hs-var">cbuf</span></a><span>
</span><a name="line-868"></a><span>     </span><span class="hs-keyword">else</span><span> </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621679289604"><span class="hs-identifier hs-var">cbuf'</span></a><span>
</span><a name="line-869"></a><span>
</span><a name="line-870"></a><span class="hs-comment">-- we have an incomplete byte sequence at the end of the buffer: try to</span><span>
</span><a name="line-871"></a><span class="hs-comment">-- read more bytes.</span><span>
</span><a name="line-872"></a><span class="hs-identifier">readTextDevice'</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-type">Handle__</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.Buffer.html#Buffer"><span class="hs-identifier hs-type">Buffer</span></a><span> </span><a href="GHC.Word.html#Word8"><span class="hs-identifier hs-type">Word8</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.Buffer.html#CharBuffer"><span class="hs-identifier hs-type">CharBuffer</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="GHC.IO.Buffer.html#CharBuffer"><span class="hs-identifier hs-type">CharBuffer</span></a><span>
</span><a name="line-873"></a><a name="readTextDevice%27"><a href="GHC.IO.Handle.Internals.html#readTextDevice%27"><span class="hs-identifier">readTextDevice'</span></a></a><span> </span><a name="local-6989586621679289605"><a href="#local-6989586621679289605"><span class="hs-identifier">h_</span></a></a><span class="hs-glyph">@</span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-var">Handle__</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><a name="local-6989586621679289619"><a href="#local-6989586621679289619"><span class="hs-identifier">bbuf0</span></a></a><span> </span><a name="local-6989586621679289620"><a href="#local-6989586621679289620"><span class="hs-identifier">cbuf0</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-874"></a><span>  </span><span class="hs-comment">--</span><span>
</span><a name="line-875"></a><span>  </span><span class="hs-comment">-- copy the partial sequence to the beginning of the buffer, so we have</span><span>
</span><a name="line-876"></a><span>  </span><span class="hs-comment">-- room to read more bytes.</span><span>
</span><a name="line-877"></a><span>  </span><a name="local-6989586621679289621"><a href="#local-6989586621679289621"><span class="hs-identifier">bbuf1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IO.Buffer.html#slideContents"><span class="hs-identifier hs-var">slideContents</span></a><span> </span><a href="#local-6989586621679289619"><span class="hs-identifier hs-var">bbuf0</span></a><span>
</span><a name="line-878"></a><span>
</span><a name="line-879"></a><span>  </span><span class="hs-comment">-- readTextDevice only calls us if we got some bytes but not some characters.</span><span>
</span><a name="line-880"></a><span>  </span><span class="hs-comment">-- This can't occur if haDecoder is Nothing because latin1_decode accepts all bytes.</span><span>
</span><a name="line-881"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a href="GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621679289622"><a href="#local-6989586621679289622"><span class="hs-identifier">decoder</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679289614"><span class="hs-identifier hs-var">haDecoder</span></a><span>
</span><a name="line-882"></a><span>
</span><a name="line-883"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679289623"><a href="#local-6989586621679289623"><span class="hs-identifier">r</span></a></a><span class="hs-special">,</span><a name="local-6989586621679289624"><a href="#local-6989586621679289624"><span class="hs-identifier">bbuf2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IO.BufferedIO.html#fillReadBuffer"><span class="hs-identifier hs-var">Buffered.fillReadBuffer</span></a><span> </span><a href="#local-6989586621679289606"><span class="hs-identifier hs-var">haDevice</span></a><span> </span><a href="#local-6989586621679289621"><span class="hs-identifier hs-var">bbuf1</span></a><span>
</span><a name="line-884"></a><span>  </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679289623"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a><span> </span><span class="hs-number">0</span><span>
</span><a name="line-885"></a><span>   </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-886"></a><span>     </span><span class="hs-comment">-- bbuf2 can be empty here when we encounter an invalid byte sequence at the end of the input</span><span>
</span><a name="line-887"></a><span>     </span><span class="hs-comment">-- with a //IGNORE codec which consumes bytes without outputting characters</span><span>
</span><a name="line-888"></a><span>     </span><span class="hs-keyword">if</span><span> </span><a href="GHC.IO.Buffer.html#isEmptyBuffer"><span class="hs-identifier hs-var">isEmptyBuffer</span></a><span> </span><a href="#local-6989586621679289624"><span class="hs-identifier hs-var">bbuf2</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="GHC.IO.Handle.Internals.html#ioe_EOF"><span class="hs-identifier hs-var">ioe_EOF</span></a><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-889"></a><span>     </span><span class="hs-special">(</span><a name="local-6989586621679289625"><a href="#local-6989586621679289625"><span class="hs-identifier">bbuf3</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679289626"><a href="#local-6989586621679289626"><span class="hs-identifier">cbuf1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">recover</span><span> </span><a href="#local-6989586621679289622"><span class="hs-identifier hs-var">decoder</span></a><span> </span><a href="#local-6989586621679289624"><span class="hs-identifier hs-var">bbuf2</span></a><span> </span><a href="#local-6989586621679289620"><span class="hs-identifier hs-var">cbuf0</span></a><span>
</span><a name="line-890"></a><span>     </span><a href="GHC.IO.Handle.Internals.html#debugIO"><span class="hs-identifier hs-var">debugIO</span></a><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;readTextDevice' after recovery: bbuf=&quot;</span><span> </span><a href="GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="GHC.IO.Buffer.html#summaryBuffer"><span class="hs-identifier hs-var">summaryBuffer</span></a><span> </span><a href="#local-6989586621679289625"><span class="hs-identifier hs-var">bbuf3</span></a><span> </span><a href="GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><span class="hs-string">&quot;, cbuf=&quot;</span><span> </span><a href="GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="GHC.IO.Buffer.html#summaryBuffer"><span class="hs-identifier hs-var">summaryBuffer</span></a><span> </span><a href="#local-6989586621679289626"><span class="hs-identifier hs-var">cbuf1</span></a><span class="hs-special">)</span><span>
</span><a name="line-891"></a><span>     </span><a href="GHC.IORef.html#writeIORef"><span class="hs-identifier hs-var">writeIORef</span></a><span> </span><a href="#local-6989586621679289608"><span class="hs-identifier hs-var">haByteBuffer</span></a><span> </span><a href="#local-6989586621679289625"><span class="hs-identifier hs-var">bbuf3</span></a><span>
</span><a name="line-892"></a><span>     </span><span class="hs-comment">-- We should recursively invoke readTextDevice after recovery,</span><span>
</span><a name="line-893"></a><span>     </span><span class="hs-comment">-- if recovery did not add at least one new character to the buffer:</span><span>
</span><a name="line-894"></a><span>     </span><span class="hs-comment">--  1. If we were using IgnoreCodingFailure it might be the case that</span><span>
</span><a name="line-895"></a><span>     </span><span class="hs-comment">--     cbuf1 is the same length as cbuf0 and we need to raise ioe_EOF</span><span>
</span><a name="line-896"></a><span>     </span><span class="hs-comment">--  2. If we were using TransliterateCodingFailure we might have *mutated*</span><span>
</span><a name="line-897"></a><span>     </span><span class="hs-comment">--     the byte buffer without changing the pointers into either buffer.</span><span>
</span><a name="line-898"></a><span>     </span><span class="hs-comment">--     We need to try and decode it again - it might just go through this time.</span><span>
</span><a name="line-899"></a><span>     </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">bufR</span><span> </span><a href="#local-6989586621679289626"><span class="hs-identifier hs-var">cbuf1</span></a><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a><span> </span><span class="hs-identifier">bufR</span><span> </span><a href="#local-6989586621679289620"><span class="hs-identifier hs-var">cbuf0</span></a><span>
</span><a name="line-900"></a><span>      </span><span class="hs-keyword">then</span><span> </span><a href="GHC.IO.Handle.Internals.html#readTextDevice"><span class="hs-identifier hs-var">readTextDevice</span></a><span> </span><a href="#local-6989586621679289605"><span class="hs-identifier hs-var">h_</span></a><span> </span><a href="#local-6989586621679289626"><span class="hs-identifier hs-var">cbuf1</span></a><span>
</span><a name="line-901"></a><span>      </span><span class="hs-keyword">else</span><span> </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621679289626"><span class="hs-identifier hs-var">cbuf1</span></a><span>
</span><a name="line-902"></a><span>   </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-903"></a><span>    </span><a href="GHC.IO.Handle.Internals.html#debugIO"><span class="hs-identifier hs-var">debugIO</span></a><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;readTextDevice' after reading: bbuf=&quot;</span><span> </span><a href="GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="GHC.IO.Buffer.html#summaryBuffer"><span class="hs-identifier hs-var">summaryBuffer</span></a><span> </span><a href="#local-6989586621679289624"><span class="hs-identifier hs-var">bbuf2</span></a><span class="hs-special">)</span><span>
</span><a name="line-904"></a><span>
</span><a name="line-905"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621679289628"><a href="#local-6989586621679289628"><span class="hs-identifier">bbuf3</span></a></a><span class="hs-special">,</span><a name="local-6989586621679289629"><a href="#local-6989586621679289629"><span class="hs-identifier">cbuf1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-906"></a><span>       </span><a name="local-6989586621679289627"><a href="#local-6989586621679289627"><span class="hs-identifier">state</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">getState</span><span> </span><a href="#local-6989586621679289622"><span class="hs-identifier hs-var">decoder</span></a><span>
</span><a name="line-907"></a><span>       </span><a href="GHC.IORef.html#writeIORef"><span class="hs-identifier hs-var">writeIORef</span></a><span> </span><a href="#local-6989586621679289610"><span class="hs-identifier hs-var">haLastDecode</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679289627"><span class="hs-identifier hs-var">state</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679289624"><span class="hs-identifier hs-var">bbuf2</span></a><span class="hs-special">)</span><span>
</span><a name="line-908"></a><span>       </span><span class="hs-special">(</span><a href="GHC.IO.Handle.Internals.html#streamEncode"><span class="hs-identifier hs-var">streamEncode</span></a><span> </span><a href="#local-6989586621679289622"><span class="hs-identifier hs-var">decoder</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679289624"><span class="hs-identifier hs-var">bbuf2</span></a><span> </span><a href="#local-6989586621679289620"><span class="hs-identifier hs-var">cbuf0</span></a><span>
</span><a name="line-909"></a><span>
</span><a name="line-910"></a><span>    </span><a href="GHC.IO.Handle.Internals.html#debugIO"><span class="hs-identifier hs-var">debugIO</span></a><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;readTextDevice' after decoding: cbuf=&quot;</span><span> </span><a href="GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="GHC.IO.Buffer.html#summaryBuffer"><span class="hs-identifier hs-var">summaryBuffer</span></a><span> </span><a href="#local-6989586621679289629"><span class="hs-identifier hs-var">cbuf1</span></a><span> </span><a href="GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span>
</span><a name="line-911"></a><span>          </span><span class="hs-string">&quot; bbuf=&quot;</span><span> </span><a href="GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="GHC.IO.Buffer.html#summaryBuffer"><span class="hs-identifier hs-var">summaryBuffer</span></a><span> </span><a href="#local-6989586621679289628"><span class="hs-identifier hs-var">bbuf3</span></a><span class="hs-special">)</span><span>
</span><a name="line-912"></a><span>
</span><a name="line-913"></a><span>    </span><a href="GHC.IORef.html#writeIORef"><span class="hs-identifier hs-var">writeIORef</span></a><span> </span><a href="#local-6989586621679289608"><span class="hs-identifier hs-var">haByteBuffer</span></a><span> </span><a href="#local-6989586621679289628"><span class="hs-identifier hs-var">bbuf3</span></a><span>
</span><a name="line-914"></a><span>    </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">bufR</span><span> </span><a href="#local-6989586621679289620"><span class="hs-identifier hs-var">cbuf0</span></a><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a><span> </span><span class="hs-identifier">bufR</span><span> </span><a href="#local-6989586621679289629"><span class="hs-identifier hs-var">cbuf1</span></a><span>
</span><a name="line-915"></a><span>       </span><span class="hs-keyword">then</span><span> </span><a href="GHC.IO.Handle.Internals.html#readTextDevice%27"><span class="hs-identifier hs-var">readTextDevice'</span></a><span> </span><a href="#local-6989586621679289605"><span class="hs-identifier hs-var">h_</span></a><span> </span><a href="#local-6989586621679289628"><span class="hs-identifier hs-var">bbuf3</span></a><span> </span><a href="#local-6989586621679289629"><span class="hs-identifier hs-var">cbuf1</span></a><span>
</span><a name="line-916"></a><span>       </span><span class="hs-keyword">else</span><span> </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621679289629"><span class="hs-identifier hs-var">cbuf1</span></a><span>
</span><a name="line-917"></a><span>
</span><a name="line-918"></a><span class="hs-comment">-- Read characters into the provided buffer.  Do not block;</span><span>
</span><a name="line-919"></a><span class="hs-comment">-- return zero characters instead.  Raises an exception on end-of-file.</span><span>
</span><a name="line-920"></a><span class="hs-identifier">readTextDeviceNonBlocking</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-type">Handle__</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.Buffer.html#CharBuffer"><span class="hs-identifier hs-type">CharBuffer</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="GHC.IO.Buffer.html#CharBuffer"><span class="hs-identifier hs-type">CharBuffer</span></a><span>
</span><a name="line-921"></a><a name="readTextDeviceNonBlocking"><a href="GHC.IO.Handle.Internals.html#readTextDeviceNonBlocking"><span class="hs-identifier">readTextDeviceNonBlocking</span></a></a><span> </span><a name="local-6989586621679289630"><a href="#local-6989586621679289630"><span class="hs-identifier">h_</span></a></a><span class="hs-glyph">@</span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-var">Handle__</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><a name="local-6989586621679289644"><a href="#local-6989586621679289644"><span class="hs-identifier">cbuf</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-922"></a><span>  </span><span class="hs-comment">--</span><span>
</span><a name="line-923"></a><span>  </span><a name="local-6989586621679289645"><a href="#local-6989586621679289645"><span class="hs-identifier">bbuf0</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IORef.html#readIORef"><span class="hs-identifier hs-var">readIORef</span></a><span> </span><a href="#local-6989586621679289633"><span class="hs-identifier hs-var">haByteBuffer</span></a><span>
</span><a name="line-924"></a><span>  </span><a href="GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a><span> </span><span class="hs-special">(</span><a href="GHC.IO.Buffer.html#isEmptyBuffer"><span class="hs-identifier hs-var">isEmptyBuffer</span></a><span> </span><a href="#local-6989586621679289645"><span class="hs-identifier hs-var">bbuf0</span></a><span class="hs-special">)</span><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-925"></a><span>     </span><span class="hs-special">(</span><a name="local-6989586621679289646"><a href="#local-6989586621679289646"><span class="hs-identifier">r</span></a></a><span class="hs-special">,</span><a name="local-6989586621679289647"><a href="#local-6989586621679289647"><span class="hs-identifier">bbuf1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IO.BufferedIO.html#fillReadBuffer0"><span class="hs-identifier hs-var">Buffered.fillReadBuffer0</span></a><span> </span><a href="#local-6989586621679289631"><span class="hs-identifier hs-var">haDevice</span></a><span> </span><a href="#local-6989586621679289645"><span class="hs-identifier hs-var">bbuf0</span></a><span>
</span><a name="line-926"></a><span>     </span><span class="hs-keyword">if</span><span> </span><a href="Data.Maybe.html#isNothing"><span class="hs-identifier hs-var">isNothing</span></a><span> </span><a href="#local-6989586621679289646"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="GHC.IO.Handle.Internals.html#ioe_EOF"><span class="hs-identifier hs-var">ioe_EOF</span></a><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-comment">-- raise EOF</span><span>
</span><a name="line-927"></a><span>     </span><a href="GHC.IORef.html#writeIORef"><span class="hs-identifier hs-var">writeIORef</span></a><span> </span><a href="#local-6989586621679289633"><span class="hs-identifier hs-var">haByteBuffer</span></a><span> </span><a href="#local-6989586621679289647"><span class="hs-identifier hs-var">bbuf1</span></a><span>
</span><a name="line-928"></a><span>
</span><a name="line-929"></a><span>  </span><a href="GHC.IO.Handle.Internals.html#decodeByteBuf"><span class="hs-identifier hs-var">decodeByteBuf</span></a><span> </span><a href="#local-6989586621679289630"><span class="hs-identifier hs-var">h_</span></a><span> </span><a href="#local-6989586621679289644"><span class="hs-identifier hs-var">cbuf</span></a><span>
</span><a name="line-930"></a><span>
</span><a name="line-931"></a><span class="hs-comment">-- Decode bytes from the byte buffer into the supplied CharBuffer.</span><span>
</span><a name="line-932"></a><span class="hs-identifier">decodeByteBuf</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-type">Handle__</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.Buffer.html#CharBuffer"><span class="hs-identifier hs-type">CharBuffer</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="GHC.IO.Buffer.html#CharBuffer"><span class="hs-identifier hs-type">CharBuffer</span></a><span>
</span><a name="line-933"></a><a name="decodeByteBuf"><a href="GHC.IO.Handle.Internals.html#decodeByteBuf"><span class="hs-identifier">decodeByteBuf</span></a></a><span> </span><a name="local-6989586621679289648"><a href="#local-6989586621679289648"><span class="hs-identifier">h_</span></a></a><span class="hs-glyph">@</span><a href="GHC.IO.Handle.Types.html#Handle__"><span class="hs-identifier hs-var">Handle__</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><a name="local-6989586621679289662"><a href="#local-6989586621679289662"><span class="hs-identifier">cbuf</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-934"></a><span>  </span><span class="hs-comment">--</span><span>
</span><a name="line-935"></a><span>  </span><a name="local-6989586621679289663"><a href="#local-6989586621679289663"><span class="hs-identifier">bbuf0</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IORef.html#readIORef"><span class="hs-identifier hs-var">readIORef</span></a><span> </span><a href="#local-6989586621679289651"><span class="hs-identifier hs-var">haByteBuffer</span></a><span>
</span><a name="line-936"></a><span>
</span><a name="line-937"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679289666"><a href="#local-6989586621679289666"><span class="hs-identifier">bbuf2</span></a></a><span class="hs-special">,</span><a name="local-6989586621679289667"><a href="#local-6989586621679289667"><span class="hs-identifier">cbuf'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-938"></a><span>      </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679289657"><span class="hs-identifier hs-var">haDecoder</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-939"></a><span>          </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-940"></a><span>               </span><a href="GHC.IORef.html#writeIORef"><span class="hs-identifier hs-var">writeIORef</span></a><span> </span><a href="#local-6989586621679289653"><span class="hs-identifier hs-var">haLastDecode</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Err.html#errorWithoutStackTrace"><span class="hs-identifier hs-var">errorWithoutStackTrace</span></a><span> </span><span class="hs-string">&quot;codec_state&quot;</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679289663"><span class="hs-identifier hs-var">bbuf0</span></a><span class="hs-special">)</span><span>
</span><a name="line-941"></a><span>               </span><a href="GHC.IO.Encoding.html#latin1_decode"><span class="hs-identifier hs-var">latin1_decode</span></a><span> </span><a href="#local-6989586621679289663"><span class="hs-identifier hs-var">bbuf0</span></a><span> </span><a href="#local-6989586621679289662"><span class="hs-identifier hs-var">cbuf</span></a><span>
</span><a name="line-942"></a><span>          </span><a href="GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621679289664"><a href="#local-6989586621679289664"><span class="hs-identifier">decoder</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-943"></a><span>               </span><a name="local-6989586621679289665"><a href="#local-6989586621679289665"><span class="hs-identifier">state</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">getState</span><span> </span><a href="#local-6989586621679289664"><span class="hs-identifier hs-var">decoder</span></a><span>
</span><a name="line-944"></a><span>               </span><a href="GHC.IORef.html#writeIORef"><span class="hs-identifier hs-var">writeIORef</span></a><span> </span><a href="#local-6989586621679289653"><span class="hs-identifier hs-var">haLastDecode</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679289665"><span class="hs-identifier hs-var">state</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679289663"><span class="hs-identifier hs-var">bbuf0</span></a><span class="hs-special">)</span><span>
</span><a name="line-945"></a><span>               </span><span class="hs-special">(</span><a href="GHC.IO.Handle.Internals.html#streamEncode"><span class="hs-identifier hs-var">streamEncode</span></a><span> </span><a href="#local-6989586621679289664"><span class="hs-identifier hs-var">decoder</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679289663"><span class="hs-identifier hs-var">bbuf0</span></a><span> </span><a href="#local-6989586621679289662"><span class="hs-identifier hs-var">cbuf</span></a><span>
</span><a name="line-946"></a><span>
</span><a name="line-947"></a><span>  </span><a href="GHC.IORef.html#writeIORef"><span class="hs-identifier hs-var">writeIORef</span></a><span> </span><a href="#local-6989586621679289651"><span class="hs-identifier hs-var">haByteBuffer</span></a><span> </span><a href="#local-6989586621679289666"><span class="hs-identifier hs-var">bbuf2</span></a><span>
</span><a name="line-948"></a><span>  </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621679289667"><span class="hs-identifier hs-var">cbuf'</span></a><span>
</span><a name="line-949"></a><span>
</span><a name="line-950"></a></pre></body></html>