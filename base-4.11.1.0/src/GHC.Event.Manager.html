<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE Trustworthy #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE BangPatterns
           , CPP
           , ExistentialQuantification
           , NoImplicitPrelude
           , RecordWildCards
           , TypeSynonymInstances
           , FlexibleInstances
  #-}</span><span>
</span><a name="line-10"></a><span>
</span><a name="line-11"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-12"></a><span class="hs-comment">-- The event manager supports event notification on fds. Each fd may</span><span>
</span><a name="line-13"></a><span class="hs-comment">-- have multiple callbacks registered, each listening for a different</span><span>
</span><a name="line-14"></a><span class="hs-comment">-- set of events. Registrations may be automatically deactivated after</span><span>
</span><a name="line-15"></a><span class="hs-comment">-- the occurrence of an event (&quot;one-shot mode&quot;) or active until</span><span>
</span><a name="line-16"></a><span class="hs-comment">-- explicitly unregistered.</span><span>
</span><a name="line-17"></a><span class="hs-comment">--</span><span>
</span><a name="line-18"></a><span class="hs-comment">-- If an fd has only one-shot registrations then we use one-shot</span><span>
</span><a name="line-19"></a><span class="hs-comment">-- polling if available. Otherwise we use multi-shot polling.</span><span>
</span><a name="line-20"></a><span>
</span><a name="line-21"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">GHC.Event.Manager</span><span>
</span><a name="line-22"></a><span>    </span><span class="hs-special">(</span><span> </span><span class="hs-comment">-- * Types</span><span>
</span><a name="line-23"></a><span>      </span><a href="GHC.Event.Manager.html#EventManager"><span class="hs-identifier hs-type">EventManager</span></a><span>
</span><a name="line-24"></a><span>
</span><a name="line-25"></a><span>      </span><span class="hs-comment">-- * Creation</span><span>
</span><a name="line-26"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="GHC.Event.Manager.html#new"><span class="hs-identifier hs-var">new</span></a><span>
</span><a name="line-27"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="GHC.Event.Manager.html#newWith"><span class="hs-identifier hs-var">newWith</span></a><span>
</span><a name="line-28"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="GHC.Event.Manager.html#newDefaultBackend"><span class="hs-identifier hs-var">newDefaultBackend</span></a><span>
</span><a name="line-29"></a><span>
</span><a name="line-30"></a><span>      </span><span class="hs-comment">-- * Running</span><span>
</span><a name="line-31"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="GHC.Event.Manager.html#finished"><span class="hs-identifier hs-var">finished</span></a><span>
</span><a name="line-32"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="GHC.Event.Manager.html#loop"><span class="hs-identifier hs-var">loop</span></a><span>
</span><a name="line-33"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="GHC.Event.Manager.html#step"><span class="hs-identifier hs-var">step</span></a><span>
</span><a name="line-34"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="GHC.Event.Manager.html#shutdown"><span class="hs-identifier hs-var">shutdown</span></a><span>
</span><a name="line-35"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="GHC.Event.Manager.html#release"><span class="hs-identifier hs-var">release</span></a><span>
</span><a name="line-36"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="GHC.Event.Manager.html#cleanup"><span class="hs-identifier hs-var">cleanup</span></a><span>
</span><a name="line-37"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="GHC.Event.Manager.html#wakeManager"><span class="hs-identifier hs-var">wakeManager</span></a><span>
</span><a name="line-38"></a><span>
</span><a name="line-39"></a><span>      </span><span class="hs-comment">-- * State</span><span>
</span><a name="line-40"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="GHC.Event.Manager.html#callbackTableVar"><span class="hs-identifier hs-var">callbackTableVar</span></a><span>
</span><a name="line-41"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="GHC.Event.Manager.html#emControl"><span class="hs-identifier hs-var">emControl</span></a><span>
</span><a name="line-42"></a><span>
</span><a name="line-43"></a><span>      </span><span class="hs-comment">-- * Registering interest in I/O events</span><span>
</span><a name="line-44"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="GHC.Event.Internal.html#Lifetime"><span class="hs-identifier hs-type">Lifetime</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-45"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="GHC.Event.Internal.html#Event"><span class="hs-identifier hs-type">Event</span></a><span>
</span><a name="line-46"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="GHC.Event.Internal.html#evtRead"><span class="hs-identifier hs-var">evtRead</span></a><span>
</span><a name="line-47"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="GHC.Event.Internal.html#evtWrite"><span class="hs-identifier hs-var">evtWrite</span></a><span>
</span><a name="line-48"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="GHC.Event.Manager.html#IOCallback"><span class="hs-identifier hs-type">IOCallback</span></a><span>
</span><a name="line-49"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="GHC.Event.Manager.html#FdKey"><span class="hs-identifier hs-type">FdKey</span></a><span class="hs-special">(</span><span class="hs-identifier">keyFd</span><span class="hs-special">)</span><span>
</span><a name="line-50"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="GHC.Event.Manager.html#FdData"><span class="hs-identifier hs-type">FdData</span></a><span>
</span><a name="line-51"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="GHC.Event.Manager.html#registerFd"><span class="hs-identifier hs-var">registerFd</span></a><span>
</span><a name="line-52"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="GHC.Event.Manager.html#unregisterFd_"><span class="hs-identifier hs-var">unregisterFd_</span></a><span>
</span><a name="line-53"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="GHC.Event.Manager.html#unregisterFd"><span class="hs-identifier hs-var">unregisterFd</span></a><span>
</span><a name="line-54"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="GHC.Event.Manager.html#closeFd"><span class="hs-identifier hs-var">closeFd</span></a><span>
</span><a name="line-55"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="GHC.Event.Manager.html#closeFd_"><span class="hs-identifier hs-var">closeFd_</span></a><span>
</span><a name="line-56"></a><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-57"></a><span>
</span><a name="line-58"></a><span class="hs-cpp">#include &quot;EventConfig.h&quot;
</span><span>
</span><a name="line-60"></a><span class="hs-comment">------------------------------------------------------------------------</span><span>
</span><a name="line-61"></a><span class="hs-comment">-- Imports</span><span>
</span><a name="line-62"></a><span>
</span><a name="line-63"></a><span class="hs-keyword">import</span><span> </span><a href="Control.Concurrent.MVar.html"><span class="hs-identifier">Control.Concurrent.MVar</span></a><span> </span><span class="hs-special">(</span><a href="GHC.MVar.html#MVar"><span class="hs-identifier hs-type">MVar</span></a><span class="hs-special">,</span><span> </span><a href="GHC.MVar.html#newMVar"><span class="hs-identifier hs-var">newMVar</span></a><span class="hs-special">,</span><span> </span><a href="GHC.MVar.html#putMVar"><span class="hs-identifier hs-var">putMVar</span></a><span class="hs-special">,</span><span>
</span><a name="line-64"></a><span>                                </span><a href="GHC.MVar.html#tryPutMVar"><span class="hs-identifier hs-var">tryPutMVar</span></a><span class="hs-special">,</span><span> </span><a href="GHC.MVar.html#takeMVar"><span class="hs-identifier hs-var">takeMVar</span></a><span class="hs-special">,</span><span> </span><a href="Control.Concurrent.MVar.html#withMVar"><span class="hs-identifier hs-var">withMVar</span></a><span class="hs-special">)</span><span>
</span><a name="line-65"></a><span class="hs-keyword">import</span><span> </span><a href="Control.Exception.html"><span class="hs-identifier">Control.Exception</span></a><span> </span><span class="hs-special">(</span><a href="Control.Exception.Base.html#onException"><span class="hs-identifier hs-var">onException</span></a><span class="hs-special">)</span><span>
</span><a name="line-66"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Bits.html"><span class="hs-identifier">Data.Bits</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="Data.Bits.html#.%26."><span class="hs-operator hs-var">.&amp;.</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-67"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Foldable.html"><span class="hs-identifier">Data.Foldable</span></a><span> </span><span class="hs-special">(</span><a href="Data.Foldable.html#forM_"><span class="hs-identifier hs-var">forM_</span></a><span class="hs-special">)</span><span>
</span><a name="line-68"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Functor.html"><span class="hs-identifier">Data.Functor</span></a><span> </span><span class="hs-special">(</span><a href="Data.Functor.html#void"><span class="hs-identifier hs-var">void</span></a><span class="hs-special">)</span><span>
</span><a name="line-69"></a><span class="hs-keyword">import</span><span> </span><a href="Data.IORef.html"><span class="hs-identifier">Data.IORef</span></a><span> </span><span class="hs-special">(</span><a href="GHC.IORef.html#IORef"><span class="hs-identifier hs-type">IORef</span></a><span class="hs-special">,</span><span> </span><a href="Data.IORef.html#atomicModifyIORef%27"><span class="hs-identifier hs-var">atomicModifyIORef'</span></a><span class="hs-special">,</span><span> </span><a href="Data.IORef.html#mkWeakIORef"><span class="hs-identifier hs-var">mkWeakIORef</span></a><span class="hs-special">,</span><span> </span><a href="GHC.IORef.html#newIORef"><span class="hs-identifier hs-var">newIORef</span></a><span class="hs-special">,</span><span> </span><a href="GHC.IORef.html#readIORef"><span class="hs-identifier hs-var">readIORef</span></a><span class="hs-special">,</span><span>
</span><a name="line-70"></a><span>                   </span><a href="GHC.IORef.html#writeIORef"><span class="hs-identifier hs-var">writeIORef</span></a><span class="hs-special">)</span><span>
</span><a name="line-71"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Maybe.html"><span class="hs-identifier">Data.Maybe</span></a><span> </span><span class="hs-special">(</span><a href="Data.Maybe.html#maybe"><span class="hs-identifier hs-var">maybe</span></a><span class="hs-special">)</span><span>
</span><a name="line-72"></a><span class="hs-keyword">import</span><span> </span><a href="Data.OldList.html"><span class="hs-identifier">Data.OldList</span></a><span> </span><span class="hs-special">(</span><a href="Data.OldList.html#partition"><span class="hs-identifier hs-var">partition</span></a><span class="hs-special">)</span><span>
</span><a name="line-73"></a><span class="hs-keyword">import</span><span> </span><a href="GHC.Arr.html"><span class="hs-identifier">GHC.Arr</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Arr.html#Array"><span class="hs-identifier hs-type">Array</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">!</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="GHC.Arr.html#listArray"><span class="hs-identifier hs-var">listArray</span></a><span class="hs-special">)</span><span>
</span><a name="line-74"></a><span class="hs-keyword">import</span><span> </span><a href="GHC.Base.html"><span class="hs-identifier">GHC.Base</span></a><span>
</span><a name="line-75"></a><span class="hs-keyword">import</span><span> </span><a href="GHC.Conc.Sync.html"><span class="hs-identifier">GHC.Conc.Sync</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Conc.Sync.html#yield"><span class="hs-identifier hs-var">yield</span></a><span class="hs-special">)</span><span>
</span><a name="line-76"></a><span class="hs-keyword">import</span><span> </span><a href="GHC.List.html"><span class="hs-identifier">GHC.List</span></a><span> </span><span class="hs-special">(</span><a href="GHC.List.html#filter"><span class="hs-identifier hs-var">filter</span></a><span class="hs-special">,</span><span> </span><a href="GHC.List.html#replicate"><span class="hs-identifier hs-var">replicate</span></a><span class="hs-special">)</span><span>
</span><a name="line-77"></a><span class="hs-keyword">import</span><span> </span><a href="GHC.Num.html"><span class="hs-identifier">GHC.Num</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Num.html#Num"><span class="hs-identifier hs-type">Num</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-78"></a><span class="hs-keyword">import</span><span> </span><a href="GHC.Real.html"><span class="hs-identifier">GHC.Real</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a><span class="hs-special">)</span><span>
</span><a name="line-79"></a><span class="hs-keyword">import</span><span> </span><a href="GHC.Show.html"><span class="hs-identifier">GHC.Show</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Show.html#Show"><span class="hs-identifier hs-type">Show</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-80"></a><span class="hs-keyword">import</span><span> </span><a href="GHC.Event.Control.html"><span class="hs-identifier">GHC.Event.Control</span></a><span>
</span><a name="line-81"></a><span class="hs-keyword">import</span><span> </span><a href="GHC.Event.IntTable.html"><span class="hs-identifier">GHC.Event.IntTable</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Event.IntTable.html#IntTable"><span class="hs-identifier hs-type">IntTable</span></a><span class="hs-special">)</span><span>
</span><a name="line-82"></a><span class="hs-keyword">import</span><span> </span><a href="GHC.Event.Internal.html"><span class="hs-identifier">GHC.Event.Internal</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Event.Internal.html#Backend"><span class="hs-identifier hs-type">Backend</span></a><span class="hs-special">,</span><span> </span><a href="GHC.Event.Internal.html#Event"><span class="hs-identifier hs-type">Event</span></a><span class="hs-special">,</span><span> </span><a href="GHC.Event.Internal.html#evtClose"><span class="hs-identifier hs-var">evtClose</span></a><span class="hs-special">,</span><span> </span><a href="GHC.Event.Internal.html#evtRead"><span class="hs-identifier hs-var">evtRead</span></a><span class="hs-special">,</span><span> </span><a href="GHC.Event.Internal.html#evtWrite"><span class="hs-identifier hs-var">evtWrite</span></a><span class="hs-special">,</span><span>
</span><a name="line-83"></a><span>                           </span><a href="GHC.Event.Internal.html#Lifetime"><span class="hs-identifier hs-type">Lifetime</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="GHC.Event.Internal.html#EventLifetime"><span class="hs-identifier hs-type">EventLifetime</span></a><span class="hs-special">,</span><span> </span><a href="GHC.Event.Internal.html#Timeout"><span class="hs-identifier hs-type">Timeout</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-84"></a><span class="hs-keyword">import</span><span> </span><a href="GHC.Event.Unique.html"><span class="hs-identifier">GHC.Event.Unique</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Event.Unique.html#Unique"><span class="hs-identifier hs-type">Unique</span></a><span class="hs-special">,</span><span> </span><a href="GHC.Event.Unique.html#UniqueSource"><span class="hs-identifier hs-type">UniqueSource</span></a><span class="hs-special">,</span><span> </span><a href="GHC.Event.Unique.html#newSource"><span class="hs-identifier hs-var">newSource</span></a><span class="hs-special">,</span><span> </span><a href="GHC.Event.Unique.html#newUnique"><span class="hs-identifier hs-var">newUnique</span></a><span class="hs-special">)</span><span>
</span><a name="line-85"></a><span class="hs-keyword">import</span><span> </span><a href="System.Posix.Types.html"><span class="hs-identifier">System.Posix.Types</span></a><span> </span><span class="hs-special">(</span><a href="System.Posix.Types.html#Fd"><span class="hs-identifier hs-type">Fd</span></a><span class="hs-special">)</span><span>
</span><a name="line-86"></a><span>
</span><a name="line-87"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="GHC.Event.IntTable.html"><span class="hs-identifier">GHC.Event.IntTable</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">IT</span><span>
</span><a name="line-88"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="GHC.Event.Internal.html"><span class="hs-identifier">GHC.Event.Internal</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">I</span><span>
</span><a name="line-89"></a><span>
</span><a name="line-90"></a><span class="hs-cpp">#if defined(HAVE_KQUEUE)
</span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">GHC.Event.KQueue</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">KQueue</span><span>
</span><a name="line-92"></a><span class="hs-cpp">#elif defined(HAVE_EPOLL)
</span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="GHC.Event.EPoll.html"><span class="hs-identifier">GHC.Event.EPoll</span></a><span>  </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">EPoll</span><span>
</span><a name="line-94"></a><span class="hs-cpp">#elif defined(HAVE_POLL)
</span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">GHC.Event.Poll</span><span>   </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Poll</span><span>
</span><a name="line-96"></a><span class="hs-cpp">#else
# error not implemented for this operating system
#endif
</span><span>
</span><a name="line-100"></a><span class="hs-comment">------------------------------------------------------------------------</span><span>
</span><a name="line-101"></a><span class="hs-comment">-- Types</span><span>
</span><a name="line-102"></a><span>
</span><a name="line-103"></a><span class="hs-keyword">data</span><span> </span><a name="FdData"><a href="GHC.Event.Manager.html#FdData"><span class="hs-identifier">FdData</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="FdData"><a href="GHC.Event.Manager.html#FdData"><span class="hs-identifier">FdData</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-104"></a><span>      </span><a name="fdKey"><a href="GHC.Event.Manager.html#fdKey"><span class="hs-identifier">fdKey</span></a></a><span>       </span><span class="hs-glyph">::</span><span> </span><span class="hs-pragma">{-# UNPACK</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-glyph">!</span><a href="GHC.Event.Manager.html#FdKey"><span class="hs-identifier hs-type">FdKey</span></a><span>
</span><a name="line-105"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="fdEvents"><a href="GHC.Event.Manager.html#fdEvents"><span class="hs-identifier">fdEvents</span></a></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-pragma">{-# UNPACK</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-glyph">!</span><a href="GHC.Event.Internal.html#EventLifetime"><span class="hs-identifier hs-type">EventLifetime</span></a><span>
</span><a name="line-106"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="_fdCallback"><a href="GHC.Event.Manager.html#_fdCallback"><span class="hs-identifier">_fdCallback</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="GHC.Event.Manager.html#IOCallback"><span class="hs-identifier hs-type">IOCallback</span></a><span>
</span><a name="line-107"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-108"></a><span>
</span><a name="line-109"></a><span class="hs-comment">-- | A file descriptor registration cookie.</span><span>
</span><a name="line-110"></a><span class="hs-keyword">data</span><span> </span><a name="FdKey"><a href="GHC.Event.Manager.html#FdKey"><span class="hs-identifier">FdKey</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="FdKey"><a href="GHC.Event.Manager.html#FdKey"><span class="hs-identifier">FdKey</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-111"></a><span>      </span><a name="keyFd"><a href="GHC.Event.Manager.html#keyFd"><span class="hs-identifier">keyFd</span></a></a><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-pragma">{-# UNPACK</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-glyph">!</span><a href="System.Posix.Types.html#Fd"><span class="hs-identifier hs-type">Fd</span></a><span>
</span><a name="line-112"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="keyUnique"><a href="GHC.Event.Manager.html#keyUnique"><span class="hs-identifier">keyUnique</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-pragma">{-# UNPACK</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-glyph">!</span><a href="GHC.Event.Unique.html#Unique"><span class="hs-identifier hs-type">Unique</span></a><span>
</span><a name="line-113"></a><span>    </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Classes.html#Eq"><span class="hs-identifier hs-type">Eq</span></a><span class="hs-special">,</span><span> </span><a href="GHC.Show.html#Show"><span class="hs-identifier hs-type">Show</span></a><span class="hs-special">)</span><span>
</span><a name="line-114"></a><span>
</span><a name="line-115"></a><span class="hs-comment">-- | Callback invoked on I/O events.</span><span>
</span><a name="line-116"></a><span class="hs-keyword">type</span><span> </span><a name="IOCallback"><a href="GHC.Event.Manager.html#IOCallback"><span class="hs-identifier">IOCallback</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.Event.Manager.html#FdKey"><span class="hs-identifier hs-type">FdKey</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Event.Internal.html#Event"><span class="hs-identifier hs-type">Event</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-117"></a><span>
</span><a name="line-118"></a><span class="hs-keyword">data</span><span> </span><a name="State"><a href="GHC.Event.Manager.html#State"><span class="hs-identifier">State</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="Created"><a href="GHC.Event.Manager.html#Created"><span class="hs-identifier">Created</span></a></a><span>
</span><a name="line-119"></a><span>           </span><span class="hs-glyph">|</span><span> </span><a name="Running"><a href="GHC.Event.Manager.html#Running"><span class="hs-identifier">Running</span></a></a><span>
</span><a name="line-120"></a><span>           </span><span class="hs-glyph">|</span><span> </span><a name="Dying"><a href="GHC.Event.Manager.html#Dying"><span class="hs-identifier">Dying</span></a></a><span>
</span><a name="line-121"></a><span>           </span><span class="hs-glyph">|</span><span> </span><a name="Releasing"><a href="GHC.Event.Manager.html#Releasing"><span class="hs-identifier">Releasing</span></a></a><span>
</span><a name="line-122"></a><span>           </span><span class="hs-glyph">|</span><span> </span><a name="Finished"><a href="GHC.Event.Manager.html#Finished"><span class="hs-identifier">Finished</span></a></a><span>
</span><a name="line-123"></a><span>             </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Classes.html#Eq"><span class="hs-identifier hs-type">Eq</span></a><span class="hs-special">,</span><span> </span><a href="GHC.Show.html#Show"><span class="hs-identifier hs-type">Show</span></a><span class="hs-special">)</span><span>
</span><a name="line-124"></a><span>
</span><a name="line-125"></a><span class="hs-comment">-- | The event manager state.</span><span>
</span><a name="line-126"></a><span class="hs-keyword">data</span><span> </span><a name="EventManager"><a href="GHC.Event.Manager.html#EventManager"><span class="hs-identifier">EventManager</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="EventManager"><a href="GHC.Event.Manager.html#EventManager"><span class="hs-identifier">EventManager</span></a></a><span>
</span><a name="line-127"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="emBackend"><a href="GHC.Event.Manager.html#emBackend"><span class="hs-identifier">emBackend</span></a></a><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="GHC.Event.Internal.html#Backend"><span class="hs-identifier hs-type">Backend</span></a><span>
</span><a name="line-128"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="emFds"><a href="GHC.Event.Manager.html#emFds"><span class="hs-identifier">emFds</span></a></a><span>          </span><span class="hs-glyph">::</span><span> </span><span class="hs-pragma">{-# UNPACK</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><a href="GHC.Arr.html#Array"><span class="hs-identifier hs-type">Array</span></a><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a><span> </span><span class="hs-special">(</span><a href="GHC.MVar.html#MVar"><span class="hs-identifier hs-type">MVar</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Event.IntTable.html#IntTable"><span class="hs-identifier hs-type">IntTable</span></a><span> </span><span class="hs-special">[</span><a href="GHC.Event.Manager.html#FdData"><span class="hs-identifier hs-type">FdData</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-129"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="emState"><a href="GHC.Event.Manager.html#emState"><span class="hs-identifier">emState</span></a></a><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-pragma">{-# UNPACK</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><a href="GHC.IORef.html#IORef"><span class="hs-identifier hs-type">IORef</span></a><span> </span><a href="GHC.Event.Manager.html#State"><span class="hs-identifier hs-type">State</span></a><span class="hs-special">)</span><span>
</span><a name="line-130"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="emUniqueSource"><a href="GHC.Event.Manager.html#emUniqueSource"><span class="hs-identifier">emUniqueSource</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-pragma">{-# UNPACK</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-glyph">!</span><a href="GHC.Event.Unique.html#UniqueSource"><span class="hs-identifier hs-type">UniqueSource</span></a><span>
</span><a name="line-131"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="emControl"><a href="GHC.Event.Manager.html#emControl"><span class="hs-identifier">emControl</span></a></a><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-pragma">{-# UNPACK</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-glyph">!</span><a href="GHC.Event.Control.html#Control"><span class="hs-identifier hs-type">Control</span></a><span>
</span><a name="line-132"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="emLock"><a href="GHC.Event.Manager.html#emLock"><span class="hs-identifier">emLock</span></a></a><span>         </span><span class="hs-glyph">::</span><span> </span><span class="hs-pragma">{-# UNPACK</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><a href="GHC.MVar.html#MVar"><span class="hs-identifier hs-type">MVar</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-133"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-134"></a><span>
</span><a name="line-135"></a><span class="hs-comment">-- must be power of 2</span><span>
</span><a name="line-136"></a><span class="hs-identifier">callbackArraySize</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a><span>
</span><a name="line-137"></a><a name="callbackArraySize"><a href="GHC.Event.Manager.html#callbackArraySize"><span class="hs-identifier">callbackArraySize</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">32</span><span>
</span><a name="line-138"></a><span>
</span><a name="line-139"></a><span class="hs-identifier">hashFd</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="System.Posix.Types.html#Fd"><span class="hs-identifier hs-type">Fd</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a><span>
</span><a name="line-140"></a><a name="hashFd"><a href="GHC.Event.Manager.html#hashFd"><span class="hs-identifier">hashFd</span></a></a><span> </span><a name="local-6989586621679297312"><a href="#local-6989586621679297312"><span class="hs-identifier">fd</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a><span> </span><a href="#local-6989586621679297312"><span class="hs-identifier hs-var">fd</span></a><span> </span><a href="Data.Bits.html#.%26."><span class="hs-operator hs-var">.&amp;.</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Event.Manager.html#callbackArraySize"><span class="hs-identifier hs-var">callbackArraySize</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-141"></a><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">hashFd</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-142"></a><span>
</span><a name="line-143"></a><span class="hs-identifier">callbackTableVar</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.Event.Manager.html#EventManager"><span class="hs-identifier hs-type">EventManager</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="System.Posix.Types.html#Fd"><span class="hs-identifier hs-type">Fd</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.MVar.html#MVar"><span class="hs-identifier hs-type">MVar</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Event.IntTable.html#IntTable"><span class="hs-identifier hs-type">IntTable</span></a><span> </span><span class="hs-special">[</span><a href="GHC.Event.Manager.html#FdData"><span class="hs-identifier hs-type">FdData</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-144"></a><a name="callbackTableVar"><a href="GHC.Event.Manager.html#callbackTableVar"><span class="hs-identifier">callbackTableVar</span></a></a><span> </span><a name="local-6989586621679297313"><a href="#local-6989586621679297313"><span class="hs-identifier">mgr</span></a></a><span> </span><a name="local-6989586621679297314"><a href="#local-6989586621679297314"><span class="hs-identifier">fd</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">emFds</span><span> </span><a href="#local-6989586621679297313"><span class="hs-identifier hs-var">mgr</span></a><span> </span><span class="hs-glyph">!</span><span> </span><a href="GHC.Event.Manager.html#hashFd"><span class="hs-identifier hs-var">hashFd</span></a><span> </span><a href="#local-6989586621679297314"><span class="hs-identifier hs-var">fd</span></a><span>
</span><a name="line-145"></a><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">callbackTableVar</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-146"></a><span>
</span><a name="line-147"></a><span class="hs-identifier">haveOneShot</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a><span>
</span><a name="line-148"></a><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">haveOneShot</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-149"></a><span class="hs-cpp">#if defined(darwin_HOST_OS) || defined(ios_HOST_OS)
</span><span class="hs-identifier">haveOneShot</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">False</span><span>
</span><a name="line-151"></a><span class="hs-cpp">#elif defined(HAVE_EPOLL) || defined(HAVE_KQUEUE)
</span><a name="haveOneShot"><a href="GHC.Event.Manager.html#haveOneShot"><span class="hs-identifier">haveOneShot</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a><span>
</span><a name="line-153"></a><span class="hs-cpp">#else
</span><span class="hs-identifier">haveOneShot</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">False</span><span>
</span><a name="line-155"></a><span class="hs-cpp">#endif
</span><span class="hs-comment">------------------------------------------------------------------------</span><span>
</span><a name="line-157"></a><span class="hs-comment">-- Creation</span><span>
</span><a name="line-158"></a><span>
</span><a name="line-159"></a><span class="hs-identifier">handleControlEvent</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.Event.Manager.html#EventManager"><span class="hs-identifier hs-type">EventManager</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="System.Posix.Types.html#Fd"><span class="hs-identifier hs-type">Fd</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Event.Internal.html#Event"><span class="hs-identifier hs-type">Event</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-160"></a><a name="handleControlEvent"><a href="GHC.Event.Manager.html#handleControlEvent"><span class="hs-identifier">handleControlEvent</span></a></a><span> </span><a name="local-6989586621679297315"><a href="#local-6989586621679297315"><span class="hs-identifier">mgr</span></a></a><span> </span><a name="local-6989586621679297316"><a href="#local-6989586621679297316"><span class="hs-identifier">fd</span></a></a><span> </span><a name="local-6989586621679297317"><a href="#local-6989586621679297317"><span class="hs-identifier">_evt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-161"></a><span>  </span><a name="local-6989586621679297318"><a href="#local-6989586621679297318"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.Event.Control.html#readControlMessage"><span class="hs-identifier hs-var">readControlMessage</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">emControl</span><span> </span><a href="#local-6989586621679297315"><span class="hs-identifier hs-var">mgr</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679297316"><span class="hs-identifier hs-var">fd</span></a><span>
</span><a name="line-162"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679297318"><span class="hs-identifier hs-var">msg</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-163"></a><span>    </span><a href="GHC.Event.Control.html#CMsgWakeup"><span class="hs-identifier hs-var">CMsgWakeup</span></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-164"></a><span>    </span><a href="GHC.Event.Control.html#CMsgDie"><span class="hs-identifier hs-var">CMsgDie</span></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IORef.html#writeIORef"><span class="hs-identifier hs-var">writeIORef</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">emState</span><span> </span><a href="#local-6989586621679297315"><span class="hs-identifier hs-var">mgr</span></a><span class="hs-special">)</span><span> </span><a href="GHC.Event.Manager.html#Finished"><span class="hs-identifier hs-var">Finished</span></a><span>
</span><a name="line-165"></a><span>    </span><span class="hs-identifier">_</span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-166"></a><span>
</span><a name="line-167"></a><span class="hs-identifier">newDefaultBackend</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="GHC.Event.Internal.html#Backend"><span class="hs-identifier hs-type">Backend</span></a><span>
</span><a name="line-168"></a><span class="hs-cpp">#if defined(HAVE_KQUEUE)
</span><span class="hs-identifier">newDefaultBackend</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">KQueue.new</span><span>
</span><a name="line-170"></a><span class="hs-cpp">#elif defined(HAVE_EPOLL)
</span><a name="newDefaultBackend"><a href="GHC.Event.Manager.html#newDefaultBackend"><span class="hs-identifier">newDefaultBackend</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.Event.EPoll.html#new"><span class="hs-identifier hs-var">EPoll.new</span></a><span>
</span><a name="line-172"></a><span class="hs-cpp">#elif defined(HAVE_POLL)
</span><span class="hs-identifier">newDefaultBackend</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">Poll.new</span><span>
</span><a name="line-174"></a><span class="hs-cpp">#else
</span><span class="hs-identifier">newDefaultBackend</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">errorWithoutStackTrace</span><span> </span><span class="hs-string">&quot;no back end for this platform&quot;</span><span>
</span><a name="line-176"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-178"></a><span class="hs-comment">-- | Create a new event manager.</span><span>
</span><a name="line-179"></a><span class="hs-identifier">new</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="GHC.Event.Manager.html#EventManager"><span class="hs-identifier hs-type">EventManager</span></a><span>
</span><a name="line-180"></a><a name="new"><a href="GHC.Event.Manager.html#new"><span class="hs-identifier">new</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.Event.Manager.html#newWith"><span class="hs-identifier hs-var">newWith</span></a><span> </span><a href="GHC.Base.html#%3D%3C%3C"><span class="hs-operator hs-var">=&lt;&lt;</span></a><span> </span><a href="GHC.Event.Manager.html#newDefaultBackend"><span class="hs-identifier hs-var">newDefaultBackend</span></a><span>
</span><a name="line-181"></a><span>
</span><a name="line-182"></a><span class="hs-comment">-- | Create a new 'EventManager' with the given polling backend.</span><span>
</span><a name="line-183"></a><span class="hs-identifier">newWith</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.Event.Internal.html#Backend"><span class="hs-identifier hs-type">Backend</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="GHC.Event.Manager.html#EventManager"><span class="hs-identifier hs-type">EventManager</span></a><span>
</span><a name="line-184"></a><a name="newWith"><a href="GHC.Event.Manager.html#newWith"><span class="hs-identifier">newWith</span></a></a><span> </span><a name="local-6989586621679297319"><a href="#local-6989586621679297319"><span class="hs-identifier">be</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-185"></a><span>  </span><a name="local-6989586621679297323"><a href="#local-6989586621679297323"><span class="hs-identifier">iofds</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.Base.html#fmap"><span class="hs-identifier hs-var">fmap</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Arr.html#listArray"><span class="hs-identifier hs-var">listArray</span></a><span> </span><span class="hs-special">(</span><span class="hs-number">0</span><span class="hs-special">,</span><span> </span><a href="GHC.Event.Manager.html#callbackArraySize"><span class="hs-identifier hs-var">callbackArraySize</span></a><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-186"></a><span>           </span><a href="#local-6989586621679297320"><span class="hs-identifier hs-var">replicateM</span></a><span> </span><a href="GHC.Event.Manager.html#callbackArraySize"><span class="hs-identifier hs-var">callbackArraySize</span></a><span> </span><span class="hs-special">(</span><a href="GHC.MVar.html#newMVar"><span class="hs-identifier hs-var">newMVar</span></a><span> </span><a href="GHC.Base.html#%3D%3C%3C"><span class="hs-operator hs-var">=&lt;&lt;</span></a><span> </span><a href="GHC.Event.IntTable.html#new"><span class="hs-identifier hs-var">IT.new</span></a><span> </span><span class="hs-number">8</span><span class="hs-special">)</span><span>
</span><a name="line-187"></a><span>  </span><a name="local-6989586621679297324"><a href="#local-6989586621679297324"><span class="hs-identifier">ctrl</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.Event.Control.html#newControl"><span class="hs-identifier hs-var">newControl</span></a><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a><span>
</span><a name="line-188"></a><span>  </span><a name="local-6989586621679297325"><a href="#local-6989586621679297325"><span class="hs-identifier">state</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IORef.html#newIORef"><span class="hs-identifier hs-var">newIORef</span></a><span> </span><a href="GHC.Event.Manager.html#Created"><span class="hs-identifier hs-var">Created</span></a><span>
</span><a name="line-189"></a><span>  </span><a name="local-6989586621679297326"><a href="#local-6989586621679297326"><span class="hs-identifier">us</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.Event.Unique.html#newSource"><span class="hs-identifier hs-var">newSource</span></a><span>
</span><a name="line-190"></a><span>  </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.IORef.html#mkWeakIORef"><span class="hs-identifier hs-var">mkWeakIORef</span></a><span> </span><a href="#local-6989586621679297325"><span class="hs-identifier hs-var">state</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-191"></a><span>               </span><a name="local-6989586621679297328"><a href="#local-6989586621679297328"><span class="hs-identifier">st</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.IORef.html#atomicModifyIORef%27"><span class="hs-identifier hs-var">atomicModifyIORef'</span></a><span> </span><a href="#local-6989586621679297325"><span class="hs-identifier hs-var">state</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679297327"><a href="#local-6989586621679297327"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="GHC.Event.Manager.html#Finished"><span class="hs-identifier hs-var">Finished</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679297327"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span>
</span><a name="line-192"></a><span>               </span><a href="GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679297328"><span class="hs-identifier hs-var">st</span></a><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Classes.html#%2F%3D"><span class="hs-operator hs-var">/=</span></a><span> </span><a href="GHC.Event.Manager.html#Finished"><span class="hs-identifier hs-var">Finished</span></a><span class="hs-special">)</span><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-193"></a><span>                 </span><a href="GHC.Event.Internal.html#delete"><span class="hs-identifier hs-var">I.delete</span></a><span> </span><a href="#local-6989586621679297319"><span class="hs-identifier hs-var">be</span></a><span>
</span><a name="line-194"></a><span>                 </span><a href="GHC.Event.Control.html#closeControl"><span class="hs-identifier hs-var">closeControl</span></a><span> </span><a href="#local-6989586621679297324"><span class="hs-identifier hs-var">ctrl</span></a><span>
</span><a name="line-195"></a><span>  </span><a name="local-6989586621679297329"><a href="#local-6989586621679297329"><span class="hs-identifier">lockVar</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.MVar.html#newMVar"><span class="hs-identifier hs-var">newMVar</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-196"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679297330"><a href="#local-6989586621679297330"><span class="hs-identifier">mgr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.Event.Manager.html#EventManager"><span class="hs-identifier hs-var">EventManager</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">emBackend</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679297319"><span class="hs-identifier hs-var">be</span></a><span>
</span><a name="line-197"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">emFds</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679297323"><span class="hs-identifier hs-var">iofds</span></a><span>
</span><a name="line-198"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">emState</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679297325"><span class="hs-identifier hs-var">state</span></a><span>
</span><a name="line-199"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">emUniqueSource</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679297326"><span class="hs-identifier hs-var">us</span></a><span>
</span><a name="line-200"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">emControl</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679297324"><span class="hs-identifier hs-var">ctrl</span></a><span>
</span><a name="line-201"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">emLock</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679297329"><span class="hs-identifier hs-var">lockVar</span></a><span>
</span><a name="line-202"></a><span>                         </span><span class="hs-special">}</span><span>
</span><a name="line-203"></a><span>  </span><a href="GHC.Event.Manager.html#registerControlFd"><span class="hs-identifier hs-var">registerControlFd</span></a><span> </span><a href="#local-6989586621679297330"><span class="hs-identifier hs-var">mgr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">controlReadFd</span><span> </span><a href="#local-6989586621679297324"><span class="hs-identifier hs-var">ctrl</span></a><span class="hs-special">)</span><span> </span><a href="GHC.Event.Internal.html#evtRead"><span class="hs-identifier hs-var">evtRead</span></a><span>
</span><a name="line-204"></a><span>  </span><a href="GHC.Event.Manager.html#registerControlFd"><span class="hs-identifier hs-var">registerControlFd</span></a><span> </span><a href="#local-6989586621679297330"><span class="hs-identifier hs-var">mgr</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Event.Control.html#wakeupReadFd"><span class="hs-identifier hs-var">wakeupReadFd</span></a><span> </span><a href="#local-6989586621679297324"><span class="hs-identifier hs-var">ctrl</span></a><span class="hs-special">)</span><span> </span><a href="GHC.Event.Internal.html#evtRead"><span class="hs-identifier hs-var">evtRead</span></a><span>
</span><a name="line-205"></a><span>  </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621679297330"><span class="hs-identifier hs-var">mgr</span></a><span>
</span><a name="line-206"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-207"></a><span>    </span><a name="local-6989586621679297320"><a href="#local-6989586621679297320"><span class="hs-identifier">replicateM</span></a></a><span> </span><a name="local-6989586621679297321"><a href="#local-6989586621679297321"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621679297322"><a href="#local-6989586621679297322"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.Base.html#sequence"><span class="hs-identifier hs-var">sequence</span></a><span> </span><span class="hs-special">(</span><a href="GHC.List.html#replicate"><span class="hs-identifier hs-var">replicate</span></a><span> </span><a href="#local-6989586621679297321"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621679297322"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span>
</span><a name="line-208"></a><span>
</span><a name="line-209"></a><span class="hs-identifier">failOnInvalidFile</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="System.Posix.Types.html#Fd"><span class="hs-identifier hs-type">Fd</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-210"></a><a name="failOnInvalidFile"><a href="GHC.Event.Manager.html#failOnInvalidFile"><span class="hs-identifier">failOnInvalidFile</span></a></a><span> </span><a name="local-6989586621679297331"><a href="#local-6989586621679297331"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621679297332"><a href="#local-6989586621679297332"><span class="hs-identifier">fd</span></a></a><span> </span><a name="local-6989586621679297333"><a href="#local-6989586621679297333"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-211"></a><span>  </span><a name="local-6989586621679297334"><a href="#local-6989586621679297334"><span class="hs-identifier">ok</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679297333"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-212"></a><span>  </span><a href="GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a><span> </span><span class="hs-special">(</span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Classes.html#not"><span class="hs-identifier hs-var">not</span></a><span> </span><a href="#local-6989586621679297334"><span class="hs-identifier hs-var">ok</span></a><span class="hs-special">)</span><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-213"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679297335"><a href="#local-6989586621679297335"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;Failed while attempting to modify registration of file &quot;</span><span> </span><a href="GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span>
</span><a name="line-214"></a><span>              </span><a href="GHC.Show.html#show"><span class="hs-identifier hs-var">show</span></a><span> </span><a href="#local-6989586621679297332"><span class="hs-identifier hs-var">fd</span></a><span> </span><a href="GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><span class="hs-string">&quot; at location &quot;</span><span> </span><a href="GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="#local-6989586621679297331"><span class="hs-identifier hs-var">loc</span></a><span>
</span><a name="line-215"></a><span>    </span><span class="hs-keyword">in</span><span> </span><a href="GHC.Err.html#errorWithoutStackTrace"><span class="hs-identifier hs-var">errorWithoutStackTrace</span></a><span> </span><a href="#local-6989586621679297335"><span class="hs-identifier hs-var">msg</span></a><span>
</span><a name="line-216"></a><span>
</span><a name="line-217"></a><span class="hs-identifier">registerControlFd</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.Event.Manager.html#EventManager"><span class="hs-identifier hs-type">EventManager</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="System.Posix.Types.html#Fd"><span class="hs-identifier hs-type">Fd</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Event.Internal.html#Event"><span class="hs-identifier hs-type">Event</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-218"></a><a name="registerControlFd"><a href="GHC.Event.Manager.html#registerControlFd"><span class="hs-identifier">registerControlFd</span></a></a><span> </span><a name="local-6989586621679297336"><a href="#local-6989586621679297336"><span class="hs-identifier">mgr</span></a></a><span> </span><a name="local-6989586621679297337"><a href="#local-6989586621679297337"><span class="hs-identifier">fd</span></a></a><span> </span><a name="local-6989586621679297338"><a href="#local-6989586621679297338"><span class="hs-identifier">evs</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-219"></a><span>  </span><a href="GHC.Event.Manager.html#failOnInvalidFile"><span class="hs-identifier hs-var">failOnInvalidFile</span></a><span> </span><span class="hs-string">&quot;registerControlFd&quot;</span><span> </span><a href="#local-6989586621679297337"><span class="hs-identifier hs-var">fd</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-220"></a><span>  </span><a href="GHC.Event.Internal.html#modifyFd"><span class="hs-identifier hs-var">I.modifyFd</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">emBackend</span><span> </span><a href="#local-6989586621679297336"><span class="hs-identifier hs-var">mgr</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679297337"><span class="hs-identifier hs-var">fd</span></a><span> </span><a href="GHC.Base.html#mempty"><span class="hs-identifier hs-var">mempty</span></a><span> </span><a href="#local-6989586621679297338"><span class="hs-identifier hs-var">evs</span></a><span>
</span><a name="line-221"></a><span>
</span><a name="line-222"></a><span class="hs-comment">-- | Asynchronously shuts down the event manager, if running.</span><span>
</span><a name="line-223"></a><span class="hs-identifier">shutdown</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.Event.Manager.html#EventManager"><span class="hs-identifier hs-type">EventManager</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-224"></a><a name="shutdown"><a href="GHC.Event.Manager.html#shutdown"><span class="hs-identifier">shutdown</span></a></a><span> </span><a name="local-6989586621679297339"><a href="#local-6989586621679297339"><span class="hs-identifier">mgr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-225"></a><span>  </span><a name="local-6989586621679297341"><a href="#local-6989586621679297341"><span class="hs-identifier">state</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.IORef.html#atomicModifyIORef%27"><span class="hs-identifier hs-var">atomicModifyIORef'</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">emState</span><span> </span><a href="#local-6989586621679297339"><span class="hs-identifier hs-var">mgr</span></a><span class="hs-special">)</span><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679297340"><a href="#local-6989586621679297340"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="GHC.Event.Manager.html#Dying"><span class="hs-identifier hs-var">Dying</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679297340"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span>
</span><a name="line-226"></a><span>  </span><a href="GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679297341"><span class="hs-identifier hs-var">state</span></a><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a><span> </span><a href="GHC.Event.Manager.html#Running"><span class="hs-identifier hs-var">Running</span></a><span class="hs-special">)</span><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="GHC.Event.Control.html#sendDie"><span class="hs-identifier hs-var">sendDie</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">emControl</span><span> </span><a href="#local-6989586621679297339"><span class="hs-identifier hs-var">mgr</span></a><span class="hs-special">)</span><span>
</span><a name="line-227"></a><span>
</span><a name="line-228"></a><span class="hs-comment">-- | Asynchronously tell the thread executing the event</span><span>
</span><a name="line-229"></a><span class="hs-comment">-- manager loop to exit.</span><span>
</span><a name="line-230"></a><span class="hs-identifier">release</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.Event.Manager.html#EventManager"><span class="hs-identifier hs-type">EventManager</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-231"></a><a name="release"><a href="GHC.Event.Manager.html#release"><span class="hs-identifier">release</span></a></a><span> </span><a href="GHC.Event.Manager.html#EventManager"><span class="hs-identifier hs-var">EventManager</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-232"></a><span>  </span><a name="local-6989586621679297349"><a href="#local-6989586621679297349"><span class="hs-identifier">state</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.IORef.html#atomicModifyIORef%27"><span class="hs-identifier hs-var">atomicModifyIORef'</span></a><span> </span><a href="#local-6989586621679297344"><span class="hs-identifier hs-var">emState</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679297348"><a href="#local-6989586621679297348"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="GHC.Event.Manager.html#Releasing"><span class="hs-identifier hs-var">Releasing</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679297348"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span>
</span><a name="line-233"></a><span>  </span><a href="GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679297349"><span class="hs-identifier hs-var">state</span></a><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a><span> </span><a href="GHC.Event.Manager.html#Running"><span class="hs-identifier hs-var">Running</span></a><span class="hs-special">)</span><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="GHC.Event.Control.html#sendWakeup"><span class="hs-identifier hs-var">sendWakeup</span></a><span> </span><a href="#local-6989586621679297346"><span class="hs-identifier hs-var">emControl</span></a><span>
</span><a name="line-234"></a><span>
</span><a name="line-235"></a><span class="hs-identifier">finished</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.Event.Manager.html#EventManager"><span class="hs-identifier hs-type">EventManager</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a><span>
</span><a name="line-236"></a><a name="finished"><a href="GHC.Event.Manager.html#finished"><span class="hs-identifier">finished</span></a></a><span> </span><a name="local-6989586621679297350"><a href="#local-6989586621679297350"><span class="hs-identifier">mgr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a><span> </span><a href="GHC.Event.Manager.html#Finished"><span class="hs-identifier hs-var">Finished</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><a href="GHC.Base.html#liftM"><span class="hs-identifier hs-var">liftM</span></a><span class="hs-special">`</span><span> </span><a href="GHC.IORef.html#readIORef"><span class="hs-identifier hs-var">readIORef</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">emState</span><span> </span><a href="#local-6989586621679297350"><span class="hs-identifier hs-var">mgr</span></a><span class="hs-special">)</span><span>
</span><a name="line-237"></a><span>
</span><a name="line-238"></a><span class="hs-identifier">cleanup</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.Event.Manager.html#EventManager"><span class="hs-identifier hs-type">EventManager</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-239"></a><a name="cleanup"><a href="GHC.Event.Manager.html#cleanup"><span class="hs-identifier">cleanup</span></a></a><span> </span><a href="GHC.Event.Manager.html#EventManager"><span class="hs-identifier hs-var">EventManager</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-240"></a><span>  </span><a href="GHC.IORef.html#writeIORef"><span class="hs-identifier hs-var">writeIORef</span></a><span> </span><a href="#local-6989586621679297353"><span class="hs-identifier hs-var">emState</span></a><span> </span><a href="GHC.Event.Manager.html#Finished"><span class="hs-identifier hs-var">Finished</span></a><span>
</span><a name="line-241"></a><span>  </span><a href="Data.Functor.html#void"><span class="hs-identifier hs-var">void</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="GHC.MVar.html#tryPutMVar"><span class="hs-identifier hs-var">tryPutMVar</span></a><span> </span><a href="#local-6989586621679297356"><span class="hs-identifier hs-var">emLock</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-242"></a><span>  </span><a href="GHC.Event.Internal.html#delete"><span class="hs-identifier hs-var">I.delete</span></a><span> </span><a href="#local-6989586621679297351"><span class="hs-identifier hs-var">emBackend</span></a><span>
</span><a name="line-243"></a><span>  </span><a href="GHC.Event.Control.html#closeControl"><span class="hs-identifier hs-var">closeControl</span></a><span> </span><a href="#local-6989586621679297355"><span class="hs-identifier hs-var">emControl</span></a><span>
</span><a name="line-244"></a><span>
</span><a name="line-245"></a><span class="hs-comment">------------------------------------------------------------------------</span><span>
</span><a name="line-246"></a><span class="hs-comment">-- Event loop</span><span>
</span><a name="line-247"></a><span>
</span><a name="line-248"></a><span class="hs-comment">-- | Start handling events.  This function loops until told to stop,</span><span>
</span><a name="line-249"></a><span class="hs-comment">-- using 'shutdown'.</span><span>
</span><a name="line-250"></a><span class="hs-comment">--</span><span>
</span><a name="line-251"></a><span class="hs-comment">-- /Note/: This loop can only be run once per 'EventManager', as it</span><span>
</span><a name="line-252"></a><span class="hs-comment">-- closes all of its control resources when it finishes.</span><span>
</span><a name="line-253"></a><span class="hs-identifier">loop</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.Event.Manager.html#EventManager"><span class="hs-identifier hs-type">EventManager</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-254"></a><a name="loop"><a href="GHC.Event.Manager.html#loop"><span class="hs-identifier">loop</span></a></a><span> </span><a name="local-6989586621679297357"><a href="#local-6989586621679297357"><span class="hs-identifier">mgr</span></a></a><span class="hs-glyph">@</span><a href="GHC.Event.Manager.html#EventManager"><span class="hs-identifier hs-var">EventManager</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-255"></a><span>  </span><a href="Data.Functor.html#void"><span class="hs-identifier hs-var">void</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="GHC.MVar.html#takeMVar"><span class="hs-identifier hs-var">takeMVar</span></a><span> </span><a href="#local-6989586621679297363"><span class="hs-identifier hs-var">emLock</span></a><span>
</span><a name="line-256"></a><span>  </span><a name="local-6989586621679297367"><a href="#local-6989586621679297367"><span class="hs-identifier">state</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.IORef.html#atomicModifyIORef%27"><span class="hs-identifier hs-var">atomicModifyIORef'</span></a><span> </span><a href="#local-6989586621679297360"><span class="hs-identifier hs-var">emState</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679297366"><a href="#local-6989586621679297366"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679297366"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-257"></a><span>    </span><a href="GHC.Event.Manager.html#Created"><span class="hs-identifier hs-var">Created</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="GHC.Event.Manager.html#Running"><span class="hs-identifier hs-var">Running</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679297366"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span>
</span><a name="line-258"></a><span>    </span><a href="GHC.Event.Manager.html#Releasing"><span class="hs-identifier hs-var">Releasing</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="GHC.Event.Manager.html#Running"><span class="hs-identifier hs-var">Running</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679297366"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span>
</span><a name="line-259"></a><span>    </span><span class="hs-identifier">_</span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679297366"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679297366"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span>
</span><a name="line-260"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679297367"><span class="hs-identifier hs-var">state</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-261"></a><span>    </span><a href="GHC.Event.Manager.html#Created"><span class="hs-identifier hs-var">Created</span></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679297364"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">`</span><a href="Control.Exception.Base.html#onException"><span class="hs-identifier hs-var">onException</span></a><span class="hs-special">`</span><span> </span><a href="GHC.Event.Manager.html#cleanup"><span class="hs-identifier hs-var">cleanup</span></a><span> </span><a href="#local-6989586621679297357"><span class="hs-identifier hs-var">mgr</span></a><span>
</span><a name="line-262"></a><span>    </span><a href="GHC.Event.Manager.html#Releasing"><span class="hs-identifier hs-var">Releasing</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679297364"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">`</span><a href="Control.Exception.Base.html#onException"><span class="hs-identifier hs-var">onException</span></a><span class="hs-special">`</span><span> </span><a href="GHC.Event.Manager.html#cleanup"><span class="hs-identifier hs-var">cleanup</span></a><span> </span><a href="#local-6989586621679297357"><span class="hs-identifier hs-var">mgr</span></a><span>
</span><a name="line-263"></a><span>    </span><a href="GHC.Event.Manager.html#Dying"><span class="hs-identifier hs-var">Dying</span></a><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Event.Manager.html#cleanup"><span class="hs-identifier hs-var">cleanup</span></a><span> </span><a href="#local-6989586621679297357"><span class="hs-identifier hs-var">mgr</span></a><span>
</span><a name="line-264"></a><span>    </span><span class="hs-comment">-- While a poll loop is never forked when the event manager is in the</span><span>
</span><a name="line-265"></a><span>    </span><span class="hs-comment">-- 'Finished' state, its state could read 'Finished' once the new thread</span><span>
</span><a name="line-266"></a><span>    </span><span class="hs-comment">-- actually runs.  This is not an error, just an unfortunate race condition</span><span>
</span><a name="line-267"></a><span>    </span><span class="hs-comment">-- in Thread.restartPollLoop.  See #8235</span><span>
</span><a name="line-268"></a><span>    </span><a href="GHC.Event.Manager.html#Finished"><span class="hs-identifier hs-var">Finished</span></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-269"></a><span>    </span><span class="hs-identifier">_</span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><a href="GHC.Event.Manager.html#cleanup"><span class="hs-identifier hs-var">cleanup</span></a><span> </span><a href="#local-6989586621679297357"><span class="hs-identifier hs-var">mgr</span></a><span>
</span><a name="line-270"></a><span>                    </span><a href="GHC.Err.html#errorWithoutStackTrace"><span class="hs-identifier hs-var">errorWithoutStackTrace</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-string">&quot;GHC.Event.Manager.loop: state is already &quot;</span><span> </span><a href="GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span>
</span><a name="line-271"></a><span>                            </span><a href="GHC.Show.html#show"><span class="hs-identifier hs-var">show</span></a><span> </span><a href="#local-6989586621679297367"><span class="hs-identifier hs-var">state</span></a><span>
</span><a name="line-272"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-273"></a><span>  </span><a name="local-6989586621679297364"><a href="#local-6989586621679297364"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621679297365"><a href="#local-6989586621679297365"><span class="hs-identifier">state</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.Event.Manager.html#step"><span class="hs-identifier hs-var">step</span></a><span> </span><a href="#local-6989586621679297357"><span class="hs-identifier hs-var">mgr</span></a><span>
</span><a name="line-274"></a><span>          </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679297365"><span class="hs-identifier hs-var">state</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-275"></a><span>            </span><a href="GHC.Event.Manager.html#Running"><span class="hs-identifier hs-var">Running</span></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Conc.Sync.html#yield"><span class="hs-identifier hs-var">yield</span></a><span> </span><a href="GHC.Base.html#%3E%3E"><span class="hs-operator hs-var">&gt;&gt;</span></a><span> </span><a href="#local-6989586621679297364"><span class="hs-identifier hs-var">go</span></a><span>
</span><a name="line-276"></a><span>            </span><a href="GHC.Event.Manager.html#Releasing"><span class="hs-identifier hs-var">Releasing</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.MVar.html#putMVar"><span class="hs-identifier hs-var">putMVar</span></a><span> </span><a href="#local-6989586621679297363"><span class="hs-identifier hs-var">emLock</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-277"></a><span>            </span><span class="hs-identifier">_</span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Event.Manager.html#cleanup"><span class="hs-identifier hs-var">cleanup</span></a><span> </span><a href="#local-6989586621679297357"><span class="hs-identifier hs-var">mgr</span></a><span>
</span><a name="line-278"></a><span>
</span><a name="line-279"></a><span class="hs-comment">-- | To make a step, we first do a non-blocking poll, in case</span><span>
</span><a name="line-280"></a><span class="hs-comment">-- there are already events ready to handle. This improves performance</span><span>
</span><a name="line-281"></a><span class="hs-comment">-- because we can make an unsafe foreign C call, thereby avoiding</span><span>
</span><a name="line-282"></a><span class="hs-comment">-- forcing the current Task to release the Capability and forcing a context switch.</span><span>
</span><a name="line-283"></a><span class="hs-comment">-- If the poll fails to find events, we yield, putting the poll loop thread at</span><span>
</span><a name="line-284"></a><span class="hs-comment">-- end of the Haskell run queue. When it comes back around, we do one more</span><span>
</span><a name="line-285"></a><span class="hs-comment">-- non-blocking poll, in case we get lucky and have ready events.</span><span>
</span><a name="line-286"></a><span class="hs-comment">-- If that also returns no events, then we do a blocking poll.</span><span>
</span><a name="line-287"></a><span class="hs-identifier">step</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.Event.Manager.html#EventManager"><span class="hs-identifier hs-type">EventManager</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="GHC.Event.Manager.html#State"><span class="hs-identifier hs-type">State</span></a><span>
</span><a name="line-288"></a><a name="step"><a href="GHC.Event.Manager.html#step"><span class="hs-identifier">step</span></a></a><span> </span><a name="local-6989586621679297368"><a href="#local-6989586621679297368"><span class="hs-identifier">mgr</span></a></a><span class="hs-glyph">@</span><a href="GHC.Event.Manager.html#EventManager"><span class="hs-identifier hs-var">EventManager</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-289"></a><span>  </span><a href="#local-6989586621679297375"><span class="hs-identifier hs-var">waitForIO</span></a><span>
</span><a name="line-290"></a><span>  </span><a name="local-6989586621679297378"><a href="#local-6989586621679297378"><span class="hs-identifier">state</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IORef.html#readIORef"><span class="hs-identifier hs-var">readIORef</span></a><span> </span><a href="#local-6989586621679297371"><span class="hs-identifier hs-var">emState</span></a><span>
</span><a name="line-291"></a><span>  </span><a href="#local-6989586621679297378"><span class="hs-identifier hs-var">state</span></a><span> </span><span class="hs-special">`</span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Prim.html#seq"><span class="hs-identifier hs-var">seq</span></a><span class="hs-special">`</span><span> </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621679297378"><span class="hs-identifier hs-var">state</span></a><span>
</span><a name="line-292"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-293"></a><span>    </span><a name="local-6989586621679297375"><a href="#local-6989586621679297375"><span class="hs-identifier">waitForIO</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-294"></a><span>      </span><a name="local-6989586621679297376"><a href="#local-6989586621679297376"><span class="hs-identifier">n1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.Event.Internal.html#poll"><span class="hs-identifier hs-var">I.poll</span></a><span> </span><a href="#local-6989586621679297369"><span class="hs-identifier hs-var">emBackend</span></a><span> </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Event.Manager.html#onFdEvent"><span class="hs-identifier hs-var">onFdEvent</span></a><span> </span><a href="#local-6989586621679297368"><span class="hs-identifier hs-var">mgr</span></a><span class="hs-special">)</span><span>
</span><a name="line-295"></a><span>      </span><a href="GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679297376"><span class="hs-identifier hs-var">n1</span></a><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Classes.html#%3C%3D"><span class="hs-operator hs-var">&lt;=</span></a><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-296"></a><span>        </span><a href="GHC.Conc.Sync.html#yield"><span class="hs-identifier hs-var">yield</span></a><span>
</span><a name="line-297"></a><span>        </span><a name="local-6989586621679297377"><a href="#local-6989586621679297377"><span class="hs-identifier">n2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.Event.Internal.html#poll"><span class="hs-identifier hs-var">I.poll</span></a><span> </span><a href="#local-6989586621679297369"><span class="hs-identifier hs-var">emBackend</span></a><span> </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Event.Manager.html#onFdEvent"><span class="hs-identifier hs-var">onFdEvent</span></a><span> </span><a href="#local-6989586621679297368"><span class="hs-identifier hs-var">mgr</span></a><span class="hs-special">)</span><span>
</span><a name="line-298"></a><span>        </span><a href="GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679297377"><span class="hs-identifier hs-var">n2</span></a><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Classes.html#%3C%3D"><span class="hs-operator hs-var">&lt;=</span></a><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-299"></a><span>          </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.Event.Internal.html#poll"><span class="hs-identifier hs-var">I.poll</span></a><span> </span><a href="#local-6989586621679297369"><span class="hs-identifier hs-var">emBackend</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="GHC.Event.Internal.html#Forever"><span class="hs-identifier hs-var">Forever</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="GHC.Event.Manager.html#onFdEvent"><span class="hs-identifier hs-var">onFdEvent</span></a><span> </span><a href="#local-6989586621679297368"><span class="hs-identifier hs-var">mgr</span></a><span class="hs-special">)</span><span>
</span><a name="line-300"></a><span>          </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-301"></a><span>
</span><a name="line-302"></a><span class="hs-comment">------------------------------------------------------------------------</span><span>
</span><a name="line-303"></a><span class="hs-comment">-- Registering interest in I/O events</span><span>
</span><a name="line-304"></a><span>
</span><a name="line-305"></a><span class="hs-comment">-- | Register interest in the given events, without waking the event</span><span>
</span><a name="line-306"></a><span class="hs-comment">-- manager thread.  The 'Bool' return value indicates whether the</span><span>
</span><a name="line-307"></a><span class="hs-comment">-- event manager ought to be woken.</span><span>
</span><a name="line-308"></a><span class="hs-comment">--</span><span>
</span><a name="line-309"></a><span class="hs-comment">-- Note that the event manager is generally implemented in terms of the</span><span>
</span><a name="line-310"></a><span class="hs-comment">-- platform's @select@ or @epoll@ system call, which tend to vary in</span><span>
</span><a name="line-311"></a><span class="hs-comment">-- what sort of fds are permitted. For instance, waiting on regular files</span><span>
</span><a name="line-312"></a><span class="hs-comment">-- is not allowed on many platforms.</span><span>
</span><a name="line-313"></a><span class="hs-identifier">registerFd_</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.Event.Manager.html#EventManager"><span class="hs-identifier hs-type">EventManager</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Event.Manager.html#IOCallback"><span class="hs-identifier hs-type">IOCallback</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="System.Posix.Types.html#Fd"><span class="hs-identifier hs-type">Fd</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Event.Internal.html#Event"><span class="hs-identifier hs-type">Event</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Event.Internal.html#Lifetime"><span class="hs-identifier hs-type">Lifetime</span></a><span>
</span><a name="line-314"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Event.Manager.html#FdKey"><span class="hs-identifier hs-type">FdKey</span></a><span class="hs-special">,</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a><span class="hs-special">)</span><span>
</span><a name="line-315"></a><a name="registerFd_"><a href="GHC.Event.Manager.html#registerFd_"><span class="hs-identifier">registerFd_</span></a></a><span> </span><a name="local-6989586621679297379"><a href="#local-6989586621679297379"><span class="hs-identifier">mgr</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="GHC.Event.Manager.html#EventManager"><span class="hs-identifier hs-var">EventManager</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621679297386"><a href="#local-6989586621679297386"><span class="hs-identifier">cb</span></a></a><span> </span><a name="local-6989586621679297387"><a href="#local-6989586621679297387"><span class="hs-identifier">fd</span></a></a><span> </span><a name="local-6989586621679297388"><a href="#local-6989586621679297388"><span class="hs-identifier">evs</span></a></a><span> </span><a name="local-6989586621679297389"><a href="#local-6989586621679297389"><span class="hs-identifier">lt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-316"></a><span>  </span><a name="local-6989586621679297390"><a href="#local-6989586621679297390"><span class="hs-identifier">u</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.Event.Unique.html#newUnique"><span class="hs-identifier hs-var">newUnique</span></a><span> </span><a href="#local-6989586621679297383"><span class="hs-identifier hs-var">emUniqueSource</span></a><span>
</span><a name="line-317"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679297391"><a href="#local-6989586621679297391"><span class="hs-identifier">fd'</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a><span> </span><a href="#local-6989586621679297387"><span class="hs-identifier hs-var">fd</span></a><span>
</span><a name="line-318"></a><span>      </span><a name="local-6989586621679297392"><a href="#local-6989586621679297392"><span class="hs-identifier">reg</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="GHC.Event.Manager.html#FdKey"><span class="hs-identifier hs-var">FdKey</span></a><span> </span><a href="#local-6989586621679297387"><span class="hs-identifier hs-var">fd</span></a><span> </span><a href="#local-6989586621679297390"><span class="hs-identifier hs-var">u</span></a><span>
</span><a name="line-319"></a><span>      </span><a name="local-6989586621679297393"><a href="#local-6989586621679297393"><span class="hs-identifier">el</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.Event.Internal.html#eventLifetime"><span class="hs-identifier hs-var">I.eventLifetime</span></a><span> </span><a href="#local-6989586621679297388"><span class="hs-identifier hs-var">evs</span></a><span> </span><a href="#local-6989586621679297389"><span class="hs-identifier hs-var">lt</span></a><span>
</span><a name="line-320"></a><span>      </span><span class="hs-glyph">!</span><a name="local-6989586621679297394"><a href="#local-6989586621679297394"><span class="hs-identifier">fdd</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.Event.Manager.html#FdData"><span class="hs-identifier hs-var">FdData</span></a><span> </span><a href="#local-6989586621679297392"><span class="hs-identifier hs-var">reg</span></a><span> </span><a href="#local-6989586621679297393"><span class="hs-identifier hs-var">el</span></a><span> </span><a href="#local-6989586621679297386"><span class="hs-identifier hs-var">cb</span></a><span>
</span><a name="line-321"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679297404"><a href="#local-6989586621679297404"><span class="hs-identifier">modify</span></a></a><span class="hs-special">,</span><a name="local-6989586621679297405"><a href="#local-6989586621679297405"><span class="hs-identifier">ok</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Control.Concurrent.MVar.html#withMVar"><span class="hs-identifier hs-var">withMVar</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Event.Manager.html#callbackTableVar"><span class="hs-identifier hs-var">callbackTableVar</span></a><span> </span><a href="#local-6989586621679297379"><span class="hs-identifier hs-var">mgr</span></a><span> </span><a href="#local-6989586621679297387"><span class="hs-identifier hs-var">fd</span></a><span class="hs-special">)</span><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679297395"><a href="#local-6989586621679297395"><span class="hs-identifier">tbl</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-322"></a><span>    </span><a name="local-6989586621679297396"><a href="#local-6989586621679297396"><span class="hs-identifier">oldFdd</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.Event.IntTable.html#insertWith"><span class="hs-identifier hs-var">IT.insertWith</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679297391"><span class="hs-identifier hs-var">fd'</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621679297394"><span class="hs-identifier hs-var">fdd</span></a><span class="hs-special">]</span><span> </span><a href="#local-6989586621679297395"><span class="hs-identifier hs-var">tbl</span></a><span>
</span><a name="line-323"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">prevEvs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.Event.Internal.html#EventLifetime"><span class="hs-identifier hs-type">EventLifetime</span></a><span>
</span><a name="line-324"></a><span>        </span><a name="local-6989586621679297397"><a href="#local-6989586621679297397"><span class="hs-identifier">prevEvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Maybe.html#maybe"><span class="hs-identifier hs-var">maybe</span></a><span> </span><a href="GHC.Base.html#mempty"><span class="hs-identifier hs-var">mempty</span></a><span> </span><a href="GHC.Event.Manager.html#eventsOf"><span class="hs-identifier hs-var">eventsOf</span></a><span> </span><a href="#local-6989586621679297396"><span class="hs-identifier hs-var">oldFdd</span></a><span>
</span><a name="line-325"></a><span>
</span><a name="line-326"></a><span>        </span><span class="hs-identifier">el'</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.Event.Internal.html#EventLifetime"><span class="hs-identifier hs-type">EventLifetime</span></a><span>
</span><a name="line-327"></a><span>        </span><a name="local-6989586621679297398"><a href="#local-6989586621679297398"><span class="hs-identifier">el'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679297397"><span class="hs-identifier hs-var">prevEvs</span></a><span> </span><span class="hs-special">`</span><a href="GHC.Base.html#mappend"><span class="hs-identifier hs-var">mappend</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679297393"><span class="hs-identifier hs-var">el</span></a><span>
</span><a name="line-328"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="GHC.Event.Internal.html#elLifetime"><span class="hs-identifier hs-var">I.elLifetime</span></a><span> </span><a href="#local-6989586621679297398"><span class="hs-identifier hs-var">el'</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-329"></a><span>      </span><span class="hs-comment">-- All registrations want one-shot semantics and this is supported</span><span>
</span><a name="line-330"></a><span>      </span><a href="GHC.Event.Internal.html#OneShot"><span class="hs-identifier hs-var">OneShot</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="GHC.Event.Manager.html#haveOneShot"><span class="hs-identifier hs-var">haveOneShot</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-331"></a><span>        </span><a name="local-6989586621679297399"><a href="#local-6989586621679297399"><span class="hs-identifier">ok</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.Event.Internal.html#modifyFdOnce"><span class="hs-identifier hs-var">I.modifyFdOnce</span></a><span> </span><a href="#local-6989586621679297380"><span class="hs-identifier hs-var">emBackend</span></a><span> </span><a href="#local-6989586621679297387"><span class="hs-identifier hs-var">fd</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Event.Internal.html#elEvent"><span class="hs-identifier hs-var">I.elEvent</span></a><span> </span><a href="#local-6989586621679297398"><span class="hs-identifier hs-var">el'</span></a><span class="hs-special">)</span><span>
</span><a name="line-332"></a><span>        </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679297399"><span class="hs-identifier hs-var">ok</span></a><span>
</span><a name="line-333"></a><span>          </span><span class="hs-keyword">then</span><span> </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a><span class="hs-special">,</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a><span class="hs-special">)</span><span>
</span><a name="line-334"></a><span>          </span><span class="hs-keyword">else</span><span> </span><a href="GHC.Event.IntTable.html#reset"><span class="hs-identifier hs-var">IT.reset</span></a><span> </span><a href="#local-6989586621679297391"><span class="hs-identifier hs-var">fd'</span></a><span> </span><a href="#local-6989586621679297396"><span class="hs-identifier hs-var">oldFdd</span></a><span> </span><a href="#local-6989586621679297395"><span class="hs-identifier hs-var">tbl</span></a><span> </span><a href="GHC.Base.html#%3E%3E"><span class="hs-operator hs-var">&gt;&gt;</span></a><span> </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a><span class="hs-special">,</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a><span class="hs-special">)</span><span>
</span><a name="line-335"></a><span>
</span><a name="line-336"></a><span>      </span><span class="hs-comment">-- We don't want or don't support one-shot semantics</span><span>
</span><a name="line-337"></a><span>      </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-338"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679297400"><a href="#local-6989586621679297400"><span class="hs-identifier">modify</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679297397"><span class="hs-identifier hs-var">prevEvs</span></a><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Classes.html#%2F%3D"><span class="hs-operator hs-var">/=</span></a><span> </span><a href="#local-6989586621679297398"><span class="hs-identifier hs-var">el'</span></a><span>
</span><a name="line-339"></a><span>        </span><a name="local-6989586621679297403"><a href="#local-6989586621679297403"><span class="hs-identifier">ok</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679297400"><span class="hs-identifier hs-var">modify</span></a><span>
</span><a name="line-340"></a><span>              </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679297401"><a href="#local-6989586621679297401"><span class="hs-identifier">newEvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.Event.Internal.html#elEvent"><span class="hs-identifier hs-var">I.elEvent</span></a><span> </span><a href="#local-6989586621679297398"><span class="hs-identifier hs-var">el'</span></a><span>
</span><a name="line-341"></a><span>                       </span><a name="local-6989586621679297402"><a href="#local-6989586621679297402"><span class="hs-identifier">oldEvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.Event.Internal.html#elEvent"><span class="hs-identifier hs-var">I.elEvent</span></a><span> </span><a href="#local-6989586621679297397"><span class="hs-identifier hs-var">prevEvs</span></a><span>
</span><a name="line-342"></a><span>                   </span><span class="hs-keyword">in</span><span> </span><a href="GHC.Event.Internal.html#modifyFd"><span class="hs-identifier hs-var">I.modifyFd</span></a><span> </span><a href="#local-6989586621679297380"><span class="hs-identifier hs-var">emBackend</span></a><span> </span><a href="#local-6989586621679297387"><span class="hs-identifier hs-var">fd</span></a><span> </span><a href="#local-6989586621679297402"><span class="hs-identifier hs-var">oldEvs</span></a><span> </span><a href="#local-6989586621679297401"><span class="hs-identifier hs-var">newEvs</span></a><span>
</span><a name="line-343"></a><span>              </span><span class="hs-keyword">else</span><span> </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a><span>
</span><a name="line-344"></a><span>        </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679297403"><span class="hs-identifier hs-var">ok</span></a><span>
</span><a name="line-345"></a><span>          </span><span class="hs-keyword">then</span><span> </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679297400"><span class="hs-identifier hs-var">modify</span></a><span class="hs-special">,</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a><span class="hs-special">)</span><span>
</span><a name="line-346"></a><span>          </span><span class="hs-keyword">else</span><span> </span><a href="GHC.Event.IntTable.html#reset"><span class="hs-identifier hs-var">IT.reset</span></a><span> </span><a href="#local-6989586621679297391"><span class="hs-identifier hs-var">fd'</span></a><span> </span><a href="#local-6989586621679297396"><span class="hs-identifier hs-var">oldFdd</span></a><span> </span><a href="#local-6989586621679297395"><span class="hs-identifier hs-var">tbl</span></a><span> </span><a href="GHC.Base.html#%3E%3E"><span class="hs-operator hs-var">&gt;&gt;</span></a><span> </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a><span class="hs-special">,</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a><span class="hs-special">)</span><span>
</span><a name="line-347"></a><span>  </span><span class="hs-comment">-- this simulates behavior of old IO manager:</span><span>
</span><a name="line-348"></a><span>  </span><span class="hs-comment">-- i.e. just call the callback if the registration fails.</span><span>
</span><a name="line-349"></a><span>  </span><a href="GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a><span> </span><span class="hs-special">(</span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Classes.html#not"><span class="hs-identifier hs-var">not</span></a><span> </span><a href="#local-6989586621679297405"><span class="hs-identifier hs-var">ok</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679297386"><span class="hs-identifier hs-var">cb</span></a><span> </span><a href="#local-6989586621679297392"><span class="hs-identifier hs-var">reg</span></a><span> </span><a href="#local-6989586621679297388"><span class="hs-identifier hs-var">evs</span></a><span class="hs-special">)</span><span>
</span><a name="line-350"></a><span>  </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679297392"><span class="hs-identifier hs-var">reg</span></a><span class="hs-special">,</span><a href="#local-6989586621679297404"><span class="hs-identifier hs-var">modify</span></a><span class="hs-special">)</span><span>
</span><a name="line-351"></a><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">registerFd_</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-352"></a><span>
</span><a name="line-353"></a><span class="hs-comment">-- | @registerFd mgr cb fd evs lt@ registers interest in the events @evs@</span><span>
</span><a name="line-354"></a><span class="hs-comment">-- on the file descriptor @fd@ for lifetime @lt@. @cb@ is called for</span><span>
</span><a name="line-355"></a><span class="hs-comment">-- each event that occurs.  Returns a cookie that can be handed to</span><span>
</span><a name="line-356"></a><span class="hs-comment">-- 'unregisterFd'.</span><span>
</span><a name="line-357"></a><span class="hs-identifier">registerFd</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.Event.Manager.html#EventManager"><span class="hs-identifier hs-type">EventManager</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Event.Manager.html#IOCallback"><span class="hs-identifier hs-type">IOCallback</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="System.Posix.Types.html#Fd"><span class="hs-identifier hs-type">Fd</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Event.Internal.html#Event"><span class="hs-identifier hs-type">Event</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Event.Internal.html#Lifetime"><span class="hs-identifier hs-type">Lifetime</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="GHC.Event.Manager.html#FdKey"><span class="hs-identifier hs-type">FdKey</span></a><span>
</span><a name="line-358"></a><a name="registerFd"><a href="GHC.Event.Manager.html#registerFd"><span class="hs-identifier">registerFd</span></a></a><span> </span><a name="local-6989586621679297406"><a href="#local-6989586621679297406"><span class="hs-identifier">mgr</span></a></a><span> </span><a name="local-6989586621679297407"><a href="#local-6989586621679297407"><span class="hs-identifier">cb</span></a></a><span> </span><a name="local-6989586621679297408"><a href="#local-6989586621679297408"><span class="hs-identifier">fd</span></a></a><span> </span><a name="local-6989586621679297409"><a href="#local-6989586621679297409"><span class="hs-identifier">evs</span></a></a><span> </span><a name="local-6989586621679297410"><a href="#local-6989586621679297410"><span class="hs-identifier">lt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-359"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679297411"><a href="#local-6989586621679297411"><span class="hs-identifier">r</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679297412"><a href="#local-6989586621679297412"><span class="hs-identifier">wake</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.Event.Manager.html#registerFd_"><span class="hs-identifier hs-var">registerFd_</span></a><span> </span><a href="#local-6989586621679297406"><span class="hs-identifier hs-var">mgr</span></a><span> </span><a href="#local-6989586621679297407"><span class="hs-identifier hs-var">cb</span></a><span> </span><a href="#local-6989586621679297408"><span class="hs-identifier hs-var">fd</span></a><span> </span><a href="#local-6989586621679297409"><span class="hs-identifier hs-var">evs</span></a><span> </span><a href="#local-6989586621679297410"><span class="hs-identifier hs-var">lt</span></a><span>
</span><a name="line-360"></a><span>  </span><a href="GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a><span> </span><a href="#local-6989586621679297412"><span class="hs-identifier hs-var">wake</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="GHC.Event.Manager.html#wakeManager"><span class="hs-identifier hs-var">wakeManager</span></a><span> </span><a href="#local-6989586621679297406"><span class="hs-identifier hs-var">mgr</span></a><span>
</span><a name="line-361"></a><span>  </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621679297411"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-362"></a><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">registerFd</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-363"></a><span>
</span><a name="line-364"></a><span class="hs-comment">{-
    Building GHC with parallel IO manager on Mac freezes when
    compiling the dph libraries in the phase 2. As workaround, we
    don't use oneshot and we wake up an IO manager on Mac every time
    when we register an event.

    For more information, please read:
        http://ghc.haskell.org/trac/ghc/ticket/7651
-}</span><span>
</span><a name="line-373"></a><span class="hs-comment">-- | Wake up the event manager.</span><span>
</span><a name="line-374"></a><span class="hs-identifier">wakeManager</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.Event.Manager.html#EventManager"><span class="hs-identifier hs-type">EventManager</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-375"></a><span class="hs-cpp">#if defined(darwin_HOST_OS) || defined(ios_HOST_OS)
</span><span class="hs-identifier">wakeManager</span><span> </span><span class="hs-identifier">mgr</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">sendWakeup</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">emControl</span><span> </span><span class="hs-identifier">mgr</span><span class="hs-special">)</span><span>
</span><a name="line-377"></a><span class="hs-cpp">#elif defined(HAVE_EPOLL) || defined(HAVE_KQUEUE)
</span><a name="wakeManager"><a href="GHC.Event.Manager.html#wakeManager"><span class="hs-identifier">wakeManager</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-379"></a><span class="hs-cpp">#else
</span><span class="hs-identifier">wakeManager</span><span> </span><span class="hs-identifier">mgr</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">sendWakeup</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">emControl</span><span> </span><span class="hs-identifier">mgr</span><span class="hs-special">)</span><span>
</span><a name="line-381"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-383"></a><span class="hs-identifier">eventsOf</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="GHC.Event.Manager.html#FdData"><span class="hs-identifier hs-type">FdData</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Event.Internal.html#EventLifetime"><span class="hs-identifier hs-type">EventLifetime</span></a><span>
</span><a name="line-384"></a><a name="eventsOf"><a href="GHC.Event.Manager.html#eventsOf"><span class="hs-identifier">eventsOf</span></a></a><span> </span><span class="hs-special">[</span><a name="local-6989586621679297413"><a href="#local-6989586621679297413"><span class="hs-identifier">fdd</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">fdEvents</span><span> </span><a href="#local-6989586621679297413"><span class="hs-identifier hs-var">fdd</span></a><span>
</span><a name="line-385"></a><span class="hs-identifier">eventsOf</span><span> </span><a name="local-6989586621679297414"><a href="#local-6989586621679297414"><span class="hs-identifier">fdds</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="GHC.Base.html#mconcat"><span class="hs-identifier hs-var">mconcat</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-identifier">fdEvents</span><span> </span><a href="#local-6989586621679297414"><span class="hs-identifier hs-var">fdds</span></a><span>
</span><a name="line-386"></a><span>
</span><a name="line-387"></a><span class="hs-comment">-- | Drop a previous file descriptor registration, without waking the</span><span>
</span><a name="line-388"></a><span class="hs-comment">-- event manager thread.  The return value indicates whether the event</span><span>
</span><a name="line-389"></a><span class="hs-comment">-- manager ought to be woken.</span><span>
</span><a name="line-390"></a><span class="hs-identifier">unregisterFd_</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.Event.Manager.html#EventManager"><span class="hs-identifier hs-type">EventManager</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Event.Manager.html#FdKey"><span class="hs-identifier hs-type">FdKey</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a><span>
</span><a name="line-391"></a><a name="unregisterFd_"><a href="GHC.Event.Manager.html#unregisterFd_"><span class="hs-identifier">unregisterFd_</span></a></a><span> </span><a name="local-6989586621679297415"><a href="#local-6989586621679297415"><span class="hs-identifier">mgr</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="GHC.Event.Manager.html#EventManager"><span class="hs-identifier hs-var">EventManager</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="GHC.Event.Manager.html#FdKey"><span class="hs-identifier hs-var">FdKey</span></a><span> </span><a name="local-6989586621679297422"><a href="#local-6989586621679297422"><span class="hs-identifier">fd</span></a></a><span> </span><a name="local-6989586621679297423"><a href="#local-6989586621679297423"><span class="hs-identifier">u</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-392"></a><span>  </span><a href="Control.Concurrent.MVar.html#withMVar"><span class="hs-identifier hs-var">withMVar</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Event.Manager.html#callbackTableVar"><span class="hs-identifier hs-var">callbackTableVar</span></a><span> </span><a href="#local-6989586621679297415"><span class="hs-identifier hs-var">mgr</span></a><span> </span><a href="#local-6989586621679297422"><span class="hs-identifier hs-var">fd</span></a><span class="hs-special">)</span><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679297424"><a href="#local-6989586621679297424"><span class="hs-identifier">tbl</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-393"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679297425"><a href="#local-6989586621679297425"><span class="hs-identifier">dropReg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.Event.Manager.html#nullToNothing"><span class="hs-identifier hs-var">nullToNothing</span></a><span> </span><a href="GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="GHC.List.html#filter"><span class="hs-identifier hs-var">filter</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Classes.html#%2F%3D"><span class="hs-operator hs-var">/=</span></a><span> </span><a href="#local-6989586621679297423"><span class="hs-identifier hs-var">u</span></a><span class="hs-special">)</span><span> </span><a href="GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><span class="hs-identifier">keyUnique</span><span> </span><a href="GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><span class="hs-identifier">fdKey</span><span class="hs-special">)</span><span>
</span><a name="line-394"></a><span>        </span><a name="local-6989586621679297426"><a href="#local-6989586621679297426"><span class="hs-identifier">fd'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a><span> </span><a href="#local-6989586621679297422"><span class="hs-identifier hs-var">fd</span></a><span>
</span><a name="line-395"></a><span>        </span><span class="hs-identifier">pairEvents</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="GHC.Event.Manager.html#FdData"><span class="hs-identifier hs-type">FdData</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Event.Internal.html#EventLifetime"><span class="hs-identifier hs-type">EventLifetime</span></a><span class="hs-special">,</span><span> </span><a href="GHC.Event.Internal.html#EventLifetime"><span class="hs-identifier hs-type">EventLifetime</span></a><span class="hs-special">)</span><span>
</span><a name="line-396"></a><span>        </span><a name="local-6989586621679297427"><a href="#local-6989586621679297427"><span class="hs-identifier">pairEvents</span></a></a><span> </span><a name="local-6989586621679297428"><a href="#local-6989586621679297428"><span class="hs-identifier">prev</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-397"></a><span>          </span><a name="local-6989586621679297429"><a href="#local-6989586621679297429"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Maybe.html#maybe"><span class="hs-identifier hs-var">maybe</span></a><span> </span><a href="GHC.Base.html#mempty"><span class="hs-identifier hs-var">mempty</span></a><span> </span><a href="GHC.Event.Manager.html#eventsOf"><span class="hs-identifier hs-var">eventsOf</span></a><span> </span><span class="hs-special">`</span><a href="GHC.Base.html#fmap"><span class="hs-identifier hs-var">fmap</span></a><span class="hs-special">`</span><span> </span><a href="GHC.Event.IntTable.html#lookup"><span class="hs-identifier hs-var">IT.lookup</span></a><span> </span><a href="#local-6989586621679297426"><span class="hs-identifier hs-var">fd'</span></a><span> </span><a href="#local-6989586621679297424"><span class="hs-identifier hs-var">tbl</span></a><span>
</span><a name="line-398"></a><span>          </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Event.Manager.html#eventsOf"><span class="hs-identifier hs-var">eventsOf</span></a><span> </span><a href="#local-6989586621679297428"><span class="hs-identifier hs-var">prev</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679297429"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span>
</span><a name="line-399"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621679297430"><a href="#local-6989586621679297430"><span class="hs-identifier">oldEls</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679297431"><a href="#local-6989586621679297431"><span class="hs-identifier">newEls</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.Event.IntTable.html#updateWith"><span class="hs-identifier hs-var">IT.updateWith</span></a><span> </span><a href="#local-6989586621679297425"><span class="hs-identifier hs-var">dropReg</span></a><span> </span><a href="#local-6989586621679297426"><span class="hs-identifier hs-var">fd'</span></a><span> </span><a href="#local-6989586621679297424"><span class="hs-identifier hs-var">tbl</span></a><span> </span><a href="GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a><span>
</span><a name="line-400"></a><span>                        </span><a href="Data.Maybe.html#maybe"><span class="hs-identifier hs-var">maybe</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Base.html#mempty"><span class="hs-identifier hs-var">mempty</span></a><span class="hs-special">,</span><span> </span><a href="GHC.Base.html#mempty"><span class="hs-identifier hs-var">mempty</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679297427"><span class="hs-identifier hs-var">pairEvents</span></a><span>
</span><a name="line-401"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679297432"><a href="#local-6989586621679297432"><span class="hs-identifier">modify</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679297430"><span class="hs-identifier hs-var">oldEls</span></a><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Classes.html#%2F%3D"><span class="hs-operator hs-var">/=</span></a><span> </span><a href="#local-6989586621679297431"><span class="hs-identifier hs-var">newEls</span></a><span>
</span><a name="line-402"></a><span>    </span><a href="GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a><span> </span><a href="#local-6989586621679297432"><span class="hs-identifier hs-var">modify</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="GHC.Event.Manager.html#failOnInvalidFile"><span class="hs-identifier hs-var">failOnInvalidFile</span></a><span> </span><span class="hs-string">&quot;unregisterFd_&quot;</span><span> </span><a href="#local-6989586621679297422"><span class="hs-identifier hs-var">fd</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-403"></a><span>      </span><span class="hs-keyword">case</span><span> </span><a href="GHC.Event.Internal.html#elLifetime"><span class="hs-identifier hs-var">I.elLifetime</span></a><span> </span><a href="#local-6989586621679297431"><span class="hs-identifier hs-var">newEls</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-404"></a><span>        </span><a href="GHC.Event.Internal.html#OneShot"><span class="hs-identifier hs-var">OneShot</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="GHC.Event.Internal.html#elEvent"><span class="hs-identifier hs-var">I.elEvent</span></a><span> </span><a href="#local-6989586621679297431"><span class="hs-identifier hs-var">newEls</span></a><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Classes.html#%2F%3D"><span class="hs-operator hs-var">/=</span></a><span> </span><a href="GHC.Base.html#mempty"><span class="hs-identifier hs-var">mempty</span></a><span class="hs-special">,</span><span> </span><a href="GHC.Event.Manager.html#haveOneShot"><span class="hs-identifier hs-var">haveOneShot</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-405"></a><span>          </span><a href="GHC.Event.Internal.html#modifyFdOnce"><span class="hs-identifier hs-var">I.modifyFdOnce</span></a><span> </span><a href="#local-6989586621679297416"><span class="hs-identifier hs-var">emBackend</span></a><span> </span><a href="#local-6989586621679297422"><span class="hs-identifier hs-var">fd</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Event.Internal.html#elEvent"><span class="hs-identifier hs-var">I.elEvent</span></a><span> </span><a href="#local-6989586621679297431"><span class="hs-identifier hs-var">newEls</span></a><span class="hs-special">)</span><span>
</span><a name="line-406"></a><span>        </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-407"></a><span>          </span><a href="GHC.Event.Internal.html#modifyFd"><span class="hs-identifier hs-var">I.modifyFd</span></a><span> </span><a href="#local-6989586621679297416"><span class="hs-identifier hs-var">emBackend</span></a><span> </span><a href="#local-6989586621679297422"><span class="hs-identifier hs-var">fd</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Event.Internal.html#elEvent"><span class="hs-identifier hs-var">I.elEvent</span></a><span> </span><a href="#local-6989586621679297430"><span class="hs-identifier hs-var">oldEls</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="GHC.Event.Internal.html#elEvent"><span class="hs-identifier hs-var">I.elEvent</span></a><span> </span><a href="#local-6989586621679297431"><span class="hs-identifier hs-var">newEls</span></a><span class="hs-special">)</span><span>
</span><a name="line-408"></a><span>    </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621679297432"><span class="hs-identifier hs-var">modify</span></a><span>
</span><a name="line-409"></a><span>
</span><a name="line-410"></a><span class="hs-comment">-- | Drop a previous file descriptor registration.</span><span>
</span><a name="line-411"></a><span class="hs-identifier">unregisterFd</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.Event.Manager.html#EventManager"><span class="hs-identifier hs-type">EventManager</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Event.Manager.html#FdKey"><span class="hs-identifier hs-type">FdKey</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-412"></a><a name="unregisterFd"><a href="GHC.Event.Manager.html#unregisterFd"><span class="hs-identifier">unregisterFd</span></a></a><span> </span><a name="local-6989586621679297433"><a href="#local-6989586621679297433"><span class="hs-identifier">mgr</span></a></a><span> </span><a name="local-6989586621679297434"><a href="#local-6989586621679297434"><span class="hs-identifier">reg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-413"></a><span>  </span><a name="local-6989586621679297435"><a href="#local-6989586621679297435"><span class="hs-identifier">wake</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.Event.Manager.html#unregisterFd_"><span class="hs-identifier hs-var">unregisterFd_</span></a><span> </span><a href="#local-6989586621679297433"><span class="hs-identifier hs-var">mgr</span></a><span> </span><a href="#local-6989586621679297434"><span class="hs-identifier hs-var">reg</span></a><span>
</span><a name="line-414"></a><span>  </span><a href="GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a><span> </span><a href="#local-6989586621679297435"><span class="hs-identifier hs-var">wake</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="GHC.Event.Manager.html#wakeManager"><span class="hs-identifier hs-var">wakeManager</span></a><span> </span><a href="#local-6989586621679297433"><span class="hs-identifier hs-var">mgr</span></a><span>
</span><a name="line-415"></a><span>
</span><a name="line-416"></a><span class="hs-comment">-- | Close a file descriptor in a race-safe way.</span><span>
</span><a name="line-417"></a><span class="hs-identifier">closeFd</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.Event.Manager.html#EventManager"><span class="hs-identifier hs-type">EventManager</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="System.Posix.Types.html#Fd"><span class="hs-identifier hs-type">Fd</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="System.Posix.Types.html#Fd"><span class="hs-identifier hs-type">Fd</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-418"></a><a name="closeFd"><a href="GHC.Event.Manager.html#closeFd"><span class="hs-identifier">closeFd</span></a></a><span> </span><a name="local-6989586621679297436"><a href="#local-6989586621679297436"><span class="hs-identifier">mgr</span></a></a><span> </span><a name="local-6989586621679297437"><a href="#local-6989586621679297437"><span class="hs-identifier">close</span></a></a><span> </span><a name="local-6989586621679297438"><a href="#local-6989586621679297438"><span class="hs-identifier">fd</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-419"></a><span>  </span><a name="local-6989586621679297443"><a href="#local-6989586621679297443"><span class="hs-identifier">fds</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Control.Concurrent.MVar.html#withMVar"><span class="hs-identifier hs-var">withMVar</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Event.Manager.html#callbackTableVar"><span class="hs-identifier hs-var">callbackTableVar</span></a><span> </span><a href="#local-6989586621679297436"><span class="hs-identifier hs-var">mgr</span></a><span> </span><a href="#local-6989586621679297438"><span class="hs-identifier hs-var">fd</span></a><span class="hs-special">)</span><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679297439"><a href="#local-6989586621679297439"><span class="hs-identifier">tbl</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-420"></a><span>    </span><a name="local-6989586621679297440"><a href="#local-6989586621679297440"><span class="hs-identifier">prev</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.Event.IntTable.html#delete"><span class="hs-identifier hs-var">IT.delete</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a><span> </span><a href="#local-6989586621679297438"><span class="hs-identifier hs-var">fd</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679297439"><span class="hs-identifier hs-var">tbl</span></a><span>
</span><a name="line-421"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679297440"><span class="hs-identifier hs-var">prev</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-422"></a><span>      </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679297437"><span class="hs-identifier hs-var">close</span></a><span> </span><a href="#local-6989586621679297438"><span class="hs-identifier hs-var">fd</span></a><span> </span><a href="GHC.Base.html#%3E%3E"><span class="hs-operator hs-var">&gt;&gt;</span></a><span> </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-423"></a><span>      </span><a href="GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621679297441"><a href="#local-6989586621679297441"><span class="hs-identifier">fds</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-424"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679297442"><a href="#local-6989586621679297442"><span class="hs-identifier">oldEls</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.Event.Manager.html#eventsOf"><span class="hs-identifier hs-var">eventsOf</span></a><span> </span><a href="#local-6989586621679297441"><span class="hs-identifier hs-var">fds</span></a><span>
</span><a name="line-425"></a><span>        </span><a href="GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Event.Internal.html#elEvent"><span class="hs-identifier hs-var">I.elEvent</span></a><span> </span><a href="#local-6989586621679297442"><span class="hs-identifier hs-var">oldEls</span></a><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Classes.html#%2F%3D"><span class="hs-operator hs-var">/=</span></a><span> </span><a href="GHC.Base.html#mempty"><span class="hs-identifier hs-var">mempty</span></a><span class="hs-special">)</span><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-426"></a><span>          </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.Event.Internal.html#modifyFd"><span class="hs-identifier hs-var">I.modifyFd</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">emBackend</span><span> </span><a href="#local-6989586621679297436"><span class="hs-identifier hs-var">mgr</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679297438"><span class="hs-identifier hs-var">fd</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Event.Internal.html#elEvent"><span class="hs-identifier hs-var">I.elEvent</span></a><span> </span><a href="#local-6989586621679297442"><span class="hs-identifier hs-var">oldEls</span></a><span class="hs-special">)</span><span> </span><a href="GHC.Base.html#mempty"><span class="hs-identifier hs-var">mempty</span></a><span>
</span><a name="line-427"></a><span>          </span><a href="GHC.Event.Manager.html#wakeManager"><span class="hs-identifier hs-var">wakeManager</span></a><span> </span><a href="#local-6989586621679297436"><span class="hs-identifier hs-var">mgr</span></a><span>
</span><a name="line-428"></a><span>        </span><a href="#local-6989586621679297437"><span class="hs-identifier hs-var">close</span></a><span> </span><a href="#local-6989586621679297438"><span class="hs-identifier hs-var">fd</span></a><span>
</span><a name="line-429"></a><span>        </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621679297441"><span class="hs-identifier hs-var">fds</span></a><span>
</span><a name="line-430"></a><span>  </span><a href="Data.Foldable.html#forM_"><span class="hs-identifier hs-var">forM_</span></a><span> </span><a href="#local-6989586621679297443"><span class="hs-identifier hs-var">fds</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><a href="GHC.Event.Manager.html#FdData"><span class="hs-identifier hs-var">FdData</span></a><span> </span><a name="local-6989586621679297444"><a href="#local-6989586621679297444"><span class="hs-identifier">reg</span></a></a><span> </span><a name="local-6989586621679297445"><a href="#local-6989586621679297445"><span class="hs-identifier">el</span></a></a><span> </span><a name="local-6989586621679297446"><a href="#local-6989586621679297446"><span class="hs-identifier">cb</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679297446"><span class="hs-identifier hs-var">cb</span></a><span> </span><a href="#local-6989586621679297444"><span class="hs-identifier hs-var">reg</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Event.Internal.html#elEvent"><span class="hs-identifier hs-var">I.elEvent</span></a><span> </span><a href="#local-6989586621679297445"><span class="hs-identifier hs-var">el</span></a><span> </span><span class="hs-special">`</span><a href="GHC.Base.html#mappend"><span class="hs-identifier hs-var">mappend</span></a><span class="hs-special">`</span><span> </span><a href="GHC.Event.Internal.html#evtClose"><span class="hs-identifier hs-var">evtClose</span></a><span class="hs-special">)</span><span>
</span><a name="line-431"></a><span>
</span><a name="line-432"></a><span class="hs-comment">-- | Close a file descriptor in a race-safe way.</span><span>
</span><a name="line-433"></a><span class="hs-comment">-- It assumes the caller will update the callback tables and that the caller</span><span>
</span><a name="line-434"></a><span class="hs-comment">-- holds the callback table lock for the fd. It must hold this lock because</span><span>
</span><a name="line-435"></a><span class="hs-comment">-- this command executes a backend command on the fd.</span><span>
</span><a name="line-436"></a><span class="hs-identifier">closeFd_</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.Event.Manager.html#EventManager"><span class="hs-identifier hs-type">EventManager</span></a><span>
</span><a name="line-437"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Event.IntTable.html#IntTable"><span class="hs-identifier hs-type">IntTable</span></a><span> </span><span class="hs-special">[</span><a href="GHC.Event.Manager.html#FdData"><span class="hs-identifier hs-type">FdData</span></a><span class="hs-special">]</span><span>
</span><a name="line-438"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="System.Posix.Types.html#Fd"><span class="hs-identifier hs-type">Fd</span></a><span>
</span><a name="line-439"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-440"></a><a name="closeFd_"><a href="GHC.Event.Manager.html#closeFd_"><span class="hs-identifier">closeFd_</span></a></a><span> </span><a name="local-6989586621679297447"><a href="#local-6989586621679297447"><span class="hs-identifier">mgr</span></a></a><span> </span><a name="local-6989586621679297448"><a href="#local-6989586621679297448"><span class="hs-identifier">tbl</span></a></a><span> </span><a name="local-6989586621679297449"><a href="#local-6989586621679297449"><span class="hs-identifier">fd</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-441"></a><span>  </span><a name="local-6989586621679297450"><a href="#local-6989586621679297450"><span class="hs-identifier">prev</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.Event.IntTable.html#delete"><span class="hs-identifier hs-var">IT.delete</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a><span> </span><a href="#local-6989586621679297449"><span class="hs-identifier hs-var">fd</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679297448"><span class="hs-identifier hs-var">tbl</span></a><span>
</span><a name="line-442"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679297450"><span class="hs-identifier hs-var">prev</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-443"></a><span>    </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-444"></a><span>    </span><a href="GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621679297451"><a href="#local-6989586621679297451"><span class="hs-identifier">fds</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-445"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679297452"><a href="#local-6989586621679297452"><span class="hs-identifier">oldEls</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.Event.Manager.html#eventsOf"><span class="hs-identifier hs-var">eventsOf</span></a><span> </span><a href="#local-6989586621679297451"><span class="hs-identifier hs-var">fds</span></a><span>
</span><a name="line-446"></a><span>      </span><a href="GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679297452"><span class="hs-identifier hs-var">oldEls</span></a><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Classes.html#%2F%3D"><span class="hs-operator hs-var">/=</span></a><span> </span><a href="GHC.Base.html#mempty"><span class="hs-identifier hs-var">mempty</span></a><span class="hs-special">)</span><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-447"></a><span>        </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.Event.Internal.html#modifyFd"><span class="hs-identifier hs-var">I.modifyFd</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">emBackend</span><span> </span><a href="#local-6989586621679297447"><span class="hs-identifier hs-var">mgr</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679297449"><span class="hs-identifier hs-var">fd</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Event.Internal.html#elEvent"><span class="hs-identifier hs-var">I.elEvent</span></a><span> </span><a href="#local-6989586621679297452"><span class="hs-identifier hs-var">oldEls</span></a><span class="hs-special">)</span><span> </span><a href="GHC.Base.html#mempty"><span class="hs-identifier hs-var">mempty</span></a><span>
</span><a name="line-448"></a><span>        </span><a href="GHC.Event.Manager.html#wakeManager"><span class="hs-identifier hs-var">wakeManager</span></a><span> </span><a href="#local-6989586621679297447"><span class="hs-identifier hs-var">mgr</span></a><span>
</span><a name="line-449"></a><span>      </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-450"></a><span>        </span><a href="Data.Foldable.html#forM_"><span class="hs-identifier hs-var">forM_</span></a><span> </span><a href="#local-6989586621679297451"><span class="hs-identifier hs-var">fds</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><a href="GHC.Event.Manager.html#FdData"><span class="hs-identifier hs-var">FdData</span></a><span> </span><a name="local-6989586621679297453"><a href="#local-6989586621679297453"><span class="hs-identifier">reg</span></a></a><span> </span><a name="local-6989586621679297454"><a href="#local-6989586621679297454"><span class="hs-identifier">el</span></a></a><span> </span><a name="local-6989586621679297455"><a href="#local-6989586621679297455"><span class="hs-identifier">cb</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-451"></a><span>          </span><a href="#local-6989586621679297455"><span class="hs-identifier hs-var">cb</span></a><span> </span><a href="#local-6989586621679297453"><span class="hs-identifier hs-var">reg</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Event.Internal.html#elEvent"><span class="hs-identifier hs-var">I.elEvent</span></a><span> </span><a href="#local-6989586621679297454"><span class="hs-identifier hs-var">el</span></a><span> </span><span class="hs-special">`</span><a href="GHC.Base.html#mappend"><span class="hs-identifier hs-var">mappend</span></a><span class="hs-special">`</span><span> </span><a href="GHC.Event.Internal.html#evtClose"><span class="hs-identifier hs-var">evtClose</span></a><span class="hs-special">)</span><span>
</span><a name="line-452"></a><span>
</span><a name="line-453"></a><span class="hs-comment">------------------------------------------------------------------------</span><span>
</span><a name="line-454"></a><span class="hs-comment">-- Utilities</span><span>
</span><a name="line-455"></a><span>
</span><a name="line-456"></a><span class="hs-comment">-- | Call the callbacks corresponding to the given file descriptor.</span><span>
</span><a name="line-457"></a><span class="hs-identifier">onFdEvent</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.Event.Manager.html#EventManager"><span class="hs-identifier hs-type">EventManager</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="System.Posix.Types.html#Fd"><span class="hs-identifier hs-type">Fd</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Event.Internal.html#Event"><span class="hs-identifier hs-type">Event</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-458"></a><a name="onFdEvent"><a href="GHC.Event.Manager.html#onFdEvent"><span class="hs-identifier">onFdEvent</span></a></a><span> </span><a name="local-6989586621679297456"><a href="#local-6989586621679297456"><span class="hs-identifier">mgr</span></a></a><span> </span><a name="local-6989586621679297457"><a href="#local-6989586621679297457"><span class="hs-identifier">fd</span></a></a><span> </span><a name="local-6989586621679297458"><a href="#local-6989586621679297458"><span class="hs-identifier">evs</span></a></a><span>
</span><a name="line-459"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679297457"><span class="hs-identifier hs-var">fd</span></a><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a><span> </span><span class="hs-identifier">controlReadFd</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">emControl</span><span> </span><a href="#local-6989586621679297456"><span class="hs-identifier hs-var">mgr</span></a><span class="hs-special">)</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Classes.html#%7C%7C"><span class="hs-operator hs-var">||</span></a><span> </span><a href="#local-6989586621679297457"><span class="hs-identifier hs-var">fd</span></a><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a><span> </span><a href="GHC.Event.Control.html#wakeupReadFd"><span class="hs-identifier hs-var">wakeupReadFd</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">emControl</span><span> </span><a href="#local-6989586621679297456"><span class="hs-identifier hs-var">mgr</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-460"></a><span>    </span><a href="GHC.Event.Manager.html#handleControlEvent"><span class="hs-identifier hs-var">handleControlEvent</span></a><span> </span><a href="#local-6989586621679297456"><span class="hs-identifier hs-var">mgr</span></a><span> </span><a href="#local-6989586621679297457"><span class="hs-identifier hs-var">fd</span></a><span> </span><a href="#local-6989586621679297458"><span class="hs-identifier hs-var">evs</span></a><span>
</span><a name="line-461"></a><span>
</span><a name="line-462"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-463"></a><span>    </span><a name="local-6989586621679297472"><a href="#local-6989586621679297472"><span class="hs-identifier">fdds</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Control.Concurrent.MVar.html#withMVar"><span class="hs-identifier hs-var">withMVar</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Event.Manager.html#callbackTableVar"><span class="hs-identifier hs-var">callbackTableVar</span></a><span> </span><a href="#local-6989586621679297456"><span class="hs-identifier hs-var">mgr</span></a><span> </span><a href="#local-6989586621679297457"><span class="hs-identifier hs-var">fd</span></a><span class="hs-special">)</span><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679297471"><a href="#local-6989586621679297471"><span class="hs-identifier">tbl</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-464"></a><span>        </span><a href="GHC.Event.IntTable.html#delete"><span class="hs-identifier hs-var">IT.delete</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a><span> </span><a href="#local-6989586621679297457"><span class="hs-identifier hs-var">fd</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679297471"><span class="hs-identifier hs-var">tbl</span></a><span> </span><a href="GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a><span> </span><a href="Data.Maybe.html#maybe"><span class="hs-identifier hs-var">maybe</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679297459"><span class="hs-identifier hs-var">selectCallbacks</span></a><span> </span><a href="#local-6989586621679297471"><span class="hs-identifier hs-var">tbl</span></a><span class="hs-special">)</span><span>
</span><a name="line-465"></a><span>    </span><a href="Data.Foldable.html#forM_"><span class="hs-identifier hs-var">forM_</span></a><span> </span><a href="#local-6989586621679297472"><span class="hs-identifier hs-var">fdds</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><a href="GHC.Event.Manager.html#FdData"><span class="hs-identifier hs-var">FdData</span></a><span> </span><a name="local-6989586621679297473"><a href="#local-6989586621679297473"><span class="hs-identifier">reg</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679297474"><a href="#local-6989586621679297474"><span class="hs-identifier">cb</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679297474"><span class="hs-identifier hs-var">cb</span></a><span> </span><a href="#local-6989586621679297473"><span class="hs-identifier hs-var">reg</span></a><span> </span><a href="#local-6989586621679297458"><span class="hs-identifier hs-var">evs</span></a><span>
</span><a name="line-466"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-467"></a><span>    </span><span class="hs-comment">-- | Here we look through the list of registrations for the fd of interest</span><span>
</span><a name="line-468"></a><span>    </span><span class="hs-comment">-- and sort out which match the events that were triggered. We,</span><span>
</span><a name="line-469"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-470"></a><span>    </span><span class="hs-comment">--   1. re-arm the fd as appropriate</span><span>
</span><a name="line-471"></a><span>    </span><span class="hs-comment">--   2. reinsert registrations that weren't triggered and multishot</span><span>
</span><a name="line-472"></a><span>    </span><span class="hs-comment">--      registrations</span><span>
</span><a name="line-473"></a><span>    </span><span class="hs-comment">--   3. return a list containing the callbacks that should be invoked.</span><span>
</span><a name="line-474"></a><span>    </span><span class="hs-identifier">selectCallbacks</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.Event.IntTable.html#IntTable"><span class="hs-identifier hs-type">IntTable</span></a><span> </span><span class="hs-special">[</span><a href="GHC.Event.Manager.html#FdData"><span class="hs-identifier hs-type">FdData</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="GHC.Event.Manager.html#FdData"><span class="hs-identifier hs-type">FdData</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">[</span><a href="GHC.Event.Manager.html#FdData"><span class="hs-identifier hs-type">FdData</span></a><span class="hs-special">]</span><span>
</span><a name="line-475"></a><span>    </span><a name="local-6989586621679297459"><a href="#local-6989586621679297459"><span class="hs-identifier">selectCallbacks</span></a></a><span> </span><a name="local-6989586621679297460"><a href="#local-6989586621679297460"><span class="hs-identifier">tbl</span></a></a><span> </span><a name="local-6989586621679297461"><a href="#local-6989586621679297461"><span class="hs-identifier">fdds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-476"></a><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-comment">-- figure out which registrations have been triggered</span><span>
</span><a name="line-477"></a><span>            </span><span class="hs-identifier">matches</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.Event.Manager.html#FdData"><span class="hs-identifier hs-type">FdData</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a><span>
</span><a name="line-478"></a><span>            </span><a name="local-6989586621679297462"><a href="#local-6989586621679297462"><span class="hs-identifier">matches</span></a></a><span> </span><a name="local-6989586621679297469"><a href="#local-6989586621679297469"><span class="hs-identifier">fd'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679297458"><span class="hs-identifier hs-var">evs</span></a><span> </span><span class="hs-special">`</span><a href="GHC.Event.Internal.html#eventIs"><span class="hs-identifier hs-var">I.eventIs</span></a><span class="hs-special">`</span><span> </span><a href="GHC.Event.Internal.html#elEvent"><span class="hs-identifier hs-var">I.elEvent</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">fdEvents</span><span> </span><a href="#local-6989586621679297469"><span class="hs-identifier hs-var">fd'</span></a><span class="hs-special">)</span><span>
</span><a name="line-479"></a><span>            </span><span class="hs-special">(</span><a name="local-6989586621679297463"><a href="#local-6989586621679297463"><span class="hs-identifier">triggered</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679297464"><a href="#local-6989586621679297464"><span class="hs-identifier">notTriggered</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.OldList.html#partition"><span class="hs-identifier hs-var">partition</span></a><span> </span><a href="#local-6989586621679297462"><span class="hs-identifier hs-var">matches</span></a><span> </span><a href="#local-6989586621679297461"><span class="hs-identifier hs-var">fdds</span></a><span>
</span><a name="line-480"></a><span>
</span><a name="line-481"></a><span>            </span><span class="hs-comment">-- sort out which registrations we need to retain</span><span>
</span><a name="line-482"></a><span>            </span><span class="hs-identifier">isMultishot</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.Event.Manager.html#FdData"><span class="hs-identifier hs-type">FdData</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a><span>
</span><a name="line-483"></a><span>            </span><a name="local-6989586621679297465"><a href="#local-6989586621679297465"><span class="hs-identifier">isMultishot</span></a></a><span> </span><a name="local-6989586621679297470"><a href="#local-6989586621679297470"><span class="hs-identifier">fd'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.Event.Internal.html#elLifetime"><span class="hs-identifier hs-var">I.elLifetime</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">fdEvents</span><span> </span><a href="#local-6989586621679297470"><span class="hs-identifier hs-var">fd'</span></a><span class="hs-special">)</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a><span> </span><a href="GHC.Event.Internal.html#MultiShot"><span class="hs-identifier hs-var">MultiShot</span></a><span>
</span><a name="line-484"></a><span>            </span><a name="local-6989586621679297466"><a href="#local-6989586621679297466"><span class="hs-identifier">saved</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679297464"><span class="hs-identifier hs-var">notTriggered</span></a><span> </span><a href="GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="GHC.List.html#filter"><span class="hs-identifier hs-var">filter</span></a><span> </span><a href="#local-6989586621679297465"><span class="hs-identifier hs-var">isMultishot</span></a><span> </span><a href="#local-6989586621679297463"><span class="hs-identifier hs-var">triggered</span></a><span>
</span><a name="line-485"></a><span>
</span><a name="line-486"></a><span>            </span><a name="local-6989586621679297467"><a href="#local-6989586621679297467"><span class="hs-identifier">savedEls</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.Event.Manager.html#eventsOf"><span class="hs-identifier hs-var">eventsOf</span></a><span> </span><a href="#local-6989586621679297466"><span class="hs-identifier hs-var">saved</span></a><span>
</span><a name="line-487"></a><span>            </span><a name="local-6989586621679297468"><a href="#local-6989586621679297468"><span class="hs-identifier">allEls</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.Event.Manager.html#eventsOf"><span class="hs-identifier hs-var">eventsOf</span></a><span> </span><a href="#local-6989586621679297461"><span class="hs-identifier hs-var">fdds</span></a><span>
</span><a name="line-488"></a><span>
</span><a name="line-489"></a><span>        </span><span class="hs-comment">-- Reinsert multishot registrations.</span><span>
</span><a name="line-490"></a><span>        </span><span class="hs-comment">-- We deleted the table entry for this fd above so we there isn't a preexisting entry</span><span>
</span><a name="line-491"></a><span>        </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.Event.IntTable.html#insertWith"><span class="hs-identifier hs-var">IT.insertWith</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679297466"><span class="hs-identifier hs-var">saved</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a><span> </span><a href="#local-6989586621679297457"><span class="hs-identifier hs-var">fd</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679297466"><span class="hs-identifier hs-var">saved</span></a><span> </span><a href="#local-6989586621679297460"><span class="hs-identifier hs-var">tbl</span></a><span>
</span><a name="line-492"></a><span>
</span><a name="line-493"></a><span>        </span><span class="hs-keyword">case</span><span> </span><a href="GHC.Event.Internal.html#elLifetime"><span class="hs-identifier hs-var">I.elLifetime</span></a><span> </span><a href="#local-6989586621679297468"><span class="hs-identifier hs-var">allEls</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-494"></a><span>          </span><span class="hs-comment">-- we previously armed the fd for multiple shots, no need to rearm</span><span>
</span><a name="line-495"></a><span>          </span><a href="GHC.Event.Internal.html#MultiShot"><span class="hs-identifier hs-var">MultiShot</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679297468"><span class="hs-identifier hs-var">allEls</span></a><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a><span> </span><a href="#local-6989586621679297467"><span class="hs-identifier hs-var">savedEls</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-496"></a><span>            </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-497"></a><span>
</span><a name="line-498"></a><span>          </span><span class="hs-comment">-- either we previously registered for one shot or the</span><span>
</span><a name="line-499"></a><span>          </span><span class="hs-comment">-- events of interest have changed, we must re-arm</span><span>
</span><a name="line-500"></a><span>          </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-501"></a><span>            </span><span class="hs-keyword">case</span><span> </span><a href="GHC.Event.Internal.html#elLifetime"><span class="hs-identifier hs-var">I.elLifetime</span></a><span> </span><a href="#local-6989586621679297467"><span class="hs-identifier hs-var">savedEls</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-502"></a><span>              </span><a href="GHC.Event.Internal.html#OneShot"><span class="hs-identifier hs-var">OneShot</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="GHC.Event.Manager.html#haveOneShot"><span class="hs-identifier hs-var">haveOneShot</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-503"></a><span>                </span><span class="hs-comment">-- if there are no saved events and we registered with one-shot</span><span>
</span><a name="line-504"></a><span>                </span><span class="hs-comment">-- semantics then there is no need to re-arm</span><span>
</span><a name="line-505"></a><span>                </span><a href="GHC.Event.Manager.html#unless"><span class="hs-identifier hs-var">unless</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Event.Internal.html#OneShot"><span class="hs-identifier hs-var">OneShot</span></a><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a><span> </span><a href="GHC.Event.Internal.html#elLifetime"><span class="hs-identifier hs-var">I.elLifetime</span></a><span> </span><a href="#local-6989586621679297468"><span class="hs-identifier hs-var">allEls</span></a><span>
</span><a name="line-506"></a><span>                        </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Classes.html#%26%26"><span class="hs-operator hs-var">&amp;&amp;</span></a><span> </span><a href="GHC.Base.html#mempty"><span class="hs-identifier hs-var">mempty</span></a><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a><span> </span><a href="GHC.Event.Internal.html#elEvent"><span class="hs-identifier hs-var">I.elEvent</span></a><span> </span><a href="#local-6989586621679297467"><span class="hs-identifier hs-var">savedEls</span></a><span class="hs-special">)</span><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-507"></a><span>                  </span><a href="Data.Functor.html#void"><span class="hs-identifier hs-var">void</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="GHC.Event.Internal.html#modifyFdOnce"><span class="hs-identifier hs-var">I.modifyFdOnce</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">emBackend</span><span> </span><a href="#local-6989586621679297456"><span class="hs-identifier hs-var">mgr</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679297457"><span class="hs-identifier hs-var">fd</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Event.Internal.html#elEvent"><span class="hs-identifier hs-var">I.elEvent</span></a><span> </span><a href="#local-6989586621679297467"><span class="hs-identifier hs-var">savedEls</span></a><span class="hs-special">)</span><span>
</span><a name="line-508"></a><span>              </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-509"></a><span>                </span><span class="hs-comment">-- we need to re-arm with multi-shot semantics</span><span>
</span><a name="line-510"></a><span>                </span><a href="Data.Functor.html#void"><span class="hs-identifier hs-var">void</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="GHC.Event.Internal.html#modifyFd"><span class="hs-identifier hs-var">I.modifyFd</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">emBackend</span><span> </span><a href="#local-6989586621679297456"><span class="hs-identifier hs-var">mgr</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679297457"><span class="hs-identifier hs-var">fd</span></a><span>
</span><a name="line-511"></a><span>                                  </span><span class="hs-special">(</span><a href="GHC.Event.Internal.html#elEvent"><span class="hs-identifier hs-var">I.elEvent</span></a><span> </span><a href="#local-6989586621679297468"><span class="hs-identifier hs-var">allEls</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="GHC.Event.Internal.html#elEvent"><span class="hs-identifier hs-var">I.elEvent</span></a><span> </span><a href="#local-6989586621679297467"><span class="hs-identifier hs-var">savedEls</span></a><span class="hs-special">)</span><span>
</span><a name="line-512"></a><span>
</span><a name="line-513"></a><span>        </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621679297463"><span class="hs-identifier hs-var">triggered</span></a><span>
</span><a name="line-514"></a><span>
</span><a name="line-515"></a><span class="hs-identifier">nullToNothing</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679297311"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621679297311"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span>
</span><a name="line-516"></a><a name="nullToNothing"><a href="GHC.Event.Manager.html#nullToNothing"><span class="hs-identifier">nullToNothing</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>
</span><a name="line-517"></a><span class="hs-identifier">nullToNothing</span><span> </span><a name="local-6989586621679297475"><a href="#local-6989586621679297475"><span class="hs-identifier">xs</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="#local-6989586621679297475"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-518"></a><span>
</span><a name="line-519"></a><span class="hs-identifier">unless</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.Base.html#Monad"><span class="hs-identifier hs-type">Monad</span></a><span> </span><a href="#local-6989586621679297310"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679297310"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679297310"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-520"></a><a name="unless"><a href="GHC.Event.Manager.html#unless"><span class="hs-identifier">unless</span></a></a><span> </span><a name="local-6989586621679297476"><a href="#local-6989586621679297476"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a><span> </span><span class="hs-special">(</span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Classes.html#not"><span class="hs-identifier hs-var">not</span></a><span> </span><a href="#local-6989586621679297476"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span>
</span><a name="line-521"></a></pre></body></html>