<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE Trustworthy #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE NoImplicitPrelude, UnboxedTuples, MagicHash #-}</span><span>
</span><a name="line-3"></a><span>
</span><a name="line-4"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-5"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-6"></a><span class="hs-comment">-- Module      :  Control.Concurrent.MVar</span><span>
</span><a name="line-7"></a><span class="hs-comment">-- Copyright   :  (c) The University of Glasgow 2001</span><span>
</span><a name="line-8"></a><span class="hs-comment">-- License     :  BSD-style (see the file libraries/base/LICENSE)</span><span>
</span><a name="line-9"></a><span class="hs-comment">-- </span><span>
</span><a name="line-10"></a><span class="hs-comment">-- Maintainer  :  libraries@haskell.org</span><span>
</span><a name="line-11"></a><span class="hs-comment">-- Stability   :  experimental</span><span>
</span><a name="line-12"></a><span class="hs-comment">-- Portability :  non-portable (concurrency)</span><span>
</span><a name="line-13"></a><span class="hs-comment">--</span><span>
</span><a name="line-14"></a><span class="hs-comment">-- An @'MVar' t@ is mutable location that is either empty or contains a</span><span>
</span><a name="line-15"></a><span class="hs-comment">-- value of type @t@.  It has two fundamental operations: 'putMVar'</span><span>
</span><a name="line-16"></a><span class="hs-comment">-- which fills an 'MVar' if it is empty and blocks otherwise, and</span><span>
</span><a name="line-17"></a><span class="hs-comment">-- 'takeMVar' which empties an 'MVar' if it is full and blocks</span><span>
</span><a name="line-18"></a><span class="hs-comment">-- otherwise.  They can be used in multiple different ways:</span><span>
</span><a name="line-19"></a><span class="hs-comment">--</span><span>
</span><a name="line-20"></a><span class="hs-comment">--   1. As synchronized mutable variables,</span><span>
</span><a name="line-21"></a><span class="hs-comment">--</span><span>
</span><a name="line-22"></a><span class="hs-comment">--   2. As channels, with 'takeMVar' and 'putMVar' as receive and send, and</span><span>
</span><a name="line-23"></a><span class="hs-comment">--</span><span>
</span><a name="line-24"></a><span class="hs-comment">--   3. As a binary semaphore @'MVar' ()@, with 'takeMVar' and 'putMVar' as</span><span>
</span><a name="line-25"></a><span class="hs-comment">--      wait and signal.</span><span>
</span><a name="line-26"></a><span class="hs-comment">--</span><span>
</span><a name="line-27"></a><span class="hs-comment">-- They were introduced in the paper</span><span>
</span><a name="line-28"></a><span class="hs-comment">-- &lt;https://www.haskell.org/ghc/docs/papers/concurrent-haskell.ps.gz &quot;Concurrent Haskell&quot;&gt;</span><span>
</span><a name="line-29"></a><span class="hs-comment">-- by Simon Peyton Jones, Andrew Gordon and Sigbjorn Finne, though</span><span>
</span><a name="line-30"></a><span class="hs-comment">-- some details of their implementation have since then changed (in</span><span>
</span><a name="line-31"></a><span class="hs-comment">-- particular, a put on a full 'MVar' used to error, but now merely</span><span>
</span><a name="line-32"></a><span class="hs-comment">-- blocks.)</span><span>
</span><a name="line-33"></a><span class="hs-comment">--</span><span>
</span><a name="line-34"></a><span class="hs-comment">-- === Applicability</span><span>
</span><a name="line-35"></a><span class="hs-comment">--</span><span>
</span><a name="line-36"></a><span class="hs-comment">-- 'MVar's offer more flexibility than 'IORef's, but less flexibility</span><span>
</span><a name="line-37"></a><span class="hs-comment">-- than 'STM'.  They are appropriate for building synchronization</span><span>
</span><a name="line-38"></a><span class="hs-comment">-- primitives and performing simple interthread communication; however</span><span>
</span><a name="line-39"></a><span class="hs-comment">-- they are very simple and susceptible to race conditions, deadlocks or</span><span>
</span><a name="line-40"></a><span class="hs-comment">-- uncaught exceptions.  Do not use them if you need perform larger</span><span>
</span><a name="line-41"></a><span class="hs-comment">-- atomic operations such as reading from multiple variables: use 'STM'</span><span>
</span><a name="line-42"></a><span class="hs-comment">-- instead.</span><span>
</span><a name="line-43"></a><span class="hs-comment">--</span><span>
</span><a name="line-44"></a><span class="hs-comment">-- In particular, the &quot;bigger&quot; functions in this module ('swapMVar',</span><span>
</span><a name="line-45"></a><span class="hs-comment">-- 'withMVar', 'modifyMVar_' and 'modifyMVar') are simply</span><span>
</span><a name="line-46"></a><span class="hs-comment">-- the composition of a 'takeMVar' followed by a 'putMVar' with</span><span>
</span><a name="line-47"></a><span class="hs-comment">-- exception safety.</span><span>
</span><a name="line-48"></a><span class="hs-comment">-- These only have atomicity guarantees if all other threads</span><span>
</span><a name="line-49"></a><span class="hs-comment">-- perform a 'takeMVar' before a 'putMVar' as well;  otherwise, they may</span><span>
</span><a name="line-50"></a><span class="hs-comment">-- block.</span><span>
</span><a name="line-51"></a><span class="hs-comment">--</span><span>
</span><a name="line-52"></a><span class="hs-comment">-- === Fairness</span><span>
</span><a name="line-53"></a><span class="hs-comment">--</span><span>
</span><a name="line-54"></a><span class="hs-comment">-- No thread can be blocked indefinitely on an 'MVar' unless another</span><span>
</span><a name="line-55"></a><span class="hs-comment">-- thread holds that 'MVar' indefinitely.  One usual implementation of</span><span>
</span><a name="line-56"></a><span class="hs-comment">-- this fairness guarantee is that threads blocked on an 'MVar' are</span><span>
</span><a name="line-57"></a><span class="hs-comment">-- served in a first-in-first-out fashion, but this is not guaranteed</span><span>
</span><a name="line-58"></a><span class="hs-comment">-- in the semantics.</span><span>
</span><a name="line-59"></a><span class="hs-comment">--</span><span>
</span><a name="line-60"></a><span class="hs-comment">-- === Gotchas</span><span>
</span><a name="line-61"></a><span class="hs-comment">--</span><span>
</span><a name="line-62"></a><span class="hs-comment">-- Like many other Haskell data structures, 'MVar's are lazy.  This</span><span>
</span><a name="line-63"></a><span class="hs-comment">-- means that if you place an expensive unevaluated thunk inside an</span><span>
</span><a name="line-64"></a><span class="hs-comment">-- 'MVar', it will be evaluated by the thread that consumes it, not the</span><span>
</span><a name="line-65"></a><span class="hs-comment">-- thread that produced it.  Be sure to 'evaluate' values to be placed</span><span>
</span><a name="line-66"></a><span class="hs-comment">-- in an 'MVar' to the appropriate normal form, or utilize a strict</span><span>
</span><a name="line-67"></a><span class="hs-comment">-- MVar provided by the strict-concurrency package.</span><span>
</span><a name="line-68"></a><span class="hs-comment">--</span><span>
</span><a name="line-69"></a><span class="hs-comment">-- === Ordering</span><span>
</span><a name="line-70"></a><span class="hs-comment">--</span><span>
</span><a name="line-71"></a><span class="hs-comment">-- 'MVar' operations are always observed to take place in the order</span><span>
</span><a name="line-72"></a><span class="hs-comment">-- they are written in the program, regardless of the memory model of</span><span>
</span><a name="line-73"></a><span class="hs-comment">-- the underlying machine.  This is in contrast to 'IORef' operations</span><span>
</span><a name="line-74"></a><span class="hs-comment">-- which may appear out-of-order to another thread in some cases.</span><span>
</span><a name="line-75"></a><span class="hs-comment">--</span><span>
</span><a name="line-76"></a><span class="hs-comment">-- === Example</span><span>
</span><a name="line-77"></a><span class="hs-comment">--</span><span>
</span><a name="line-78"></a><span class="hs-comment">-- Consider the following concurrent data structure, a skip channel.</span><span>
</span><a name="line-79"></a><span class="hs-comment">-- This is a channel for an intermittent source of high bandwidth</span><span>
</span><a name="line-80"></a><span class="hs-comment">-- information (for example, mouse movement events.)  Writing to the</span><span>
</span><a name="line-81"></a><span class="hs-comment">-- channel never blocks, and reading from the channel only returns the</span><span>
</span><a name="line-82"></a><span class="hs-comment">-- most recent value, or blocks if there are no new values.  Multiple</span><span>
</span><a name="line-83"></a><span class="hs-comment">-- readers are supported with a @dupSkipChan@ operation.</span><span>
</span><a name="line-84"></a><span class="hs-comment">--</span><span>
</span><a name="line-85"></a><span class="hs-comment">-- A skip channel is a pair of 'MVar's. The first 'MVar' contains the</span><span>
</span><a name="line-86"></a><span class="hs-comment">-- current value, and a list of semaphores that need to be notified</span><span>
</span><a name="line-87"></a><span class="hs-comment">-- when it changes. The second 'MVar' is a semaphore for this particular</span><span>
</span><a name="line-88"></a><span class="hs-comment">-- reader: it is full if there is a value in the channel that this</span><span>
</span><a name="line-89"></a><span class="hs-comment">-- reader has not read yet, and empty otherwise.</span><span>
</span><a name="line-90"></a><span class="hs-comment">--</span><span>
</span><a name="line-91"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-92"></a><span class="hs-comment">--     data SkipChan a = SkipChan (MVar (a, [MVar ()])) (MVar ())</span><span>
</span><a name="line-93"></a><span class="hs-comment">--</span><span>
</span><a name="line-94"></a><span class="hs-comment">--     newSkipChan :: IO (SkipChan a)</span><span>
</span><a name="line-95"></a><span class="hs-comment">--     newSkipChan = do</span><span>
</span><a name="line-96"></a><span class="hs-comment">--         sem &lt;- newEmptyMVar</span><span>
</span><a name="line-97"></a><span class="hs-comment">--         main &lt;- newMVar (undefined, [sem])</span><span>
</span><a name="line-98"></a><span class="hs-comment">--         return (SkipChan main sem)</span><span>
</span><a name="line-99"></a><span class="hs-comment">--</span><span>
</span><a name="line-100"></a><span class="hs-comment">--     putSkipChan :: SkipChan a -&gt; a -&gt; IO ()</span><span>
</span><a name="line-101"></a><span class="hs-comment">--     putSkipChan (SkipChan main _) v = do</span><span>
</span><a name="line-102"></a><span class="hs-comment">--         (_, sems) &lt;- takeMVar main</span><span>
</span><a name="line-103"></a><span class="hs-comment">--         putMVar main (v, [])</span><span>
</span><a name="line-104"></a><span class="hs-comment">--         mapM_ (\sem -&gt; putMVar sem ()) sems</span><span>
</span><a name="line-105"></a><span class="hs-comment">--</span><span>
</span><a name="line-106"></a><span class="hs-comment">--     getSkipChan :: SkipChan a -&gt; IO a</span><span>
</span><a name="line-107"></a><span class="hs-comment">--     getSkipChan (SkipChan main sem) = do</span><span>
</span><a name="line-108"></a><span class="hs-comment">--         takeMVar sem</span><span>
</span><a name="line-109"></a><span class="hs-comment">--         (v, sems) &lt;- takeMVar main</span><span>
</span><a name="line-110"></a><span class="hs-comment">--         putMVar main (v, sem:sems)</span><span>
</span><a name="line-111"></a><span class="hs-comment">--         return v</span><span>
</span><a name="line-112"></a><span class="hs-comment">--</span><span>
</span><a name="line-113"></a><span class="hs-comment">--     dupSkipChan :: SkipChan a -&gt; IO (SkipChan a)</span><span>
</span><a name="line-114"></a><span class="hs-comment">--     dupSkipChan (SkipChan main _) = do</span><span>
</span><a name="line-115"></a><span class="hs-comment">--         sem &lt;- newEmptyMVar</span><span>
</span><a name="line-116"></a><span class="hs-comment">--         (v, sems) &lt;- takeMVar main</span><span>
</span><a name="line-117"></a><span class="hs-comment">--         putMVar main (v, sem:sems)</span><span>
</span><a name="line-118"></a><span class="hs-comment">--         return (SkipChan main sem)</span><span>
</span><a name="line-119"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-120"></a><span class="hs-comment">--</span><span>
</span><a name="line-121"></a><span class="hs-comment">-- This example was adapted from the original Concurrent Haskell paper.</span><span>
</span><a name="line-122"></a><span class="hs-comment">-- For more examples of 'MVar's being used to build higher-level</span><span>
</span><a name="line-123"></a><span class="hs-comment">-- synchronization primitives, see 'Control.Concurrent.Chan' and</span><span>
</span><a name="line-124"></a><span class="hs-comment">-- 'Control.Concurrent.QSem'.</span><span>
</span><a name="line-125"></a><span class="hs-comment">--</span><span>
</span><a name="line-126"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-127"></a><span>
</span><a name="line-128"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Control.Concurrent.MVar</span><span>
</span><a name="line-129"></a><span>        </span><span class="hs-special">(</span><span>
</span><a name="line-130"></a><span>          </span><span class="hs-comment">-- * @MVar@s</span><span>
</span><a name="line-131"></a><span>          </span><a href="GHC.MVar.html#MVar"><span class="hs-identifier hs-type">MVar</span></a><span>
</span><a name="line-132"></a><span>        </span><span class="hs-special">,</span><span> </span><a href="GHC.MVar.html#newEmptyMVar"><span class="hs-identifier hs-var">newEmptyMVar</span></a><span>
</span><a name="line-133"></a><span>        </span><span class="hs-special">,</span><span> </span><a href="GHC.MVar.html#newMVar"><span class="hs-identifier hs-var">newMVar</span></a><span>
</span><a name="line-134"></a><span>        </span><span class="hs-special">,</span><span> </span><a href="GHC.MVar.html#takeMVar"><span class="hs-identifier hs-var">takeMVar</span></a><span>
</span><a name="line-135"></a><span>        </span><span class="hs-special">,</span><span> </span><a href="GHC.MVar.html#putMVar"><span class="hs-identifier hs-var">putMVar</span></a><span>
</span><a name="line-136"></a><span>        </span><span class="hs-special">,</span><span> </span><a href="GHC.MVar.html#readMVar"><span class="hs-identifier hs-var">readMVar</span></a><span>
</span><a name="line-137"></a><span>        </span><span class="hs-special">,</span><span> </span><a href="Control.Concurrent.MVar.html#swapMVar"><span class="hs-identifier hs-var">swapMVar</span></a><span>
</span><a name="line-138"></a><span>        </span><span class="hs-special">,</span><span> </span><a href="GHC.MVar.html#tryTakeMVar"><span class="hs-identifier hs-var">tryTakeMVar</span></a><span>
</span><a name="line-139"></a><span>        </span><span class="hs-special">,</span><span> </span><a href="GHC.MVar.html#tryPutMVar"><span class="hs-identifier hs-var">tryPutMVar</span></a><span>
</span><a name="line-140"></a><span>        </span><span class="hs-special">,</span><span> </span><a href="GHC.MVar.html#isEmptyMVar"><span class="hs-identifier hs-var">isEmptyMVar</span></a><span>
</span><a name="line-141"></a><span>        </span><span class="hs-special">,</span><span> </span><a href="Control.Concurrent.MVar.html#withMVar"><span class="hs-identifier hs-var">withMVar</span></a><span>
</span><a name="line-142"></a><span>        </span><span class="hs-special">,</span><span> </span><a href="Control.Concurrent.MVar.html#withMVarMasked"><span class="hs-identifier hs-var">withMVarMasked</span></a><span>
</span><a name="line-143"></a><span>        </span><span class="hs-special">,</span><span> </span><a href="Control.Concurrent.MVar.html#modifyMVar_"><span class="hs-identifier hs-var">modifyMVar_</span></a><span>
</span><a name="line-144"></a><span>        </span><span class="hs-special">,</span><span> </span><a href="Control.Concurrent.MVar.html#modifyMVar"><span class="hs-identifier hs-var">modifyMVar</span></a><span>
</span><a name="line-145"></a><span>        </span><span class="hs-special">,</span><span> </span><a href="Control.Concurrent.MVar.html#modifyMVarMasked_"><span class="hs-identifier hs-var">modifyMVarMasked_</span></a><span>
</span><a name="line-146"></a><span>        </span><span class="hs-special">,</span><span> </span><a href="Control.Concurrent.MVar.html#modifyMVarMasked"><span class="hs-identifier hs-var">modifyMVarMasked</span></a><span>
</span><a name="line-147"></a><span>        </span><span class="hs-special">,</span><span> </span><a href="GHC.MVar.html#tryReadMVar"><span class="hs-identifier hs-var">tryReadMVar</span></a><span>
</span><a name="line-148"></a><span>        </span><span class="hs-special">,</span><span> </span><a href="Control.Concurrent.MVar.html#mkWeakMVar"><span class="hs-identifier hs-var">mkWeakMVar</span></a><span>
</span><a name="line-149"></a><span>        </span><span class="hs-special">,</span><span> </span><a href="Control.Concurrent.MVar.html#addMVarFinalizer"><span class="hs-identifier hs-var">addMVarFinalizer</span></a><span>
</span><a name="line-150"></a><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-151"></a><span>
</span><a name="line-152"></a><span class="hs-keyword">import</span><span> </span><a href="GHC.MVar.html"><span class="hs-identifier">GHC.MVar</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="GHC.MVar.html#MVar"><span class="hs-identifier hs-type">MVar</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="GHC.MVar.html#newEmptyMVar"><span class="hs-identifier hs-var">newEmptyMVar</span></a><span class="hs-special">,</span><span> </span><a href="GHC.MVar.html#newMVar"><span class="hs-identifier hs-var">newMVar</span></a><span class="hs-special">,</span><span> </span><a href="GHC.MVar.html#takeMVar"><span class="hs-identifier hs-var">takeMVar</span></a><span class="hs-special">,</span><span> </span><a href="GHC.MVar.html#putMVar"><span class="hs-identifier hs-var">putMVar</span></a><span class="hs-special">,</span><span>
</span><a name="line-153"></a><span>                  </span><a href="GHC.MVar.html#tryTakeMVar"><span class="hs-identifier hs-var">tryTakeMVar</span></a><span class="hs-special">,</span><span> </span><a href="GHC.MVar.html#tryPutMVar"><span class="hs-identifier hs-var">tryPutMVar</span></a><span class="hs-special">,</span><span> </span><a href="GHC.MVar.html#isEmptyMVar"><span class="hs-identifier hs-var">isEmptyMVar</span></a><span class="hs-special">,</span><span> </span><a href="GHC.MVar.html#readMVar"><span class="hs-identifier hs-var">readMVar</span></a><span class="hs-special">,</span><span>
</span><a name="line-154"></a><span>                  </span><a href="GHC.MVar.html#tryReadMVar"><span class="hs-identifier hs-var">tryReadMVar</span></a><span>
</span><a name="line-155"></a><span>                </span><span class="hs-special">)</span><span>
</span><a name="line-156"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="GHC.MVar.html"><span class="hs-identifier">GHC.MVar</span></a><span>
</span><a name="line-157"></a><span class="hs-keyword">import</span><span> </span><a href="GHC.Weak.html"><span class="hs-identifier">GHC.Weak</span></a><span>
</span><a name="line-158"></a><span class="hs-keyword">import</span><span> </span><a href="GHC.Base.html"><span class="hs-identifier">GHC.Base</span></a><span>
</span><a name="line-159"></a><span>
</span><a name="line-160"></a><span class="hs-keyword">import</span><span> </span><a href="Control.Exception.Base.html"><span class="hs-identifier">Control.Exception.Base</span></a><span>
</span><a name="line-161"></a><span>
</span><a name="line-162"></a><span class="hs-comment">{-|
  Take a value from an 'MVar', put a new value into the 'MVar' and
  return the value taken. This function is atomic only if there are
  no other producers for this 'MVar'.
-}</span><span>
</span><a name="line-167"></a><span class="hs-identifier">swapMVar</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.MVar.html#MVar"><span class="hs-identifier hs-type">MVar</span></a><span> </span><a href="#local-6989586621679292603"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679292603"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="#local-6989586621679292603"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-168"></a><a name="swapMVar"><a href="Control.Concurrent.MVar.html#swapMVar"><span class="hs-identifier">swapMVar</span></a></a><span> </span><a name="local-6989586621679292604"><a href="#local-6989586621679292604"><span class="hs-identifier">mvar</span></a></a><span> </span><a name="local-6989586621679292605"><a href="#local-6989586621679292605"><span class="hs-identifier">new</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-169"></a><span>  </span><a href="GHC.IO.html#mask_"><span class="hs-identifier hs-var">mask_</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-170"></a><span>    </span><a name="local-6989586621679292606"><a href="#local-6989586621679292606"><span class="hs-identifier">old</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.MVar.html#takeMVar"><span class="hs-identifier hs-var">takeMVar</span></a><span> </span><a href="#local-6989586621679292604"><span class="hs-identifier hs-var">mvar</span></a><span>
</span><a name="line-171"></a><span>    </span><a href="GHC.MVar.html#putMVar"><span class="hs-identifier hs-var">putMVar</span></a><span> </span><a href="#local-6989586621679292604"><span class="hs-identifier hs-var">mvar</span></a><span> </span><a href="#local-6989586621679292605"><span class="hs-identifier hs-var">new</span></a><span>
</span><a name="line-172"></a><span>    </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621679292606"><span class="hs-identifier hs-var">old</span></a><span>
</span><a name="line-173"></a><span>
</span><a name="line-174"></a><span class="hs-comment">{-|
  'withMVar' is an exception-safe wrapper for operating on the contents
  of an 'MVar'.  This operation is exception-safe: it will replace the
  original contents of the 'MVar' if an exception is raised (see
  &quot;Control.Exception&quot;).  However, it is only atomic if there are no
  other producers for this 'MVar'.
-}</span><span>
</span><a name="line-181"></a><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">withMVar</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-182"></a><span class="hs-comment">-- inlining has been reported to have dramatic effects; see</span><span>
</span><a name="line-183"></a><span class="hs-comment">-- http://www.haskell.org//pipermail/haskell/2006-May/017907.html</span><span>
</span><a name="line-184"></a><span class="hs-identifier">withMVar</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.MVar.html#MVar"><span class="hs-identifier hs-type">MVar</span></a><span> </span><a href="#local-6989586621679292601"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679292601"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="#local-6989586621679292602"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="#local-6989586621679292602"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-185"></a><a name="withMVar"><a href="Control.Concurrent.MVar.html#withMVar"><span class="hs-identifier">withMVar</span></a></a><span> </span><a name="local-6989586621679292607"><a href="#local-6989586621679292607"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679292608"><a href="#local-6989586621679292608"><span class="hs-identifier">io</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-186"></a><span>  </span><a href="GHC.IO.html#mask"><span class="hs-identifier hs-var">mask</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679292609"><a href="#local-6989586621679292609"><span class="hs-identifier">restore</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-187"></a><span>    </span><a name="local-6989586621679292610"><a href="#local-6989586621679292610"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.MVar.html#takeMVar"><span class="hs-identifier hs-var">takeMVar</span></a><span> </span><a href="#local-6989586621679292607"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-188"></a><span>    </span><a name="local-6989586621679292611"><a href="#local-6989586621679292611"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679292609"><span class="hs-identifier hs-var">restore</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679292608"><span class="hs-identifier hs-var">io</span></a><span> </span><a href="#local-6989586621679292610"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><a href="Control.Exception.Base.html#onException"><span class="hs-identifier hs-var">onException</span></a><span class="hs-special">`</span><span> </span><a href="GHC.MVar.html#putMVar"><span class="hs-identifier hs-var">putMVar</span></a><span> </span><a href="#local-6989586621679292607"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="#local-6989586621679292610"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-189"></a><span>    </span><a href="GHC.MVar.html#putMVar"><span class="hs-identifier hs-var">putMVar</span></a><span> </span><a href="#local-6989586621679292607"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="#local-6989586621679292610"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-190"></a><span>    </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621679292611"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-191"></a><span>
</span><a name="line-192"></a><span class="hs-comment">{-|
  Like 'withMVar', but the @IO@ action in the second argument is executed
  with asynchronous exceptions masked.

  @since 4.7.0.0
-}</span><span>
</span><a name="line-198"></a><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">withMVarMasked</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-199"></a><span class="hs-identifier">withMVarMasked</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.MVar.html#MVar"><span class="hs-identifier hs-type">MVar</span></a><span> </span><a href="#local-6989586621679292599"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679292599"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="#local-6989586621679292600"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="#local-6989586621679292600"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-200"></a><a name="withMVarMasked"><a href="Control.Concurrent.MVar.html#withMVarMasked"><span class="hs-identifier">withMVarMasked</span></a></a><span> </span><a name="local-6989586621679292612"><a href="#local-6989586621679292612"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679292613"><a href="#local-6989586621679292613"><span class="hs-identifier">io</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-201"></a><span>  </span><a href="GHC.IO.html#mask_"><span class="hs-identifier hs-var">mask_</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-202"></a><span>    </span><a name="local-6989586621679292614"><a href="#local-6989586621679292614"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.MVar.html#takeMVar"><span class="hs-identifier hs-var">takeMVar</span></a><span> </span><a href="#local-6989586621679292612"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-203"></a><span>    </span><a name="local-6989586621679292615"><a href="#local-6989586621679292615"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679292613"><span class="hs-identifier hs-var">io</span></a><span> </span><a href="#local-6989586621679292614"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-special">`</span><a href="Control.Exception.Base.html#onException"><span class="hs-identifier hs-var">onException</span></a><span class="hs-special">`</span><span> </span><a href="GHC.MVar.html#putMVar"><span class="hs-identifier hs-var">putMVar</span></a><span> </span><a href="#local-6989586621679292612"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="#local-6989586621679292614"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-204"></a><span>    </span><a href="GHC.MVar.html#putMVar"><span class="hs-identifier hs-var">putMVar</span></a><span> </span><a href="#local-6989586621679292612"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="#local-6989586621679292614"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-205"></a><span>    </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621679292615"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-206"></a><span>
</span><a name="line-207"></a><span class="hs-comment">{-|
  An exception-safe wrapper for modifying the contents of an 'MVar'.
  Like 'withMVar', 'modifyMVar' will replace the original contents of
  the 'MVar' if an exception is raised during the operation.  This
  function is only atomic if there are no other producers for this
  'MVar'.
-}</span><span>
</span><a name="line-214"></a><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">modifyMVar_</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-215"></a><span class="hs-identifier">modifyMVar_</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.MVar.html#MVar"><span class="hs-identifier hs-type">MVar</span></a><span> </span><a href="#local-6989586621679292598"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679292598"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="#local-6989586621679292598"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-216"></a><a name="modifyMVar_"><a href="Control.Concurrent.MVar.html#modifyMVar_"><span class="hs-identifier">modifyMVar_</span></a></a><span> </span><a name="local-6989586621679292616"><a href="#local-6989586621679292616"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679292617"><a href="#local-6989586621679292617"><span class="hs-identifier">io</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-217"></a><span>  </span><a href="GHC.IO.html#mask"><span class="hs-identifier hs-var">mask</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679292618"><a href="#local-6989586621679292618"><span class="hs-identifier">restore</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-218"></a><span>    </span><a name="local-6989586621679292619"><a href="#local-6989586621679292619"><span class="hs-identifier">a</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.MVar.html#takeMVar"><span class="hs-identifier hs-var">takeMVar</span></a><span> </span><a href="#local-6989586621679292616"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-219"></a><span>    </span><a name="local-6989586621679292620"><a href="#local-6989586621679292620"><span class="hs-identifier">a'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679292618"><span class="hs-identifier hs-var">restore</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679292617"><span class="hs-identifier hs-var">io</span></a><span> </span><a href="#local-6989586621679292619"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><a href="Control.Exception.Base.html#onException"><span class="hs-identifier hs-var">onException</span></a><span class="hs-special">`</span><span> </span><a href="GHC.MVar.html#putMVar"><span class="hs-identifier hs-var">putMVar</span></a><span> </span><a href="#local-6989586621679292616"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="#local-6989586621679292619"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-220"></a><span>    </span><a href="GHC.MVar.html#putMVar"><span class="hs-identifier hs-var">putMVar</span></a><span> </span><a href="#local-6989586621679292616"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="#local-6989586621679292620"><span class="hs-identifier hs-var">a'</span></a><span>
</span><a name="line-221"></a><span>
</span><a name="line-222"></a><span class="hs-comment">{-|
  A slight variation on 'modifyMVar_' that allows a value to be
  returned (@b@) in addition to the modified value of the 'MVar'.
-}</span><span>
</span><a name="line-226"></a><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">modifyMVar</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-227"></a><span class="hs-identifier">modifyMVar</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.MVar.html#MVar"><span class="hs-identifier hs-type">MVar</span></a><span> </span><a href="#local-6989586621679292596"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679292596"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679292596"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><a href="#local-6989586621679292597"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="#local-6989586621679292597"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-228"></a><a name="modifyMVar"><a href="Control.Concurrent.MVar.html#modifyMVar"><span class="hs-identifier">modifyMVar</span></a></a><span> </span><a name="local-6989586621679292621"><a href="#local-6989586621679292621"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679292622"><a href="#local-6989586621679292622"><span class="hs-identifier">io</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-229"></a><span>  </span><a href="GHC.IO.html#mask"><span class="hs-identifier hs-var">mask</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679292623"><a href="#local-6989586621679292623"><span class="hs-identifier">restore</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-230"></a><span>    </span><a name="local-6989586621679292624"><a href="#local-6989586621679292624"><span class="hs-identifier">a</span></a></a><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.MVar.html#takeMVar"><span class="hs-identifier hs-var">takeMVar</span></a><span> </span><a href="#local-6989586621679292621"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-231"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621679292625"><a href="#local-6989586621679292625"><span class="hs-identifier">a'</span></a></a><span class="hs-special">,</span><a name="local-6989586621679292626"><a href="#local-6989586621679292626"><span class="hs-identifier">b</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679292623"><span class="hs-identifier hs-var">restore</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679292622"><span class="hs-identifier hs-var">io</span></a><span> </span><a href="#local-6989586621679292624"><span class="hs-identifier hs-var">a</span></a><span> </span><a href="GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a><span> </span><a href="GHC.IO.html#evaluate"><span class="hs-identifier hs-var">evaluate</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><a href="Control.Exception.Base.html#onException"><span class="hs-identifier hs-var">onException</span></a><span class="hs-special">`</span><span> </span><a href="GHC.MVar.html#putMVar"><span class="hs-identifier hs-var">putMVar</span></a><span> </span><a href="#local-6989586621679292621"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="#local-6989586621679292624"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-232"></a><span>    </span><a href="GHC.MVar.html#putMVar"><span class="hs-identifier hs-var">putMVar</span></a><span> </span><a href="#local-6989586621679292621"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="#local-6989586621679292625"><span class="hs-identifier hs-var">a'</span></a><span>
</span><a name="line-233"></a><span>    </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621679292626"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-234"></a><span>
</span><a name="line-235"></a><span class="hs-comment">{-|
  Like 'modifyMVar_', but the @IO@ action in the second argument is executed with
  asynchronous exceptions masked.

  @since 4.6.0.0
-}</span><span>
</span><a name="line-241"></a><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">modifyMVarMasked_</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-242"></a><span class="hs-identifier">modifyMVarMasked_</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.MVar.html#MVar"><span class="hs-identifier hs-type">MVar</span></a><span> </span><a href="#local-6989586621679292595"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679292595"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="#local-6989586621679292595"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-243"></a><a name="modifyMVarMasked_"><a href="Control.Concurrent.MVar.html#modifyMVarMasked_"><span class="hs-identifier">modifyMVarMasked_</span></a></a><span> </span><a name="local-6989586621679292627"><a href="#local-6989586621679292627"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679292628"><a href="#local-6989586621679292628"><span class="hs-identifier">io</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-244"></a><span>  </span><a href="GHC.IO.html#mask_"><span class="hs-identifier hs-var">mask_</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-245"></a><span>    </span><a name="local-6989586621679292629"><a href="#local-6989586621679292629"><span class="hs-identifier">a</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.MVar.html#takeMVar"><span class="hs-identifier hs-var">takeMVar</span></a><span> </span><a href="#local-6989586621679292627"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-246"></a><span>    </span><a name="local-6989586621679292630"><a href="#local-6989586621679292630"><span class="hs-identifier">a'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679292628"><span class="hs-identifier hs-var">io</span></a><span> </span><a href="#local-6989586621679292629"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-special">`</span><a href="Control.Exception.Base.html#onException"><span class="hs-identifier hs-var">onException</span></a><span class="hs-special">`</span><span> </span><a href="GHC.MVar.html#putMVar"><span class="hs-identifier hs-var">putMVar</span></a><span> </span><a href="#local-6989586621679292627"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="#local-6989586621679292629"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-247"></a><span>    </span><a href="GHC.MVar.html#putMVar"><span class="hs-identifier hs-var">putMVar</span></a><span> </span><a href="#local-6989586621679292627"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="#local-6989586621679292630"><span class="hs-identifier hs-var">a'</span></a><span>
</span><a name="line-248"></a><span>
</span><a name="line-249"></a><span class="hs-comment">{-|
  Like 'modifyMVar', but the @IO@ action in the second argument is executed with
  asynchronous exceptions masked.

  @since 4.6.0.0
-}</span><span>
</span><a name="line-255"></a><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">modifyMVarMasked</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-256"></a><span class="hs-identifier">modifyMVarMasked</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.MVar.html#MVar"><span class="hs-identifier hs-type">MVar</span></a><span> </span><a href="#local-6989586621679292593"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679292593"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679292593"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><a href="#local-6989586621679292594"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="#local-6989586621679292594"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-257"></a><a name="modifyMVarMasked"><a href="Control.Concurrent.MVar.html#modifyMVarMasked"><span class="hs-identifier">modifyMVarMasked</span></a></a><span> </span><a name="local-6989586621679292631"><a href="#local-6989586621679292631"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679292632"><a href="#local-6989586621679292632"><span class="hs-identifier">io</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-258"></a><span>  </span><a href="GHC.IO.html#mask_"><span class="hs-identifier hs-var">mask_</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-259"></a><span>    </span><a name="local-6989586621679292633"><a href="#local-6989586621679292633"><span class="hs-identifier">a</span></a></a><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.MVar.html#takeMVar"><span class="hs-identifier hs-var">takeMVar</span></a><span> </span><a href="#local-6989586621679292631"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-260"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621679292634"><a href="#local-6989586621679292634"><span class="hs-identifier">a'</span></a></a><span class="hs-special">,</span><a name="local-6989586621679292635"><a href="#local-6989586621679292635"><span class="hs-identifier">b</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679292632"><span class="hs-identifier hs-var">io</span></a><span> </span><a href="#local-6989586621679292633"><span class="hs-identifier hs-var">a</span></a><span> </span><a href="GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a><span> </span><a href="GHC.IO.html#evaluate"><span class="hs-identifier hs-var">evaluate</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><a href="Control.Exception.Base.html#onException"><span class="hs-identifier hs-var">onException</span></a><span class="hs-special">`</span><span> </span><a href="GHC.MVar.html#putMVar"><span class="hs-identifier hs-var">putMVar</span></a><span> </span><a href="#local-6989586621679292631"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="#local-6989586621679292633"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-261"></a><span>    </span><a href="GHC.MVar.html#putMVar"><span class="hs-identifier hs-var">putMVar</span></a><span> </span><a href="#local-6989586621679292631"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="#local-6989586621679292634"><span class="hs-identifier hs-var">a'</span></a><span>
</span><a name="line-262"></a><span>    </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621679292635"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-263"></a><span>
</span><a name="line-264"></a><span class="hs-pragma">{-# DEPRECATED</span><span> </span><span class="hs-pragma">addMVarFinalizer</span><span> </span><span class="hs-pragma">&quot;use 'mkWeakMVar' instead&quot;</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-comment">-- deprecated in 7.6</span><span>
</span><a name="line-265"></a><span class="hs-identifier">addMVarFinalizer</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.MVar.html#MVar"><span class="hs-identifier hs-type">MVar</span></a><span> </span><a href="#local-6989586621679292592"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-266"></a><a name="addMVarFinalizer"><a href="Control.Concurrent.MVar.html#addMVarFinalizer"><span class="hs-identifier">addMVarFinalizer</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.MVar.html#addMVarFinalizer"><span class="hs-identifier hs-var">GHC.MVar.addMVarFinalizer</span></a><span>
</span><a name="line-267"></a><span>
</span><a name="line-268"></a><span class="hs-comment">-- | Make a 'Weak' pointer to an 'MVar', using the second argument as</span><span>
</span><a name="line-269"></a><span class="hs-comment">-- a finalizer to run when 'MVar' is garbage-collected</span><span>
</span><a name="line-270"></a><span class="hs-comment">--</span><span>
</span><a name="line-271"></a><span class="hs-comment">-- @since 4.6.0.0</span><span>
</span><a name="line-272"></a><span class="hs-identifier">mkWeakMVar</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.MVar.html#MVar"><span class="hs-identifier hs-type">MVar</span></a><span> </span><a href="#local-6989586621679292591"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Weak.html#Weak"><span class="hs-identifier hs-type">Weak</span></a><span> </span><span class="hs-special">(</span><a href="GHC.MVar.html#MVar"><span class="hs-identifier hs-type">MVar</span></a><span> </span><a href="#local-6989586621679292591"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-273"></a><a name="mkWeakMVar"><a href="Control.Concurrent.MVar.html#mkWeakMVar"><span class="hs-identifier">mkWeakMVar</span></a></a><span> </span><a name="local-6989586621679292636"><a href="#local-6989586621679292636"><span class="hs-identifier">m</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="GHC.MVar.html#MVar"><span class="hs-identifier hs-var">MVar</span></a><span> </span><a name="local-6989586621679292637"><a href="#local-6989586621679292637"><span class="hs-identifier">m#</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-var">IO</span></a><span> </span><a name="local-6989586621679292638"><a href="#local-6989586621679292638"><span class="hs-identifier">f</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-var">IO</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679292639"><a href="#local-6989586621679292639"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-274"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Prim.html#mkWeak%23"><span class="hs-identifier hs-var">mkWeak#</span></a><span> </span><a href="#local-6989586621679292637"><span class="hs-identifier hs-var">m#</span></a><span> </span><a href="#local-6989586621679292636"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="#local-6989586621679292638"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679292639"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">(#</span><span> </span><a name="local-6989586621679292640"><a href="#local-6989586621679292640"><span class="hs-identifier">s1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679292641"><a href="#local-6989586621679292641"><span class="hs-identifier">w</span></a></a><span> </span><span class="hs-special">#)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(#</span><span> </span><a href="#local-6989586621679292640"><span class="hs-identifier hs-var">s1</span></a><span class="hs-special">,</span><span> </span><a href="GHC.Weak.html#Weak"><span class="hs-identifier hs-var">Weak</span></a><span> </span><a href="#local-6989586621679292641"><span class="hs-identifier hs-var">w</span></a><span> </span><span class="hs-special">#)</span><span>
</span><a name="line-275"></a></pre></body></html>