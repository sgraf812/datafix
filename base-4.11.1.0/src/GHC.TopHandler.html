<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE Trustworthy #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE CPP
           , NoImplicitPrelude
           , MagicHash
           , UnboxedTuples
           , UnliftedFFITypes
  #-}</span><span>
</span><a name="line-8"></a><span class="hs-pragma">{-# OPTIONS_HADDOCK hide #-}</span><span>
</span><a name="line-9"></a><span>
</span><a name="line-10"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-11"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-12"></a><span class="hs-comment">-- Module      :  GHC.TopHandler</span><span>
</span><a name="line-13"></a><span class="hs-comment">-- Copyright   :  (c) The University of Glasgow, 2001-2002</span><span>
</span><a name="line-14"></a><span class="hs-comment">-- License     :  see libraries/base/LICENSE</span><span>
</span><a name="line-15"></a><span class="hs-comment">--</span><span>
</span><a name="line-16"></a><span class="hs-comment">-- Maintainer  :  cvs-ghc@haskell.org</span><span>
</span><a name="line-17"></a><span class="hs-comment">-- Stability   :  internal</span><span>
</span><a name="line-18"></a><span class="hs-comment">-- Portability :  non-portable (GHC Extensions)</span><span>
</span><a name="line-19"></a><span class="hs-comment">--</span><span>
</span><a name="line-20"></a><span class="hs-comment">-- Support for catching exceptions raised during top-level computations</span><span>
</span><a name="line-21"></a><span class="hs-comment">-- (e.g. @Main.main@, 'Control.Concurrent.forkIO', and foreign exports)</span><span>
</span><a name="line-22"></a><span class="hs-comment">--</span><span>
</span><a name="line-23"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-24"></a><span>
</span><a name="line-25"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">GHC.TopHandler</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-26"></a><span>        </span><a href="GHC.TopHandler.html#runMainIO"><span class="hs-identifier hs-var">runMainIO</span></a><span class="hs-special">,</span><span> </span><a href="GHC.TopHandler.html#runIO"><span class="hs-identifier hs-var">runIO</span></a><span class="hs-special">,</span><span> </span><a href="GHC.TopHandler.html#runIOFastExit"><span class="hs-identifier hs-var">runIOFastExit</span></a><span class="hs-special">,</span><span> </span><a href="GHC.TopHandler.html#runNonIO"><span class="hs-identifier hs-var">runNonIO</span></a><span class="hs-special">,</span><span>
</span><a name="line-27"></a><span>        </span><a href="GHC.TopHandler.html#topHandler"><span class="hs-identifier hs-var">topHandler</span></a><span class="hs-special">,</span><span> </span><a href="GHC.TopHandler.html#topHandlerFastExit"><span class="hs-identifier hs-var">topHandlerFastExit</span></a><span class="hs-special">,</span><span>
</span><a name="line-28"></a><span>        </span><a href="GHC.Conc.Sync.html#reportStackOverflow"><span class="hs-identifier hs-var">reportStackOverflow</span></a><span class="hs-special">,</span><span> </span><a href="GHC.Conc.Sync.html#reportError"><span class="hs-identifier hs-var">reportError</span></a><span class="hs-special">,</span><span>
</span><a name="line-29"></a><span>        </span><a href="GHC.TopHandler.html#flushStdHandles"><span class="hs-identifier hs-var">flushStdHandles</span></a><span>
</span><a name="line-30"></a><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-31"></a><span>
</span><a name="line-32"></a><span class="hs-cpp">#include &quot;HsBaseConfig.h&quot;
</span><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><a href="Control.Exception.html"><span class="hs-identifier">Control.Exception</span></a><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Maybe.html"><span class="hs-identifier">Data.Maybe</span></a><span>
</span><a name="line-36"></a><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><a href="Foreign.html"><span class="hs-identifier">Foreign</span></a><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><a href="Foreign.C.html"><span class="hs-identifier">Foreign.C</span></a><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><a href="GHC.Base.html"><span class="hs-identifier">GHC.Base</span></a><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><a href="GHC.Conc.html"><span class="hs-identifier">GHC.Conc</span></a><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><a href="GHC.Conc.Sync.html#throwTo"><span class="hs-identifier hs-var">throwTo</span></a><span class="hs-special">)</span><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><a href="GHC.Real.html"><span class="hs-identifier">GHC.Real</span></a><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><a href="GHC.IO.html"><span class="hs-identifier">GHC.IO</span></a><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><a href="GHC.IO.Handle.FD.html"><span class="hs-identifier">GHC.IO.Handle.FD</span></a><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><a href="GHC.IO.Handle.html"><span class="hs-identifier">GHC.IO.Handle</span></a><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><a href="GHC.IO.Exception.html"><span class="hs-identifier">GHC.IO.Exception</span></a><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span> </span><a href="GHC.Weak.html"><span class="hs-identifier">GHC.Weak</span></a><span>
</span><a name="line-47"></a><span>
</span><a name="line-48"></a><span class="hs-cpp">#if defined(mingw32_HOST_OS)
</span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GHC.ConsoleHandler</span><span>
</span><a name="line-50"></a><span class="hs-cpp">#else
</span><span class="hs-keyword">import</span><span> </span><a href="Data.Dynamic.html"><span class="hs-identifier">Data.Dynamic</span></a><span> </span><span class="hs-special">(</span><a href="Data.Dynamic.html#toDyn"><span class="hs-identifier hs-var">toDyn</span></a><span class="hs-special">)</span><span>
</span><a name="line-52"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-54"></a><span class="hs-comment">-- Note [rts_setMainThread must be called unsafely]</span><span>
</span><a name="line-55"></a><span class="hs-comment">-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span>
</span><a name="line-56"></a><span class="hs-comment">--</span><span>
</span><a name="line-57"></a><span class="hs-comment">-- rts_setMainThread must be called as unsafe, because it</span><span>
</span><a name="line-58"></a><span class="hs-comment">-- dereferences the Weak# and manipulates the raw Haskell value</span><span>
</span><a name="line-59"></a><span class="hs-comment">-- behind it.  Therefore, it must not race with a garbage collection.</span><span>
</span><a name="line-60"></a><span>
</span><a name="line-61"></a><span class="hs-comment">-- Note [rts_setMainThread has an unsound type]</span><span>
</span><a name="line-62"></a><span class="hs-comment">-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span>
</span><a name="line-63"></a><span class="hs-comment">--</span><span>
</span><a name="line-64"></a><span class="hs-comment">-- 'rts_setMainThread' is imported with type Weak# ThreadId -&gt; IO (),</span><span>
</span><a name="line-65"></a><span class="hs-comment">-- but this is an unsound type for it: it grabs the /key/ of the</span><span>
</span><a name="line-66"></a><span class="hs-comment">-- 'Weak#' object, which isn't tracked by the type at all.</span><span>
</span><a name="line-67"></a><span class="hs-comment">-- That this works at all is a consequence of the fact that</span><span>
</span><a name="line-68"></a><span class="hs-comment">-- 'mkWeakThreadId' produces a 'Weak#' with a 'ThreadId#' as the key</span><span>
</span><a name="line-69"></a><span class="hs-comment">-- This is fairly robust, in that 'mkWeakThreadId' wouldn't work</span><span>
</span><a name="line-70"></a><span class="hs-comment">-- otherwise, but it still is sufficiently non-trivial to justify an</span><span>
</span><a name="line-71"></a><span class="hs-comment">-- ASSERT in rts/TopHandler.c.</span><span>
</span><a name="line-72"></a><span>
</span><a name="line-73"></a><span class="hs-comment">-- see Note [rts_setMainThread must be called unsafely] and</span><span>
</span><a name="line-74"></a><span class="hs-comment">-- Note [rts_setMainThread has an unsound type]</span><span>
</span><a name="line-75"></a><span class="hs-keyword">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">ccall</span><span> </span><span class="hs-keyword">unsafe</span><span> </span><span class="hs-string">&quot;rts_setMainThread&quot;</span><span>
</span><a name="line-76"></a><span>  </span><span class="hs-identifier">setMainThread</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Prim.html#Weak%23"><span class="hs-identifier hs-type">Weak#</span></a><span> </span><a href="GHC.Conc.Sync.html#ThreadId"><span class="hs-identifier hs-type">ThreadId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-77"></a><span>
</span><a name="line-78"></a><span class="hs-comment">-- | 'runMainIO' is wrapped around 'Main.main' (or whatever main is</span><span>
</span><a name="line-79"></a><span class="hs-comment">-- called in the program).  It catches otherwise uncaught exceptions,</span><span>
</span><a name="line-80"></a><span class="hs-comment">-- and also flushes stdout\/stderr before exiting.</span><span>
</span><a name="line-81"></a><span class="hs-identifier">runMainIO</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="#local-6989586621679359699"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="#local-6989586621679359699"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-82"></a><a name="runMainIO"><a href="GHC.TopHandler.html#runMainIO"><span class="hs-identifier">runMainIO</span></a></a><span> </span><a name="local-6989586621679359700"><a href="#local-6989586621679359700"><span class="hs-identifier">main</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-83"></a><span>    </span><span class="hs-keyword">do</span><span>
</span><a name="line-84"></a><span>      </span><a name="local-6989586621679359701"><a href="#local-6989586621679359701"><span class="hs-identifier">main_thread_id</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.Conc.Sync.html#myThreadId"><span class="hs-identifier hs-var">myThreadId</span></a><span>
</span><a name="line-85"></a><span>      </span><a name="local-6989586621679359702"><a href="#local-6989586621679359702"><span class="hs-identifier">weak_tid</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.Conc.Sync.html#mkWeakThreadId"><span class="hs-identifier hs-var">mkWeakThreadId</span></a><span> </span><a href="#local-6989586621679359701"><span class="hs-identifier hs-var">main_thread_id</span></a><span>
</span><a name="line-86"></a><span>      </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679359702"><span class="hs-identifier hs-var">weak_tid</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">(</span><a href="GHC.Weak.html#Weak"><span class="hs-identifier hs-var">Weak</span></a><span> </span><a name="local-6989586621679359703"><a href="#local-6989586621679359703"><span class="hs-identifier">w</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.TopHandler.html#setMainThread"><span class="hs-identifier hs-var">setMainThread</span></a><span> </span><a href="#local-6989586621679359703"><span class="hs-identifier hs-var">w</span></a><span>
</span><a name="line-87"></a><span>      </span><a href="GHC.TopHandler.html#install_interrupt_handler"><span class="hs-identifier hs-var">install_interrupt_handler</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-88"></a><span>           </span><a name="local-6989586621679359704"><a href="#local-6989586621679359704"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.Weak.html#deRefWeak"><span class="hs-identifier hs-var">deRefWeak</span></a><span> </span><a href="#local-6989586621679359702"><span class="hs-identifier hs-var">weak_tid</span></a><span>
</span><a name="line-89"></a><span>           </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679359704"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-90"></a><span>               </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-91"></a><span>               </span><a href="GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621679359705"><a href="#local-6989586621679359705"><span class="hs-identifier">tid</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Conc.Sync.html#throwTo"><span class="hs-identifier hs-var">throwTo</span></a><span> </span><a href="#local-6989586621679359705"><span class="hs-identifier hs-var">tid</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Exception.html#toException"><span class="hs-identifier hs-var">toException</span></a><span> </span><a href="GHC.IO.Exception.html#UserInterrupt"><span class="hs-identifier hs-var">UserInterrupt</span></a><span class="hs-special">)</span><span>
</span><a name="line-92"></a><span>      </span><a href="#local-6989586621679359700"><span class="hs-identifier hs-var">main</span></a><span> </span><span class="hs-comment">-- hs_exit() will flush</span><span>
</span><a name="line-93"></a><span>    </span><span class="hs-special">`</span><a href="GHC.IO.html#catch"><span class="hs-identifier hs-var">catch</span></a><span class="hs-special">`</span><span>
</span><a name="line-94"></a><span>      </span><a href="GHC.TopHandler.html#topHandler"><span class="hs-identifier hs-var">topHandler</span></a><span>
</span><a name="line-95"></a><span>
</span><a name="line-96"></a><span class="hs-identifier">install_interrupt_handler</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-97"></a><span class="hs-cpp">#if defined(mingw32_HOST_OS)
</span><span class="hs-identifier">install_interrupt_handler</span><span> </span><span class="hs-identifier">handler</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-99"></a><span>  </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">GHC.ConsoleHandler.installHandler</span><span> </span><span class="hs-operator">$</span><span>
</span><a name="line-100"></a><span>     </span><span class="hs-identifier">Catch</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">event</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-101"></a><span>        </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">event</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-102"></a><span>           </span><span class="hs-identifier">ControlC</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">handler</span><span>
</span><a name="line-103"></a><span>           </span><span class="hs-identifier">Break</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">handler</span><span>
</span><a name="line-104"></a><span>           </span><span class="hs-identifier">Close</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">handler</span><span>
</span><a name="line-105"></a><span>           </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-106"></a><span>  </span><span class="hs-identifier">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-107"></a><span class="hs-cpp">#else
#include &quot;rts/Signals.h&quot;
</span><span class="hs-comment">-- specialised version of System.Posix.Signals.installHandler, which</span><span>
</span><a name="line-110"></a><span class="hs-comment">-- isn't available here.</span><span>
</span><a name="line-111"></a><a name="install_interrupt_handler"><a href="GHC.TopHandler.html#install_interrupt_handler"><span class="hs-identifier">install_interrupt_handler</span></a></a><span> </span><a name="local-6989586621679359706"><a href="#local-6989586621679359706"><span class="hs-identifier">handler</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-112"></a><span>   </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679359707"><a href="#local-6989586621679359707"><span class="hs-identifier">sig</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">CONST_SIGINT</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">CInt</span><span>
</span><a name="line-113"></a><span>   </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.Conc.Signal.html#setHandler"><span class="hs-identifier hs-var">setHandler</span></a><span> </span><a href="#local-6989586621679359707"><span class="hs-identifier hs-var">sig</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Base.html#const"><span class="hs-identifier hs-var">const</span></a><span> </span><a href="#local-6989586621679359706"><span class="hs-identifier hs-var">handler</span></a><span class="hs-special">,</span><span> </span><a href="Data.Dynamic.html#toDyn"><span class="hs-identifier hs-var">toDyn</span></a><span> </span><a href="#local-6989586621679359706"><span class="hs-identifier hs-var">handler</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-114"></a><span>   </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.TopHandler.html#stg_sig_install"><span class="hs-identifier hs-var">stg_sig_install</span></a><span> </span><a href="#local-6989586621679359707"><span class="hs-identifier hs-var">sig</span></a><span> </span><span class="hs-identifier">STG_SIG_RST</span><span> </span><span class="hs-identifier">nullPtr</span><span>
</span><a name="line-115"></a><span>     </span><span class="hs-comment">-- STG_SIG_RST: the second ^C kills us for real, just in case the</span><span>
</span><a name="line-116"></a><span>     </span><span class="hs-comment">-- RTS or program is unresponsive.</span><span>
</span><a name="line-117"></a><span>   </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-118"></a><span>
</span><a name="line-119"></a><span class="hs-keyword">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">ccall</span><span> </span><span class="hs-keyword">unsafe</span><span>
</span><a name="line-120"></a><span>  </span><span class="hs-identifier">stg_sig_install</span><span>
</span><a name="line-121"></a><span>        </span><span class="hs-glyph">::</span><span> </span><a href="Foreign.C.Types.html#CInt"><span class="hs-identifier hs-type">CInt</span></a><span>                         </span><span class="hs-comment">-- sig no.</span><span>
</span><a name="line-122"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Foreign.C.Types.html#CInt"><span class="hs-identifier hs-type">CInt</span></a><span>                         </span><span class="hs-comment">-- action code (STG_SIG_HAN etc.)</span><span>
</span><a name="line-123"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>                       </span><span class="hs-comment">-- (in, out) blocked</span><span>
</span><a name="line-124"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="Foreign.C.Types.html#CInt"><span class="hs-identifier hs-type">CInt</span></a><span>                      </span><span class="hs-comment">-- (ret) old action code</span><span>
</span><a name="line-125"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-127"></a><span class="hs-comment">-- | 'runIO' is wrapped around every @foreign export@ and @foreign</span><span>
</span><a name="line-128"></a><span class="hs-comment">-- import \&quot;wrapper\&quot;@ to mop up any uncaught exceptions.  Thus, the</span><span>
</span><a name="line-129"></a><span class="hs-comment">-- result of running 'System.Exit.exitWith' in a foreign-exported</span><span>
</span><a name="line-130"></a><span class="hs-comment">-- function is the same as in the main thread: it terminates the</span><span>
</span><a name="line-131"></a><span class="hs-comment">-- program.</span><span>
</span><a name="line-132"></a><span class="hs-comment">--</span><span>
</span><a name="line-133"></a><span class="hs-identifier">runIO</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="#local-6989586621679359698"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="#local-6989586621679359698"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-134"></a><a name="runIO"><a href="GHC.TopHandler.html#runIO"><span class="hs-identifier">runIO</span></a></a><span> </span><a name="local-6989586621679359708"><a href="#local-6989586621679359708"><span class="hs-identifier">main</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.html#catch"><span class="hs-identifier hs-var">catch</span></a><span> </span><a href="#local-6989586621679359708"><span class="hs-identifier hs-var">main</span></a><span> </span><a href="GHC.TopHandler.html#topHandler"><span class="hs-identifier hs-var">topHandler</span></a><span>
</span><a name="line-135"></a><span>
</span><a name="line-136"></a><span class="hs-comment">-- | Like 'runIO', but in the event of an exception that causes an exit,</span><span>
</span><a name="line-137"></a><span class="hs-comment">-- we don't shut down the system cleanly, we just exit.  This is</span><span>
</span><a name="line-138"></a><span class="hs-comment">-- useful in some cases, because the safe exit version will give other</span><span>
</span><a name="line-139"></a><span class="hs-comment">-- threads a chance to clean up first, which might shut down the</span><span>
</span><a name="line-140"></a><span class="hs-comment">-- system in a different way.  For example, try</span><span>
</span><a name="line-141"></a><span class="hs-comment">--</span><span>
</span><a name="line-142"></a><span class="hs-comment">--   main = forkIO (runIO (exitWith (ExitFailure 1))) &gt;&gt; threadDelay 10000</span><span>
</span><a name="line-143"></a><span class="hs-comment">--</span><span>
</span><a name="line-144"></a><span class="hs-comment">-- This will sometimes exit with &quot;interrupted&quot; and code 0, because the</span><span>
</span><a name="line-145"></a><span class="hs-comment">-- main thread is given a chance to shut down when the child thread calls</span><span>
</span><a name="line-146"></a><span class="hs-comment">-- safeExit.  There is a race to shut down between the main and child threads.</span><span>
</span><a name="line-147"></a><span class="hs-comment">--</span><span>
</span><a name="line-148"></a><span class="hs-identifier">runIOFastExit</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="#local-6989586621679359697"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="#local-6989586621679359697"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-149"></a><a name="runIOFastExit"><a href="GHC.TopHandler.html#runIOFastExit"><span class="hs-identifier">runIOFastExit</span></a></a><span> </span><a name="local-6989586621679359709"><a href="#local-6989586621679359709"><span class="hs-identifier">main</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.html#catch"><span class="hs-identifier hs-var">catch</span></a><span> </span><a href="#local-6989586621679359709"><span class="hs-identifier hs-var">main</span></a><span> </span><a href="GHC.TopHandler.html#topHandlerFastExit"><span class="hs-identifier hs-var">topHandlerFastExit</span></a><span>
</span><a name="line-150"></a><span>        </span><span class="hs-comment">-- NB. this is used by the testsuite driver</span><span>
</span><a name="line-151"></a><span>
</span><a name="line-152"></a><span class="hs-comment">-- | The same as 'runIO', but for non-IO computations.  Used for</span><span>
</span><a name="line-153"></a><span class="hs-comment">-- wrapping @foreign export@ and @foreign import \&quot;wrapper\&quot;@ when these</span><span>
</span><a name="line-154"></a><span class="hs-comment">-- are used to export Haskell functions with non-IO types.</span><span>
</span><a name="line-155"></a><span class="hs-comment">--</span><span>
</span><a name="line-156"></a><span class="hs-identifier">runNonIO</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679359696"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="#local-6989586621679359696"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-157"></a><a name="runNonIO"><a href="GHC.TopHandler.html#runNonIO"><span class="hs-identifier">runNonIO</span></a></a><span> </span><a name="local-6989586621679359710"><a href="#local-6989586621679359710"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.html#catch"><span class="hs-identifier hs-var">catch</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679359710"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-special">`</span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Prim.html#seq"><span class="hs-identifier hs-var">seq</span></a><span class="hs-special">`</span><span> </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621679359710"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span> </span><a href="GHC.TopHandler.html#topHandler"><span class="hs-identifier hs-var">topHandler</span></a><span>
</span><a name="line-158"></a><span>
</span><a name="line-159"></a><span class="hs-identifier">topHandler</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.Exception.html#SomeException"><span class="hs-identifier hs-type">SomeException</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="#local-6989586621679359695"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-160"></a><a name="topHandler"><a href="GHC.TopHandler.html#topHandler"><span class="hs-identifier">topHandler</span></a></a><span> </span><a name="local-6989586621679359711"><a href="#local-6989586621679359711"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.html#catch"><span class="hs-identifier hs-var">catch</span></a><span> </span><span class="hs-special">(</span><a href="GHC.TopHandler.html#real_handler"><span class="hs-identifier hs-var">real_handler</span></a><span> </span><a href="GHC.TopHandler.html#safeExit"><span class="hs-identifier hs-var">safeExit</span></a><span> </span><a href="#local-6989586621679359711"><span class="hs-identifier hs-var">err</span></a><span class="hs-special">)</span><span> </span><a href="GHC.TopHandler.html#topHandler"><span class="hs-identifier hs-var">topHandler</span></a><span>
</span><a name="line-161"></a><span>
</span><a name="line-162"></a><span class="hs-identifier">topHandlerFastExit</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.Exception.html#SomeException"><span class="hs-identifier hs-type">SomeException</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="#local-6989586621679359694"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-163"></a><a name="topHandlerFastExit"><a href="GHC.TopHandler.html#topHandlerFastExit"><span class="hs-identifier">topHandlerFastExit</span></a></a><span> </span><a name="local-6989586621679359712"><a href="#local-6989586621679359712"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-164"></a><span>  </span><a href="GHC.IO.html#catchException"><span class="hs-identifier hs-var">catchException</span></a><span> </span><span class="hs-special">(</span><a href="GHC.TopHandler.html#real_handler"><span class="hs-identifier hs-var">real_handler</span></a><span> </span><a href="GHC.TopHandler.html#fastExit"><span class="hs-identifier hs-var">fastExit</span></a><span> </span><a href="#local-6989586621679359712"><span class="hs-identifier hs-var">err</span></a><span class="hs-special">)</span><span> </span><a href="GHC.TopHandler.html#topHandlerFastExit"><span class="hs-identifier hs-var">topHandlerFastExit</span></a><span>
</span><a name="line-165"></a><span>
</span><a name="line-166"></a><span class="hs-comment">-- Make sure we handle errors while reporting the error!</span><span>
</span><a name="line-167"></a><span class="hs-comment">-- (e.g. evaluating the string passed to 'error' might generate</span><span>
</span><a name="line-168"></a><span class="hs-comment">--  another error, etc.)</span><span>
</span><a name="line-169"></a><span class="hs-comment">--</span><span>
</span><a name="line-170"></a><span class="hs-identifier">real_handler</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="#local-6989586621679359693"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Exception.html#SomeException"><span class="hs-identifier hs-type">SomeException</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="#local-6989586621679359693"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-171"></a><a name="real_handler"><a href="GHC.TopHandler.html#real_handler"><span class="hs-identifier">real_handler</span></a></a><span> </span><a name="local-6989586621679359713"><a href="#local-6989586621679359713"><span class="hs-identifier">exit</span></a></a><span> </span><a name="local-6989586621679359714"><a href="#local-6989586621679359714"><span class="hs-identifier">se</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-172"></a><span>  </span><a href="GHC.TopHandler.html#flushStdHandles"><span class="hs-identifier hs-var">flushStdHandles</span></a><span> </span><span class="hs-comment">-- before any error output</span><span>
</span><a name="line-173"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="GHC.Exception.html#fromException"><span class="hs-identifier hs-var">fromException</span></a><span> </span><a href="#local-6989586621679359714"><span class="hs-identifier hs-var">se</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-174"></a><span>      </span><a href="GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="GHC.IO.Exception.html#StackOverflow"><span class="hs-identifier hs-var">StackOverflow</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-175"></a><span>           </span><a href="GHC.Conc.Sync.html#reportStackOverflow"><span class="hs-identifier hs-var">reportStackOverflow</span></a><span>
</span><a name="line-176"></a><span>           </span><a href="#local-6989586621679359713"><span class="hs-identifier hs-var">exit</span></a><span> </span><span class="hs-number">2</span><span>
</span><a name="line-177"></a><span>
</span><a name="line-178"></a><span>      </span><a href="GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="GHC.IO.Exception.html#UserInterrupt"><span class="hs-identifier hs-var">UserInterrupt</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.TopHandler.html#exitInterrupted"><span class="hs-identifier hs-var">exitInterrupted</span></a><span>
</span><a name="line-179"></a><span>
</span><a name="line-180"></a><span>      </span><a href="GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="GHC.IO.Exception.html#HeapOverflow"><span class="hs-identifier hs-var">HeapOverflow</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-181"></a><span>           </span><a href="GHC.Conc.Sync.html#reportHeapOverflow"><span class="hs-identifier hs-var">reportHeapOverflow</span></a><span>
</span><a name="line-182"></a><span>           </span><a href="#local-6989586621679359713"><span class="hs-identifier hs-var">exit</span></a><span> </span><span class="hs-number">251</span><span>
</span><a name="line-183"></a><span>
</span><a name="line-184"></a><span>      </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="GHC.Exception.html#fromException"><span class="hs-identifier hs-var">fromException</span></a><span> </span><a href="#local-6989586621679359714"><span class="hs-identifier hs-var">se</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-185"></a><span>           </span><span class="hs-comment">-- only the main thread gets ExitException exceptions</span><span>
</span><a name="line-186"></a><span>           </span><a href="GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="GHC.IO.Exception.html#ExitSuccess"><span class="hs-identifier hs-var">ExitSuccess</span></a><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679359713"><span class="hs-identifier hs-var">exit</span></a><span> </span><span class="hs-number">0</span><span>
</span><a name="line-187"></a><span>           </span><a href="GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="GHC.IO.Exception.html#ExitFailure"><span class="hs-identifier hs-var">ExitFailure</span></a><span> </span><a name="local-6989586621679359715"><a href="#local-6989586621679359715"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679359713"><span class="hs-identifier hs-var">exit</span></a><span> </span><a href="#local-6989586621679359715"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-188"></a><span>
</span><a name="line-189"></a><span>           </span><span class="hs-comment">-- EPIPE errors received for stdout are ignored (#2699)</span><span>
</span><a name="line-190"></a><span>           </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.html#catch"><span class="hs-identifier hs-var">catch</span></a><span> </span><span class="hs-special">(</span><span class="hs-keyword">case</span><span> </span><a href="GHC.Exception.html#fromException"><span class="hs-identifier hs-var">fromException</span></a><span> </span><a href="#local-6989586621679359714"><span class="hs-identifier hs-var">se</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-191"></a><span>                </span><a href="GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="GHC.IO.Exception.html#IOError"><span class="hs-identifier hs-var">IOError</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">ioe_type</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.Exception.html#ResourceVanished"><span class="hs-identifier hs-var">ResourceVanished</span></a><span class="hs-special">,</span><span>
</span><a name="line-192"></a><span>                              </span><span class="hs-identifier">ioe_errno</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621679359716"><a href="#local-6989586621679359716"><span class="hs-identifier">ioe</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-193"></a><span>                              </span><span class="hs-identifier">ioe_handle</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621679359717"><a href="#local-6989586621679359717"><span class="hs-identifier">hdl</span></a></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-194"></a><span>                   </span><span class="hs-glyph">|</span><span> </span><a href="Foreign.C.Error.html#Errno"><span class="hs-identifier hs-var">Errno</span></a><span> </span><a href="#local-6989586621679359716"><span class="hs-identifier hs-var">ioe</span></a><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a><span> </span><a href="Foreign.C.Error.html#ePIPE"><span class="hs-identifier hs-var">ePIPE</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679359717"><span class="hs-identifier hs-var">hdl</span></a><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a><span> </span><a href="GHC.IO.Handle.FD.html#stdout"><span class="hs-identifier hs-var">stdout</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679359713"><span class="hs-identifier hs-var">exit</span></a><span> </span><span class="hs-number">0</span><span>
</span><a name="line-195"></a><span>                </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><a href="GHC.Conc.Sync.html#reportError"><span class="hs-identifier hs-var">reportError</span></a><span> </span><a href="#local-6989586621679359714"><span class="hs-identifier hs-var">se</span></a><span>
</span><a name="line-196"></a><span>                        </span><a href="#local-6989586621679359713"><span class="hs-identifier hs-var">exit</span></a><span> </span><span class="hs-number">1</span><span>
</span><a name="line-197"></a><span>                </span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="GHC.TopHandler.html#disasterHandler"><span class="hs-identifier hs-var">disasterHandler</span></a><span> </span><a href="#local-6989586621679359713"><span class="hs-identifier hs-var">exit</span></a><span class="hs-special">)</span><span> </span><span class="hs-comment">-- See Note [Disaster with iconv]</span><span>
</span><a name="line-198"></a><span>
</span><a name="line-199"></a><span class="hs-comment">-- don't use errorBelch() directly, because we cannot call varargs functions</span><span>
</span><a name="line-200"></a><span class="hs-comment">-- using the FFI.</span><span>
</span><a name="line-201"></a><span class="hs-keyword">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">ccall</span><span> </span><span class="hs-keyword">unsafe</span><span> </span><span class="hs-string">&quot;HsBase.h errorBelch2&quot;</span><span>
</span><a name="line-202"></a><span>   </span><span class="hs-identifier">errorBelch</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Foreign.C.String.html#CString"><span class="hs-identifier hs-type">CString</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Foreign.C.String.html#CString"><span class="hs-identifier hs-type">CString</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-203"></a><span>
</span><a name="line-204"></a><span class="hs-identifier">disasterHandler</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="#local-6989586621679359692"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.Exception.html#IOError"><span class="hs-identifier hs-type">IOError</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="#local-6989586621679359692"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-205"></a><a name="disasterHandler"><a href="GHC.TopHandler.html#disasterHandler"><span class="hs-identifier">disasterHandler</span></a></a><span> </span><a name="local-6989586621679359718"><a href="#local-6989586621679359718"><span class="hs-identifier">exit</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-206"></a><span>  </span><a href="Foreign.C.String.html#withCAString"><span class="hs-identifier hs-var">withCAString</span></a><span> </span><span class="hs-string">&quot;%s&quot;</span><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679359720"><a href="#local-6989586621679359720"><span class="hs-identifier">fmt</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-207"></a><span>    </span><a href="Foreign.C.String.html#withCAString"><span class="hs-identifier hs-var">withCAString</span></a><span> </span><a href="#local-6989586621679359719"><span class="hs-identifier hs-var">msgStr</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679359721"><a href="#local-6989586621679359721"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-208"></a><span>      </span><a href="GHC.TopHandler.html#errorBelch"><span class="hs-identifier hs-var">errorBelch</span></a><span> </span><a href="#local-6989586621679359720"><span class="hs-identifier hs-var">fmt</span></a><span> </span><a href="#local-6989586621679359721"><span class="hs-identifier hs-var">msg</span></a><span> </span><a href="GHC.Base.html#%3E%3E"><span class="hs-operator hs-var">&gt;&gt;</span></a><span> </span><a href="#local-6989586621679359718"><span class="hs-identifier hs-var">exit</span></a><span> </span><span class="hs-number">1</span><span>
</span><a name="line-209"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-210"></a><span>    </span><a name="local-6989586621679359719"><a href="#local-6989586621679359719"><span class="hs-identifier">msgStr</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-211"></a><span>        </span><span class="hs-string">&quot;encountered an exception while trying to report an exception.\n&quot;</span><span> </span><a href="GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span>
</span><a name="line-212"></a><span>        </span><span class="hs-string">&quot;One possible reason for this is that we failed while trying to &quot;</span><span> </span><a href="GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span>
</span><a name="line-213"></a><span>        </span><span class="hs-string">&quot;encode an error message. Check that your locale is configured &quot;</span><span> </span><a href="GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span>
</span><a name="line-214"></a><span>        </span><span class="hs-string">&quot;properly.&quot;</span><span>
</span><a name="line-215"></a><span>
</span><a name="line-216"></a><span class="hs-comment">{- Note [Disaster with iconv]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

When using iconv, it's possible for things like iconv_open to fail in
restricted environments (like an initram or restricted container), but
when this happens the error raised inevitably calls `peekCString`,
which depends on the users locale, which depends on using
`iconv_open`... which causes an infinite loop.

This occurrence is also known as tickets #10298 and #7695. So to work
around it we just set _another_ error handler and bail directly by
calling the RTS, without iconv at all.
-}</span><span>
</span><a name="line-229"></a><span>
</span><a name="line-230"></a><span>
</span><a name="line-231"></a><span class="hs-comment">-- try to flush stdout/stderr, but don't worry if we fail</span><span>
</span><a name="line-232"></a><span class="hs-comment">-- (these handles might have errors, and we don't want to go into</span><span>
</span><a name="line-233"></a><span class="hs-comment">-- an infinite loop).</span><span>
</span><a name="line-234"></a><span class="hs-identifier">flushStdHandles</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-235"></a><a name="flushStdHandles"><a href="GHC.TopHandler.html#flushStdHandles"><span class="hs-identifier">flushStdHandles</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-236"></a><span>  </span><a href="GHC.IO.Handle.html#hFlush"><span class="hs-identifier hs-var">hFlush</span></a><span> </span><a href="GHC.IO.Handle.FD.html#stdout"><span class="hs-identifier hs-var">stdout</span></a><span> </span><span class="hs-special">`</span><a href="GHC.IO.html#catchAny"><span class="hs-identifier hs-var">catchAny</span></a><span class="hs-special">`</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-237"></a><span>  </span><a href="GHC.IO.Handle.html#hFlush"><span class="hs-identifier hs-var">hFlush</span></a><span> </span><a href="GHC.IO.Handle.FD.html#stderr"><span class="hs-identifier hs-var">stderr</span></a><span> </span><span class="hs-special">`</span><a href="GHC.IO.html#catchAny"><span class="hs-identifier hs-var">catchAny</span></a><span class="hs-special">`</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-238"></a><span>
</span><a name="line-239"></a><span class="hs-identifier">safeExit</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fastExit</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="#local-6989586621679359691"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-240"></a><a name="safeExit"><a href="GHC.TopHandler.html#safeExit"><span class="hs-identifier">safeExit</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.TopHandler.html#exitHelper"><span class="hs-identifier hs-var">exitHelper</span></a><span> </span><a href="GHC.TopHandler.html#useSafeExit"><span class="hs-identifier hs-var">useSafeExit</span></a><span>
</span><a name="line-241"></a><a name="fastExit"><a href="GHC.TopHandler.html#fastExit"><span class="hs-identifier">fastExit</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.TopHandler.html#exitHelper"><span class="hs-identifier hs-var">exitHelper</span></a><span> </span><a href="GHC.TopHandler.html#useFastExit"><span class="hs-identifier hs-var">useFastExit</span></a><span>
</span><a name="line-242"></a><span>
</span><a name="line-243"></a><span class="hs-identifier">unreachable</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="#local-6989586621679359690"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-244"></a><a name="unreachable"><a href="GHC.TopHandler.html#unreachable"><span class="hs-identifier">unreachable</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.Base.html#fail"><span class="hs-identifier hs-var">fail</span></a><span> </span><span class="hs-string">&quot;If you can read this, shutdownHaskellAndExit did not exit.&quot;</span><span>
</span><a name="line-245"></a><span>
</span><a name="line-246"></a><span class="hs-identifier">exitHelper</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Foreign.C.Types.html#CInt"><span class="hs-identifier hs-type">CInt</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="#local-6989586621679359689"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-247"></a><span class="hs-cpp">#if defined(mingw32_HOST_OS)
</span><span class="hs-identifier">exitHelper</span><span> </span><span class="hs-identifier">exitKind</span><span> </span><span class="hs-identifier">r</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-249"></a><span>  </span><span class="hs-identifier">shutdownHaskellAndExit</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">fromIntegral</span><span> </span><span class="hs-identifier">r</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">exitKind</span><span> </span><span class="hs-operator">&gt;&gt;</span><span> </span><span class="hs-identifier">unreachable</span><span>
</span><a name="line-250"></a><span class="hs-cpp">#else
</span><span class="hs-comment">-- On Unix we use an encoding for the ExitCode:</span><span>
</span><a name="line-252"></a><span class="hs-comment">--      0 -- 255  normal exit code</span><span>
</span><a name="line-253"></a><span class="hs-comment">--   -127 -- -1   exit by signal</span><span>
</span><a name="line-254"></a><span class="hs-comment">-- For any invalid encoding we just use a replacement (0xff).</span><span>
</span><a name="line-255"></a><a name="exitHelper"><a href="GHC.TopHandler.html#exitHelper"><span class="hs-identifier">exitHelper</span></a></a><span> </span><a name="local-6989586621679359722"><a href="#local-6989586621679359722"><span class="hs-identifier">exitKind</span></a></a><span> </span><a name="local-6989586621679359723"><a href="#local-6989586621679359723"><span class="hs-identifier">r</span></a></a><span>
</span><a name="line-256"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679359723"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Classes.html#%3E%3D"><span class="hs-operator hs-var">&gt;=</span></a><span> </span><span class="hs-number">0</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Classes.html#%26%26"><span class="hs-operator hs-var">&amp;&amp;</span></a><span> </span><a href="#local-6989586621679359723"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Classes.html#%3C%3D"><span class="hs-operator hs-var">&lt;=</span></a><span> </span><span class="hs-number">255</span><span>
</span><a name="line-257"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="GHC.TopHandler.html#shutdownHaskellAndExit"><span class="hs-identifier hs-var">shutdownHaskellAndExit</span></a><span>   </span><span class="hs-special">(</span><a href="GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a><span>   </span><a href="#local-6989586621679359723"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span>  </span><a href="#local-6989586621679359722"><span class="hs-identifier hs-var">exitKind</span></a><span> </span><a href="GHC.Base.html#%3E%3E"><span class="hs-operator hs-var">&gt;&gt;</span></a><span> </span><a href="GHC.TopHandler.html#unreachable"><span class="hs-identifier hs-var">unreachable</span></a><span>
</span><a name="line-258"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679359723"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Classes.html#%3E%3D"><span class="hs-operator hs-var">&gt;=</span></a><span> </span><span class="hs-glyph">-</span><span class="hs-number">127</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Classes.html#%26%26"><span class="hs-operator hs-var">&amp;&amp;</span></a><span> </span><a href="#local-6989586621679359723"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Classes.html#%3C%3D"><span class="hs-operator hs-var">&lt;=</span></a><span> </span><span class="hs-glyph">-</span><span class="hs-number">1</span><span>
</span><a name="line-259"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="GHC.TopHandler.html#shutdownHaskellAndSignal"><span class="hs-identifier hs-var">shutdownHaskellAndSignal</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">-</span><a href="#local-6989586621679359723"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679359722"><span class="hs-identifier hs-var">exitKind</span></a><span> </span><a href="GHC.Base.html#%3E%3E"><span class="hs-operator hs-var">&gt;&gt;</span></a><span> </span><a href="GHC.TopHandler.html#unreachable"><span class="hs-identifier hs-var">unreachable</span></a><span>
</span><a name="line-260"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-261"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="GHC.TopHandler.html#shutdownHaskellAndExit"><span class="hs-identifier hs-var">shutdownHaskellAndExit</span></a><span>   </span><span class="hs-number">0xff</span><span>                </span><a href="#local-6989586621679359722"><span class="hs-identifier hs-var">exitKind</span></a><span> </span><a href="GHC.Base.html#%3E%3E"><span class="hs-operator hs-var">&gt;&gt;</span></a><span> </span><a href="GHC.TopHandler.html#unreachable"><span class="hs-identifier hs-var">unreachable</span></a><span>
</span><a name="line-262"></a><span>
</span><a name="line-263"></a><span class="hs-keyword">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">ccall</span><span> </span><span class="hs-string">&quot;shutdownHaskellAndSignal&quot;</span><span>
</span><a name="line-264"></a><span>  </span><span class="hs-identifier">shutdownHaskellAndSignal</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Foreign.C.Types.html#CInt"><span class="hs-identifier hs-type">CInt</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Foreign.C.Types.html#CInt"><span class="hs-identifier hs-type">CInt</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-265"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-267"></a><span class="hs-identifier">exitInterrupted</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="#local-6989586621679359688"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-268"></a><a name="exitInterrupted"><a href="GHC.TopHandler.html#exitInterrupted"><span class="hs-identifier">exitInterrupted</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-269"></a><span class="hs-cpp">#if defined(mingw32_HOST_OS)
</span><span>  </span><span class="hs-identifier">safeExit</span><span> </span><span class="hs-number">252</span><span>
</span><a name="line-271"></a><span class="hs-cpp">#else
</span><span>  </span><span class="hs-comment">-- we must exit via the default action for SIGINT, so that the</span><span>
</span><a name="line-273"></a><span>  </span><span class="hs-comment">-- parent of this process can take appropriate action (see #2301)</span><span>
</span><a name="line-274"></a><span>  </span><a href="GHC.TopHandler.html#safeExit"><span class="hs-identifier hs-var">safeExit</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">-</span><span class="hs-identifier">CONST_SIGINT</span><span class="hs-special">)</span><span>
</span><a name="line-275"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-277"></a><span class="hs-comment">-- NOTE: shutdownHaskellAndExit must be called &quot;safe&quot;, because it *can*</span><span>
</span><a name="line-278"></a><span class="hs-comment">-- re-enter Haskell land through finalizers.</span><span>
</span><a name="line-279"></a><span class="hs-keyword">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">ccall</span><span> </span><span class="hs-string">&quot;Rts.h shutdownHaskellAndExit&quot;</span><span>
</span><a name="line-280"></a><span>  </span><span class="hs-identifier">shutdownHaskellAndExit</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Foreign.C.Types.html#CInt"><span class="hs-identifier hs-type">CInt</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Foreign.C.Types.html#CInt"><span class="hs-identifier hs-type">CInt</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-281"></a><span>
</span><a name="line-282"></a><span class="hs-identifier">useFastExit</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">useSafeExit</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Foreign.C.Types.html#CInt"><span class="hs-identifier hs-type">CInt</span></a><span>
</span><a name="line-283"></a><a name="useFastExit"><a href="GHC.TopHandler.html#useFastExit"><span class="hs-identifier">useFastExit</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-284"></a><a name="useSafeExit"><a href="GHC.TopHandler.html#useSafeExit"><span class="hs-identifier">useSafeExit</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-285"></a></pre></body></html>