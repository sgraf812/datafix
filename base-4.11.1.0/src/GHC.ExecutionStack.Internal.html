<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LINE</span><span> </span><span class="hs-pragma">1</span><span> </span><span class="hs-pragma">&quot;libraries/base/GHC/ExecutionStack/Internal.hsc&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-2"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-3"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-4"></a><span class="hs-comment">-- Module      :  GHC.ExecutionStack.Internal</span><span>
</span><a name="line-5"></a><span class="hs-comment">-- Copyright   :  (c) The University of Glasgow 2013-2015</span><span>
</span><a name="line-6"></a><span class="hs-comment">-- License     :  see libraries/base/LICENSE</span><span>
</span><a name="line-7"></a><span class="hs-comment">--</span><span>
</span><a name="line-8"></a><span class="hs-comment">-- Maintainer  :  cvs-ghc@haskell.org</span><span>
</span><a name="line-9"></a><span class="hs-comment">-- Stability   :  internal</span><span>
</span><a name="line-10"></a><span class="hs-comment">-- Portability :  non-portable (GHC Extensions)</span><span>
</span><a name="line-11"></a><span class="hs-comment">--</span><span>
</span><a name="line-12"></a><span class="hs-comment">-- Internals of the `GHC.ExecutionStack` module</span><span>
</span><a name="line-13"></a><span class="hs-comment">--</span><span>
</span><a name="line-14"></a><span class="hs-comment">-- @since 4.9.0.0</span><span>
</span><a name="line-15"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-16"></a><span>
</span><a name="line-17"></a><span>
</span><a name="line-18"></a><span>
</span><a name="line-19"></a><span>
</span><a name="line-20"></a><span>
</span><a name="line-21"></a><span class="hs-pragma">{-# LANGUAGE MultiWayIf #-}</span><span>
</span><a name="line-22"></a><span>
</span><a name="line-23"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">GHC.ExecutionStack.Internal</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-24"></a><span>  </span><span class="hs-comment">-- * Internal</span><span>
</span><a name="line-25"></a><span>    </span><span class="hs-identifier">Location</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-26"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">SrcLoc</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-27"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">StackTrace</span><span>
</span><a name="line-28"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">stackFrames</span><span>
</span><a name="line-29"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">stackDepth</span><span>
</span><a name="line-30"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">collectStackTrace</span><span>
</span><a name="line-31"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">showStackFrames</span><span>
</span><a name="line-32"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">invalidateDebugCache</span><span>
</span><a name="line-33"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-34"></a><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">join</span><span class="hs-special">)</span><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Word</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Foreign.C.Types</span><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Foreign.C.String</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">peekCString</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">CString</span><span class="hs-special">)</span><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Foreign.Ptr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Ptr</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">nullPtr</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">castPtr</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">plusPtr</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">FunPtr</span><span class="hs-special">)</span><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Foreign.ForeignPtr</span><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Foreign.Marshal.Alloc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">allocaBytes</span><span class="hs-special">)</span><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Foreign.Storable</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Storable</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.IO.Unsafe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">unsafePerformIO</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">unsafeInterleaveIO</span><span class="hs-special">)</span><span>
</span><a name="line-44"></a><span>
</span><a name="line-45"></a><span class="hs-comment">-- N.B. See includes/rts/Libdw.h for notes on stack representation.</span><span>
</span><a name="line-46"></a><span>
</span><a name="line-47"></a><span class="hs-comment">-- | A location in the original program source.</span><span>
</span><a name="line-48"></a><span class="hs-keyword">data</span><span> </span><span class="hs-identifier">SrcLoc</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">SrcLoc</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sourceFile</span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">String</span><span>
</span><a name="line-49"></a><span>                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sourceLine</span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Int</span><span>
</span><a name="line-50"></a><span>                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sourceColumn</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Int</span><span>
</span><a name="line-51"></a><span>                     </span><span class="hs-special">}</span><span>
</span><a name="line-52"></a><span>
</span><a name="line-53"></a><span class="hs-comment">-- | Location information about an address from a backtrace.</span><span>
</span><a name="line-54"></a><span class="hs-keyword">data</span><span> </span><span class="hs-identifier">Location</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">Location</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">objectName</span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">String</span><span>
</span><a name="line-55"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">functionName</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">String</span><span>
</span><a name="line-56"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">srcLoc</span><span>       </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Maybe</span><span> </span><span class="hs-identifier">SrcLoc</span><span>
</span><a name="line-57"></a><span>                         </span><span class="hs-special">}</span><span>
</span><a name="line-58"></a><span>
</span><a name="line-59"></a><span class="hs-comment">-- | A chunk of backtrace frames</span><span>
</span><a name="line-60"></a><span class="hs-keyword">data</span><span> </span><span class="hs-identifier">Chunk</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">Chunk</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">chunkFrames</span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier">Word</span><span>
</span><a name="line-61"></a><span>                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">chunkNext</span><span>       </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">Chunk</span><span class="hs-special">)</span><span>
</span><a name="line-62"></a><span>                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">chunkFirstFrame</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">Addr</span><span class="hs-special">)</span><span>
</span><a name="line-63"></a><span>                   </span><span class="hs-special">}</span><span>
</span><a name="line-64"></a><span>
</span><a name="line-65"></a><span class="hs-comment">-- | The state of the execution stack</span><span>
</span><a name="line-66"></a><span class="hs-keyword">newtype</span><span> </span><span class="hs-identifier">StackTrace</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">StackTrace</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ForeignPtr</span><span> </span><span class="hs-identifier">StackTrace</span><span class="hs-special">)</span><span>
</span><a name="line-67"></a><span>
</span><a name="line-68"></a><span class="hs-comment">-- | An address</span><span>
</span><a name="line-69"></a><span class="hs-keyword">type</span><span> </span><span class="hs-identifier">Addr</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-70"></a><span>
</span><a name="line-71"></a><span class="hs-identifier">withSession</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ForeignPtr</span><span> </span><span class="hs-identifier">Session</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-identifier">a</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Maybe</span><span> </span><span class="hs-identifier">a</span><span class="hs-special">)</span><span>
</span><a name="line-72"></a><span class="hs-identifier">withSession</span><span> </span><span class="hs-identifier">action</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-73"></a><span>    </span><span class="hs-identifier">ptr</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">libdw_pool_take</span><span>
</span><a name="line-74"></a><span>    </span><span class="hs-keyword">if</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">nullPtr</span><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-identifier">ptr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">return</span><span> </span><span class="hs-identifier">Nothing</span><span>
</span><a name="line-75"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">otherwise</span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-76"></a><span>           </span><span class="hs-identifier">fptr</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">newForeignPtr</span><span> </span><span class="hs-identifier">libdw_pool_release</span><span> </span><span class="hs-identifier">ptr</span><span>
</span><a name="line-77"></a><span>           </span><span class="hs-identifier">ret</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">action</span><span> </span><span class="hs-identifier">fptr</span><span>
</span><a name="line-78"></a><span>           </span><span class="hs-identifier">return</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">Just</span><span> </span><span class="hs-identifier">ret</span><span>
</span><a name="line-79"></a><span>
</span><a name="line-80"></a><span class="hs-comment">-- | How many stack frames in the given 'StackTrace'</span><span>
</span><a name="line-81"></a><span class="hs-identifier">stackDepth</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">StackTrace</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Int</span><span>
</span><a name="line-82"></a><span class="hs-identifier">stackDepth</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">StackTrace</span><span> </span><span class="hs-identifier">fptr</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-83"></a><span>    </span><span class="hs-identifier">unsafePerformIO</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">withForeignPtr</span><span> </span><span class="hs-identifier">fptr</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">ptr</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-84"></a><span>        </span><span class="hs-identifier">fromIntegral</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">asWord</span><span> </span><span class="hs-operator">&lt;$&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">peekByteOff</span><span> </span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">ptr</span><span>
</span><a name="line-85"></a><span class="hs-pragma">{-# LINE</span><span> </span><span class="hs-pragma">84</span><span> </span><span class="hs-pragma">&quot;libraries/base/GHC/ExecutionStack/Internal.hsc&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-86"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-87"></a><span>    </span><span class="hs-identifier">asWord</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">id</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Word</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Word</span><span>
</span><a name="line-88"></a><span>
</span><a name="line-89"></a><span class="hs-identifier">peekChunk</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">Chunk</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-identifier">Chunk</span><span>
</span><a name="line-90"></a><span class="hs-identifier">peekChunk</span><span> </span><span class="hs-identifier">ptr</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-91"></a><span>    </span><span class="hs-identifier">Chunk</span><span> </span><span class="hs-operator">&lt;$&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">peekByteOff</span><span> </span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">ptr</span><span>
</span><a name="line-92"></a><span class="hs-pragma">{-# LINE</span><span> </span><span class="hs-pragma">90</span><span> </span><span class="hs-pragma">&quot;libraries/base/GHC/ExecutionStack/Internal.hsc&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-93"></a><span>          </span><span class="hs-operator">&lt;*&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">peekByteOff</span><span> </span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-number">8</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">ptr</span><span>
</span><a name="line-94"></a><span class="hs-pragma">{-# LINE</span><span> </span><span class="hs-pragma">91</span><span> </span><span class="hs-pragma">&quot;libraries/base/GHC/ExecutionStack/Internal.hsc&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-95"></a><span>          </span><span class="hs-operator">&lt;*&gt;</span><span> </span><span class="hs-identifier">pure</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">castPtr</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">plusPtr</span><span class="hs-special">`</span><span> </span><span class="hs-number">16</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">ptr</span><span class="hs-special">)</span><span>
</span><a name="line-96"></a><span class="hs-pragma">{-# LINE</span><span> </span><span class="hs-pragma">92</span><span> </span><span class="hs-pragma">&quot;libraries/base/GHC/ExecutionStack/Internal.hsc&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-97"></a><span>
</span><a name="line-98"></a><span class="hs-comment">-- | Return a list of the chunks of a backtrace, from the outer-most to</span><span>
</span><a name="line-99"></a><span class="hs-comment">-- inner-most chunk.</span><span>
</span><a name="line-100"></a><span class="hs-identifier">chunksList</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">StackTrace</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">Chunk</span><span class="hs-special">]</span><span>
</span><a name="line-101"></a><span class="hs-identifier">chunksList</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">StackTrace</span><span> </span><span class="hs-identifier">fptr</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">withForeignPtr</span><span> </span><span class="hs-identifier">fptr</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">ptr</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-102"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-operator">=&lt;&lt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">peekByteOff</span><span> </span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-number">8</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">ptr</span><span>
</span><a name="line-103"></a><span class="hs-pragma">{-# LINE</span><span> </span><span class="hs-pragma">98</span><span> </span><span class="hs-pragma">&quot;libraries/base/GHC/ExecutionStack/Internal.hsc&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-104"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-105"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier">accum</span><span> </span><span class="hs-identifier">ptr</span><span>
</span><a name="line-106"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">ptr</span><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-identifier">nullPtr</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">return</span><span> </span><span class="hs-identifier">accum</span><span>
</span><a name="line-107"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-108"></a><span>            </span><span class="hs-identifier">chunk</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">peekChunk</span><span> </span><span class="hs-identifier">ptr</span><span>
</span><a name="line-109"></a><span>            </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">chunk</span><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">accum</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">chunkNext</span><span> </span><span class="hs-identifier">chunk</span><span class="hs-special">)</span><span>
</span><a name="line-110"></a><span>
</span><a name="line-111"></a><span class="hs-comment">-- | Unpack the given 'Location' in the Haskell representation</span><span>
</span><a name="line-112"></a><span class="hs-identifier">peekLocation</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">Location</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-identifier">Location</span><span>
</span><a name="line-113"></a><span class="hs-identifier">peekLocation</span><span> </span><span class="hs-identifier">ptr</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-114"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">peekCStringPtr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">CString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-identifier">String</span><span>
</span><a name="line-115"></a><span>        </span><span class="hs-identifier">peekCStringPtr</span><span> </span><span class="hs-identifier">p</span><span>
</span><a name="line-116"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">p</span><span> </span><span class="hs-operator">/=</span><span> </span><span class="hs-identifier">nullPtr</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">peekCString</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">castPtr</span><span> </span><span class="hs-identifier">p</span><span>
</span><a name="line-117"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">otherwise</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">return</span><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-118"></a><span>    </span><span class="hs-identifier">objFile</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">peekCStringPtr</span><span> </span><span class="hs-operator">=&lt;&lt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">peekByteOff</span><span> </span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">ptr</span><span>
</span><a name="line-119"></a><span class="hs-pragma">{-# LINE</span><span> </span><span class="hs-pragma">113</span><span> </span><span class="hs-pragma">&quot;libraries/base/GHC/ExecutionStack/Internal.hsc&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-120"></a><span>    </span><span class="hs-identifier">function</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">peekCStringPtr</span><span> </span><span class="hs-operator">=&lt;&lt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">peekByteOff</span><span> </span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-number">8</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">ptr</span><span>
</span><a name="line-121"></a><span class="hs-pragma">{-# LINE</span><span> </span><span class="hs-pragma">114</span><span> </span><span class="hs-pragma">&quot;libraries/base/GHC/ExecutionStack/Internal.hsc&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-122"></a><span>    </span><span class="hs-identifier">srcFile</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">peekCStringPtr</span><span> </span><span class="hs-operator">=&lt;&lt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">peekByteOff</span><span> </span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-number">16</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">ptr</span><span>
</span><a name="line-123"></a><span class="hs-pragma">{-# LINE</span><span> </span><span class="hs-pragma">115</span><span> </span><span class="hs-pragma">&quot;libraries/base/GHC/ExecutionStack/Internal.hsc&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-124"></a><span>    </span><span class="hs-identifier">lineNo</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">peekByteOff</span><span> </span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-number">24</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">ptr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-identifier">Word32</span><span>
</span><a name="line-125"></a><span class="hs-pragma">{-# LINE</span><span> </span><span class="hs-pragma">116</span><span> </span><span class="hs-pragma">&quot;libraries/base/GHC/ExecutionStack/Internal.hsc&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-126"></a><span>    </span><span class="hs-identifier">colNo</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">peekByteOff</span><span> </span><span class="hs-identifier">hsc_ptr</span><span> </span><span class="hs-number">28</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">ptr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-identifier">Word32</span><span>
</span><a name="line-127"></a><span class="hs-pragma">{-# LINE</span><span> </span><span class="hs-pragma">117</span><span> </span><span class="hs-pragma">&quot;libraries/base/GHC/ExecutionStack/Internal.hsc&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-128"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">_srcLoc</span><span>
</span><a name="line-129"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">null</span><span> </span><span class="hs-identifier">srcFile</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">Nothing</span><span>
</span><a name="line-130"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">Just</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">SrcLoc</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sourceFile</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">srcFile</span><span>
</span><a name="line-131"></a><span>                                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sourceLine</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">fromIntegral</span><span> </span><span class="hs-identifier">lineNo</span><span>
</span><a name="line-132"></a><span>                                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sourceColumn</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">fromIntegral</span><span> </span><span class="hs-identifier">colNo</span><span>
</span><a name="line-133"></a><span>                                      </span><span class="hs-special">}</span><span>
</span><a name="line-134"></a><span>    </span><span class="hs-identifier">return</span><span> </span><span class="hs-identifier">Location</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">objectName</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">objFile</span><span>
</span><a name="line-135"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">functionName</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">function</span><span>
</span><a name="line-136"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">srcLoc</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">_srcLoc</span><span>
</span><a name="line-137"></a><span>                    </span><span class="hs-special">}</span><span>
</span><a name="line-138"></a><span>
</span><a name="line-139"></a><span class="hs-comment">-- | The size in bytes of a 'locationSize'</span><span>
</span><a name="line-140"></a><span class="hs-identifier">locationSize</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Int</span><span>
</span><a name="line-141"></a><span class="hs-identifier">locationSize</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-number">32</span><span class="hs-special">)</span><span>
</span><a name="line-142"></a><span class="hs-pragma">{-# LINE</span><span> </span><span class="hs-pragma">131</span><span> </span><span class="hs-pragma">&quot;libraries/base/GHC/ExecutionStack/Internal.hsc&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-143"></a><span>
</span><a name="line-144"></a><span class="hs-comment">-- | List the frames of a stack trace.</span><span>
</span><a name="line-145"></a><span class="hs-identifier">stackFrames</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">StackTrace</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Maybe</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">Location</span><span class="hs-special">]</span><span>
</span><a name="line-146"></a><span class="hs-identifier">stackFrames</span><span> </span><span class="hs-identifier">st</span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier">StackTrace</span><span> </span><span class="hs-identifier">fptr</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">unsafePerformIO</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">withSession</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">sess</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-147"></a><span>    </span><span class="hs-identifier">chunks</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">chunksList</span><span> </span><span class="hs-identifier">st</span><span>
</span><a name="line-148"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier">sess</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">reverse</span><span> </span><span class="hs-identifier">chunks</span><span class="hs-special">)</span><span>
</span><a name="line-149"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-150"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">ForeignPtr</span><span> </span><span class="hs-identifier">Session</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">Chunk</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">Location</span><span class="hs-special">]</span><span>
</span><a name="line-151"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">return</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-152"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier">sess</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">chunk</span><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">chunks</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-153"></a><span>        </span><span class="hs-identifier">this</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">iterChunk</span><span> </span><span class="hs-identifier">sess</span><span> </span><span class="hs-identifier">chunk</span><span>
</span><a name="line-154"></a><span>        </span><span class="hs-identifier">rest</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">unsafeInterleaveIO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier">sess</span><span> </span><span class="hs-identifier">chunks</span><span class="hs-special">)</span><span>
</span><a name="line-155"></a><span>        </span><span class="hs-identifier">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">this</span><span> </span><span class="hs-operator">++</span><span> </span><span class="hs-identifier">rest</span><span class="hs-special">)</span><span>
</span><a name="line-156"></a><span>
</span><a name="line-157"></a><span>    </span><span class="hs-comment">{-
    Here we lazily lookup the location information associated with each address
    as this can be rather costly. This does mean, however, that if the set of
    loaded modules changes between the time that we capture the stack and the
    time we reach here, we may end up with nonsense (mostly likely merely
    unknown symbols). I think this is a reasonable price to pay, however, as
    module loading/unloading is a rather rare event.

    Morover, we stand to gain a great deal by lazy lookups as the stack frames
    may never even be requested, meaning the only effort wasted is the
    collection of the stack frames themselves.

    The only slightly tricky thing here is to ensure that the ForeignPtr
    stays alive until we reach the end.
    -}</span><span>
</span><a name="line-172"></a><span>    </span><span class="hs-identifier">iterChunk</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">ForeignPtr</span><span> </span><span class="hs-identifier">Session</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Chunk</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">Location</span><span class="hs-special">]</span><span>
</span><a name="line-173"></a><span>    </span><span class="hs-identifier">iterChunk</span><span> </span><span class="hs-identifier">sess</span><span> </span><span class="hs-identifier">chunk</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">iterFrames</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">chunkFrames</span><span> </span><span class="hs-identifier">chunk</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">chunkFirstFrame</span><span> </span><span class="hs-identifier">chunk</span><span class="hs-special">)</span><span>
</span><a name="line-174"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-175"></a><span>        </span><span class="hs-identifier">iterFrames</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Word</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">Addr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">Location</span><span class="hs-special">]</span><span>
</span><a name="line-176"></a><span>        </span><span class="hs-identifier">iterFrames</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">return</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-177"></a><span>        </span><span class="hs-identifier">iterFrames</span><span> </span><span class="hs-identifier">n</span><span> </span><span class="hs-identifier">frame</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-178"></a><span>            </span><span class="hs-identifier">pc</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">peek</span><span> </span><span class="hs-identifier">frame</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-identifier">Addr</span><span>
</span><a name="line-179"></a><span>            </span><span class="hs-identifier">mframe</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">lookupFrame</span><span> </span><span class="hs-identifier">pc</span><span>
</span><a name="line-180"></a><span>            </span><span class="hs-identifier">rest</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">unsafeInterleaveIO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">iterFrames</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">n</span><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">frame'</span><span class="hs-special">)</span><span>
</span><a name="line-181"></a><span>            </span><span class="hs-identifier">return</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">maybe</span><span> </span><span class="hs-identifier">rest</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">:</span><span class="hs-identifier">rest</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">mframe</span><span>
</span><a name="line-182"></a><span>          </span><span class="hs-keyword">where</span><span>
</span><a name="line-183"></a><span>            </span><span class="hs-identifier">frame'</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">frame</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">plusPtr</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">sizeOf</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">undefined</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Addr</span><span class="hs-special">)</span><span>
</span><a name="line-184"></a><span>
</span><a name="line-185"></a><span>        </span><span class="hs-identifier">lookupFrame</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Addr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Maybe</span><span> </span><span class="hs-identifier">Location</span><span class="hs-special">)</span><span>
</span><a name="line-186"></a><span>        </span><span class="hs-identifier">lookupFrame</span><span> </span><span class="hs-identifier">pc</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">withForeignPtr</span><span> </span><span class="hs-identifier">fptr</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">const</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-187"></a><span>            </span><span class="hs-identifier">allocaBytes</span><span> </span><span class="hs-identifier">locationSize</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">buf</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-188"></a><span>                </span><span class="hs-identifier">ret</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">withForeignPtr</span><span> </span><span class="hs-identifier">sess</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">sessPtr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">libdw_lookup_location</span><span> </span><span class="hs-identifier">sessPtr</span><span> </span><span class="hs-identifier">buf</span><span> </span><span class="hs-identifier">pc</span><span>
</span><a name="line-189"></a><span>                </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">ret</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-190"></a><span>                  </span><span class="hs-number">0</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Just</span><span> </span><span class="hs-operator">&lt;$&gt;</span><span> </span><span class="hs-identifier">peekLocation</span><span> </span><span class="hs-identifier">buf</span><span>
</span><a name="line-191"></a><span>                  </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">return</span><span> </span><span class="hs-identifier">Nothing</span><span>
</span><a name="line-192"></a><span>
</span><a name="line-193"></a><span class="hs-comment">-- | A LibdwSession from the runtime system</span><span>
</span><a name="line-194"></a><span class="hs-keyword">data</span><span> </span><span class="hs-identifier">Session</span><span>
</span><a name="line-195"></a><span>
</span><a name="line-196"></a><span class="hs-keyword">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">ccall</span><span> </span><span class="hs-keyword">unsafe</span><span> </span><span class="hs-string">&quot;libdwPoolTake&quot;</span><span>
</span><a name="line-197"></a><span>    </span><span class="hs-identifier">libdw_pool_take</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">Session</span><span class="hs-special">)</span><span>
</span><a name="line-198"></a><span>
</span><a name="line-199"></a><span class="hs-keyword">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">ccall</span><span> </span><span class="hs-keyword">unsafe</span><span> </span><span class="hs-string">&quot;&amp;libdwPoolRelease&quot;</span><span>
</span><a name="line-200"></a><span>    </span><span class="hs-identifier">libdw_pool_release</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">FunPtr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">Session</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-201"></a><span>
</span><a name="line-202"></a><span class="hs-keyword">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">ccall</span><span> </span><span class="hs-keyword">unsafe</span><span> </span><span class="hs-string">&quot;libdwPoolClear&quot;</span><span>
</span><a name="line-203"></a><span>    </span><span class="hs-identifier">libdw_pool_clear</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-204"></a><span>
</span><a name="line-205"></a><span class="hs-keyword">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">ccall</span><span> </span><span class="hs-keyword">unsafe</span><span> </span><span class="hs-string">&quot;libdwLookupLocation&quot;</span><span>
</span><a name="line-206"></a><span>    </span><span class="hs-identifier">libdw_lookup_location</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">Session</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">Location</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Addr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-identifier">CInt</span><span>
</span><a name="line-207"></a><span>
</span><a name="line-208"></a><span class="hs-keyword">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">ccall</span><span> </span><span class="hs-keyword">unsafe</span><span> </span><span class="hs-string">&quot;libdwGetBacktrace&quot;</span><span>
</span><a name="line-209"></a><span>    </span><span class="hs-identifier">libdw_get_backtrace</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">Session</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">StackTrace</span><span class="hs-special">)</span><span>
</span><a name="line-210"></a><span>
</span><a name="line-211"></a><span class="hs-keyword">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">ccall</span><span> </span><span class="hs-keyword">unsafe</span><span> </span><span class="hs-string">&quot;&amp;backtraceFree&quot;</span><span>
</span><a name="line-212"></a><span>    </span><span class="hs-identifier">backtrace_free</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">FunPtr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">StackTrace</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-213"></a><span>
</span><a name="line-214"></a><span class="hs-comment">-- | Get an execution stack.</span><span>
</span><a name="line-215"></a><span class="hs-identifier">collectStackTrace</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Maybe</span><span> </span><span class="hs-identifier">StackTrace</span><span class="hs-special">)</span><span>
</span><a name="line-216"></a><span class="hs-identifier">collectStackTrace</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">fmap</span><span> </span><span class="hs-identifier">join</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">withSession</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">sess</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-217"></a><span>    </span><span class="hs-identifier">st</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">withForeignPtr</span><span> </span><span class="hs-identifier">sess</span><span> </span><span class="hs-identifier">libdw_get_backtrace</span><span>
</span><a name="line-218"></a><span>    </span><span class="hs-keyword">if</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">st</span><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-identifier">nullPtr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">return</span><span> </span><span class="hs-identifier">Nothing</span><span>
</span><a name="line-219"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">otherwise</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Just</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">StackTrace</span><span> </span><span class="hs-operator">&lt;$&gt;</span><span> </span><span class="hs-identifier">newForeignPtr</span><span> </span><span class="hs-identifier">backtrace_free</span><span> </span><span class="hs-identifier">st</span><span>
</span><a name="line-220"></a><span>
</span><a name="line-221"></a><span class="hs-comment">-- | Free the cached debug data.</span><span>
</span><a name="line-222"></a><span class="hs-identifier">invalidateDebugCache</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-223"></a><span class="hs-identifier">invalidateDebugCache</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">libdw_pool_clear</span><span>
</span><a name="line-224"></a><span>
</span><a name="line-225"></a><span class="hs-comment">-- | Render a stacktrace as a string</span><span>
</span><a name="line-226"></a><span class="hs-identifier">showStackFrames</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">Location</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">ShowS</span><span>
</span><a name="line-227"></a><span class="hs-identifier">showStackFrames</span><span> </span><span class="hs-identifier">frames</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-228"></a><span>    </span><span class="hs-identifier">showString</span><span> </span><span class="hs-string">&quot;Stack trace:\n&quot;</span><span>
</span><a name="line-229"></a><span>    </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">foldr</span><span> </span><span class="hs-special">(</span><span class="hs-operator">.</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">id</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">map</span><span> </span><span class="hs-identifier">showFrame</span><span> </span><span class="hs-identifier">frames</span><span class="hs-special">)</span><span>
</span><a name="line-230"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-231"></a><span>    </span><span class="hs-identifier">showFrame</span><span> </span><span class="hs-identifier">loc</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-232"></a><span>      </span><span class="hs-identifier">showString</span><span> </span><span class="hs-string">&quot;    &quot;</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">showLocation</span><span> </span><span class="hs-identifier">loc</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">showChar</span><span> </span><span class="hs-char">'\n'</span><span>
</span><a name="line-233"></a><span>
</span><a name="line-234"></a><span class="hs-comment">-- | Render a 'Location' as a string</span><span>
</span><a name="line-235"></a><span class="hs-identifier">showLocation</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Location</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">ShowS</span><span>
</span><a name="line-236"></a><span class="hs-identifier">showLocation</span><span> </span><span class="hs-identifier">loc</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-237"></a><span>        </span><span class="hs-identifier">showString</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">functionName</span><span> </span><span class="hs-identifier">loc</span><span class="hs-special">)</span><span>
</span><a name="line-238"></a><span>      </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">maybe</span><span> </span><span class="hs-identifier">id</span><span> </span><span class="hs-identifier">showSrcLoc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">srcLoc</span><span> </span><span class="hs-identifier">loc</span><span class="hs-special">)</span><span>
</span><a name="line-239"></a><span>      </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">showString</span><span> </span><span class="hs-string">&quot; in &quot;</span><span>
</span><a name="line-240"></a><span>      </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">showString</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">objectName</span><span> </span><span class="hs-identifier">loc</span><span class="hs-special">)</span><span>
</span><a name="line-241"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-242"></a><span>    </span><span class="hs-identifier">showSrcLoc</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">SrcLoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">ShowS</span><span>
</span><a name="line-243"></a><span>    </span><span class="hs-identifier">showSrcLoc</span><span> </span><span class="hs-identifier">sloc</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-244"></a><span>        </span><span class="hs-identifier">showString</span><span> </span><span class="hs-string">&quot; (&quot;</span><span>
</span><a name="line-245"></a><span>      </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">showString</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">sourceFile</span><span> </span><span class="hs-identifier">sloc</span><span class="hs-special">)</span><span>
</span><a name="line-246"></a><span>      </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">showString</span><span> </span><span class="hs-string">&quot;:&quot;</span><span>
</span><a name="line-247"></a><span>      </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">shows</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">sourceLine</span><span> </span><span class="hs-identifier">sloc</span><span class="hs-special">)</span><span>
</span><a name="line-248"></a><span>      </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">showString</span><span> </span><span class="hs-string">&quot;.&quot;</span><span>
</span><a name="line-249"></a><span>      </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">shows</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">sourceColumn</span><span> </span><span class="hs-identifier">sloc</span><span class="hs-special">)</span><span>
</span><a name="line-250"></a><span>      </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">showString</span><span> </span><span class="hs-string">&quot;)&quot;</span><span>
</span><a name="line-251"></a></pre></body></html>