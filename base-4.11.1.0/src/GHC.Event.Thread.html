<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE Trustworthy #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE BangPatterns, NoImplicitPrelude #-}</span><span>
</span><a name="line-3"></a><span>
</span><a name="line-4"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">GHC.Event.Thread</span><span>
</span><a name="line-5"></a><span>    </span><span class="hs-special">(</span><span> </span><a href="GHC.Event.Thread.html#getSystemEventManager"><span class="hs-identifier hs-var">getSystemEventManager</span></a><span>
</span><a name="line-6"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="GHC.Event.Thread.html#getSystemTimerManager"><span class="hs-identifier hs-var">getSystemTimerManager</span></a><span>
</span><a name="line-7"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="GHC.Event.Thread.html#ensureIOManagerIsRunning"><span class="hs-identifier hs-var">ensureIOManagerIsRunning</span></a><span>
</span><a name="line-8"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="GHC.Event.Thread.html#ioManagerCapabilitiesChanged"><span class="hs-identifier hs-var">ioManagerCapabilitiesChanged</span></a><span>
</span><a name="line-9"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="GHC.Event.Thread.html#threadWaitRead"><span class="hs-identifier hs-var">threadWaitRead</span></a><span>
</span><a name="line-10"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="GHC.Event.Thread.html#threadWaitWrite"><span class="hs-identifier hs-var">threadWaitWrite</span></a><span>
</span><a name="line-11"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="GHC.Event.Thread.html#threadWaitReadSTM"><span class="hs-identifier hs-var">threadWaitReadSTM</span></a><span>
</span><a name="line-12"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="GHC.Event.Thread.html#threadWaitWriteSTM"><span class="hs-identifier hs-var">threadWaitWriteSTM</span></a><span>
</span><a name="line-13"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="GHC.Event.Thread.html#closeFdWith"><span class="hs-identifier hs-var">closeFdWith</span></a><span>
</span><a name="line-14"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="GHC.Event.Thread.html#threadDelay"><span class="hs-identifier hs-var">threadDelay</span></a><span>
</span><a name="line-15"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="GHC.Event.Thread.html#registerDelay"><span class="hs-identifier hs-var">registerDelay</span></a><span>
</span><a name="line-16"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="GHC.Event.Thread.html#blockedOnBadFD"><span class="hs-identifier hs-var">blockedOnBadFD</span></a><span> </span><span class="hs-comment">-- used by RTS</span><span>
</span><a name="line-17"></a><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-18"></a><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><a href="Control.Exception.html"><span class="hs-identifier">Control.Exception</span></a><span> </span><span class="hs-special">(</span><a href="Control.Exception.Base.html#finally"><span class="hs-identifier hs-var">finally</span></a><span class="hs-special">,</span><span> </span><a href="GHC.Exception.html#SomeException"><span class="hs-identifier hs-type">SomeException</span></a><span class="hs-special">,</span><span> </span><a href="GHC.Exception.html#toException"><span class="hs-identifier hs-var">toException</span></a><span class="hs-special">)</span><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Foldable.html"><span class="hs-identifier">Data.Foldable</span></a><span> </span><span class="hs-special">(</span><a href="Data.Foldable.html#forM_"><span class="hs-identifier hs-var">forM_</span></a><span class="hs-special">,</span><span> </span><a href="Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a><span class="hs-special">,</span><span> </span><a href="Data.Foldable.html#sequence_"><span class="hs-identifier hs-var">sequence_</span></a><span class="hs-special">)</span><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><a href="Data.IORef.html"><span class="hs-identifier">Data.IORef</span></a><span> </span><span class="hs-special">(</span><a href="GHC.IORef.html#IORef"><span class="hs-identifier hs-type">IORef</span></a><span class="hs-special">,</span><span> </span><a href="GHC.IORef.html#newIORef"><span class="hs-identifier hs-var">newIORef</span></a><span class="hs-special">,</span><span> </span><a href="GHC.IORef.html#readIORef"><span class="hs-identifier hs-var">readIORef</span></a><span class="hs-special">,</span><span> </span><a href="GHC.IORef.html#writeIORef"><span class="hs-identifier hs-var">writeIORef</span></a><span class="hs-special">)</span><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Tuple.html"><span class="hs-identifier">Data.Tuple</span></a><span> </span><span class="hs-special">(</span><a href="Data.Tuple.html#snd"><span class="hs-identifier hs-var">snd</span></a><span class="hs-special">)</span><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><a href="Foreign.C.Error.html"><span class="hs-identifier">Foreign.C.Error</span></a><span> </span><span class="hs-special">(</span><a href="Foreign.C.Error.html#eBADF"><span class="hs-identifier hs-var">eBADF</span></a><span class="hs-special">,</span><span> </span><a href="Foreign.C.Error.html#errnoToIOError"><span class="hs-identifier hs-var">errnoToIOError</span></a><span class="hs-special">)</span><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><a href="Foreign.C.Types.html"><span class="hs-identifier">Foreign.C.Types</span></a><span> </span><span class="hs-special">(</span><a href="Foreign.C.Types.html#CInt"><span class="hs-identifier hs-type">CInt</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Foreign.C.Types.html#CUInt"><span class="hs-identifier hs-type">CUInt</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><a href="Foreign.Ptr.html"><span class="hs-identifier">Foreign.Ptr</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a><span class="hs-special">)</span><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><a href="GHC.Base.html"><span class="hs-identifier">GHC.Base</span></a><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><a href="GHC.List.html"><span class="hs-identifier">GHC.List</span></a><span> </span><span class="hs-special">(</span><a href="GHC.List.html#zipWith"><span class="hs-identifier hs-var">zipWith</span></a><span class="hs-special">,</span><span> </span><a href="GHC.List.html#zipWith3"><span class="hs-identifier hs-var">zipWith3</span></a><span class="hs-special">)</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><a href="GHC.Conc.Sync.html"><span class="hs-identifier">GHC.Conc.Sync</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Conc.Sync.html#TVar"><span class="hs-identifier hs-type">TVar</span></a><span class="hs-special">,</span><span> </span><a href="GHC.Conc.Sync.html#ThreadId"><span class="hs-identifier hs-type">ThreadId</span></a><span class="hs-special">,</span><span> </span><a href="GHC.Conc.Sync.html#ThreadStatus"><span class="hs-identifier hs-type">ThreadStatus</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="GHC.Conc.Sync.html#atomically"><span class="hs-identifier hs-var">atomically</span></a><span class="hs-special">,</span><span> </span><a href="GHC.Conc.Sync.html#forkIO"><span class="hs-identifier hs-var">forkIO</span></a><span class="hs-special">,</span><span>
</span><a name="line-29"></a><span>                      </span><a href="GHC.Conc.Sync.html#labelThread"><span class="hs-identifier hs-var">labelThread</span></a><span class="hs-special">,</span><span> </span><a href="GHC.Conc.Sync.html#modifyMVar_"><span class="hs-identifier hs-var">modifyMVar_</span></a><span class="hs-special">,</span><span> </span><a href="GHC.Conc.Sync.html#withMVar"><span class="hs-identifier hs-var">withMVar</span></a><span class="hs-special">,</span><span> </span><a href="GHC.Conc.Sync.html#newTVar"><span class="hs-identifier hs-var">newTVar</span></a><span class="hs-special">,</span><span> </span><a href="GHC.Conc.Sync.html#sharedCAF"><span class="hs-identifier hs-var">sharedCAF</span></a><span class="hs-special">,</span><span>
</span><a name="line-30"></a><span>                      </span><a href="GHC.Conc.Sync.html#getNumCapabilities"><span class="hs-identifier hs-var">getNumCapabilities</span></a><span class="hs-special">,</span><span> </span><a href="GHC.Conc.Sync.html#threadCapability"><span class="hs-identifier hs-var">threadCapability</span></a><span class="hs-special">,</span><span> </span><a href="GHC.Conc.Sync.html#myThreadId"><span class="hs-identifier hs-var">myThreadId</span></a><span class="hs-special">,</span><span> </span><a href="GHC.Conc.Sync.html#forkOn"><span class="hs-identifier hs-var">forkOn</span></a><span class="hs-special">,</span><span>
</span><a name="line-31"></a><span>                      </span><a href="GHC.Conc.Sync.html#threadStatus"><span class="hs-identifier hs-var">threadStatus</span></a><span class="hs-special">,</span><span> </span><a href="GHC.Conc.Sync.html#writeTVar"><span class="hs-identifier hs-var">writeTVar</span></a><span class="hs-special">,</span><span> </span><a href="GHC.Conc.Sync.html#newTVarIO"><span class="hs-identifier hs-var">newTVarIO</span></a><span class="hs-special">,</span><span> </span><a href="GHC.Conc.Sync.html#readTVar"><span class="hs-identifier hs-var">readTVar</span></a><span class="hs-special">,</span><span> </span><a href="GHC.Conc.Sync.html#retry"><span class="hs-identifier hs-var">retry</span></a><span class="hs-special">,</span><a href="GHC.Conc.Sync.html#throwSTM"><span class="hs-identifier hs-var">throwSTM</span></a><span class="hs-special">,</span><a href="GHC.Conc.Sync.html#STM"><span class="hs-identifier hs-type">STM</span></a><span class="hs-special">)</span><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><a href="GHC.IO.html"><span class="hs-identifier">GHC.IO</span></a><span> </span><span class="hs-special">(</span><a href="GHC.IO.html#mask_"><span class="hs-identifier hs-var">mask_</span></a><span class="hs-special">,</span><span> </span><a href="GHC.IO.html#onException"><span class="hs-identifier hs-var">onException</span></a><span class="hs-special">)</span><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><a href="GHC.IO.Exception.html"><span class="hs-identifier">GHC.IO.Exception</span></a><span> </span><span class="hs-special">(</span><a href="GHC.IO.Exception.html#ioError"><span class="hs-identifier hs-var">ioError</span></a><span class="hs-special">)</span><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><a href="GHC.IOArray.html"><span class="hs-identifier">GHC.IOArray</span></a><span> </span><span class="hs-special">(</span><a href="GHC.IOArray.html#IOArray"><span class="hs-identifier hs-type">IOArray</span></a><span class="hs-special">,</span><span> </span><a href="GHC.IOArray.html#newIOArray"><span class="hs-identifier hs-var">newIOArray</span></a><span class="hs-special">,</span><span> </span><a href="GHC.IOArray.html#readIOArray"><span class="hs-identifier hs-var">readIOArray</span></a><span class="hs-special">,</span><span> </span><a href="GHC.IOArray.html#writeIOArray"><span class="hs-identifier hs-var">writeIOArray</span></a><span class="hs-special">,</span><span>
</span><a name="line-35"></a><span>                    </span><a href="GHC.IOArray.html#boundsIOArray"><span class="hs-identifier hs-var">boundsIOArray</span></a><span class="hs-special">)</span><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><a href="GHC.MVar.html"><span class="hs-identifier">GHC.MVar</span></a><span> </span><span class="hs-special">(</span><a href="GHC.MVar.html#MVar"><span class="hs-identifier hs-type">MVar</span></a><span class="hs-special">,</span><span> </span><a href="GHC.MVar.html#newEmptyMVar"><span class="hs-identifier hs-var">newEmptyMVar</span></a><span class="hs-special">,</span><span> </span><a href="GHC.MVar.html#newMVar"><span class="hs-identifier hs-var">newMVar</span></a><span class="hs-special">,</span><span> </span><a href="GHC.MVar.html#putMVar"><span class="hs-identifier hs-var">putMVar</span></a><span class="hs-special">,</span><span> </span><a href="GHC.MVar.html#takeMVar"><span class="hs-identifier hs-var">takeMVar</span></a><span class="hs-special">)</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><a href="GHC.Event.Control.html"><span class="hs-identifier">GHC.Event.Control</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Event.Control.html#controlWriteFd"><span class="hs-identifier hs-var">controlWriteFd</span></a><span class="hs-special">)</span><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><a href="GHC.Event.Internal.html"><span class="hs-identifier">GHC.Event.Internal</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Event.Internal.html#eventIs"><span class="hs-identifier hs-var">eventIs</span></a><span class="hs-special">,</span><span> </span><a href="GHC.Event.Internal.html#evtClose"><span class="hs-identifier hs-var">evtClose</span></a><span class="hs-special">)</span><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><a href="GHC.Event.Manager.html"><span class="hs-identifier">GHC.Event.Manager</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Event.Internal.html#Event"><span class="hs-identifier hs-type">Event</span></a><span class="hs-special">,</span><span> </span><a href="GHC.Event.Manager.html#EventManager"><span class="hs-identifier hs-type">EventManager</span></a><span class="hs-special">,</span><span> </span><a href="GHC.Event.Internal.html#evtRead"><span class="hs-identifier hs-var">evtRead</span></a><span class="hs-special">,</span><span> </span><a href="GHC.Event.Internal.html#evtWrite"><span class="hs-identifier hs-var">evtWrite</span></a><span class="hs-special">,</span><span> </span><a href="GHC.Event.Manager.html#loop"><span class="hs-identifier hs-var">loop</span></a><span class="hs-special">,</span><span>
</span><a name="line-40"></a><span>                             </span><a href="GHC.Event.Manager.html#new"><span class="hs-identifier hs-var">new</span></a><span class="hs-special">,</span><span> </span><a href="GHC.Event.Manager.html#registerFd"><span class="hs-identifier hs-var">registerFd</span></a><span class="hs-special">,</span><span> </span><a href="GHC.Event.Manager.html#unregisterFd_"><span class="hs-identifier hs-var">unregisterFd_</span></a><span class="hs-special">)</span><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="GHC.Event.Manager.html"><span class="hs-identifier">GHC.Event.Manager</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">M</span><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="GHC.Event.TimerManager.html"><span class="hs-identifier">GHC.Event.TimerManager</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">TM</span><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><a href="GHC.Num.html"><span class="hs-identifier">GHC.Num</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">-</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><a href="GHC.Real.html"><span class="hs-identifier">GHC.Real</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a><span class="hs-special">)</span><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><a href="GHC.Show.html"><span class="hs-identifier">GHC.Show</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Show.html#showSignedInt"><span class="hs-identifier hs-var">showSignedInt</span></a><span class="hs-special">)</span><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span> </span><a href="System.IO.Unsafe.html"><span class="hs-identifier">System.IO.Unsafe</span></a><span> </span><span class="hs-special">(</span><a href="GHC.IO.Unsafe.html#unsafePerformIO"><span class="hs-identifier hs-var">unsafePerformIO</span></a><span class="hs-special">)</span><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span> </span><a href="System.Posix.Types.html"><span class="hs-identifier">System.Posix.Types</span></a><span> </span><span class="hs-special">(</span><a href="System.Posix.Types.html#Fd"><span class="hs-identifier hs-type">Fd</span></a><span class="hs-special">)</span><span>
</span><a name="line-48"></a><span>
</span><a name="line-49"></a><span class="hs-comment">-- | Suspends the current thread for a given number of microseconds</span><span>
</span><a name="line-50"></a><span class="hs-comment">-- (GHC only).</span><span>
</span><a name="line-51"></a><span class="hs-comment">--</span><span>
</span><a name="line-52"></a><span class="hs-comment">-- There is no guarantee that the thread will be rescheduled promptly</span><span>
</span><a name="line-53"></a><span class="hs-comment">-- when the delay has expired, but the thread will never continue to</span><span>
</span><a name="line-54"></a><span class="hs-comment">-- run /earlier/ than specified.</span><span>
</span><a name="line-55"></a><span class="hs-identifier">threadDelay</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-56"></a><a name="threadDelay"><a href="GHC.Event.Thread.html#threadDelay"><span class="hs-identifier">threadDelay</span></a></a><span> </span><a name="local-6989586621679299264"><a href="#local-6989586621679299264"><span class="hs-identifier">usecs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.html#mask_"><span class="hs-identifier hs-var">mask_</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-57"></a><span>  </span><a name="local-6989586621679299265"><a href="#local-6989586621679299265"><span class="hs-identifier">mgr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.Event.Thread.html#getSystemTimerManager"><span class="hs-identifier hs-var">getSystemTimerManager</span></a><span>
</span><a name="line-58"></a><span>  </span><a name="local-6989586621679299266"><a href="#local-6989586621679299266"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.MVar.html#newEmptyMVar"><span class="hs-identifier hs-var">newEmptyMVar</span></a><span>
</span><a name="line-59"></a><span>  </span><a name="local-6989586621679299267"><a href="#local-6989586621679299267"><span class="hs-identifier">reg</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.Event.TimerManager.html#registerTimeout"><span class="hs-identifier hs-var">TM.registerTimeout</span></a><span> </span><a href="#local-6989586621679299265"><span class="hs-identifier hs-var">mgr</span></a><span> </span><a href="#local-6989586621679299264"><span class="hs-identifier hs-var">usecs</span></a><span> </span><span class="hs-special">(</span><a href="GHC.MVar.html#putMVar"><span class="hs-identifier hs-var">putMVar</span></a><span> </span><a href="#local-6989586621679299266"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-60"></a><span>  </span><a href="GHC.MVar.html#takeMVar"><span class="hs-identifier hs-var">takeMVar</span></a><span> </span><a href="#local-6989586621679299266"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-special">`</span><a href="GHC.IO.html#onException"><span class="hs-identifier hs-var">onException</span></a><span class="hs-special">`</span><span> </span><a href="GHC.Event.TimerManager.html#unregisterTimeout"><span class="hs-identifier hs-var">TM.unregisterTimeout</span></a><span> </span><a href="#local-6989586621679299265"><span class="hs-identifier hs-var">mgr</span></a><span> </span><a href="#local-6989586621679299267"><span class="hs-identifier hs-var">reg</span></a><span>
</span><a name="line-61"></a><span>
</span><a name="line-62"></a><span class="hs-comment">-- | Set the value of returned TVar to True after a given number of</span><span>
</span><a name="line-63"></a><span class="hs-comment">-- microseconds. The caveats associated with threadDelay also apply.</span><span>
</span><a name="line-64"></a><span class="hs-comment">--</span><span>
</span><a name="line-65"></a><span class="hs-identifier">registerDelay</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Conc.Sync.html#TVar"><span class="hs-identifier hs-type">TVar</span></a><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a><span class="hs-special">)</span><span>
</span><a name="line-66"></a><a name="registerDelay"><a href="GHC.Event.Thread.html#registerDelay"><span class="hs-identifier">registerDelay</span></a></a><span> </span><a name="local-6989586621679299268"><a href="#local-6989586621679299268"><span class="hs-identifier">usecs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-67"></a><span>  </span><a name="local-6989586621679299269"><a href="#local-6989586621679299269"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.Conc.Sync.html#atomically"><span class="hs-identifier hs-var">atomically</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="GHC.Conc.Sync.html#newTVar"><span class="hs-identifier hs-var">newTVar</span></a><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a><span>
</span><a name="line-68"></a><span>  </span><a name="local-6989586621679299270"><a href="#local-6989586621679299270"><span class="hs-identifier">mgr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.Event.Thread.html#getSystemTimerManager"><span class="hs-identifier hs-var">getSystemTimerManager</span></a><span>
</span><a name="line-69"></a><span>  </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.Event.TimerManager.html#registerTimeout"><span class="hs-identifier hs-var">TM.registerTimeout</span></a><span> </span><a href="#local-6989586621679299270"><span class="hs-identifier hs-var">mgr</span></a><span> </span><a href="#local-6989586621679299268"><span class="hs-identifier hs-var">usecs</span></a><span> </span><a href="GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="GHC.Conc.Sync.html#atomically"><span class="hs-identifier hs-var">atomically</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="GHC.Conc.Sync.html#writeTVar"><span class="hs-identifier hs-var">writeTVar</span></a><span> </span><a href="#local-6989586621679299269"><span class="hs-identifier hs-var">t</span></a><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a><span>
</span><a name="line-70"></a><span>  </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621679299269"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-71"></a><span>
</span><a name="line-72"></a><span class="hs-comment">-- | Block the current thread until data is available to read from the</span><span>
</span><a name="line-73"></a><span class="hs-comment">-- given file descriptor.</span><span>
</span><a name="line-74"></a><span class="hs-comment">--</span><span>
</span><a name="line-75"></a><span class="hs-comment">-- This will throw an 'IOError' if the file descriptor was closed</span><span>
</span><a name="line-76"></a><span class="hs-comment">-- while this thread was blocked.  To safely close a file descriptor</span><span>
</span><a name="line-77"></a><span class="hs-comment">-- that has been used with 'threadWaitRead', use 'closeFdWith'.</span><span>
</span><a name="line-78"></a><span class="hs-identifier">threadWaitRead</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="System.Posix.Types.html#Fd"><span class="hs-identifier hs-type">Fd</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-79"></a><a name="threadWaitRead"><a href="GHC.Event.Thread.html#threadWaitRead"><span class="hs-identifier">threadWaitRead</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.Event.Thread.html#threadWait"><span class="hs-identifier hs-var">threadWait</span></a><span> </span><a href="GHC.Event.Internal.html#evtRead"><span class="hs-identifier hs-var">evtRead</span></a><span>
</span><a name="line-80"></a><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">threadWaitRead</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-81"></a><span>
</span><a name="line-82"></a><span class="hs-comment">-- | Block the current thread until the given file descriptor can</span><span>
</span><a name="line-83"></a><span class="hs-comment">-- accept data to write.</span><span>
</span><a name="line-84"></a><span class="hs-comment">--</span><span>
</span><a name="line-85"></a><span class="hs-comment">-- This will throw an 'IOError' if the file descriptor was closed</span><span>
</span><a name="line-86"></a><span class="hs-comment">-- while this thread was blocked.  To safely close a file descriptor</span><span>
</span><a name="line-87"></a><span class="hs-comment">-- that has been used with 'threadWaitWrite', use 'closeFdWith'.</span><span>
</span><a name="line-88"></a><span class="hs-identifier">threadWaitWrite</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="System.Posix.Types.html#Fd"><span class="hs-identifier hs-type">Fd</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-89"></a><a name="threadWaitWrite"><a href="GHC.Event.Thread.html#threadWaitWrite"><span class="hs-identifier">threadWaitWrite</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.Event.Thread.html#threadWait"><span class="hs-identifier hs-var">threadWait</span></a><span> </span><a href="GHC.Event.Internal.html#evtWrite"><span class="hs-identifier hs-var">evtWrite</span></a><span>
</span><a name="line-90"></a><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">threadWaitWrite</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-91"></a><span>
</span><a name="line-92"></a><span class="hs-comment">-- | Close a file descriptor in a concurrency-safe way.</span><span>
</span><a name="line-93"></a><span class="hs-comment">--</span><span>
</span><a name="line-94"></a><span class="hs-comment">-- Any threads that are blocked on the file descriptor via</span><span>
</span><a name="line-95"></a><span class="hs-comment">-- 'threadWaitRead' or 'threadWaitWrite' will be unblocked by having</span><span>
</span><a name="line-96"></a><span class="hs-comment">-- IO exceptions thrown.</span><span>
</span><a name="line-97"></a><span class="hs-identifier">closeFdWith</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="System.Posix.Types.html#Fd"><span class="hs-identifier hs-type">Fd</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>        </span><span class="hs-comment">-- ^ Action that performs the close.</span><span>
</span><a name="line-98"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="System.Posix.Types.html#Fd"><span class="hs-identifier hs-type">Fd</span></a><span>                   </span><span class="hs-comment">-- ^ File descriptor to close.</span><span>
</span><a name="line-99"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-100"></a><a name="closeFdWith"><a href="GHC.Event.Thread.html#closeFdWith"><span class="hs-identifier">closeFdWith</span></a></a><span> </span><a name="local-6989586621679299271"><a href="#local-6989586621679299271"><span class="hs-identifier">close</span></a></a><span> </span><a name="local-6989586621679299272"><a href="#local-6989586621679299272"><span class="hs-identifier">fd</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-101"></a><span>  </span><a name="local-6989586621679299281"><a href="#local-6989586621679299281"><span class="hs-identifier">eventManagerArray</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IORef.html#readIORef"><span class="hs-identifier hs-var">readIORef</span></a><span> </span><a href="GHC.Event.Thread.html#eventManager"><span class="hs-identifier hs-var">eventManager</span></a><span>
</span><a name="line-102"></a><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679299282"><a href="#local-6989586621679299282"><span class="hs-identifier">low</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679299283"><a href="#local-6989586621679299283"><span class="hs-identifier">high</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IOArray.html#boundsIOArray"><span class="hs-identifier hs-var">boundsIOArray</span></a><span> </span><a href="#local-6989586621679299281"><span class="hs-identifier hs-var">eventManagerArray</span></a><span>
</span><a name="line-103"></a><span>  </span><a name="local-6989586621679299286"><a href="#local-6989586621679299286"><span class="hs-identifier">mgrs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.Base.html#flip"><span class="hs-identifier hs-var">flip</span></a><span> </span><a href="GHC.Base.html#mapM"><span class="hs-identifier hs-var">mapM</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621679299282"><span class="hs-identifier hs-var">low</span></a><span class="hs-glyph">..</span><a href="#local-6989586621679299283"><span class="hs-identifier hs-var">high</span></a><span class="hs-special">]</span><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679299284"><a href="#local-6989586621679299284"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-104"></a><span>    </span><a href="GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span class="hs-glyph">!</span><a name="local-6989586621679299285"><a href="#local-6989586621679299285"><span class="hs-identifier">mgr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IOArray.html#readIOArray"><span class="hs-identifier hs-var">readIOArray</span></a><span> </span><a href="#local-6989586621679299281"><span class="hs-identifier hs-var">eventManagerArray</span></a><span> </span><a href="#local-6989586621679299284"><span class="hs-identifier hs-var">i</span></a><span>
</span><a name="line-105"></a><span>    </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621679299285"><span class="hs-identifier hs-var">mgr</span></a><span>
</span><a name="line-106"></a><span>  </span><a href="GHC.IO.html#mask_"><span class="hs-identifier hs-var">mask_</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-107"></a><span>    </span><a name="local-6989586621679299288"><a href="#local-6989586621679299288"><span class="hs-identifier">tables</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.Base.html#flip"><span class="hs-identifier hs-var">flip</span></a><span> </span><a href="GHC.Base.html#mapM"><span class="hs-identifier hs-var">mapM</span></a><span> </span><a href="#local-6989586621679299286"><span class="hs-identifier hs-var">mgrs</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679299287"><a href="#local-6989586621679299287"><span class="hs-identifier">mgr</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.MVar.html#takeMVar"><span class="hs-identifier hs-var">takeMVar</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="GHC.Event.Manager.html#callbackTableVar"><span class="hs-identifier hs-var">M.callbackTableVar</span></a><span> </span><a href="#local-6989586621679299287"><span class="hs-identifier hs-var">mgr</span></a><span> </span><a href="#local-6989586621679299272"><span class="hs-identifier hs-var">fd</span></a><span>
</span><a name="line-108"></a><span>    </span><a name="local-6989586621679299291"><a href="#local-6989586621679299291"><span class="hs-identifier">cbApps</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679299274"><span class="hs-identifier hs-var">zipWithM</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679299289"><a href="#local-6989586621679299289"><span class="hs-identifier">mgr</span></a></a><span> </span><a name="local-6989586621679299290"><a href="#local-6989586621679299290"><span class="hs-identifier">table</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Event.Manager.html#closeFd_"><span class="hs-identifier hs-var">M.closeFd_</span></a><span> </span><a href="#local-6989586621679299289"><span class="hs-identifier hs-var">mgr</span></a><span> </span><a href="#local-6989586621679299290"><span class="hs-identifier hs-var">table</span></a><span> </span><a href="#local-6989586621679299272"><span class="hs-identifier hs-var">fd</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679299286"><span class="hs-identifier hs-var">mgrs</span></a><span> </span><a href="#local-6989586621679299288"><span class="hs-identifier hs-var">tables</span></a><span>
</span><a name="line-109"></a><span>    </span><a href="#local-6989586621679299271"><span class="hs-identifier hs-var">close</span></a><span> </span><a href="#local-6989586621679299272"><span class="hs-identifier hs-var">fd</span></a><span> </span><span class="hs-special">`</span><a href="Control.Exception.Base.html#finally"><span class="hs-identifier hs-var">finally</span></a><span class="hs-special">`</span><span> </span><a href="Data.Foldable.html#sequence_"><span class="hs-identifier hs-var">sequence_</span></a><span> </span><span class="hs-special">(</span><a href="GHC.List.html#zipWith3"><span class="hs-identifier hs-var">zipWith3</span></a><span> </span><a href="#local-6989586621679299273"><span class="hs-identifier hs-var">finish</span></a><span> </span><a href="#local-6989586621679299286"><span class="hs-identifier hs-var">mgrs</span></a><span> </span><a href="#local-6989586621679299288"><span class="hs-identifier hs-var">tables</span></a><span> </span><a href="#local-6989586621679299291"><span class="hs-identifier hs-var">cbApps</span></a><span class="hs-special">)</span><span>
</span><a name="line-110"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-111"></a><span>    </span><a name="local-6989586621679299273"><a href="#local-6989586621679299273"><span class="hs-identifier">finish</span></a></a><span> </span><a name="local-6989586621679299275"><a href="#local-6989586621679299275"><span class="hs-identifier">mgr</span></a></a><span> </span><a name="local-6989586621679299276"><a href="#local-6989586621679299276"><span class="hs-identifier">table</span></a></a><span> </span><a name="local-6989586621679299277"><a href="#local-6989586621679299277"><span class="hs-identifier">cbApp</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.MVar.html#putMVar"><span class="hs-identifier hs-var">putMVar</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Event.Manager.html#callbackTableVar"><span class="hs-identifier hs-var">M.callbackTableVar</span></a><span> </span><a href="#local-6989586621679299275"><span class="hs-identifier hs-var">mgr</span></a><span> </span><a href="#local-6989586621679299272"><span class="hs-identifier hs-var">fd</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679299276"><span class="hs-identifier hs-var">table</span></a><span> </span><a href="GHC.Base.html#%3E%3E"><span class="hs-operator hs-var">&gt;&gt;</span></a><span> </span><a href="#local-6989586621679299277"><span class="hs-identifier hs-var">cbApp</span></a><span>
</span><a name="line-112"></a><span>    </span><a name="local-6989586621679299274"><a href="#local-6989586621679299274"><span class="hs-identifier">zipWithM</span></a></a><span> </span><a name="local-6989586621679299278"><a href="#local-6989586621679299278"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621679299279"><a href="#local-6989586621679299279"><span class="hs-identifier">xs</span></a></a><span> </span><a name="local-6989586621679299280"><a href="#local-6989586621679299280"><span class="hs-identifier">ys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.Base.html#sequence"><span class="hs-identifier hs-var">sequence</span></a><span> </span><span class="hs-special">(</span><a href="GHC.List.html#zipWith"><span class="hs-identifier hs-var">zipWith</span></a><span> </span><a href="#local-6989586621679299278"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679299279"><span class="hs-identifier hs-var">xs</span></a><span> </span><a href="#local-6989586621679299280"><span class="hs-identifier hs-var">ys</span></a><span class="hs-special">)</span><span>
</span><a name="line-113"></a><span>
</span><a name="line-114"></a><span class="hs-identifier">threadWait</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.Event.Internal.html#Event"><span class="hs-identifier hs-type">Event</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="System.Posix.Types.html#Fd"><span class="hs-identifier hs-type">Fd</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-115"></a><a name="threadWait"><a href="GHC.Event.Thread.html#threadWait"><span class="hs-identifier">threadWait</span></a></a><span> </span><a name="local-6989586621679299292"><a href="#local-6989586621679299292"><span class="hs-identifier">evt</span></a></a><span> </span><a name="local-6989586621679299293"><a href="#local-6989586621679299293"><span class="hs-identifier">fd</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.html#mask_"><span class="hs-identifier hs-var">mask_</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-116"></a><span>  </span><a name="local-6989586621679299294"><a href="#local-6989586621679299294"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.MVar.html#newEmptyMVar"><span class="hs-identifier hs-var">newEmptyMVar</span></a><span>
</span><a name="line-117"></a><span>  </span><a name="local-6989586621679299295"><a href="#local-6989586621679299295"><span class="hs-identifier">mgr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.Event.Thread.html#getSystemEventManager_"><span class="hs-identifier hs-var">getSystemEventManager_</span></a><span>
</span><a name="line-118"></a><span>  </span><a name="local-6989586621679299297"><a href="#local-6989586621679299297"><span class="hs-identifier">reg</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.Event.Manager.html#registerFd"><span class="hs-identifier hs-var">registerFd</span></a><span> </span><a href="#local-6989586621679299295"><span class="hs-identifier hs-var">mgr</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679299296"><a href="#local-6989586621679299296"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.MVar.html#putMVar"><span class="hs-identifier hs-var">putMVar</span></a><span> </span><a href="#local-6989586621679299294"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="#local-6989586621679299296"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679299293"><span class="hs-identifier hs-var">fd</span></a><span> </span><a href="#local-6989586621679299292"><span class="hs-identifier hs-var">evt</span></a><span> </span><a href="GHC.Event.Internal.html#OneShot"><span class="hs-identifier hs-var">M.OneShot</span></a><span>
</span><a name="line-119"></a><span>  </span><a name="local-6989586621679299298"><a href="#local-6989586621679299298"><span class="hs-identifier">evt'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.MVar.html#takeMVar"><span class="hs-identifier hs-var">takeMVar</span></a><span> </span><a href="#local-6989586621679299294"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-special">`</span><a href="GHC.IO.html#onException"><span class="hs-identifier hs-var">onException</span></a><span class="hs-special">`</span><span> </span><a href="GHC.Event.Manager.html#unregisterFd_"><span class="hs-identifier hs-var">unregisterFd_</span></a><span> </span><a href="#local-6989586621679299295"><span class="hs-identifier hs-var">mgr</span></a><span> </span><a href="#local-6989586621679299297"><span class="hs-identifier hs-var">reg</span></a><span>
</span><a name="line-120"></a><span>  </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679299298"><span class="hs-identifier hs-var">evt'</span></a><span> </span><span class="hs-special">`</span><a href="GHC.Event.Internal.html#eventIs"><span class="hs-identifier hs-var">eventIs</span></a><span class="hs-special">`</span><span> </span><a href="GHC.Event.Internal.html#evtClose"><span class="hs-identifier hs-var">evtClose</span></a><span>
</span><a name="line-121"></a><span>    </span><span class="hs-keyword">then</span><span> </span><a href="GHC.IO.Exception.html#ioError"><span class="hs-identifier hs-var">ioError</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Foreign.C.Error.html#errnoToIOError"><span class="hs-identifier hs-var">errnoToIOError</span></a><span> </span><span class="hs-string">&quot;threadWait&quot;</span><span> </span><a href="Foreign.C.Error.html#eBADF"><span class="hs-identifier hs-var">eBADF</span></a><span> </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>
</span><a name="line-122"></a><span>    </span><span class="hs-keyword">else</span><span> </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-123"></a><span>
</span><a name="line-124"></a><span class="hs-comment">-- used at least by RTS in 'select()' IO manager backend</span><span>
</span><a name="line-125"></a><span class="hs-identifier">blockedOnBadFD</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.Exception.html#SomeException"><span class="hs-identifier hs-type">SomeException</span></a><span>
</span><a name="line-126"></a><a name="blockedOnBadFD"><a href="GHC.Event.Thread.html#blockedOnBadFD"><span class="hs-identifier">blockedOnBadFD</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.Exception.html#toException"><span class="hs-identifier hs-var">toException</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Foreign.C.Error.html#errnoToIOError"><span class="hs-identifier hs-var">errnoToIOError</span></a><span> </span><span class="hs-string">&quot;awaitEvent&quot;</span><span> </span><a href="Foreign.C.Error.html#eBADF"><span class="hs-identifier hs-var">eBADF</span></a><span> </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>
</span><a name="line-127"></a><span>
</span><a name="line-128"></a><span class="hs-identifier">threadWaitSTM</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.Event.Internal.html#Event"><span class="hs-identifier hs-type">Event</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="System.Posix.Types.html#Fd"><span class="hs-identifier hs-type">Fd</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Conc.Sync.html#STM"><span class="hs-identifier hs-type">STM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-129"></a><a name="threadWaitSTM"><a href="GHC.Event.Thread.html#threadWaitSTM"><span class="hs-identifier">threadWaitSTM</span></a></a><span> </span><a name="local-6989586621679299299"><a href="#local-6989586621679299299"><span class="hs-identifier">evt</span></a></a><span> </span><a name="local-6989586621679299300"><a href="#local-6989586621679299300"><span class="hs-identifier">fd</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.html#mask_"><span class="hs-identifier hs-var">mask_</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-130"></a><span>  </span><a name="local-6989586621679299301"><a href="#local-6989586621679299301"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.Conc.Sync.html#newTVarIO"><span class="hs-identifier hs-var">newTVarIO</span></a><span> </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>
</span><a name="line-131"></a><span>  </span><a name="local-6989586621679299302"><a href="#local-6989586621679299302"><span class="hs-identifier">mgr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.Event.Thread.html#getSystemEventManager_"><span class="hs-identifier hs-var">getSystemEventManager_</span></a><span>
</span><a name="line-132"></a><span>  </span><a name="local-6989586621679299304"><a href="#local-6989586621679299304"><span class="hs-identifier">reg</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.Event.Manager.html#registerFd"><span class="hs-identifier hs-var">registerFd</span></a><span> </span><a href="#local-6989586621679299302"><span class="hs-identifier hs-var">mgr</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679299303"><a href="#local-6989586621679299303"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Conc.Sync.html#atomically"><span class="hs-identifier hs-var">atomically</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Conc.Sync.html#writeTVar"><span class="hs-identifier hs-var">writeTVar</span></a><span> </span><a href="#local-6989586621679299301"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="#local-6989586621679299303"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679299300"><span class="hs-identifier hs-var">fd</span></a><span> </span><a href="#local-6989586621679299299"><span class="hs-identifier hs-var">evt</span></a><span> </span><a href="GHC.Event.Internal.html#OneShot"><span class="hs-identifier hs-var">M.OneShot</span></a><span>
</span><a name="line-133"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679299305"><a href="#local-6989586621679299305"><span class="hs-identifier">waitAction</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-134"></a><span>        </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621679299306"><a href="#local-6989586621679299306"><span class="hs-identifier">mevt</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.Conc.Sync.html#readTVar"><span class="hs-identifier hs-var">readTVar</span></a><span> </span><a href="#local-6989586621679299301"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-135"></a><span>           </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679299306"><span class="hs-identifier hs-var">mevt</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-136"></a><span>             </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Conc.Sync.html#retry"><span class="hs-identifier hs-var">retry</span></a><span>
</span><a name="line-137"></a><span>             </span><a href="GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621679299307"><a href="#local-6989586621679299307"><span class="hs-identifier">evt'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-138"></a><span>               </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679299307"><span class="hs-identifier hs-var">evt'</span></a><span> </span><span class="hs-special">`</span><a href="GHC.Event.Internal.html#eventIs"><span class="hs-identifier hs-var">eventIs</span></a><span class="hs-special">`</span><span> </span><a href="GHC.Event.Internal.html#evtClose"><span class="hs-identifier hs-var">evtClose</span></a><span>
</span><a name="line-139"></a><span>               </span><span class="hs-keyword">then</span><span> </span><a href="GHC.Conc.Sync.html#throwSTM"><span class="hs-identifier hs-var">throwSTM</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Foreign.C.Error.html#errnoToIOError"><span class="hs-identifier hs-var">errnoToIOError</span></a><span> </span><span class="hs-string">&quot;threadWaitSTM&quot;</span><span> </span><a href="Foreign.C.Error.html#eBADF"><span class="hs-identifier hs-var">eBADF</span></a><span> </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>
</span><a name="line-140"></a><span>               </span><span class="hs-keyword">else</span><span> </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-141"></a><span>  </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679299305"><span class="hs-identifier hs-var">waitAction</span></a><span class="hs-special">,</span><span> </span><a href="GHC.Event.Manager.html#unregisterFd_"><span class="hs-identifier hs-var">unregisterFd_</span></a><span> </span><a href="#local-6989586621679299302"><span class="hs-identifier hs-var">mgr</span></a><span> </span><a href="#local-6989586621679299304"><span class="hs-identifier hs-var">reg</span></a><span> </span><a href="GHC.Base.html#%3E%3E"><span class="hs-operator hs-var">&gt;&gt;</span></a><span> </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-142"></a><span>
</span><a name="line-143"></a><span class="hs-comment">-- | Allows a thread to use an STM action to wait for a file descriptor to be readable.</span><span>
</span><a name="line-144"></a><span class="hs-comment">-- The STM action will retry until the file descriptor has data ready.</span><span>
</span><a name="line-145"></a><span class="hs-comment">-- The second element of the return value pair is an IO action that can be used</span><span>
</span><a name="line-146"></a><span class="hs-comment">-- to deregister interest in the file descriptor.</span><span>
</span><a name="line-147"></a><span class="hs-comment">--</span><span>
</span><a name="line-148"></a><span class="hs-comment">-- The STM action will throw an 'IOError' if the file descriptor was closed</span><span>
</span><a name="line-149"></a><span class="hs-comment">-- while the STM action is being executed.  To safely close a file descriptor</span><span>
</span><a name="line-150"></a><span class="hs-comment">-- that has been used with 'threadWaitReadSTM', use 'closeFdWith'.</span><span>
</span><a name="line-151"></a><span class="hs-identifier">threadWaitReadSTM</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="System.Posix.Types.html#Fd"><span class="hs-identifier hs-type">Fd</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Conc.Sync.html#STM"><span class="hs-identifier hs-type">STM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-152"></a><a name="threadWaitReadSTM"><a href="GHC.Event.Thread.html#threadWaitReadSTM"><span class="hs-identifier">threadWaitReadSTM</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.Event.Thread.html#threadWaitSTM"><span class="hs-identifier hs-var">threadWaitSTM</span></a><span> </span><a href="GHC.Event.Internal.html#evtRead"><span class="hs-identifier hs-var">evtRead</span></a><span>
</span><a name="line-153"></a><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">threadWaitReadSTM</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-154"></a><span>
</span><a name="line-155"></a><span class="hs-comment">-- | Allows a thread to use an STM action to wait until a file descriptor can accept a write.</span><span>
</span><a name="line-156"></a><span class="hs-comment">-- The STM action will retry while the file until the given file descriptor can accept a write.</span><span>
</span><a name="line-157"></a><span class="hs-comment">-- The second element of the return value pair is an IO action that can be used to deregister</span><span>
</span><a name="line-158"></a><span class="hs-comment">-- interest in the file descriptor.</span><span>
</span><a name="line-159"></a><span class="hs-comment">--</span><span>
</span><a name="line-160"></a><span class="hs-comment">-- The STM action will throw an 'IOError' if the file descriptor was closed</span><span>
</span><a name="line-161"></a><span class="hs-comment">-- while the STM action is being executed.  To safely close a file descriptor</span><span>
</span><a name="line-162"></a><span class="hs-comment">-- that has been used with 'threadWaitWriteSTM', use 'closeFdWith'.</span><span>
</span><a name="line-163"></a><span class="hs-identifier">threadWaitWriteSTM</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="System.Posix.Types.html#Fd"><span class="hs-identifier hs-type">Fd</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Conc.Sync.html#STM"><span class="hs-identifier hs-type">STM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-164"></a><a name="threadWaitWriteSTM"><a href="GHC.Event.Thread.html#threadWaitWriteSTM"><span class="hs-identifier">threadWaitWriteSTM</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.Event.Thread.html#threadWaitSTM"><span class="hs-identifier hs-var">threadWaitSTM</span></a><span> </span><a href="GHC.Event.Internal.html#evtWrite"><span class="hs-identifier hs-var">evtWrite</span></a><span>
</span><a name="line-165"></a><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">threadWaitWriteSTM</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-166"></a><span>
</span><a name="line-167"></a><span>
</span><a name="line-168"></a><span class="hs-comment">-- | Retrieve the system event manager for the capability on which the</span><span>
</span><a name="line-169"></a><span class="hs-comment">-- calling thread is running.</span><span>
</span><a name="line-170"></a><span class="hs-comment">--</span><span>
</span><a name="line-171"></a><span class="hs-comment">-- This function always returns 'Just' the current thread's event manager</span><span>
</span><a name="line-172"></a><span class="hs-comment">-- when using the threaded RTS and 'Nothing' otherwise.</span><span>
</span><a name="line-173"></a><span class="hs-identifier">getSystemEventManager</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="GHC.Event.Manager.html#EventManager"><span class="hs-identifier hs-type">EventManager</span></a><span class="hs-special">)</span><span>
</span><a name="line-174"></a><a name="getSystemEventManager"><a href="GHC.Event.Thread.html#getSystemEventManager"><span class="hs-identifier">getSystemEventManager</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-175"></a><span>  </span><a name="local-6989586621679299308"><a href="#local-6989586621679299308"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.Conc.Sync.html#myThreadId"><span class="hs-identifier hs-var">myThreadId</span></a><span>
</span><a name="line-176"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679299309"><a href="#local-6989586621679299309"><span class="hs-identifier">cap</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.Conc.Sync.html#threadCapability"><span class="hs-identifier hs-var">threadCapability</span></a><span> </span><a href="#local-6989586621679299308"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-177"></a><span>  </span><a name="local-6989586621679299310"><a href="#local-6989586621679299310"><span class="hs-identifier">eventManagerArray</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IORef.html#readIORef"><span class="hs-identifier hs-var">readIORef</span></a><span> </span><a href="GHC.Event.Thread.html#eventManager"><span class="hs-identifier hs-var">eventManager</span></a><span>
</span><a name="line-178"></a><span>  </span><a name="local-6989586621679299311"><a href="#local-6989586621679299311"><span class="hs-identifier">mmgr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IOArray.html#readIOArray"><span class="hs-identifier hs-var">readIOArray</span></a><span> </span><a href="#local-6989586621679299310"><span class="hs-identifier hs-var">eventManagerArray</span></a><span> </span><a href="#local-6989586621679299309"><span class="hs-identifier hs-var">cap</span></a><span>
</span><a name="line-179"></a><span>  </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="GHC.Base.html#fmap"><span class="hs-identifier hs-var">fmap</span></a><span> </span><a href="Data.Tuple.html#snd"><span class="hs-identifier hs-var">snd</span></a><span> </span><a href="#local-6989586621679299311"><span class="hs-identifier hs-var">mmgr</span></a><span>
</span><a name="line-180"></a><span>
</span><a name="line-181"></a><span class="hs-identifier">getSystemEventManager_</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="GHC.Event.Manager.html#EventManager"><span class="hs-identifier hs-type">EventManager</span></a><span>
</span><a name="line-182"></a><a name="getSystemEventManager_"><a href="GHC.Event.Thread.html#getSystemEventManager_"><span class="hs-identifier">getSystemEventManager_</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-183"></a><span>  </span><a href="GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621679299312"><a href="#local-6989586621679299312"><span class="hs-identifier">mgr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.Event.Thread.html#getSystemEventManager"><span class="hs-identifier hs-var">getSystemEventManager</span></a><span>
</span><a name="line-184"></a><span>  </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621679299312"><span class="hs-identifier hs-var">mgr</span></a><span>
</span><a name="line-185"></a><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">getSystemEventManager_</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-186"></a><span>
</span><a name="line-187"></a><span class="hs-keyword">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">ccall</span><span> </span><span class="hs-keyword">unsafe</span><span> </span><span class="hs-string">&quot;getOrSetSystemEventThreadEventManagerStore&quot;</span><span>
</span><a name="line-188"></a><span>    </span><span class="hs-identifier">getOrSetSystemEventThreadEventManagerStore</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a><span> </span><a href="#local-6989586621679299362"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a><span> </span><a href="#local-6989586621679299362"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-189"></a><span>
</span><a name="line-190"></a><span class="hs-identifier">eventManager</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.IORef.html#IORef"><span class="hs-identifier hs-type">IORef</span></a><span> </span><span class="hs-special">(</span><a href="GHC.IOArray.html#IOArray"><span class="hs-identifier hs-type">IOArray</span></a><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Conc.Sync.html#ThreadId"><span class="hs-identifier hs-type">ThreadId</span></a><span class="hs-special">,</span><span> </span><a href="GHC.Event.Manager.html#EventManager"><span class="hs-identifier hs-type">EventManager</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-191"></a><a name="eventManager"><a href="GHC.Event.Thread.html#eventManager"><span class="hs-identifier">eventManager</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.Unsafe.html#unsafePerformIO"><span class="hs-identifier hs-var">unsafePerformIO</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-192"></a><span>    </span><a name="local-6989586621679299313"><a href="#local-6989586621679299313"><span class="hs-identifier">numCaps</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.Conc.Sync.html#getNumCapabilities"><span class="hs-identifier hs-var">getNumCapabilities</span></a><span>
</span><a name="line-193"></a><span>    </span><a name="local-6989586621679299314"><a href="#local-6989586621679299314"><span class="hs-identifier">eventManagerArray</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IOArray.html#newIOArray"><span class="hs-identifier hs-var">newIOArray</span></a><span> </span><span class="hs-special">(</span><span class="hs-number">0</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679299313"><span class="hs-identifier hs-var">numCaps</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>
</span><a name="line-194"></a><span>    </span><a name="local-6989586621679299315"><a href="#local-6989586621679299315"><span class="hs-identifier">em</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IORef.html#newIORef"><span class="hs-identifier hs-var">newIORef</span></a><span> </span><a href="#local-6989586621679299314"><span class="hs-identifier hs-var">eventManagerArray</span></a><span>
</span><a name="line-195"></a><span>    </span><a href="GHC.Conc.Sync.html#sharedCAF"><span class="hs-identifier hs-var">sharedCAF</span></a><span> </span><a href="#local-6989586621679299315"><span class="hs-identifier hs-var">em</span></a><span> </span><a href="GHC.Event.Thread.html#getOrSetSystemEventThreadEventManagerStore"><span class="hs-identifier hs-var">getOrSetSystemEventThreadEventManagerStore</span></a><span>
</span><a name="line-196"></a><span class="hs-pragma">{-# NOINLINE</span><span> </span><span class="hs-pragma">eventManager</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-197"></a><span>
</span><a name="line-198"></a><span class="hs-identifier">numEnabledEventManagers</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.IORef.html#IORef"><span class="hs-identifier hs-type">IORef</span></a><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a><span>
</span><a name="line-199"></a><a name="numEnabledEventManagers"><a href="GHC.Event.Thread.html#numEnabledEventManagers"><span class="hs-identifier">numEnabledEventManagers</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.Unsafe.html#unsafePerformIO"><span class="hs-identifier hs-var">unsafePerformIO</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-200"></a><span>  </span><a href="GHC.IORef.html#newIORef"><span class="hs-identifier hs-var">newIORef</span></a><span> </span><span class="hs-number">0</span><span>
</span><a name="line-201"></a><span class="hs-pragma">{-# NOINLINE</span><span> </span><span class="hs-pragma">numEnabledEventManagers</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-202"></a><span>
</span><a name="line-203"></a><span class="hs-keyword">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">ccall</span><span> </span><span class="hs-keyword">unsafe</span><span> </span><span class="hs-string">&quot;getOrSetSystemEventThreadIOManagerThreadStore&quot;</span><span>
</span><a name="line-204"></a><span>    </span><span class="hs-identifier">getOrSetSystemEventThreadIOManagerThreadStore</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a><span> </span><a href="#local-6989586621679299361"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a><span> </span><a href="#local-6989586621679299361"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-205"></a><span>
</span><a name="line-206"></a><span class="hs-comment">-- | The ioManagerLock protects the 'eventManager' value:</span><span>
</span><a name="line-207"></a><span class="hs-comment">-- Only one thread at a time can start or shutdown event managers.</span><span>
</span><a name="line-208"></a><span class="hs-pragma">{-# NOINLINE</span><span> </span><span class="hs-pragma">ioManagerLock</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-209"></a><span class="hs-identifier">ioManagerLock</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.MVar.html#MVar"><span class="hs-identifier hs-type">MVar</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-210"></a><a name="ioManagerLock"><a href="GHC.Event.Thread.html#ioManagerLock"><span class="hs-identifier">ioManagerLock</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.Unsafe.html#unsafePerformIO"><span class="hs-identifier hs-var">unsafePerformIO</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-211"></a><span>   </span><a name="local-6989586621679299316"><a href="#local-6989586621679299316"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.MVar.html#newMVar"><span class="hs-identifier hs-var">newMVar</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-212"></a><span>   </span><a href="GHC.Conc.Sync.html#sharedCAF"><span class="hs-identifier hs-var">sharedCAF</span></a><span> </span><a href="#local-6989586621679299316"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="GHC.Event.Thread.html#getOrSetSystemEventThreadIOManagerThreadStore"><span class="hs-identifier hs-var">getOrSetSystemEventThreadIOManagerThreadStore</span></a><span>
</span><a name="line-213"></a><span>
</span><a name="line-214"></a><span class="hs-identifier">getSystemTimerManager</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="GHC.Event.TimerManager.html#TimerManager"><span class="hs-identifier hs-type">TM.TimerManager</span></a><span>
</span><a name="line-215"></a><a name="getSystemTimerManager"><a href="GHC.Event.Thread.html#getSystemTimerManager"><span class="hs-identifier">getSystemTimerManager</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-216"></a><span>  </span><a href="GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621679299317"><a href="#local-6989586621679299317"><span class="hs-identifier">mgr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IORef.html#readIORef"><span class="hs-identifier hs-var">readIORef</span></a><span> </span><a href="GHC.Event.Thread.html#timerManager"><span class="hs-identifier hs-var">timerManager</span></a><span>
</span><a name="line-217"></a><span>  </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621679299317"><span class="hs-identifier hs-var">mgr</span></a><span>
</span><a name="line-218"></a><span>
</span><a name="line-219"></a><span class="hs-keyword">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">ccall</span><span> </span><span class="hs-keyword">unsafe</span><span> </span><span class="hs-string">&quot;getOrSetSystemTimerThreadEventManagerStore&quot;</span><span>
</span><a name="line-220"></a><span>    </span><span class="hs-identifier">getOrSetSystemTimerThreadEventManagerStore</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a><span> </span><a href="#local-6989586621679299360"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a><span> </span><a href="#local-6989586621679299360"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-221"></a><span>
</span><a name="line-222"></a><span class="hs-identifier">timerManager</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.IORef.html#IORef"><span class="hs-identifier hs-type">IORef</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="GHC.Event.TimerManager.html#TimerManager"><span class="hs-identifier hs-type">TM.TimerManager</span></a><span class="hs-special">)</span><span>
</span><a name="line-223"></a><a name="timerManager"><a href="GHC.Event.Thread.html#timerManager"><span class="hs-identifier">timerManager</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.Unsafe.html#unsafePerformIO"><span class="hs-identifier hs-var">unsafePerformIO</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-224"></a><span>    </span><a name="local-6989586621679299318"><a href="#local-6989586621679299318"><span class="hs-identifier">em</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IORef.html#newIORef"><span class="hs-identifier hs-var">newIORef</span></a><span> </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>
</span><a name="line-225"></a><span>    </span><a href="GHC.Conc.Sync.html#sharedCAF"><span class="hs-identifier hs-var">sharedCAF</span></a><span> </span><a href="#local-6989586621679299318"><span class="hs-identifier hs-var">em</span></a><span> </span><a href="GHC.Event.Thread.html#getOrSetSystemTimerThreadEventManagerStore"><span class="hs-identifier hs-var">getOrSetSystemTimerThreadEventManagerStore</span></a><span>
</span><a name="line-226"></a><span class="hs-pragma">{-# NOINLINE</span><span> </span><span class="hs-pragma">timerManager</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-227"></a><span>
</span><a name="line-228"></a><span class="hs-keyword">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">ccall</span><span> </span><span class="hs-keyword">unsafe</span><span> </span><span class="hs-string">&quot;getOrSetSystemTimerThreadIOManagerThreadStore&quot;</span><span>
</span><a name="line-229"></a><span>    </span><span class="hs-identifier">getOrSetSystemTimerThreadIOManagerThreadStore</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a><span> </span><a href="#local-6989586621679299359"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a><span> </span><a href="#local-6989586621679299359"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-230"></a><span>
</span><a name="line-231"></a><span class="hs-pragma">{-# NOINLINE</span><span> </span><span class="hs-pragma">timerManagerThreadVar</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-232"></a><span class="hs-identifier">timerManagerThreadVar</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.MVar.html#MVar"><span class="hs-identifier hs-type">MVar</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="GHC.Conc.Sync.html#ThreadId"><span class="hs-identifier hs-type">ThreadId</span></a><span class="hs-special">)</span><span>
</span><a name="line-233"></a><a name="timerManagerThreadVar"><a href="GHC.Event.Thread.html#timerManagerThreadVar"><span class="hs-identifier">timerManagerThreadVar</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.Unsafe.html#unsafePerformIO"><span class="hs-identifier hs-var">unsafePerformIO</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-234"></a><span>   </span><a name="local-6989586621679299319"><a href="#local-6989586621679299319"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.MVar.html#newMVar"><span class="hs-identifier hs-var">newMVar</span></a><span> </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>
</span><a name="line-235"></a><span>   </span><a href="GHC.Conc.Sync.html#sharedCAF"><span class="hs-identifier hs-var">sharedCAF</span></a><span> </span><a href="#local-6989586621679299319"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="GHC.Event.Thread.html#getOrSetSystemTimerThreadIOManagerThreadStore"><span class="hs-identifier hs-var">getOrSetSystemTimerThreadIOManagerThreadStore</span></a><span>
</span><a name="line-236"></a><span>
</span><a name="line-237"></a><span class="hs-identifier">ensureIOManagerIsRunning</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-238"></a><a name="ensureIOManagerIsRunning"><a href="GHC.Event.Thread.html#ensureIOManagerIsRunning"><span class="hs-identifier">ensureIOManagerIsRunning</span></a></a><span>
</span><a name="line-239"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Classes.html#not"><span class="hs-identifier hs-var">not</span></a><span> </span><a href="GHC.Event.Thread.html#threaded"><span class="hs-identifier hs-var">threaded</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-240"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-241"></a><span>      </span><a href="GHC.Event.Thread.html#startIOManagerThreads"><span class="hs-identifier hs-var">startIOManagerThreads</span></a><span>
</span><a name="line-242"></a><span>      </span><a href="GHC.Event.Thread.html#startTimerManagerThread"><span class="hs-identifier hs-var">startTimerManagerThread</span></a><span>
</span><a name="line-243"></a><span>
</span><a name="line-244"></a><span class="hs-identifier">startIOManagerThreads</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-245"></a><a name="startIOManagerThreads"><a href="GHC.Event.Thread.html#startIOManagerThreads"><span class="hs-identifier">startIOManagerThreads</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-246"></a><span>  </span><a href="GHC.Conc.Sync.html#withMVar"><span class="hs-identifier hs-var">withMVar</span></a><span> </span><a href="GHC.Event.Thread.html#ioManagerLock"><span class="hs-identifier hs-var">ioManagerLock</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-247"></a><span>    </span><a name="local-6989586621679299320"><a href="#local-6989586621679299320"><span class="hs-identifier">eventManagerArray</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IORef.html#readIORef"><span class="hs-identifier hs-var">readIORef</span></a><span> </span><a href="GHC.Event.Thread.html#eventManager"><span class="hs-identifier hs-var">eventManager</span></a><span>
</span><a name="line-248"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679299321"><a href="#local-6989586621679299321"><span class="hs-identifier">high</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IOArray.html#boundsIOArray"><span class="hs-identifier hs-var">boundsIOArray</span></a><span> </span><a href="#local-6989586621679299320"><span class="hs-identifier hs-var">eventManagerArray</span></a><span>
</span><a name="line-249"></a><span>    </span><a href="Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Event.Thread.html#startIOManagerThread"><span class="hs-identifier hs-var">startIOManagerThread</span></a><span> </span><a href="#local-6989586621679299320"><span class="hs-identifier hs-var">eventManagerArray</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-number">0</span><span class="hs-glyph">..</span><a href="#local-6989586621679299321"><span class="hs-identifier hs-var">high</span></a><span class="hs-special">]</span><span>
</span><a name="line-250"></a><span>    </span><a href="GHC.IORef.html#writeIORef"><span class="hs-identifier hs-var">writeIORef</span></a><span> </span><a href="GHC.Event.Thread.html#numEnabledEventManagers"><span class="hs-identifier hs-var">numEnabledEventManagers</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679299321"><span class="hs-identifier hs-var">high</span></a><a href="GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-251"></a><span>
</span><a name="line-252"></a><span class="hs-identifier">show_int</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span>
</span><a name="line-253"></a><a name="show_int"><a href="GHC.Event.Thread.html#show_int"><span class="hs-identifier">show_int</span></a></a><span> </span><a name="local-6989586621679299322"><a href="#local-6989586621679299322"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.Show.html#showSignedInt"><span class="hs-identifier hs-var">showSignedInt</span></a><span> </span><span class="hs-number">0</span><span> </span><a href="#local-6989586621679299322"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-254"></a><span>
</span><a name="line-255"></a><span class="hs-identifier">restartPollLoop</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.Event.Manager.html#EventManager"><span class="hs-identifier hs-type">EventManager</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="GHC.Conc.Sync.html#ThreadId"><span class="hs-identifier hs-type">ThreadId</span></a><span>
</span><a name="line-256"></a><a name="restartPollLoop"><a href="GHC.Event.Thread.html#restartPollLoop"><span class="hs-identifier">restartPollLoop</span></a></a><span> </span><a name="local-6989586621679299323"><a href="#local-6989586621679299323"><span class="hs-identifier">mgr</span></a></a><span> </span><a name="local-6989586621679299324"><a href="#local-6989586621679299324"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-257"></a><span>  </span><a href="GHC.Event.Manager.html#release"><span class="hs-identifier hs-var">M.release</span></a><span> </span><a href="#local-6989586621679299323"><span class="hs-identifier hs-var">mgr</span></a><span>
</span><a name="line-258"></a><span>  </span><span class="hs-glyph">!</span><a name="local-6989586621679299325"><a href="#local-6989586621679299325"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.Conc.Sync.html#forkOn"><span class="hs-identifier hs-var">forkOn</span></a><span> </span><a href="#local-6989586621679299324"><span class="hs-identifier hs-var">i</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="GHC.Event.Manager.html#loop"><span class="hs-identifier hs-var">loop</span></a><span> </span><a href="#local-6989586621679299323"><span class="hs-identifier hs-var">mgr</span></a><span>
</span><a name="line-259"></a><span>  </span><a href="GHC.Conc.Sync.html#labelThread"><span class="hs-identifier hs-var">labelThread</span></a><span> </span><a href="#local-6989586621679299325"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;IOManager on cap &quot;</span><span> </span><a href="GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="GHC.Event.Thread.html#show_int"><span class="hs-identifier hs-var">show_int</span></a><span> </span><a href="#local-6989586621679299324"><span class="hs-identifier hs-var">i</span></a><span class="hs-special">)</span><span>
</span><a name="line-260"></a><span>  </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621679299325"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-261"></a><span>
</span><a name="line-262"></a><span class="hs-identifier">startIOManagerThread</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.IOArray.html#IOArray"><span class="hs-identifier hs-type">IOArray</span></a><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Conc.Sync.html#ThreadId"><span class="hs-identifier hs-type">ThreadId</span></a><span class="hs-special">,</span><span> </span><a href="GHC.Event.Manager.html#EventManager"><span class="hs-identifier hs-type">EventManager</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-263"></a><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a><span>
</span><a name="line-264"></a><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-265"></a><a name="startIOManagerThread"><a href="GHC.Event.Thread.html#startIOManagerThread"><span class="hs-identifier">startIOManagerThread</span></a></a><span> </span><a name="local-6989586621679299326"><a href="#local-6989586621679299326"><span class="hs-identifier">eventManagerArray</span></a></a><span> </span><a name="local-6989586621679299327"><a href="#local-6989586621679299327"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-266"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679299328"><a href="#local-6989586621679299328"><span class="hs-identifier">create</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-267"></a><span>        </span><span class="hs-glyph">!</span><a name="local-6989586621679299329"><a href="#local-6989586621679299329"><span class="hs-identifier">mgr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.Event.Manager.html#new"><span class="hs-identifier hs-var">new</span></a><span>
</span><a name="line-268"></a><span>        </span><span class="hs-glyph">!</span><a name="local-6989586621679299330"><a href="#local-6989586621679299330"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.Conc.Sync.html#forkOn"><span class="hs-identifier hs-var">forkOn</span></a><span> </span><a href="#local-6989586621679299327"><span class="hs-identifier hs-var">i</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-269"></a><span>                </span><a href="GHC.Event.Thread.html#c_setIOManagerControlFd"><span class="hs-identifier hs-var">c_setIOManagerControlFd</span></a><span>
</span><a name="line-270"></a><span>                  </span><span class="hs-special">(</span><a href="GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a><span> </span><a href="#local-6989586621679299327"><span class="hs-identifier hs-var">i</span></a><span class="hs-special">)</span><span>
</span><a name="line-271"></a><span>                  </span><span class="hs-special">(</span><a href="GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-identifier">controlWriteFd</span><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-identifier">M.emControl</span><span> </span><a href="#local-6989586621679299329"><span class="hs-identifier hs-var">mgr</span></a><span class="hs-special">)</span><span>
</span><a name="line-272"></a><span>                </span><a href="GHC.Event.Manager.html#loop"><span class="hs-identifier hs-var">loop</span></a><span> </span><a href="#local-6989586621679299329"><span class="hs-identifier hs-var">mgr</span></a><span>
</span><a name="line-273"></a><span>        </span><a href="GHC.Conc.Sync.html#labelThread"><span class="hs-identifier hs-var">labelThread</span></a><span> </span><a href="#local-6989586621679299330"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;IOManager on cap &quot;</span><span> </span><a href="GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="GHC.Event.Thread.html#show_int"><span class="hs-identifier hs-var">show_int</span></a><span> </span><a href="#local-6989586621679299327"><span class="hs-identifier hs-var">i</span></a><span class="hs-special">)</span><span>
</span><a name="line-274"></a><span>        </span><a href="GHC.IOArray.html#writeIOArray"><span class="hs-identifier hs-var">writeIOArray</span></a><span> </span><a href="#local-6989586621679299326"><span class="hs-identifier hs-var">eventManagerArray</span></a><span> </span><a href="#local-6989586621679299327"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679299330"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">,</span><a href="#local-6989586621679299329"><span class="hs-identifier hs-var">mgr</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-275"></a><span>  </span><a name="local-6989586621679299331"><a href="#local-6989586621679299331"><span class="hs-identifier">old</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IOArray.html#readIOArray"><span class="hs-identifier hs-var">readIOArray</span></a><span> </span><a href="#local-6989586621679299326"><span class="hs-identifier hs-var">eventManagerArray</span></a><span> </span><a href="#local-6989586621679299327"><span class="hs-identifier hs-var">i</span></a><span>
</span><a name="line-276"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679299331"><span class="hs-identifier hs-var">old</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-277"></a><span>    </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679299328"><span class="hs-identifier hs-var">create</span></a><span>
</span><a name="line-278"></a><span>    </span><a href="GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679299332"><a href="#local-6989586621679299332"><span class="hs-identifier">t</span></a></a><span class="hs-special">,</span><a name="local-6989586621679299333"><a href="#local-6989586621679299333"><span class="hs-identifier">em</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-279"></a><span>      </span><a name="local-6989586621679299334"><a href="#local-6989586621679299334"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.Conc.Sync.html#threadStatus"><span class="hs-identifier hs-var">threadStatus</span></a><span> </span><a href="#local-6989586621679299332"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-280"></a><span>      </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679299334"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-281"></a><span>        </span><a href="GHC.Conc.Sync.html#ThreadFinished"><span class="hs-identifier hs-var">ThreadFinished</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679299328"><span class="hs-identifier hs-var">create</span></a><span>
</span><a name="line-282"></a><span>        </span><a href="GHC.Conc.Sync.html#ThreadDied"><span class="hs-identifier hs-var">ThreadDied</span></a><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-283"></a><span>          </span><span class="hs-comment">-- Sanity check: if the thread has died, there is a chance</span><span>
</span><a name="line-284"></a><span>          </span><span class="hs-comment">-- that event manager is still alive. This could happend during</span><span>
</span><a name="line-285"></a><span>          </span><span class="hs-comment">-- the fork, for example. In this case we should clean up</span><span>
</span><a name="line-286"></a><span>          </span><span class="hs-comment">-- open pipes and everything else related to the event manager.</span><span>
</span><a name="line-287"></a><span>          </span><span class="hs-comment">-- See #4449</span><span>
</span><a name="line-288"></a><span>          </span><a href="GHC.Event.Thread.html#c_setIOManagerControlFd"><span class="hs-identifier hs-var">c_setIOManagerControlFd</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a><span> </span><a href="#local-6989586621679299327"><span class="hs-identifier hs-var">i</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-289"></a><span>          </span><a href="GHC.Event.Manager.html#cleanup"><span class="hs-identifier hs-var">M.cleanup</span></a><span> </span><a href="#local-6989586621679299333"><span class="hs-identifier hs-var">em</span></a><span>
</span><a name="line-290"></a><span>          </span><a href="#local-6989586621679299328"><span class="hs-identifier hs-var">create</span></a><span>
</span><a name="line-291"></a><span>        </span><a name="local-6989586621679299335"><a href="#local-6989586621679299335"><span class="hs-identifier">_other</span></a></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-292"></a><span>
</span><a name="line-293"></a><span class="hs-identifier">startTimerManagerThread</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-294"></a><a name="startTimerManagerThread"><a href="GHC.Event.Thread.html#startTimerManagerThread"><span class="hs-identifier">startTimerManagerThread</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.Conc.Sync.html#modifyMVar_"><span class="hs-identifier hs-var">modifyMVar_</span></a><span> </span><a href="GHC.Event.Thread.html#timerManagerThreadVar"><span class="hs-identifier hs-var">timerManagerThreadVar</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679299336"><a href="#local-6989586621679299336"><span class="hs-identifier">old</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-295"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679299337"><a href="#local-6989586621679299337"><span class="hs-identifier">create</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-296"></a><span>        </span><span class="hs-glyph">!</span><a name="local-6989586621679299338"><a href="#local-6989586621679299338"><span class="hs-identifier">mgr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.Event.TimerManager.html#new"><span class="hs-identifier hs-var">TM.new</span></a><span>
</span><a name="line-297"></a><span>        </span><a href="GHC.Event.Thread.html#c_setTimerManagerControlFd"><span class="hs-identifier hs-var">c_setTimerManagerControlFd</span></a><span>
</span><a name="line-298"></a><span>          </span><span class="hs-special">(</span><a href="GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-identifier">controlWriteFd</span><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-identifier">TM.emControl</span><span> </span><a href="#local-6989586621679299338"><span class="hs-identifier hs-var">mgr</span></a><span class="hs-special">)</span><span>
</span><a name="line-299"></a><span>        </span><a href="GHC.IORef.html#writeIORef"><span class="hs-identifier hs-var">writeIORef</span></a><span> </span><a href="GHC.Event.Thread.html#timerManager"><span class="hs-identifier hs-var">timerManager</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="#local-6989586621679299338"><span class="hs-identifier hs-var">mgr</span></a><span>
</span><a name="line-300"></a><span>        </span><span class="hs-glyph">!</span><a name="local-6989586621679299339"><a href="#local-6989586621679299339"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.Conc.Sync.html#forkIO"><span class="hs-identifier hs-var">forkIO</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="GHC.Event.TimerManager.html#loop"><span class="hs-identifier hs-var">TM.loop</span></a><span> </span><a href="#local-6989586621679299338"><span class="hs-identifier hs-var">mgr</span></a><span>
</span><a name="line-301"></a><span>        </span><a href="GHC.Conc.Sync.html#labelThread"><span class="hs-identifier hs-var">labelThread</span></a><span> </span><a href="#local-6989586621679299339"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-string">&quot;TimerManager&quot;</span><span>
</span><a name="line-302"></a><span>        </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="#local-6989586621679299339"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-303"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679299336"><span class="hs-identifier hs-var">old</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-304"></a><span>    </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679299337"><span class="hs-identifier hs-var">create</span></a><span>
</span><a name="line-305"></a><span>    </span><a name="local-6989586621679299340"><a href="#local-6989586621679299340"><span class="hs-identifier">st</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621679299341"><a href="#local-6989586621679299341"><span class="hs-identifier">t</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-306"></a><span>      </span><a name="local-6989586621679299342"><a href="#local-6989586621679299342"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.Conc.Sync.html#threadStatus"><span class="hs-identifier hs-var">threadStatus</span></a><span> </span><a href="#local-6989586621679299341"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-307"></a><span>      </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679299342"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-308"></a><span>        </span><a href="GHC.Conc.Sync.html#ThreadFinished"><span class="hs-identifier hs-var">ThreadFinished</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679299337"><span class="hs-identifier hs-var">create</span></a><span>
</span><a name="line-309"></a><span>        </span><a href="GHC.Conc.Sync.html#ThreadDied"><span class="hs-identifier hs-var">ThreadDied</span></a><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-310"></a><span>          </span><span class="hs-comment">-- Sanity check: if the thread has died, there is a chance</span><span>
</span><a name="line-311"></a><span>          </span><span class="hs-comment">-- that event manager is still alive. This could happend during</span><span>
</span><a name="line-312"></a><span>          </span><span class="hs-comment">-- the fork, for example. In this case we should clean up</span><span>
</span><a name="line-313"></a><span>          </span><span class="hs-comment">-- open pipes and everything else related to the event manager.</span><span>
</span><a name="line-314"></a><span>          </span><span class="hs-comment">-- See #4449</span><span>
</span><a name="line-315"></a><span>          </span><a name="local-6989586621679299343"><a href="#local-6989586621679299343"><span class="hs-identifier">mem</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IORef.html#readIORef"><span class="hs-identifier hs-var">readIORef</span></a><span> </span><a href="GHC.Event.Thread.html#timerManager"><span class="hs-identifier hs-var">timerManager</span></a><span>
</span><a name="line-316"></a><span>          </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679299343"><span class="hs-identifier hs-var">mem</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-317"></a><span>                 </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-318"></a><span>                 </span><a href="GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621679299344"><a href="#local-6989586621679299344"><span class="hs-identifier">em</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><a href="GHC.Event.Thread.html#c_setTimerManagerControlFd"><span class="hs-identifier hs-var">c_setTimerManagerControlFd</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-319"></a><span>                               </span><a href="GHC.Event.TimerManager.html#cleanup"><span class="hs-identifier hs-var">TM.cleanup</span></a><span> </span><a href="#local-6989586621679299344"><span class="hs-identifier hs-var">em</span></a><span>
</span><a name="line-320"></a><span>          </span><a href="#local-6989586621679299337"><span class="hs-identifier hs-var">create</span></a><span>
</span><a name="line-321"></a><span>        </span><a name="local-6989586621679299345"><a href="#local-6989586621679299345"><span class="hs-identifier">_other</span></a></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621679299340"><span class="hs-identifier hs-var">st</span></a><span>
</span><a name="line-322"></a><span>
</span><a name="line-323"></a><span class="hs-keyword">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">ccall</span><span> </span><span class="hs-keyword">unsafe</span><span> </span><span class="hs-string">&quot;rtsSupportsBoundThreads&quot;</span><span> </span><span class="hs-identifier">threaded</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a><span>
</span><a name="line-324"></a><span>
</span><a name="line-325"></a><span class="hs-identifier">ioManagerCapabilitiesChanged</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-326"></a><a name="ioManagerCapabilitiesChanged"><a href="GHC.Event.Thread.html#ioManagerCapabilitiesChanged"><span class="hs-identifier">ioManagerCapabilitiesChanged</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-327"></a><span>  </span><a href="GHC.Conc.Sync.html#withMVar"><span class="hs-identifier hs-var">withMVar</span></a><span> </span><a href="GHC.Event.Thread.html#ioManagerLock"><span class="hs-identifier hs-var">ioManagerLock</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-328"></a><span>    </span><a name="local-6989586621679299346"><a href="#local-6989586621679299346"><span class="hs-identifier">new_n_caps</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.Conc.Sync.html#getNumCapabilities"><span class="hs-identifier hs-var">getNumCapabilities</span></a><span>
</span><a name="line-329"></a><span>    </span><a name="local-6989586621679299347"><a href="#local-6989586621679299347"><span class="hs-identifier">numEnabled</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IORef.html#readIORef"><span class="hs-identifier hs-var">readIORef</span></a><span> </span><a href="GHC.Event.Thread.html#numEnabledEventManagers"><span class="hs-identifier hs-var">numEnabledEventManagers</span></a><span>
</span><a name="line-330"></a><span>    </span><a href="GHC.IORef.html#writeIORef"><span class="hs-identifier hs-var">writeIORef</span></a><span> </span><a href="GHC.Event.Thread.html#numEnabledEventManagers"><span class="hs-identifier hs-var">numEnabledEventManagers</span></a><span> </span><a href="#local-6989586621679299346"><span class="hs-identifier hs-var">new_n_caps</span></a><span>
</span><a name="line-331"></a><span>    </span><a name="local-6989586621679299348"><a href="#local-6989586621679299348"><span class="hs-identifier">eventManagerArray</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IORef.html#readIORef"><span class="hs-identifier hs-var">readIORef</span></a><span> </span><a href="GHC.Event.Thread.html#eventManager"><span class="hs-identifier hs-var">eventManager</span></a><span>
</span><a name="line-332"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679299349"><a href="#local-6989586621679299349"><span class="hs-identifier">high</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IOArray.html#boundsIOArray"><span class="hs-identifier hs-var">boundsIOArray</span></a><span> </span><a href="#local-6989586621679299348"><span class="hs-identifier hs-var">eventManagerArray</span></a><span>
</span><a name="line-333"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679299350"><a href="#local-6989586621679299350"><span class="hs-identifier">old_n_caps</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679299349"><span class="hs-identifier hs-var">high</span></a><span> </span><a href="GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a><span> </span><span class="hs-number">1</span><span>
</span><a name="line-334"></a><span>    </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679299346"><span class="hs-identifier hs-var">new_n_caps</span></a><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Classes.html#%3E"><span class="hs-operator hs-var">&gt;</span></a><span> </span><a href="#local-6989586621679299350"><span class="hs-identifier hs-var">old_n_caps</span></a><span>
</span><a name="line-335"></a><span>      </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621679299351"><a href="#local-6989586621679299351"><span class="hs-identifier">new_eventManagerArray</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IOArray.html#newIOArray"><span class="hs-identifier hs-var">newIOArray</span></a><span> </span><span class="hs-special">(</span><span class="hs-number">0</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679299346"><span class="hs-identifier hs-var">new_n_caps</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><a href="GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>
</span><a name="line-336"></a><span>
</span><a name="line-337"></a><span>              </span><span class="hs-comment">-- copy the existing values into the new array:</span><span>
</span><a name="line-338"></a><span>              </span><a href="Data.Foldable.html#forM_"><span class="hs-identifier hs-var">forM_</span></a><span> </span><span class="hs-special">[</span><span class="hs-number">0</span><span class="hs-glyph">..</span><a href="#local-6989586621679299349"><span class="hs-identifier hs-var">high</span></a><span class="hs-special">]</span><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679299352"><a href="#local-6989586621679299352"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-339"></a><span>                </span><a href="GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679299353"><a href="#local-6989586621679299353"><span class="hs-identifier">tid</span></a></a><span class="hs-special">,</span><a name="local-6989586621679299354"><a href="#local-6989586621679299354"><span class="hs-identifier">mgr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IOArray.html#readIOArray"><span class="hs-identifier hs-var">readIOArray</span></a><span> </span><a href="#local-6989586621679299348"><span class="hs-identifier hs-var">eventManagerArray</span></a><span> </span><a href="#local-6989586621679299352"><span class="hs-identifier hs-var">i</span></a><span>
</span><a name="line-340"></a><span>                </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679299352"><span class="hs-identifier hs-var">i</span></a><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Classes.html#%3C"><span class="hs-operator hs-var">&lt;</span></a><span> </span><a href="#local-6989586621679299347"><span class="hs-identifier hs-var">numEnabled</span></a><span>
</span><a name="line-341"></a><span>                  </span><span class="hs-keyword">then</span><span> </span><a href="GHC.IOArray.html#writeIOArray"><span class="hs-identifier hs-var">writeIOArray</span></a><span> </span><a href="#local-6989586621679299351"><span class="hs-identifier hs-var">new_eventManagerArray</span></a><span> </span><a href="#local-6989586621679299352"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679299353"><span class="hs-identifier hs-var">tid</span></a><span class="hs-special">,</span><a href="#local-6989586621679299354"><span class="hs-identifier hs-var">mgr</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-342"></a><span>                  </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621679299355"><a href="#local-6989586621679299355"><span class="hs-identifier">tid'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.Event.Thread.html#restartPollLoop"><span class="hs-identifier hs-var">restartPollLoop</span></a><span> </span><a href="#local-6989586621679299354"><span class="hs-identifier hs-var">mgr</span></a><span> </span><a href="#local-6989586621679299352"><span class="hs-identifier hs-var">i</span></a><span>
</span><a name="line-343"></a><span>                          </span><a href="GHC.IOArray.html#writeIOArray"><span class="hs-identifier hs-var">writeIOArray</span></a><span> </span><a href="#local-6989586621679299351"><span class="hs-identifier hs-var">new_eventManagerArray</span></a><span> </span><a href="#local-6989586621679299352"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679299355"><span class="hs-identifier hs-var">tid'</span></a><span class="hs-special">,</span><a href="#local-6989586621679299354"><span class="hs-identifier hs-var">mgr</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-344"></a><span>
</span><a name="line-345"></a><span>              </span><span class="hs-comment">-- create new IO managers for the new caps:</span><span>
</span><a name="line-346"></a><span>              </span><a href="Data.Foldable.html#forM_"><span class="hs-identifier hs-var">forM_</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621679299350"><span class="hs-identifier hs-var">old_n_caps</span></a><span class="hs-glyph">..</span><a href="#local-6989586621679299346"><span class="hs-identifier hs-var">new_n_caps</span></a><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">]</span><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-347"></a><span>                </span><a href="GHC.Event.Thread.html#startIOManagerThread"><span class="hs-identifier hs-var">startIOManagerThread</span></a><span> </span><a href="#local-6989586621679299351"><span class="hs-identifier hs-var">new_eventManagerArray</span></a><span>
</span><a name="line-348"></a><span>
</span><a name="line-349"></a><span>              </span><span class="hs-comment">-- update the event manager array reference:</span><span>
</span><a name="line-350"></a><span>              </span><a href="GHC.IORef.html#writeIORef"><span class="hs-identifier hs-var">writeIORef</span></a><span> </span><a href="GHC.Event.Thread.html#eventManager"><span class="hs-identifier hs-var">eventManager</span></a><span> </span><a href="#local-6989586621679299351"><span class="hs-identifier hs-var">new_eventManagerArray</span></a><span>
</span><a name="line-351"></a><span>      </span><span class="hs-keyword">else</span><span> </span><a href="GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679299346"><span class="hs-identifier hs-var">new_n_caps</span></a><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Classes.html#%3E"><span class="hs-operator hs-var">&gt;</span></a><span> </span><a href="#local-6989586621679299347"><span class="hs-identifier hs-var">numEnabled</span></a><span class="hs-special">)</span><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-352"></a><span>            </span><a href="Data.Foldable.html#forM_"><span class="hs-identifier hs-var">forM_</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621679299347"><span class="hs-identifier hs-var">numEnabled</span></a><span class="hs-glyph">..</span><a href="#local-6989586621679299346"><span class="hs-identifier hs-var">new_n_caps</span></a><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">]</span><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679299356"><a href="#local-6989586621679299356"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-353"></a><span>              </span><a href="GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621679299357"><a href="#local-6989586621679299357"><span class="hs-identifier">mgr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IOArray.html#readIOArray"><span class="hs-identifier hs-var">readIOArray</span></a><span> </span><a href="#local-6989586621679299348"><span class="hs-identifier hs-var">eventManagerArray</span></a><span> </span><a href="#local-6989586621679299356"><span class="hs-identifier hs-var">i</span></a><span>
</span><a name="line-354"></a><span>              </span><a name="local-6989586621679299358"><a href="#local-6989586621679299358"><span class="hs-identifier">tid</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.Event.Thread.html#restartPollLoop"><span class="hs-identifier hs-var">restartPollLoop</span></a><span> </span><a href="#local-6989586621679299357"><span class="hs-identifier hs-var">mgr</span></a><span> </span><a href="#local-6989586621679299356"><span class="hs-identifier hs-var">i</span></a><span>
</span><a name="line-355"></a><span>              </span><a href="GHC.IOArray.html#writeIOArray"><span class="hs-identifier hs-var">writeIOArray</span></a><span> </span><a href="#local-6989586621679299348"><span class="hs-identifier hs-var">eventManagerArray</span></a><span> </span><a href="#local-6989586621679299356"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679299358"><span class="hs-identifier hs-var">tid</span></a><span class="hs-special">,</span><a href="#local-6989586621679299357"><span class="hs-identifier hs-var">mgr</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-356"></a><span>
</span><a name="line-357"></a><span class="hs-comment">-- Used to tell the RTS how it can send messages to the I/O manager.</span><span>
</span><a name="line-358"></a><span class="hs-keyword">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">ccall</span><span> </span><span class="hs-keyword">unsafe</span><span> </span><span class="hs-string">&quot;setIOManagerControlFd&quot;</span><span>
</span><a name="line-359"></a><span>   </span><span class="hs-identifier">c_setIOManagerControlFd</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Foreign.C.Types.html#CUInt"><span class="hs-identifier hs-type">CUInt</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Foreign.C.Types.html#CInt"><span class="hs-identifier hs-type">CInt</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-360"></a><span>
</span><a name="line-361"></a><span class="hs-keyword">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">ccall</span><span> </span><span class="hs-keyword">unsafe</span><span> </span><span class="hs-string">&quot;setTimerManagerControlFd&quot;</span><span>
</span><a name="line-362"></a><span>   </span><span class="hs-identifier">c_setTimerManagerControlFd</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Foreign.C.Types.html#CInt"><span class="hs-identifier hs-type">CInt</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim-0.5.2.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-363"></a></pre></body></html>